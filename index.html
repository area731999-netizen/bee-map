<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ ë´‰ì¥ì§€ë„</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#100c07;--bg2:#1a1208;--bg3:#221a0e;
  --bdr:rgba(255,179,0,0.22);
  --gold:#FFB300;--goldl:#FFD54F;
  --tx:#e8e0d0;--dim:#64748b;
  --blue:#3b82f6;--red:#f87171;--green:#4ade80
}
body{background:var(--bg);color:var(--tx);font-family:'Apple SD Gothic Neo','Noto Sans KR',sans-serif;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
#hdr{padding:9px 14px;background:linear-gradient(135deg,#1a0a00,#2d1400);border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
#hdr h1{font-size:1rem;font-weight:900;color:var(--gold)}
#gst{font-size:0.72rem;color:var(--dim)}
#mapwrap{position:relative;flex-shrink:0}
#vmap{width:100%;height:52dvh;background:#111}
.mtr{position:absolute;top:10px;right:10px;z-index:500;display:flex;gap:6px}
.mbl{position:absolute;bottom:12px;left:10px;z-index:500;display:flex;flex-direction:column;gap:6px}
.mtype{padding:5px 10px;background:rgba(15,10,5,.9);border:1px solid var(--bdr);border-radius:8px;color:#777;font-size:.72rem;font-weight:700;cursor:pointer;touch-action:manipulation}
.mtype.on{background:rgba(255,179,0,.9);color:#1a0800;border-color:var(--gold)}
.icob{width:40px;height:40px;background:rgba(15,10,5,.9);border:2px solid var(--bdr);border-radius:50%;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:manipulation}
#locbar{display:none;padding:8px 14px;background:rgba(5,8,15,.96);border-top:1px solid rgba(59,130,246,.3);align-items:center;gap:10px;flex-shrink:0}
#locbar.on{display:flex}
#panel{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px 12px 30px}
#legend{display:flex;gap:12px;flex-wrap:wrap;padding:6px 2px 10px;font-size:.76rem;color:#aaa}
.ac{background:var(--bg3);border:1px solid var(--bdr);border-radius:14px;margin-bottom:10px;overflow:hidden}
.ac-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;gap:8px}
.ac-btns{display:flex;flex-direction:column;gap:5px;align-items:flex-end;flex-shrink:0}
.btn{padding:7px 12px;border:none;border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;touch-action:manipulation}
.bg{background:rgba(255,179,0,.18);color:var(--goldl)}
.br{background:rgba(185,28,28,.22);color:var(--red)}
.mapbtn{width:100%;padding:7px;background:rgba(255,179,0,.06);color:var(--goldl);border:none;border-top:1px solid var(--bdr);font-size:.75rem;cursor:pointer;touch-action:manipulation}
.ac-form{display:none;padding:14px;border-top:2px solid rgba(255,179,0,.2);background:rgba(0,0,0,.25)}
.ac-form.on{display:block}
.fi{width:100%;padding:10px 12px;background:rgba(0,0,0,.35);border:1px solid var(--bdr);border-radius:10px;color:var(--tx);font-size:.88rem;outline:none;margin-bottom:10px}
.fi:focus{border-color:var(--gold)}
.fi::placeholder{color:#3a3a3a}
.fbig{width:100%;padding:12px;border:none;border-radius:12px;font-size:.9rem;font-weight:700;cursor:pointer;touch-action:manipulation;margin-bottom:8px}
.fgps{background:rgba(59,130,246,.25);color:#60a5fa;border:1px solid rgba(59,130,246,.4)}
.fsave{background:linear-gradient(135deg,#b45309,#78350f);color:#fef3c7}
.fcancel{background:rgba(100,100,100,.15);color:#666;margin-bottom:0}
.cbox{display:none;padding:8px 10px;background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.25);border-radius:8px;margin-bottom:10px;font-size:.78rem}
.cbox.on{display:block}
.tw{display:flex;align-items:center;gap:10px;padding:9px 10px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:10px}
.tt{width:44px;height:24px;border-radius:24px;cursor:pointer;display:flex;align-items:center;padding:2px;transition:background .3s}
.th{width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .3s}
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(20,14,6,.96);color:var(--goldl);padding:9px 18px;border-radius:20px;font-size:.82rem;font-weight:700;border:1px solid rgba(255,179,0,.3);z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis}
#toast.on{opacity:1}
.leaflet-control-zoom{border:1px solid var(--bdr)!important}
.leaflet-control-zoom a{background:rgba(15,10,5,.9)!important;color:var(--gold)!important}
.leaflet-popup-content-wrapper{background:transparent!important;border:none!important;box-shadow:none!important;padding:0!important}
.leaflet-popup-content{margin:0!important}
.leaflet-popup-tip-container{display:none!important}
</style>
</head>
<body>

<div id="hdr">
  <h1>ğŸ ë´‰ì¥ì§€ë„</h1>
  <span id="gst">GPS ëŒ€ê¸°</span>
</div>

<div id="mapwrap">
  <div class="mtr">
    <button class="mtype on" id="bsat"  onclick="setTile('sat')">ìœ„ì„±</button>
    <button class="mtype"    id="bbase" onclick="setTile('base')">ì¼ë°˜</button>
  </div>
  <div class="mbl">
    <button class="icob" onclick="goMyLoc()">ğŸ“</button>
  </div>
  <div id="vmap"></div>
</div>

<div id="locbar">
  <span style="font-size:1.1rem">ğŸ“</span>
  <div style="flex:1;min-width:0">
    <div id="laddr" style="font-size:.82rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">í™•ì¸ ì¤‘...</div>
    <div id="lcoord" style="font-size:.71rem;color:var(--dim)"></div>
  </div>
  <button class="btn" onclick="hideLocbar()" style="color:#444;flex-shrink:0">âœ•</button>
</div>

<div id="panel">
  <div id="legend">
    <span>ğŸŸ¡ ê³ ì •ë´‰ì¥</span><span>ğŸŸ  ì´ë™ë´‰ì¥</span><span>âš« ë¯¸ë“±ë¡</span><span>ğŸ”µ ë‚´ìœ„ì¹˜</span>
  </div>
  <div id="alist"></div>
</div>

<div id="toast"></div>

<script>
'use strict';

var VK = 'F00592E3-2B83-38D8-9EBA-DA543461A436';

var ADB = [
  {k:'í‰íƒ ì§„ìœ„ë©´',lat:37.063,lng:127.052},{k:'í‰íƒ ì˜¤ì„±ë©´',lat:37.082,lng:127.023},
  {k:'í‰íƒ ì„œíƒ„ë©´',lat:37.051,lng:127.082},{k:'í‰íƒ í˜„ë•ë©´',lat:37.001,lng:126.970},
  {k:'í‰íƒ íŒ½ì„±ì',lat:37.012,lng:127.025},{k:'í‰íƒ ì²­ë¶ì',lat:37.023,lng:126.954},
  {k:'í‰íƒ í¬ìŠ¹ì',lat:36.989,lng:126.986},{k:'í‰íƒ ì•ˆì¤‘ì',lat:36.993,lng:126.924},
  {k:'í‰íƒ ê³ ë•ë©´',lat:37.038,lng:127.100},{k:'í‰íƒ ì†¡íƒ„',lat:37.084,lng:127.065},
  {k:'í‰íƒì‹œ',lat:37.063,lng:127.080},{k:'í‰íƒ',lat:37.063,lng:127.080},
  {k:'ì•ˆì„± ê³µë„ì',lat:37.082,lng:127.143},{k:'ì•ˆì„± ë¯¸ì–‘ë©´',lat:37.043,lng:127.210},
  {k:'ì•ˆì„± ê¸ˆê´‘ë©´',lat:37.052,lng:127.244},{k:'ì•ˆì„± ì¼ì£½ë©´',lat:37.008,lng:127.440},
  {k:'ì•ˆì„± ì–‘ì„±ë©´',lat:37.012,lng:127.193},{k:'ì•ˆì„±ì‹œ',lat:37.008,lng:127.270},{k:'ì•ˆì„±',lat:37.008,lng:127.270},
  {k:'í™”ì„± ë´‰ë‹´ì',lat:37.212,lng:126.988},{k:'í™”ì„± ìš°ì •ì',lat:37.087,lng:126.780},
  {k:'í™”ì„± íŒ”íƒ„ë©´',lat:37.193,lng:126.878},{k:'í™”ì„± í–¥ë‚¨ì',lat:37.150,lng:126.912},
  {k:'í™”ì„±ì‹œ',lat:37.199,lng:126.831},{k:'í™”ì„±',lat:37.199,lng:126.831},
  {k:'ìš©ì¸ ë‚¨ì‚¬ì',lat:37.152,lng:127.157},{k:'ìš©ì¸ ì²˜ì¸êµ¬',lat:37.234,lng:127.205},
  {k:'ìš©ì¸ ê¸°í¥êµ¬',lat:37.278,lng:127.116},{k:'ìš©ì¸ ìˆ˜ì§€êµ¬',lat:37.322,lng:127.096},
  {k:'ìš©ì¸ì‹œ',lat:37.238,lng:127.200},{k:'ìš©ì¸',lat:37.238,lng:127.200},
  {k:'ìˆ˜ì›ì‹œ',lat:37.263,lng:127.028},{k:'ìˆ˜ì›',lat:37.263,lng:127.028},
  {k:'ì˜¤ì‚°ì‹œ',lat:37.150,lng:127.076},{k:'ì˜¤ì‚°',lat:37.150,lng:127.076},
  {k:'ì´ì²œì‹œ',lat:37.272,lng:127.435},{k:'ì´ì²œ',lat:37.272,lng:127.435},
  {k:'ì—¬ì£¼ì‹œ',lat:37.298,lng:127.637},{k:'ì—¬ì£¼',lat:37.298,lng:127.637},
  {k:'ì²œì•ˆì‹œ',lat:36.806,lng:127.152},{k:'ì²œì•ˆ',lat:36.806,lng:127.152},
  {k:'ì•„ì‚°ì‹œ',lat:36.789,lng:127.002},{k:'ì•„ì‚°',lat:36.789,lng:127.002},
  {k:'ì•„ì‚° ë„ê³ ë©´',lat:36.816,lng:126.914},{k:'ì•„ì‚° ë°°ë°©ì',lat:36.805,lng:127.021},
  {k:'ë‹¹ì§„ì‹œ',lat:36.889,lng:126.629},{k:'ë‹¹ì§„',lat:36.889,lng:126.629},
  {k:'ì„œì‚°ì‹œ',lat:36.779,lng:126.452},{k:'ì„œì‚°',lat:36.779,lng:126.452},
  {k:'í™ì„±êµ°',lat:36.601,lng:126.661},{k:'í™ì„±',lat:36.601,lng:126.661},
  {k:'ì˜ˆì‚°êµ°',lat:36.681,lng:126.849},{k:'ì˜ˆì‚°',lat:36.681,lng:126.849},
  {k:'ë…¼ì‚°ì‹œ',lat:36.187,lng:127.099},{k:'ë…¼ì‚°',lat:36.187,lng:127.099},
  {k:'ë³´ë ¹ì‹œ',lat:36.333,lng:126.614},{k:'ë³´ë ¹',lat:36.333,lng:126.614},
  {k:'ì„œìš¸',lat:37.566,lng:126.978},{k:'ë¶€ì‚°',lat:35.179,lng:129.075},
  {k:'ëŒ€êµ¬',lat:35.871,lng:128.602},{k:'ì¸ì²œ',lat:37.456,lng:126.705},
  {k:'ê´‘ì£¼',lat:35.160,lng:126.851},{k:'ëŒ€ì „',lat:36.351,lng:127.385},
  {k:'ìš¸ì‚°',lat:35.538,lng:129.312},{k:'ì œì£¼',lat:33.499,lng:126.531},
  {k:'ì„¸ì¢…',lat:36.480,lng:127.289},{k:'ì¶˜ì²œ',lat:37.881,lng:127.730},
  {k:'ê°•ë¦‰',lat:37.751,lng:128.876},{k:'ì²­ì£¼',lat:36.642,lng:127.489},
  {k:'ì „ì£¼',lat:35.824,lng:127.148},{k:'ìˆœì²œ',lat:34.950,lng:127.487},
  {k:'ì°½ì›',lat:35.228,lng:128.681},{k:'ì§„ì£¼',lat:35.180,lng:128.107},
  {k:'í¬í•­',lat:36.019,lng:129.343},{k:'ê²½ì£¼',lat:35.856,lng:129.225},
  {k:'ì•ˆë™',lat:36.569,lng:128.729},{k:'ì›ì£¼',lat:37.342,lng:127.921}
];

function jsonp(url, cb) {
  var fn = 'vw_' + Date.now() + '_' + Math.random().toString(36).slice(2);
  window[fn] = function(data) { try{document.head.removeChild(s);}catch(e){} delete window[fn]; cb(data); };
  var s = document.createElement('script');
  s.src = url + '&callback=' + fn;
  s.onerror = function() { try{document.head.removeChild(s);}catch(e){} delete window[fn]; cb(null); };
  document.head.appendChild(s);
}

function nearAddr(lat, lng, cb) {
  var url = 'https://api.vworld.kr/req/address?service=address&request=getAddress&version=2.0'
    + '&crs=epsg:4326&point=' + lng + ',' + lat
    + '&format=json&type=both&zipcode=false&simple=false&key=' + VK;
  jsonp(url, function(data) {
    if(data && data.response && data.response.status === 'OK') {
      var res = data.response.result;
      var road  = res.filter(function(r){return r.type==='road';})[0];
      var jibun = res.filter(function(r){return r.type==='parcel';})[0];
      cb((road?road.text:'') || (jibun?jibun.text:'') || '');
    } else { cb(''); }
  });
}

function addrToCoord(addr, cb) {
  var url = 'https://api.vworld.kr/req/search?service=search&request=search&version=2.0'
    + '&crs=epsg:4326&query=' + encodeURIComponent(addr)
    + '&type=address&category=road&format=json&errorformat=json&key=' + VK;
  jsonp(url, function(data) {
    if(data && data.response && data.response.status==='OK'
       && data.response.result && data.response.result.items && data.response.result.items.length>0) {
      var it = data.response.result.items[0];
      cb(parseFloat(it.point.y), parseFloat(it.point.x), it.title||addr); return;
    }
    var url2 = 'https://api.vworld.kr/req/search?service=search&request=search&version=2.0'
      + '&crs=epsg:4326&query=' + encodeURIComponent(addr)
      + '&type=address&category=parcel&format=json&errorformat=json&key=' + VK;
    jsonp(url2, function(data2) {
      if(data2 && data2.response && data2.response.status==='OK'
         && data2.response.result && data2.response.result.items && data2.response.result.items.length>0) {
        var it2 = data2.response.result.items[0];
        cb(parseFloat(it2.point.y), parseFloat(it2.point.x), it2.title||addr);
      } else { addrDB(addr, cb); }
    });
  });
}

function addrDB(addr, cb) {
  function norm(s){return s.replace(/\s/g,'').replace(/ì‹œ$|êµ°$|êµ¬$/,'').replace(/ì$|ë©´$|ë™$|ë¦¬$/,'');}
  var q=norm(addr), found=null, bl=0;
  ADB.forEach(function(r){ var k=norm(r.k); if(q.indexOf(k)>=0||k.indexOf(q)>=0){ if(r.k.length>bl){bl=r.k.length;found=r;} } });
  if(found){cb(found.lat,found.lng,found.k);}else{cb(null,null,null);}
}

var AS = (function(){try{return JSON.parse(localStorage.getItem('apiarySettings'));}catch(e){return null;}})()
  || {'1ë´‰ì¥':true,'2ë´‰ì¥':true,'3ë´‰ì¥':true,'ì´ë™1ë´‰ì¥':false,'ì´ë™2ë´‰ì¥':false,'ì´ë™3ë´‰ì¥':false};
var AL = (function(){try{return JSON.parse(localStorage.getItem('apiaryLocations'))||{};}catch(e){return{};}})();

function getNames(){return Object.keys(AS).filter(function(k){return AS[k];});}
function saveLocs(){try{localStorage.setItem('apiaryLocations',JSON.stringify(AL));return true;}catch(e){showToast('âš ï¸ ì €ì¥ ì‹¤íŒ¨');return false;}}

var vmap=null, tiles=[], aMks=[], myMk=null, myC=null, myPos=null, wid=null;
var tpins={}, openForm=null, gpsMoved=false, NAMES=[];
var formLat={}, formLng={};

function initMap(){
  if(vmap) return;
  vmap=L.map('vmap',{center:[36.5,127.8],zoom:7,zoomControl:true,attributionControl:false});
  setTile('sat');
  setTimeout(function(){
    vmap.invalidateSize();
    renderAList();
    renderAMks();
    startGPS();
    var cnt=getNames().filter(function(n){return AL[n]&&AL[n].lat;}).length;
    if(cnt>0) showToast('ğŸ“‚ ì €ì¥ëœ ë´‰ì¥ '+cnt+'ê°œ ë³µì›ë¨');
  },300);
}

function setTile(type){
  tiles.forEach(function(l){vmap.removeLayer(l);}); tiles=[];
  if(type==='sat'){
    tiles.push(L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+VK+'/Satellite/{z}/{y}/{x}.jpeg',{maxZoom:19}).addTo(vmap));
    tiles.push(L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+VK+'/Hybrid/{z}/{y}/{x}.png',{maxZoom:19,opacity:0.85}).addTo(vmap));
  } else {
    tiles.push(L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+VK+'/Base/{z}/{y}/{x}.png',{maxZoom:19}).addTo(vmap));
  }
  document.getElementById('bsat').classList.toggle('on',type==='sat');
  document.getElementById('bbase').classList.toggle('on',type==='base');
}

function startGPS(){
  if(!navigator.geolocation){showToast('âš ï¸ GPS ë¯¸ì§€ì›');return;}
  if(wid) navigator.geolocation.clearWatch(wid);
  gpsMoved=false;
  document.getElementById('gst').textContent='ğŸ“¡ GPS í™•ì¸ì¤‘...';
  wid=navigator.geolocation.watchPosition(onGPS,function(e){
    document.getElementById('gst').textContent=e.code===1?'ğŸ”’ ìœ„ì¹˜ê¶Œí•œ ì°¨ë‹¨':'âš ï¸ GPSì—†ìŒ';
  },{enableHighAccuracy:true,timeout:20000,maximumAge:0});
}

function onGPS(pos){
  var lat=pos.coords.latitude, lng=pos.coords.longitude, acc=Math.round(pos.coords.accuracy);
  myPos={lat:lat,lng:lng,acc:acc};
  var col=acc<=50?'#4ade80':acc<=300?'#fbbf24':'#f87171';
  var gst=document.getElementById('gst');
  gst.textContent='ğŸ“ Â±'+acc+'m'; gst.style.color=col;
  if(myMk) vmap.removeLayer(myMk);
  if(myC)  vmap.removeLayer(myC);
  myC=L.circle([lat,lng],{radius:acc,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:0.1,weight:1.5}).addTo(vmap);
  myMk=L.marker([lat,lng],{icon:L.divIcon({className:'',
    html:'<div style="width:16px;height:16px;background:#3b82f6;border:3px solid #fff;border-radius:50%;box-shadow:0 0 0 4px rgba(59,130,246,0.25);"></div>',
    iconSize:[16,16],iconAnchor:[8,8]}),zIndexOffset:2000}).addTo(vmap);
  if(!gpsMoved && acc<=500){gpsMoved=true; vmap.setView([lat,lng],14);}
  document.getElementById('laddr').textContent='ì£¼ì†Œ í™•ì¸ ì¤‘...';
  document.getElementById('lcoord').textContent=lat.toFixed(5)+', '+lng.toFixed(5)+'  (Â±'+acc+'m)';
  document.getElementById('locbar').classList.add('on');
  nearAddr(lat, lng, function(addr){
    document.getElementById('laddr').textContent = addr || 'ìœ„ì¹˜ í™•ì¸ë¨';
  });
}

function goMyLoc(){
  if(myPos){vmap.setView([myPos.lat,myPos.lng],15);showToast('ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™');}
  else{startGPS();showToast('ğŸ“¡ GPS ì‹ í˜¸ í™•ì¸ ì¤‘...');}
}
function hideLocbar(){document.getElementById('locbar').classList.remove('on');}

function renderAMks(){
  if(!vmap) return;
  aMks.forEach(function(m){vmap.removeLayer(m);}); aMks=[];
  getNames().forEach(function(name){
    var d=AL[name]; if(!d||!d.lat) return;
    var mov=name.indexOf('ì´ë™')>=0, col=mov?'#f97316':'#FFB300';
    var icon=L.divIcon({className:'',
      html:'<div style="width:30px;height:38px;"><svg viewBox="0 0 30 38" width="30" height="38">'
        +'<path d="M15 0C6.7 0 0 6.7 0 15c0 10 15 23 15 23s15-13 15-23C30 6.7 23.3 0 15 0z" fill="'+col+'"/>'
        +'<circle cx="15" cy="15" r="8" fill="rgba(255,255,255,0.92)"/>'
        +'<text x="15" y="20" font-size="9" text-anchor="middle">'+(mov?'ğŸšš':'ğŸ')+'</text>'
        +'</svg></div>',
      iconSize:[30,38],iconAnchor:[15,38],popupAnchor:[0,-40]
    });
    var popDiv=document.createElement('div');
    popDiv.style.cssText='background:#1e1410;border:2px solid '+col+';border-radius:10px;padding:10px 13px;min-width:175px;';
    popDiv.innerHTML='<b style="color:'+col+';">'+(mov?'ğŸšš ':'ğŸ ')+name+'</b>'
      +(d.address?'<div style="color:#aaa;font-size:.78rem;margin-top:4px;">ğŸ“ '+d.address+'</div>':'')
      +(d.memo?'<div style="color:#666;font-size:.76rem;margin-top:2px;">ğŸ“ '+d.memo+'</div>':'');
    var pbtnRow=document.createElement('div');
    pbtnRow.style.cssText='display:flex;gap:6px;margin-top:8px;';
    var pbtnEdit=document.createElement('button');
    pbtnEdit.style.cssText='flex:1;padding:6px;background:rgba(255,179,0,.18);color:#FFD54F;border:none;border-radius:7px;font-size:.75rem;font-weight:700;cursor:pointer;';
    pbtnEdit.textContent='âœï¸ ìˆ˜ì •';
    pbtnEdit.onclick=(function(n){return function(){popEdit(n);};})(name);
    var pbtnDel=document.createElement('button');
    pbtnDel.style.cssText='flex:1;padding:6px;background:rgba(185,28,28,.22);color:#f87171;border:none;border-radius:7px;font-size:.75rem;font-weight:700;cursor:pointer;';
    pbtnDel.textContent='ğŸ—‘ï¸ ì‚­ì œ';
    pbtnDel.onclick=(function(n){return function(){popDel(n);};})(name);
    pbtnRow.appendChild(pbtnEdit); pbtnRow.appendChild(pbtnDel);
    popDiv.appendChild(pbtnRow);
    var mk=L.marker([d.lat,d.lng],{icon:icon});
    mk.bindPopup(popDiv,{maxWidth:220});
    mk.addTo(vmap); aMks.push(mk);
  });
}

var regListOpen = false;

function renderAList(){
  NAMES=getNames();
  var el=document.getElementById('alist');
  if(!NAMES.length){el.innerHTML='<div style="text-align:center;color:#444;padding:24px;">í™œì„±í™”ëœ ë´‰ì¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}
  el.innerHTML='';

  var unreg = NAMES.filter(function(n){return !AL[n]||!AL[n].lat;});
  var reg   = NAMES.filter(function(n){return AL[n]&&AL[n].lat;});

  // ë¯¸ë“±ë¡ ë´‰ì¥ ì¹´ë“œ
  unreg.forEach(function(name){
    var i=NAMES.indexOf(name);
    var mov=name.indexOf('ì´ë™')>=0, col=mov?'#f97316':'#FFB300';
    var card=document.createElement('div');
    card.className='ac'; card.id='card-'+i;
    card.style.borderLeft='4px solid '+col;

    var head=document.createElement('div');
    head.className='ac-head';
    var info=document.createElement('div'); info.style.flex='1';
    info.innerHTML='<div style="font-weight:900;font-size:.92rem">'+(mov?'ğŸšš ':'ğŸ ')+name+'</div>'
      +'<div style="color:#444;font-size:.78rem;margin-top:2px">ìœ„ì¹˜ ë¯¸ë“±ë¡</div>';
    var btns=document.createElement('div'); btns.className='ac-btns';
    var editBtn=document.createElement('button'); editBtn.className='btn bg';
    editBtn.textContent='+ ë“±ë¡';
    editBtn.onclick=(function(n,idx){return function(){toggleForm(n,idx);};})(name,i);
    btns.appendChild(editBtn);
    head.appendChild(info); head.appendChild(btns);
    card.appendChild(head);
    card.appendChild(buildFormEl(i,name,{}));
    el.appendChild(card);
  });

  // ë“±ë¡ëœ ë´‰ì¥ ë³´ê¸° í† ê¸€ ë²„íŠ¼
  if(reg.length>0){
    var toggleBtn=document.createElement('button');
    toggleBtn.id='reg-toggle-btn';
    toggleBtn.style.cssText='width:100%;padding:11px;background:rgba(255,179,0,.08);color:var(--goldl);border:1px solid rgba(255,179,0,.25);border-radius:12px;font-size:.85rem;font-weight:700;cursor:pointer;touch-action:manipulation;margin-bottom:4px;';
    toggleBtn.textContent=(regListOpen?'â–² ':'â–¼ ')+'ë“±ë¡ëœ ë´‰ì¥ ë³´ê¸° ('+reg.length+'ê°œ)';
    toggleBtn.onclick=function(){
      regListOpen=!regListOpen;
      renderAList();
      renderAMks();
    };
    el.appendChild(toggleBtn);

    // ë“±ë¡ëœ ë´‰ì¥ ëª©ë¡ (í† ê¸€)
    if(regListOpen){
      reg.forEach(function(name){
        var i=NAMES.indexOf(name);
        var d=AL[name], mov=name.indexOf('ì´ë™')>=0, col=mov?'#f97316':'#FFB300';
        var card=document.createElement('div');
        card.className='ac'; card.id='card-'+i;
        card.style.borderLeft='4px solid '+col;

        var head=document.createElement('div'); head.className='ac-head';
        var info=document.createElement('div'); info.style.flex='1';
        info.innerHTML='<div style="font-weight:900;font-size:.92rem">'+(mov?'ğŸšš ':'ğŸ ')+name+'</div>'
          +'<div style="color:var(--dim);font-size:.78rem;margin-top:2px">ğŸ“ '+(d.address||d.lat.toFixed(4)+', '+d.lng.toFixed(4))+'</div>'
          +(d.memo?'<div style="color:#475569;font-size:.73rem;margin-top:1px">ğŸ“ '+d.memo+'</div>':'');

        var btns=document.createElement('div'); btns.className='ac-btns';
        var badge=document.createElement('span');
        badge.style.cssText='padding:2px 7px;background:'+(d.isPublic?'rgba(74,222,128,.12)':'rgba(100,100,100,.15)')+';color:'+(d.isPublic?'#4ade80':'#555')+';border-radius:5px;font-size:.7rem;';
        badge.textContent=d.isPublic?'ê³µê°œ':'ë¹„ê³µê°œ';
        btns.appendChild(badge);
        var editBtn=document.createElement('button'); editBtn.className='btn bg';
        editBtn.textContent='âœï¸ ìˆ˜ì •';
        editBtn.onclick=(function(n,idx){return function(){toggleForm(n,idx);};})(name,i);
        btns.appendChild(editBtn);
        var delBtn=document.createElement('button'); delBtn.className='btn br';
        delBtn.textContent='ğŸ—‘ï¸ ì‚­ì œ';
        delBtn.onclick=(function(n){return function(){delApy(n);};})(name);
        btns.appendChild(delBtn);
        head.appendChild(info); head.appendChild(btns);
        card.appendChild(head);

        var mapBtn=document.createElement('button'); mapBtn.className='mapbtn';
        mapBtn.textContent='ğŸ—ºï¸ ì§€ë„ì—ì„œ ë³´ê¸°';
        mapBtn.onclick=(function(n){return function(){focusApy(n);};})(name);
        card.appendChild(mapBtn);

        card.appendChild(buildFormEl(i,name,d));
        el.appendChild(card);
      });
    }
  }

  // ë¯¸ë“±ë¡ë„ ì—†ê³  ë“±ë¡ë„ ì—†ìœ¼ë©´
  if(!unreg.length && !reg.length){
    el.innerHTML='<div style="text-align:center;color:#444;padding:24px;">í™œì„±í™”ëœ ë´‰ì¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
  }
}

function buildFormEl(i, name, d){
  var has=!!(d&&d.lat);
  var form=document.createElement('div');
  form.className='ac-form'; form.id='form-'+i;

  var gpsBtn=document.createElement('button'); gpsBtn.className='fbig fgps';
  gpsBtn.textContent='ğŸ“¡ í˜„ì¬ GPS ìœ„ì¹˜ë¡œ ë“±ë¡';
  gpsBtn.onclick=(function(idx){return function(){gpsToForm(idx);};})(i);
  form.appendChild(gpsBtn);

  var searchRow=document.createElement('div');
  searchRow.style.cssText='display:flex;gap:8px;margin-bottom:10px;';
  var addrInput=document.createElement('input');
  addrInput.id='faddy-'+i; addrInput.className='fi';
  addrInput.style.cssText='flex:1;margin-bottom:0';
  addrInput.placeholder='ì˜ˆ) ìš©ì¸ ë‚¨ì‚¬ì, ì•ˆê³¨ê¸¸ 28-6';
  addrInput.value=has?d.address:'';
  var searchBtn=document.createElement('button'); searchBtn.className='btn bg';
  searchBtn.style.cssText='padding:0 12px;flex-shrink:0';
  searchBtn.textContent='ê²€ìƒ‰';
  searchBtn.onclick=(function(idx){return function(){doSearch(idx);};})(i);
  searchRow.appendChild(addrInput); searchRow.appendChild(searchBtn);
  form.appendChild(searchRow);

  var cbox=document.createElement('div');
  cbox.id='cbox-'+i; cbox.className='cbox'+(has?' on':'');
  cbox.innerHTML='<div id="cba-'+i+'" style="font-weight:700;margin-bottom:2px;color:var(--tx)">'+(has?'ğŸ“ '+(d.address||''):'')+'</div><div style="color:var(--green);font-size:.72rem">âœ… ì¢Œí‘œ í™•ì •ë¨</div>';
  form.appendChild(cbox);

  var memoInput=document.createElement('input');
  memoInput.id='fmemo-'+i; memoInput.className='fi';
  memoInput.placeholder='ğŸ“ ë©”ëª¨ (ì§„ì…ë¡œ ì£¼ì˜, ì•„ê¹Œì‹œ êµ°ë½ì§€ ë“±)';
  memoInput.value=has?d.memo:'';
  form.appendChild(memoInput);

  var pub=!!(d&&d.isPublic);
  var tw=document.createElement('div'); tw.className='tw';
  tw.innerHTML='<span style="flex:1;font-size:.88rem;color:#ccc">ğŸŒ ìœ„ì¹˜ ê³µê°œ</span>'
    +'<div id="tt-'+i+'" onclick="togglePub('+i+')" class="tt" style="background:'+(pub?'#16a34a':'#374151')+'">'
    +'<div id="th-'+i+'" class="th" style="transform:'+(pub?'translateX(22px)':'translateX(0)')+'"></div></div>'
    +'<span id="tl-'+i+'" style="color:'+(pub?'var(--green)':'#555')+';font-size:.8rem;font-weight:700">'+(pub?'ê³µê°œ':'ë¹„ê³µê°œ')+'</span>';
  form.appendChild(tw);

  var saveBtn=document.createElement('button'); saveBtn.className='fbig fsave';
  saveBtn.textContent='ğŸ’¾ ì €ì¥';
  saveBtn.onclick=(function(idx){return function(){saveApy(idx);};})(i);
  form.appendChild(saveBtn);

  var cancelBtn=document.createElement('button'); cancelBtn.className='fbig fcancel';
  cancelBtn.textContent='ì·¨ì†Œ';
  cancelBtn.onclick=(function(idx){return function(){closeForm(idx);};})(i);
  form.appendChild(cancelBtn);

  return form;
}

function toggleForm(name, i){
  var form=document.getElementById('form-'+i);
  var isOpen=form.classList.contains('on');
  if(openForm!==null && openForm!==i){
    var prev=document.getElementById('form-'+openForm);
    if(prev) prev.classList.remove('on');
    if(tpins[openForm]){vmap.removeLayer(tpins[openForm]);delete tpins[openForm];}
  }
  if(isOpen){
    form.classList.remove('on');
    if(tpins[i]){vmap.removeLayer(tpins[i]);delete tpins[i];}
    openForm=null;
  } else {
    var d=AL[name]||{};
    formLat[i]=d.lat||null; formLng[i]=d.lng||null;
    if(d.lat) setTimeout(function(){vmap.setView([d.lat,d.lng],15);},200);
    form.classList.add('on');
    openForm=i;
    setTimeout(function(){form.scrollIntoView({behavior:'smooth',block:'nearest'});},300);
  }
}

function closeForm(i){
  var form=document.getElementById('form-'+i);
  if(form) form.classList.remove('on');
  if(tpins[i]){vmap.removeLayer(tpins[i]);delete tpins[i];}
  if(openForm===i) openForm=null;
}

function updCbox(i){
  var box=document.getElementById('cbox-'+i);
  var bba=document.getElementById('cba-'+i);
  if(!box) return;
  if(formLat[i]){
    box.classList.add('on');
    var addrEl=document.getElementById('faddy-'+i);
    if(bba) bba.textContent='ğŸ“ '+(addrEl?addrEl.value:'');
  } else { box.classList.remove('on'); }
}

function setFCoord(i, lat, lng, label){
  formLat[i]=lat; formLng[i]=lng;
  if(tpins[i]){vmap.removeLayer(tpins[i]);delete tpins[i];}
  tpins[i]=L.marker([lat,lng],{icon:L.divIcon({className:'',
    html:'<div style="font-size:1.8rem;filter:drop-shadow(0 2px 5px rgba(0,0,0,.8))">ğŸ“</div>',
    iconSize:[30,30],iconAnchor:[10,28]}),zIndexOffset:1500}).addTo(vmap);
  vmap.setView([lat,lng],15);
  updCbox(i);
  showToast('ğŸ“ '+label+' ìœ„ì¹˜ ì„ íƒë¨');
}

function gpsToForm(i){
  if(myPos&&myPos.lat){
    setFCoord(i, myPos.lat, myPos.lng, 'í˜„ì¬ GPS (Â±'+myPos.acc+'m)');
    var el=document.getElementById('faddy-'+i);
    if(el) el.value='ì£¼ì†Œ í™•ì¸ ì¤‘...';
    nearAddr(myPos.lat, myPos.lng, function(addr){
      var el2=document.getElementById('faddy-'+i);
      if(el2) el2.value=addr||'';
      updCbox(i);
    });
  } else {
    showToast('ğŸ“¡ GPS ì‹ í˜¸ í™•ì¸ ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”');
    startGPS();
  }
}

function doSearch(i){
  var el=document.getElementById('faddy-'+i);
  var addr=el?el.value.trim():'';
  if(!addr){showToast('âš ï¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');return;}
  showToast('ğŸ” ê²€ìƒ‰ ì¤‘...');
  addrToCoord(addr, function(lat, lng, title){
    if(lat){
      var el2=document.getElementById('faddy-'+i);
      if(el2) el2.value=title||addr;
      setFCoord(i, lat, lng, title||addr);
    } else {
      showToast('âš ï¸ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„ë¡œëª…/ì§€ë²ˆ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
  });
}

function togglePub(i){
  var th=document.getElementById('th-'+i);
  var tt=document.getElementById('tt-'+i);
  var tl=document.getElementById('tl-'+i);
  if(!th) return;
  var on=th.style.transform!=='translateX(22px)';
  th.style.transform=on?'translateX(22px)':'translateX(0)';
  tt.style.background=on?'#16a34a':'#374151';
  tl.textContent=on?'ê³µê°œ':'ë¹„ê³µê°œ';
  tl.style.color=on?'var(--green)':'#555';
}

function saveApy(i){
  var name=NAMES[i];
  if(!formLat[i]){showToast('âš ï¸ GPS ë²„íŠ¼ì´ë‚˜ ì£¼ì†Œ ê²€ìƒ‰ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”');return;}
  var th=document.getElementById('th-'+i);
  var pub=th&&th.style.transform==='translateX(22px)';
  var addrEl=document.getElementById('faddy-'+i);
  var memoEl=document.getElementById('fmemo-'+i);
  AL[name]={
    lat:formLat[i], lng:formLng[i],
    address:addrEl?addrEl.value.trim():'',
    memo:memoEl?memoEl.value.trim():'',
    isPublic:pub, updatedAt:new Date().toISOString()
  };
  if(saveLocs()){
    var lat=formLat[i], lng=formLng[i];
    closeForm(i);
    showToast('âœ… '+name+' ì €ì¥ ì™„ë£Œ!');
    renderAList();
    renderAMks();
    setTimeout(function(){vmap.setView([lat,lng],15);},300);
  }
}

function delApy(name){
  if(!confirm(name+' ìœ„ì¹˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  delete AL[name]; saveLocs();
  showToast('ğŸ—‘ï¸ '+name+' ì‚­ì œ ì™„ë£Œ');
  renderAList(); renderAMks();
}

function popEdit(name){
  vmap.closePopup();
  regListOpen=true;
  renderAList();
  var i=NAMES.indexOf(name);
  if(i<0) return;
  setTimeout(function(){
    toggleForm(name,i);
    var card=document.getElementById('card-'+i);
    if(card) card.scrollIntoView({behavior:'smooth',block:'center'});
  },200);
}

function popDel(name){
  vmap.closePopup();
  delApy(name);
}

function focusApy(name){
  var d=AL[name]; if(!d||!vmap) return;
  vmap.setView([d.lat,d.lng],15);
  window.scrollTo({top:0,behavior:'smooth'});
}

var _tt=null;
function showToast(msg){
  var el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('on');
  if(_tt) clearTimeout(_tt);
  _tt=setTimeout(function(){el.classList.remove('on');},2800);
}

window.addEventListener('load',function(){
  NAMES=getNames();
  renderAList();
  initMap();
});
</script>
</body>
</html>
