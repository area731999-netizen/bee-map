<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Noto+Sans+KR:wght@300;400;600;700;900&display=swap');
        
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body { 
            margin: 0; 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1410 100%); 
            color: #e8e3d8; 
            font-family: 'Noto Sans KR', sans-serif; 
            overflow-x: hidden;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ========== 라이트 모드 (모바일 친화적 색상) ========== */
        body.light-mode {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #212529;
        }

        /* 배경 패턴 */
        body.light-mode::before {
            background: 
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(16, 185, 129, 0.03) 0%, transparent 50%);
        }

        /* 메인 컨테이너 */
        body.light-mode .view-group {
            background: #ffffff;
            color: #212529;
        }

        /* 네비게이션 바 */
        body.light-mode .nav-bar {
            background: #ffffff;
            border-top: 1px solid #e9ecef;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }

        body.light-mode .bottom-nav {
            background: rgba(255,255,255,0.97) !important;
            border-top: 1px solid #dee2e6 !important;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.08) !important;
        }

        body.light-mode .nav-item {
            color: #6c757d !important;
        }
        body.light-mode .nav-item.active {
            color: #4f46e5 !important;
        }
        body.light-mode .nav-item::before {
            background: #4f46e5 !important;
        }

        body.light-mode .nav-item {
            color: #6c757d;
        }

        body.light-mode .nav-item.active {
            color: #4f46e5;
            background: rgba(79, 70, 229, 0.12);
        }

        /* 상단 네비게이션 */
        body.light-mode .top-nav-bar {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        body.light-mode .top-nav-bar .ml-2 {
            color: #ffffff !important;
        }

        body.light-mode .btn-home {
            background: rgba(255,255,255,0.25) !important;
            color: #ffffff !important;
            border: 1px solid rgba(255,255,255,0.5) !important;
        }

        /* 입력 필드 */
        body.light-mode .field {
            background: #ffffff !important;
            color: #212529 !important;
            border: 2px solid #ced4da !important;
            font-weight: 500;
        }

        body.light-mode .field:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
            background: #ffffff !important;
        }

        body.light-mode textarea.field {
            background: #ffffff !important;
            color: #212529 !important;
        }

        /* Select 드롭다운 가독성 개선 */
        body.light-mode select.field {
            background: #ffffff !important;
            color: #212529 !important;
            font-size: 1rem !important;
            font-weight: 600 !important;
            border: 2px solid #ced4da !important;
        }

        body.light-mode select.field option {
            background: #ffffff !important;
            color: #212529 !important;
            padding: 10px !important;
            font-weight: 500 !important;
        }

        body.light-mode select.field:focus {
            background: #ffffff !important;
            border-color: #3b82f6 !important;
        }

        /* Input 필드 */
        body.light-mode input.field {
            background: #ffffff !important;
            color: #212529 !important;
        }

        body.light-mode input.field::placeholder {
            color: #6c757d !important;
            opacity: 0.7;
        }

        /* 버튼 */
        body.light-mode .btn,
        body.light-mode .btn-save {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: #ffffff !important;
            border: none;
            box-shadow: 0 2px 8px rgba(79,70,229,0.25);
        }

        body.light-mode .work-btn {
            background: #ffffff;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        body.light-mode .work-btn:hover {
            background: #f8f9fa;
            border-color: #3b82f6;
        }

        body.light-mode .work-btn.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* 봉장 버튼 */
        body.light-mode .location-btn {
            background: #ffffff;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        body.light-mode .location-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #ffffff;
            border-color: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* 카드 */
        body.light-mode .list-card,
        body.light-mode .record-card {
            background: #ffffff;
            color: #212529;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* 달력 */
        body.light-mode .cal-day {
            background: #ffffff;
            color: #212529;
            border: 1px solid #e9ecef;
        }

        body.light-mode .cal-day:hover {
            background: #f8f9fa;
            border-color: #3b82f6;
        }

        body.light-mode .cal-head {
            color: #6c757d;
            font-weight: 600;
        }

        body.light-mode .today-highlight {
            background: rgba(59, 130, 246, 0.1) !important;
            border: 2px solid #3b82f6 !important;
        }

        /* 배지 */
        body.light-mode .badge {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
        }

        /* 탭 (설정 화면 등) */
        body.light-mode .v-switch .v-btn {
            background: #e0e7ff;
            color: #3730a3 !important;
            border: 2px solid #c7d2fe;
            font-weight: 700;
        }

        body.light-mode .v-switch .v-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: #ffffff !important;
            border-color: #3730a3;
        }

        /* 가계부 탭 */
        body.light-mode .acc-tab {
            background: #e0e7ff !important;
            color: #3730a3 !important;
            border: 2px solid #c7d2fe !important;
            font-weight: 700;
        }

        body.light-mode .acc-tab.active {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%) !important;
            color: #ffffff !important;
            border-color: #3730a3 !important;
        }

        /* 아코디언 */
        body.light-mode .settings-tab > div {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
        }

        /* 설정 탭 내부 섹션 */
        body.light-mode .settings-tab > div > div {
            background: #ffffff !important;
        }

        /* 텍스트 색상 */
        body.light-mode h1, 
        body.light-mode h2, 
        body.light-mode h3, 
        body.light-mode h4,
        body.light-mode .font-bold {
            color: #212529 !important;
        }

        body.light-mode .text-xs,
        body.light-mode .text-sm,
        body.light-mode small {
            color: #6c757d !important;
        }

        /* 라벨 */
        body.light-mode .input-label {
            color: #212529 !important;
            font-weight: 700 !important;
            font-size: 0.95rem !important;
        }

        body.light-mode label {
            color: #495057 !important;
            font-weight: 500;
        }

        /* 모달 */
        body.light-mode #calendar-preview-modal > div,
        body.light-mode #work-selection-area {
            background: #ffffff !important;
            border: 1px solid #dee2e6 !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
        }

        body.light-mode #modal-date-title,
        body.light-mode #work-selection-area h2 {
            color: #4f46e5 !important;
        }

        /* 선택 표시 */
        body.light-mode #selected-works-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        /* 음성 버튼 */
        body.light-mode .voice-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: #ffffff;
        }

        /* 통계 색상 유지 */
        body.light-mode .text-green-500 { color: #10b981 !important; }
        body.light-mode .text-red-500 { color: #ef4444 !important; }
        body.light-mode .text-blue-500 { color: #3b82f6 !important; }
        body.light-mode .text-purple-400 { color: #a78bfa !important; }

        /* 링크/버튼 색상 - inherit 제거로 인라인 스타일 정상 작동 */
        body.light-mode button[onclick="saveUserInfoManual()"],
        body.light-mode button[onclick="saveSettingsAll()"] {
            color: #ffffff !important;
            background: linear-gradient(135deg,#16a34a,#15803d) !important;
            -webkit-text-fill-color: #ffffff !important;
        }

        body.light-mode .dyn-btn {
            opacity: 1;
        }

        /* 필터 버튼 */
        body.light-mode .filter-btn {
            background: #e0e7ff;
            color: #3730a3 !important;
            border: 2px solid #c7d2fe;
            font-weight: 700;
        }

        body.light-mode .filter-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: #ffffff !important;
            border-color: #3730a3;
        }

        /* 특정 색상 오버라이드 */
        body.light-mode [style*="color: #FFB300"],
        body.light-mode [style*="color: #FFD54F"] {
            color: #3b82f6 !important;
        }

        body.light-mode [style*="background: rgba(255,179,0"] {
            background: rgba(59, 130, 246, 0.1) !important;
        }

        body.light-mode [style*="border-color: #FFB300"] {
            border-color: #3b82f6 !important;
        }

        /* ===== 라이트모드 추가 요소들 ===== */

        /* input-row 카드 배경 */
        body.light-mode .input-row {
            background: #ffffff !important;
            border: 1px solid #dee2e6 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
        }
        body.light-mode .input-row:focus-within {
            border-color: #3b82f6 !important;
        }

        /* 작업선택 토글버튼 */
        body.light-mode .toggle-btn {
            background: #f8f9fa !important;
            color: #212529 !important;
            border: 1px solid #dee2e6 !important;
        }
        body.light-mode .toggle-btn:active {
            background: #e9ecef !important;
        }

        /* 봉장 설정 체크박스 아이템 */
        body.light-mode .apiary-toggle-item {
            background: #ffffff !important;
            border: 2px solid #dee2e6 !important;
        }
        body.light-mode .apiary-toggle-item:hover {
            border-color: #3b82f6 !important;
            background: #f0f7ff !important;
        }
        body.light-mode .apiary-toggle-item .apiary-label {
            color: #212529 !important;
        }
        body.light-mode .apiary-toggle-item input[type="checkbox"]:checked + .apiary-label {
            color: #2563eb !important;
        }

        /* 가계부 지출/수입 탭 */
        body.light-mode .mode-tab {
            background: #f1f3f5 !important;
            border: 1px solid #dee2e6 !important;
        }
        body.light-mode .m-tab {
            color: #6c757d !important;
        }

        /* 가계부 카테고리 버튼 */
        body.light-mode .m-cat-btn {
            background: #ffffff !important;
            border: 2px solid #dee2e6 !important;
            color: #495057 !important;
        }
        body.light-mode .m-cat-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            border-color: #2563eb !important;
            color: #ffffff !important;
        }

        /* 서브카테고리 영역 */
        body.light-mode .sub-cat-area {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
        }
        body.light-mode .s-btn {
            background: #e0e7ff !important;
            color: #3730a3 !important;
            border: 2px solid #c7d2fe !important;
            font-weight: 700 !important;
        }
        body.light-mode .s-btn:active {
            background: #e7f0ff !important;
            color: #2563eb !important;
        }

        /* 기간별 내역 탭 */
        body.light-mode .stat-sub-tabs .ss-tab {
            background: #e0e7ff !important;
            border: 1px solid #c7d2fe !important;
            color: #3730a3 !important;
            font-weight: 700 !important;
        }
        body.light-mode .stat-sub-tabs .ss-tab.active {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%) !important;
            color: #ffffff !important;
            border-color: #3730a3 !important;
        }

        /* calendar-grid 배경 */
        body.light-mode .calendar-grid {
            background: #f1f3f5 !important;
            border: 1px solid #dee2e6 !important;
        }

        /* queen-day, disease-alarm-day 라이트모드 */
        body.light-mode .queen-day {
            background: transparent !important;
            border: 2px solid #f43f5e !important;
        }
        body.light-mode .disease-alarm-day {
            background: transparent !important;
            border: 2px solid #8b5cf6 !important;
        }

        /* work-selection 팝업 배경 */
        body.light-mode #work-selection-area {
            background: rgba(255,255,255,0.98) !important;
        }
        body.light-mode .work-grid {
            gap: 10px !important;
        }

        /* 사진촬영/앨범 버튼 */
        body.light-mode label[style*="rgba(255,179,0,0.15)"],
        body.light-mode button[onclick*="openInlineCamera"] {
            background: rgba(59,130,246,0.1) !important;
            color: #2563eb !important;
            border-color: rgba(59,130,246,0.4) !important;
        }
        body.light-mode label[style*="rgba(74,222,128,0.15)"] {
            background: rgba(16,185,129,0.1) !important;
            color: #059669 !important;
            border-color: rgba(16,185,129,0.4) !important;
        }

        /* 방역 버튼(btn-dis) */
        body.light-mode .btn-dis {
            background: #fff0f0 !important;
            border: 2px solid #fca5a5 !important;
            color: #dc2626 !important;
        }

        /* 계산기 섹션 카드 */
        body.light-mode #view-calculator > div[style*="rgba(30,25,20"] {
            background: #ffffff !important;
            border: 1px solid #dee2e6 !important;
        }

        /* 결과 표시 박스 */
        body.light-mode [style*="rgba(139,92,246,0.2)"] {
            background: #f0ebff !important;
            color: #212529 !important;
        }

        /* 가계부 다중 품목 입력 필드 라이트모드 */
        body.light-mode #acc-lines-container input {
            background: #ffffff !important;
            color: #212529 !important;
            border-color: #ced4da !important;
        }
        body.light-mode #acc-lines-container label {
            color: #6c757d !important;
        }
        body.light-mode #acc-lines-container > div {
            background: #f8f9fa !important;
            border-color: #dee2e6 !important;
        }
        body.light-mode #acc-total-display {
            color: #1d4ed8 !important;
        }

        /* 상단 날짜/기온 텍스트 */
        body.light-mode #current-date,
        body.light-mode .top-nav-bar span {
            color: #ffffff !important;
        }

        /* 고대비/테마 토글 버튼 (상단) */
        body.light-mode #theme-toggle-btn,
        body.light-mode button[onclick="toggleHighContrast()"] {
            background: rgba(255,255,255,0.25) !important;
            border-color: rgba(255,255,255,0.6) !important;
            color: #ffffff !important;
        }

        /* record-card 라이트 세부 */
        body.light-mode .record-card {
            border-left-color: #3b82f6 !important;
        }
        body.light-mode .record-card [style*="color: #FFB300"] {
            color: #2563eb !important;
        }
        body.light-mode .record-card [style*="color: #999"],
        body.light-mode .record-card [style*="color: #666"] {
            color: #6c757d !important;
        }
        body.light-mode .record-card [style*="rgba(0,0,0,0.3)"] {
            background: #f8f9fa !important;
        }

        /* 개인일정 카드 */
        body.light-mode .record-card[style*="border-left: 4px solid #c084fc"] {
            border-left-color: #7c3aed !important;
        }

        /* 방역카드 */
        body.light-mode .record-card[style*="border-left: 4px solid #ef4444"] {
            border-left-color: #dc2626 !important;
        }
        body.light-mode .record-card [style*="rgba(0,0,0,0.2)"] {
            background: #f1f3f5 !important;
        }

        /* toast */
        body.light-mode .toast {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
        }

        /* 오늘의 추천작업 */
        body.light-mode #today-work-suggestion > div {
            background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(37,99,235,0.07) 100%) !important;
            border: 2px solid rgba(59,130,246,0.25) !important;
        }
        body.light-mode #today-work-list {
            color: #374151 !important;
        }

        /* 스플래시 화면은 항상 다크 유지 */
        body.light-mode #splash {
            background: linear-gradient(135deg, #FFB300 0%, #FF8F00 100%) !important;
        }

        /* ========== 모바일 터치 최적화 ========== */
        /* 최소 터치 타겟 크기: 44x44px */
        
        /* 수정/삭제 버튼 크기 증가 */
        .dyn-btn {
            min-width: 60px;
            min-height: 44px;
            padding: 10px 16px !important;
            font-size: 0.875rem !important;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700 !important;
        }
        /* 삭제 버튼 공통 강화 */
        .dyn-btn[data-action*="delete"],
        .dyn-btn[data-action*="Delete"] {
            background: #dc2626 !important;
            color: #ffffff !important;
            letter-spacing: 0.5px;
        }

        /* 사진 삭제 버튼 크기 증가 */
        button[onclick^="removeDiaryPhoto"],
        button[onclick^="removeDiseasePhoto"] {
            width: 36px !important;
            height: 36px !important;
            font-size: 18px !important;
            line-height: 36px !important;
            top: 2px !important;
            right: 2px !important;
        }

        /* 모달 닫기 버튼 크기 증가 */
        button[onclick="closePreviewModal"],
        button[onclick="closePhotoModal"] {
            min-width: 44px !important;
            min-height: 44px !important;
            font-size: 1.4rem !important;
            line-height: 44px !important;
        }

        /* 체크박스와 라벨 터치 영역 증가 */
        input[type="checkbox"],
        input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        label {
            cursor: pointer;
            min-height: 44px;
            display: flex;
            align-items: center;
            padding: 8px 0;
        }

        /* 아코디언 헤더 터치 영역 */
        [onclick*="toggleSettingAccordion"],
        [onclick*="toggleAccordion"] {
            min-height: 54px !important;
            padding: 16px 18px !important;
        }

        /* 작은 텍스트 크기 증가 */
        .text-xs {
            font-size: 0.8125rem !important; /* 13px */
        }

        .text-sm {
            font-size: 0.875rem !important; /* 14px */
        }

        /* 달력 날짜 최소 크기 */
        .cal-day {
            min-height: 0 !important;
            min-width: 0 !important;
        }

        /* 오늘 표시 크기 증가 */
        .cal-day [style*="font-size: 0.6rem"] {
            font-size: 0.7rem !important;
            padding: 3px 8px !important;
        }

        /* 봉장 버튼 최소 크기 */
        .location-btn {
            min-height: 75px !important;
            min-width: 75px !important;
            padding: 14px 10px !important;
        }

        /* 네비게이션 아이콘 터치 영역 */
        .nav-item {
            min-width: 60px;
            min-height: 60px;
            padding: 8px !important;
        }

        /* 버튼 간 간격 */
        .space-y-4 > * + * {
            margin-top: 1.25rem !important;
        }

        button + button {
            margin-left: 10px;
        }

        /* Select 드롭다운 터치 영역 */
        select.field {
            min-height: 48px;
            padding: 12px 14px;
            font-size: 1rem;
        }

        /* 음성 버튼 크기 */
        .voice-btn {
            min-width: 80px !important;
            min-height: 44px !important;
            padding: 10px 16px !important;
        }

        /* 필터 버튼 크기 */
        .filter-btn {
            min-height: 44px !important;
            padding: 12px 20px !important;
        }

        /* 탭 버튼 크기 */
        .v-btn,
        .acc-tab {
            min-height: 48px !important;
            padding: 12px 20px !important;
        }

        /* 고대비 버튼 크기 */
        button[onclick="toggleHighContrast"] {
            min-height: 40px !important;
            padding: 8px 14px !important;
            font-size: 0.8rem !important;
        }

        /* 작업 선택 완료 버튼 */
        button[onclick="closeWorkSelection"] {
            min-height: 56px !important;
            font-size: 1.1rem !important;
        }

        /* 설정 버튼들 */
        .btn-save,
        button[onclick*="backupData"],
        button[onclick*="executeReset"],
        button[onclick*="export"] {
            min-height: 52px !important;
            padding: 14px 20px !important;
            font-size: 1rem !important;
        }

        /* 입력 필드 터치 영역 */
        input[type="text"].field,
        input[type="number"].field,
        input[type="date"].field,
        input[type="time"].field {
            min-height: 48px;
            padding: 12px 14px;
            font-size: 1rem;
        }

        textarea.field {
            min-height: 120px;
            padding: 12px 14px;
            font-size: 1rem;
        }

        /* 배지 크기 */
        .badge {
            padding: 6px 12px !important;
            font-size: 0.875rem !important;
        }

        /* 일정/방역 카드 버튼 간격 */
        .record-card button,
        .list-card button {
            margin: 4px;
        }

        /* 배경 벌집 패턴 */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 213, 79, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(141, 78, 42, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* 스플래시 화면 */
        #splash { 
            position: fixed; 
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            min-width: 100vw;
            min-height: 100vh;
            background: linear-gradient(135deg, #FFB300 0%, #FF8F00 100%);
            z-index: 20000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            overflow: hidden;
        }

        #splash::before {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            border-radius: 50%;
            top: -150px;
            right: -150px;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-30px, 30px) scale(1.1); }
        }

        .bee-fly { 
            font-size: 85px; 
            animation: fly 2s infinite alternate ease-in-out; 
            margin-bottom: 30px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            z-index: 2;
        }
        
        @keyframes fly { 
            0% { transform: translate(0,0) rotate(-8deg); } 
            50% { transform: translate(20px,-30px) rotate(0deg); }
            100% { transform: translate(40px,-60px) rotate(8deg); } 
        }
        
        .logo-text { 
            font-size: 3.8rem; 
            font-weight: 900; 
            color: #1a0800; 
            font-family: 'Gowun Batang', serif;
            letter-spacing: -3px; 
            margin-bottom: 1rem;
            text-shadow: 2px 2px 0 rgba(255,255,255,0.3), 4px 4px 20px rgba(0,0,0,0.2);
            z-index: 2;
        }

        .subtitle {
            font-size: 1rem;
            color: rgba(26, 8, 0, 0.7);
            font-weight: 600;
            margin-bottom: 3rem;
            z-index: 2;
        }
       
        .choice-btn-container { 
            display: flex; 
            gap: 2rem; 
            padding: 0 2rem; 
            width: 100%; 
            max-width: 500px;
            z-index: 2;
        }
        
        .choice-btn { 
            flex: 1; 
            height: 180px; 
            border-radius: 2rem; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-weight: 900; 
            font-size: 1.6rem; 
            border: 4px solid; 
            background: #fff; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .choice-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.4) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .choice-btn:active::before {
            opacity: 1;
        }

        .choice-btn:active {
            transform: scale(0.95);
        }
        
        .btn-apiculture { 
            border-color: #E65100; 
            color: #E65100; 
        }
        
        .btn-oriental { 
            border-color: #4E342E; 
            color: #4E342E; 
        }

        .choice-btn span:first-child {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .hidden { display: none !important; }

        /* 상단 네비게이션 */
        .top-nav-bar { 
            padding: 16px 20px; 
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            border-bottom: 1px solid rgba(255,213,79,0.2); 
            position: sticky; 
            top: 0; 
            z-index: 6000;
        }
        
        .btn-home { 
            background: linear-gradient(135deg, #FFD54F 0%, #FFB300 100%); 
            color: #1a0800; 
            padding: 8px 16px; 
            border-radius: 12px; 
            font-size: 13px; 
            font-weight: 800; 
            border: none;
            box-shadow: 0 4px 12px rgba(255,213,79,0.3);
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-home:active {
            transform: translateY(2px);
            box-shadow: 0 2px 6px rgba(255,213,79,0.3);
        }
       
        /* 뷰 컨테이너 */
        .view-group { 
            min-height: calc(100vh - 180px);
            overflow-y: visible;
            padding: 20px; 
            display: none; 
            animation: fadeIn 0.3s ease-out;
        }
        
        .view-active { 
            display: block !important; 
        }
#view-map.view-active {
            display: flex !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 입력 필드 */
        .input-row { 
            background: linear-gradient(135deg, rgba(30,25,20,0.7) 0%, rgba(20,15,10,0.5) 100%);
            border-radius: 14px; 
            padding: 16px; 
            margin-bottom: 12px; 
            border: 1px solid rgba(255,213,79,0.15);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            transition: border 0.3s;
        }

        .input-row:focus-within {
            border-color: rgba(255,213,79,0.4);
        }
        
        .input-label { 
            color: #FFD54F; 
            font-weight: 700; 
            font-size: 0.95rem; 
            margin-bottom: 12px; 
            display: block;
            letter-spacing: -0.5px;
        }
        
        .field { 
            background: rgba(20,15,10,0.8) !important; 
            color: #e8e3d8 !important; 
            width: 100%; 
            border: 1px solid rgba(141,78,42,0.3); 
            padding: 14px; 
            border-radius: 10px; 
            font-size: 1rem; 
            outline: none;
            transition: all 0.2s;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .field:focus {
            border-color: #FFB300;
            box-shadow: 0 0 0 3px rgba(255,179,0,0.1);
        }

        .location-btn {
            padding: 12px 8px;
            border: 2px solid rgba(141,78,42,0.4);
            border-radius: 10px;
            background: rgba(40,30,25,0.8);
            color: #999;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .location-btn:active {
            transform: scale(0.95);
        }

        .location-btn.active {
            border-color: #FFB300;
            background: linear-gradient(135deg, rgba(255,179,0,0.3) 0%, rgba(141,78,42,0.2) 100%);
            color: #FFD54F;
            box-shadow: 0 0 20px rgba(255,179,0,0.3);
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid rgba(141,78,42,0.4);
            border-radius: 20px;
            background: rgba(40,30,25,0.6);
            color: #999;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .filter-btn.active {
            border-color: #FFB300;
            background: rgba(255,179,0,0.2);
            color: #FFD54F;
        }

        .voice-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,179,0,0.2);
            border: 1px solid #FFB300;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-btn:active {
            background: rgba(255,179,0,0.4);
        }

        .voice-btn.recording {
            background: rgba(239,68,68,0.3);
            border-color: #ef4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 고대비 모드 */
        body.high-contrast {
            filter: contrast(1.5) brightness(1.2);
        }

        body.high-contrast .field,
        body.high-contrast .location-btn,
        body.high-contrast .filter-btn {
            border-width: 3px;
            font-weight: 700;
        }

        body.high-contrast .cal-day {
            border-width: 3px;
            font-weight: 900;
        }

        /* 봉장 토글 스타일 */
        .apiary-toggle-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(40,30,25,0.8);
            border: 2px solid rgba(141,78,42,0.4);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .apiary-toggle-item:hover {
            border-color: #FFB300;
            background: rgba(40,30,25,0.95);
        }

        .apiary-toggle-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #FFB300;
        }

        .apiary-toggle-item .apiary-label {
            font-size: 1rem;
            color: #e8e3d8;
            font-weight: 600;
            flex: 1;
        }

        .apiary-toggle-item input[type="checkbox"]:checked + .apiary-label {
            color: #FFD54F;
        }

        .field::placeholder {
            color: rgba(232,227,216,0.4);
        }
       
        /* 토글 버튼 */
        .toggle-btn { 
            background: linear-gradient(135deg, rgba(40,30,25,0.8) 0%, rgba(30,20,15,0.6) 100%); 
            color: #FFD54F; 
            padding: 18px; 
            border-radius: 14px; 
            width: 100%; 
            font-weight: 700; 
            text-align: left; 
            display: flex; 
            justify-content: space-between; 
            border: 1px solid rgba(141,78,42,0.4);
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn:active {
            transform: scale(0.98);
            background: linear-gradient(135deg, rgba(50,40,35,0.9) 0%, rgba(40,30,25,0.7) 100%);
        }

        /* 작업 선택 팝업 */
        #work-selection-area { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(5px);
            z-index: 10000; 
            padding: 20px 20px 40px;
            flex-direction: column; 
            justify-content: flex-start;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .work-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .work-btn { 
            background: linear-gradient(135deg, rgba(40,30,25,0.6) 0%, rgba(30,20,15,0.4) 100%); 
            border: 2px solid rgba(141,78,42,0.4); 
            padding: 24px 8px; 
            border-radius: 16px; 
            text-align: center; 
            font-size: 1.05rem; 
            color: #c4b8a8;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-weight: 700;
        }
        
        .work-btn.selected { 
            background: linear-gradient(135deg, #A0522D 0%, #8D4E2A 100%); 
            color: white; 
            border-color: #FFD54F; 
            font-weight: 800;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(141,78,42,0.4);
        }

        /* 저장 버튼 */
        .btn-dis { 
            background: linear-gradient(135deg, rgba(30,10,10,0.8) 0%, rgba(20,5,5,0.6) 100%); 
            border: 2px solid rgba(239,68,68,0.4); 
            color: #ef4444; 
            padding: 20px; 
            border-radius: 14px; 
            font-weight: 700; 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-dis:active {
            transform: scale(0.98);
        }
        
        .btn-save { 
            background: linear-gradient(135deg, #A0522D 0%, #8D4E2A 100%); 
            color: white; 
            padding: 22px; 
            border-radius: 16px; 
            font-weight: 900; 
            font-size: 1.4rem; 
            width: 100%; 
            border: none;
            box-shadow: 0 8px 24px rgba(141,78,42,0.5), inset 0 -4px 0 rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: -0.5px;
        }

        .btn-save:active {
            transform: translateY(2px);
            box-shadow: 0 4px 12px rgba(141,78,42,0.4), inset 0 -2px 0 rgba(0,0,0,0.2);
        }

        /* 일지 저장 버튼 - 따뜻한 황금빛 */
        .btn-diary-save {
            background: linear-gradient(135deg, #b45309 0%, #92400e 100%);
            box-shadow: 0 8px 24px rgba(180,83,9,0.5), inset 0 -4px 0 rgba(0,0,0,0.2);
            border: 2px solid rgba(251,191,36,0.3);
            color: #fef3c7;
        }
        .btn-diary-save:active {
            box-shadow: 0 4px 12px rgba(180,83,9,0.4), inset 0 -2px 0 rgba(0,0,0,0.2);
        }

        /* 방역 저장 버튼 - 선명한 붉은색 */
        .btn-disease-save {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 0 8px 24px rgba(220,38,38,0.5), inset 0 -4px 0 rgba(0,0,0,0.2);
            border: 2px solid rgba(252,165,165,0.25);
            color: #fee2e2;
        }
        .btn-disease-save:active {
            box-shadow: 0 4px 12px rgba(220,38,38,0.4), inset 0 -2px 0 rgba(0,0,0,0.2);
        }

        /* 달력 */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 3px; 
            background: rgba(30,25,20,0.4); 
            padding: 8px; 
            border-radius: 16px;
            border: 1px solid rgba(141,78,42,0.2);
            overflow: hidden;
        }
        
        .cal-day { 
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(26,20,15,0.8) 0%, rgba(20,15,10,0.6) 100%); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            border-radius: 8px; 
            cursor: pointer; 
            position: relative;
            border: 1px solid transparent;
            transition: all 0.2s;
            padding: 4px 2px;
            font-size: 1rem;
            overflow: hidden;
        }

        .cal-day:active {
            transform: scale(0.95);
        }
        
        .solar-term {
            font-size: 0.6rem;
            color: #ffffff;
            font-weight: 900;
            background: #16a34a;
            padding: 1px 5px;
            border-radius: 6px;
            white-space: nowrap;
            display: block;
            margin-bottom: 1px;
            line-height: 1.4;
        }
        
        .today-highlight {
            background: linear-gradient(135deg, rgba(255,179,0,0.3) 0%, rgba(141,78,42,0.2) 100%) !important;
            border: 2px solid #FFB300 !important;
            box-shadow: 0 0 20px rgba(255,179,0,0.3);
        }
        
        .cal-head { 
            color: #FFB300; 
            font-weight: 900; 
            text-align: center; 
            font-size: 1rem; 
            padding: 12px 0;
            background: rgba(255,179,0,0.1);
            border-radius: 8px;
        }
        
        .queen-day { 
            background: transparent !important; 
            border: 2px solid #ef4444 !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); }
            50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
        }
        
        .queen-text { 
            color: #ff6b6b; 
            font-size: 11px; 
            font-weight: 900;
            margin-top: 4px;
            text-shadow: 0 0 10px rgba(255,107,107,0.5);
        }

        .disease-alarm-day {
            background: transparent !important;
            border: 2px solid #a78bfa !important;
        }

        .disease-alarm-text {
            color: #c4b5fd;
            font-size: 11px;
            font-weight: 900;
            margin-top: 4px;
            text-shadow: 0 0 10px rgba(196,181,253,0.5);
        }

        .cal-day.border-amber-600 {
            border-color: #FFB300 !important;
            background: linear-gradient(135deg, rgba(160,82,45,0.3) 0%, rgba(141,78,42,0.2) 100%) !important;
        }

        .cal-day.border-green-400 {
            border-color: #4ade80 !important;
            background: linear-gradient(135deg, rgba(74,222,128,0.2) 0%, rgba(34,197,94,0.15) 100%) !important;
        }

        .cal-day.border-purple-400 {
            border-color: #c084fc !important;
            background: linear-gradient(135deg, rgba(192,132,252,0.2) 0%, rgba(167,139,250,0.15) 100%) !important;
        }
       
        /* 가계부 스타일 */
        .v-switch { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px;
            background: rgba(30,25,20,0.6);
            padding: 6px;
            border-radius: 14px;
            border: 1px solid rgba(141,78,42,0.2);
        }
        
        .v-btn { 
            flex: 1; 
            padding: 14px; 
            background: transparent; 
            border: none; 
            border-radius: 10px; 
            color: #777; 
            text-align: center; 
            font-size: 16px; 
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
        }
        
        .v-btn.active { 
            background: linear-gradient(135deg, #A0522D 0%, #8D4E2A 100%); 
            color: #FFD54F; 
            font-weight: 800;
            box-shadow: 0 4px 12px rgba(141,78,42,0.3);
        }
        
        .mode-tab { 
            display: flex; 
            background: rgba(30,25,20,0.7); 
            border-radius: 14px; 
            margin-bottom: 20px; 
            border: 1px solid rgba(141,78,42,0.2); 
            overflow: hidden;
            padding: 4px;
            transition: background 0.35s, border-color 0.35s;
        }

        /* 지출 모드일 때 컨테이너 */
        .mode-tab.mode-out {
            background: rgba(120,30,20,0.25);
            border-color: rgba(239,68,68,0.35);
        }

        /* 수입 모드일 때 컨테이너 */
        .mode-tab.mode-in {
            background: rgba(20,90,30,0.25);
            border-color: rgba(74,222,128,0.35);
        }
        
        .m-tab { 
            flex: 1; 
            text-align: center; 
            padding: 14px; 
            color: #666; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 700;
            border-radius: 10px;
            transition: all 0.25s;
            touch-action: manipulation;
        }

        /* 비활성 지출 탭 - 연한 붉은 힌트 */
        .tab-out:not(.active) {
            color: rgba(248,113,113,0.55);
        }

        /* 비활성 수입 탭 - 연한 초록 힌트 */
        .tab-in:not(.active) {
            color: rgba(74,222,128,0.55);
        }
        
        .tab-out.active { 
            background: linear-gradient(135deg, #b91c1c 0%, #9a3412 100%); 
            color: #fff;
            box-shadow: 0 4px 16px rgba(185,28,28,0.45);
            font-size: 1.05rem;
        }
        
        .tab-in.active { 
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); 
            color: #fff;
            box-shadow: 0 4px 16px rgba(22,163,74,0.45);
            font-size: 1.05rem;
        }
        
        .cat-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        
        .m-cat-btn { 
            background: linear-gradient(135deg, rgba(30,25,20,0.7) 0%, rgba(20,15,10,0.5) 100%); 
            border: 2px solid rgba(141,78,42,0.3); 
            color: #999; 
            padding: 16px 8px; 
            border-radius: 12px; 
            text-align: center; 
            font-size: 15px; 
            cursor: pointer;
            transition: all 0.15s;
            font-weight: 700;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .m-cat-btn.active { 
            border-color: #FFB300; 
            color: #fff; 
            background: linear-gradient(135deg, rgba(160,82,45,0.5) 0%, rgba(141,78,42,0.4) 100%);
            transform: scale(1.05);
        }

        /* 지출 모드에서 대분류 활성 */
        .mode-out ~ * .m-cat-btn.active,
        .mode-out + div .m-cat-btn.active {
            border-color: #f87171;
            background: linear-gradient(135deg, rgba(185,28,28,0.4) 0%, rgba(153,27,27,0.35) 100%);
        }

        /* 수입 모드에서 대분류 활성 */
        .mode-in ~ * .m-cat-btn.active,
        .mode-in + div .m-cat-btn.active {
            border-color: #4ade80;
            background: linear-gradient(135deg, rgba(22,163,74,0.4) 0%, rgba(15,118,55,0.35) 100%);
        }
        
        .sub-cat-area { 
            background: rgba(30,25,20,0.5); 
            border-radius: 14px; 
            padding: 16px; 
            margin-bottom: 20px; 
            border: 1px solid rgba(141,78,42,0.2); 
            display: none;
        }
        
        .sub-grid { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
        }
        
        .s-btn { 
            background: rgba(40,30,25,0.6); 
            border: 1px solid rgba(141,78,42,0.3); 
            color: #d4c8b8; 
            padding: 10px 16px; 
            border-radius: 20px; 
            font-size: 15px; 
            cursor: pointer;
            transition: background 0.1s, color 0.1s, border-color 0.1s;
            font-weight: 600;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .s-btn:active {
            background: rgba(160,82,45,0.5);
            color: #FFD54F;
            transform: scale(0.97);
        }
        
        .s-btn.selected {
            background: rgba(255,179,0,0.3);
            border-color: #FFB300;
            color: #FFD54F;
            font-weight: 700;
        }
        
        .stat-sub-tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px; 
        }
        
        .ss-tab { 
            flex: 1; 
            padding: 12px; 
            font-size: 12px; 
            background: rgba(30,25,20,0.7); 
            border-radius: 10px; 
            text-align: center; 
            color: #666; 
            cursor: pointer;
            border: 1px solid rgba(141,78,42,0.2);
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .ss-tab.active { 
            background: linear-gradient(135deg, rgba(160,82,45,0.5) 0%, rgba(141,78,42,0.4) 100%); 
            color: #FFD54F; 
            border-color: rgba(255,179,0,0.4);
            font-weight: 700;
        }
        
        .list-card { 
            background: linear-gradient(135deg, rgba(30,25,20,0.8) 0%, rgba(20,15,10,0.6) 100%); 
            border-radius: 14px; 
            margin-bottom: 12px; 
            padding: 18px; 
            border-left: 4px solid rgba(141,78,42,0.5); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* 하단 네비게이션 */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            height: 85px; 
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,213,79,0.2); 
            display: flex; 
            z-index: 5000; 
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }
        
        .nav-item { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 13px; 
            color: #666; 
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 700;
            position: relative;
            gap: 2px;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: #FFB300;
            transition: width 0.3s;
            border-radius: 0 0 3px 3px;
        }

        .nav-item.active::before {
            width: 60%;
        }
        
        .nav-item.active { 
            color: #FFD54F; 
            font-weight: 900;
            background: rgba(255,179,0,0.12);
            border-radius: 10px;
        }

        .nav-item:active {
            transform: scale(0.95);
        }
        
        .badge { 
            background: linear-gradient(135deg, #A0522D 0%, #8D4E2A 100%); 
            color: white; 
            padding: 6px 14px; 
            border-radius: 18px; 
            font-size: 0.8rem; 
            font-weight: 700; 
            border: 1px solid rgba(255,213,79,0.3); 
            margin: 4px;
            box-shadow: 0 2px 8px rgba(141,78,42,0.3);
            display: inline-block;
        }

        /* 스크롤바 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(20,15,10,0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(141,78,42,0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(141,78,42,0.7);
        }

        /* 기록 카드 */
        .record-card {
            background: linear-gradient(135deg, rgba(26,20,15,0.9) 0%, rgba(20,15,10,0.7) 100%);
            padding: 24px;
            border-radius: 18px;
            border-left: 5px solid #FFB300;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            margin-bottom: 16px;
        }

        .queen-alert {
            background: linear-gradient(135deg, rgba(127,29,29,0.8) 0%, rgba(69,10,10,0.6) 100%);
            padding: 20px;
            border-radius: 16px;
            border: 3px solid #ef4444;
            font-weight: 900;
            text-align: center;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(239,68,68,0.4);
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 8px 24px rgba(239,68,68,0.4); }
            50% { box-shadow: 0 8px 32px rgba(239,68,68,0.7); }
        }

        /* 로딩 애니메이션 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,213,79,0.3);
            border-radius: 50%;
            border-top-color: #FFD54F;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 토스트 알림 */
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: linear-gradient(135deg, #A0522D 0%, #8D4E2A 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 15000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-weight: 700;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 모바일 최적화 */
        @media (max-width: 400px) {
            .logo-text { font-size: 3rem; }
            .choice-btn { height: 150px; font-size: 1.4rem; }
            .work-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
            /* 달력 연월 제목 */
        body.light-mode #cal-title,
        body.light-mode #acc-cal-title {
            color: #1d4ed8 !important;
        }
        /* 달력 그리드 헤더 (일월화수목금토) */
        body.light-mode .cal-head {
            color: #374151 !important;
            background: rgba(59,130,246,0.08) !important;
            font-weight: 700 !important;
        }
        /* 가계부 달력 헤드 */
        body.light-mode #view-account .cal-head {
            color: #065f46 !important;
            background: rgba(16,185,129,0.08) !important;
        }
        /* 위치필터 버튼 */
        body.light-mode .filter-btn {
            background: #ffffff !important;
            color: #374151 !important;
            border: 2px solid #dee2e6 !important;
        }
        body.light-mode .filter-btn.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: #fff !important;
            border-color: #2563eb !important;
        }
        /* 오늘의 추천 섹션 아이콘 텍스트 */
        body.light-mode #today-work-suggestion [style*="color: #FFD54F"] {
            color: #1d4ed8 !important;
        }
        /* 방역 기록 없음 텍스트 */
        body.light-mode #history-list-view p {
            color: #9ca3af !important;
        }
        /* record-list 날짜 제목 */
        body.light-mode #record-list h4 {
            color: #1d4ed8 !important;
        }
        /* 개인일정 제목 */
        body.light-mode #record-list h5 {
            color: #7c3aed !important;
        }
        /* 아코디언 화살표 */
        body.light-mode [id^="acc-arrow-"] {
            color: #2563eb !important;
        }
        /* 설정 아코디언 헤더 */
        body.light-mode [onclick^="toggleSettingAccordion"] span:first-child {
            color: #1d4ed8 !important;
        }

        /* 라이트모드 설정 화면 배경 및 텍스트 가독성 */
        body.light-mode .settings-tab [style*="rgba(30,25,20"] {
            background: #f1f3f5 !important;
            border: 1px solid #dee2e6 !important;
        }
        body.light-mode .settings-tab [style*="rgba(30,25,20"] span,
        body.light-mode .settings-tab [style*="rgba(30,25,20"] div,
        body.light-mode .settings-tab [style*="rgba(30,25,20"] p,
        body.light-mode .settings-tab [style*="rgba(30,25,20"] label {
            color: #212529 !important;
        }
        body.light-mode .settings-tab [style*="color: #FFD54F"],
        body.light-mode .settings-tab [style*="color: #FFB300"],
        body.light-mode .settings-tab [style*="color: #999"],
        body.light-mode .settings-tab [style*="color: #666"],
        body.light-mode .settings-tab [style*="color: #aaa"] {
            color: #495057 !important;
        }
        body.light-mode .settings-tab [id^="acc-arrow-"] {
            color: #495057 !important;
        }
        body.light-mode .settings-tab [style*="border-top: 1px solid rgba(255"] {
            border-top-color: #dee2e6 !important;
        }
        /* 설정 화면 전체 - 다크 스타일 인라인 오버라이드 */
        body.light-mode #settings-basic [style*="background"]:not(button),
        body.light-mode #settings-custom [style*="background"]:not(button),
        body.light-mode #settings-apiary [style*="background"]:not(button),
        body.light-mode #settings-data [style*="background"]:not(button) {
            background: #f8f9fa !important;
        }
        body.light-mode #settings-basic span[style*="color"],
        body.light-mode #settings-basic div[style*="color"],
        body.light-mode #settings-basic p[style*="color"],
        body.light-mode #settings-custom span[style*="color"],
        body.light-mode #settings-custom div[style*="color"],
        body.light-mode #settings-custom p[style*="color"],
        body.light-mode #settings-apiary span[style*="color"],
        body.light-mode #settings-apiary div[style*="color"],
        body.light-mode #settings-data span[style*="color"],
        body.light-mode #settings-data div[style*="color"],
        body.light-mode #settings-data p[style*="color"] {
            color: #212529 !important;
        }
        body.light-mode button[style*="rgba(100,100,100"] {
            background: rgba(100,100,100,0.15) !important;
            color: #495057 !important;
        }
        body.light-mode button[style*="rgba(185,28,28"] {
            background: rgba(220,53,69,0.15) !important;
            color: #dc3545 !important;
        }

        /* ========== 라이트모드 전체 가독성 보완 ========== */

        /* ── 지도 뷰 ── */
        body.light-mode #hdr {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
            border-bottom: 2px solid rgba(255,255,255,0.2) !important;
        }
        body.light-mode #hdr h1 { color: #ffffff !important; }
        body.light-mode #gst { color: rgba(255,255,255,0.8) !important; }
        body.light-mode #panel {
            background: #f8fafc !important;
        }
        body.light-mode #legend { color: #374151 !important; font-weight: 700 !important; }
        body.light-mode .ac {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
        }
        body.light-mode .ac-head { background: #ffffff !important; }
        body.light-mode .ac-form {
            background: #f1f5f9 !important;
            border-top: 2px solid #e2e8f0 !important;
        }
        body.light-mode .mtype {
            background: #e0e7ff !important;
            color: #3730a3 !important;
            border: 1px solid #c7d2fe !important;
            font-weight: 700 !important;
        }
        body.light-mode .mtype.on {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%) !important;
            color: #ffffff !important;
            border-color: #3730a3 !important;
        }
        body.light-mode .flt {
            background: #e0e7ff !important;
            color: #3730a3 !important;
            border: 1px solid #c7d2fe !important;
            font-weight: 700 !important;
        }
        body.light-mode .flt.on {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%) !important;
            color: #ffffff !important;
            border-color: #3730a3 !important;
        }
        body.light-mode .icob {
            background: rgba(255,255,255,0.95) !important;
            border-color: #d1d5db !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2) !important;
        }
        body.light-mode .mapbtn {
            background: #f0f7ff !important;
            color: #2563eb !important;
            border-top: 1px solid #e2e8f0 !important;
        }
        body.light-mode .fi {
            background: #ffffff !important;
            color: #212529 !important;
            border: 1px solid #d1d5db !important;
        }
        body.light-mode .fi::placeholder { color: #9ca3af !important; }
        body.light-mode .fi:focus { border-color: #2563eb !important; background: #ffffff !important; }
        body.light-mode .fbig.fsave { background: #16a34a !important; color: #ffffff !important; }
        body.light-mode .fbig.fgps { background: #dbeafe !important; color: #1d4ed8 !important; border: 1px solid #93c5fd !important; }
        body.light-mode .fbig.fcancel { background: #f1f5f9 !important; color: #6b7280 !important; }
        body.light-mode .bg { background: #e0e7ff !important; color: #3730a3 !important; }
        body.light-mode .br { background: #fee2e2 !important; color: #dc2626 !important; }
        body.light-mode #locbar { background: #f0f7ff !important; border-top: 1px solid #93c5fd !important; }
        body.light-mode #laddr { color: #1e3a5f !important; }
        body.light-mode #lcoord { color: #6b7280 !important; }
        body.light-mode .ac-btns .btn { background: #f1f5f9 !important; }

        /* ── 전체 인라인 다크 배경 오버라이드 ── */
        body.light-mode [style*="rgba(30,25,20"] {
            background: #ffffff !important;
            border-color: #e2e8f0 !important;
            color: #212529 !important;
        }
        body.light-mode [style*="rgba(26,18,10"] {
            background: #f8fafc !important;
            border-color: #e2e8f0 !important;
        }
        body.light-mode [style*="rgba(20,15,10"] {
            background: #f8fafc !important;
        }
        body.light-mode [style*="background: rgba(0,0,0,0."] {
            background: #f1f5f9 !important;
        }
        body.light-mode [style*="background:rgba(0,0,0"] {
            background: #f1f5f9 !important;
        }

        /* ── 텍스트 색상 전반 ── */
        body.light-mode [style*="color: #FFD54F"]:not(.top-nav-bar *):not(#hdr *) { color: #b45309 !important; }
        body.light-mode [style*="color: #FFB300"]:not(.top-nav-bar *):not(#hdr *) { color: #b45309 !important; }
        body.light-mode [style*="color: #e8e3d8"] { color: #212529 !important; }
        body.light-mode [style*="color: #aaa"] { color: #6b7280 !important; }
        body.light-mode [style*="color: #888"] { color: #6b7280 !important; }
        body.light-mode [style*="color: #999"] { color: #6b7280 !important; }
        body.light-mode [style*="color: #666"] { color: #6b7280 !important; }
        body.light-mode [style*="color: #555"] { color: #6b7280 !important; }
        body.light-mode [style*="color: #444"] { color: #4b5563 !important; }
        body.light-mode [style*="color: #777"] { color: #374151 !important; }
        body.light-mode [style*="color: #ffffff"]:not(.top-nav-bar *):not(#hdr *):not(.btn-dis):not(.flt.on):not(.mtype.on):not(.choice-btn) { color: #ffffff; }

        /* ── 카드/목록 배경 ── */
        body.light-mode .list-card,
        body.light-mode .record-card,
        body.light-mode [style*="border-radius: 16px"][style*="rgba"],
        body.light-mode [style*="border-radius: 14px"][style*="rgba"],
        body.light-mode [style*="border-radius: 12px"][style*="rgba(30"],
        body.light-mode [style*="border-radius: 12px"][style*="rgba(26"] {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            color: #212529 !important;
        }

        /* ── 탭/스위치 ── */
        body.light-mode .v-btn:not(.active) {
            background: #e0e7ff !important;
            color: #3730a3 !important;
            border: 1px solid #c7d2fe !important;
            font-weight: 700 !important;
        }
        body.light-mode .v-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%) !important;
            color: #ffffff !important;
        }
        body.light-mode .acc-tab:not(.active) {
            background: #f1f5f9 !important;
            color: #374151 !important;
        }

        /* ── 통계/차트 섹션 ── */
        body.light-mode .stat-card,
        body.light-mode [style*="background: rgba(30,25,20,0.7)"],
        body.light-mode [style*="background: rgba(30,25,20,.7)"] {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
        }

        /* ── 가계부 ── */
        body.light-mode #acc-total-display {
            background: #f0fdf4 !important;
            border: 1px solid #86efac !important;
            color: #166534 !important;
        }
        body.light-mode .acc-tab { border: 1px solid #e2e8f0 !important; }

        /* ── 달력 네비 버튼 ── */
        body.light-mode button[onclick*="changeYear"],
        body.light-mode button[onclick*="changeMonth"],
        body.light-mode button[onclick*="goToToday"] {
            background: #f0f7ff !important;
            color: #2563eb !important;
            border: 1px solid #bfdbfe !important;
        }

        /* ── 모달 ── */
        body.light-mode #calendar-preview-modal > div {
            background: #ffffff !important;
            color: #212529 !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important;
        }
        body.light-mode #work-selection-area {
            background: #ffffff !important;
            color: #212529 !important;
        }

        /* ── 설정 화면 추가 ── */
        body.light-mode #view-apiary-settings [style*="rgba(30,25,20"],
        body.light-mode #view-apiary-settings [style*="rgba(26,18,10"],
        body.light-mode #view-apiary-settings [style*="rgba(0,0,0"] {
            background: #ffffff !important;
            border-color: #e2e8f0 !important;
            color: #212529 !important;
        }

        /* ── 병역/방역 ── */
        body.light-mode #view-disease [style*="rgba(30,25,20"],
        body.light-mode #view-disease [style*="rgba(26,18,10"],
        body.light-mode #view-disease-history [style*="rgba(30,25,20"],
        body.light-mode #view-disease-history [style*="rgba(26,18,10"] {
            background: #ffffff !important;
            border-color: #e2e8f0 !important;
        }
        /* ── dyn-btn 수정/삭제 버튼 라이트모드 ── */
        body.light-mode .dyn-btn[data-action*="edit"] {
            background: #dbeafe !important;
            color: #1d4ed8 !important;
        }
        body.light-mode .dyn-btn[data-action*="delete"] {
            background: #fee2e2 !important;
            color: #dc2626 !important;
        }

        /* ── 가계부 카드 배경 ── */
        body.light-mode #view-account [style*="rgba(30,25,20"],
        body.light-mode #view-account [style*="rgba(26,18,10"],
        body.light-mode #view-account [style*="rgba(20,15,10"],
        body.light-mode #view-account [style*="rgba(0,0,0"] {
            background: #ffffff !important;
            border-color: #e2e8f0 !important;
            color: #212529 !important;
        }

        /* ── 가계부 지출/수입 배지 ── */
        body.light-mode [style*="background: rgba(185,28,28"] {
            background: #fee2e2 !important;
            color: #dc2626 !important;
        }
        body.light-mode [style*="background: rgba(74,222,128"] {
            background: #d1fae5 !important;
            color: #065f46 !important;
        }
        body.light-mode [style*="background:rgba(74,222,128"] {
            background: #d1fae5 !important;
            color: #065f46 !important;
        }
        body.light-mode [style*="background:rgba(185,28,28"] {
            background: #fee2e2 !important;
            color: #dc2626 !important;
        }

        /* ── 가계부 합계 표시줄 ── */
        body.light-mode #acc-today-summary,
        body.light-mode [id*="acc"][style*="rgba"] {
            background: #f0fdf4 !important;
            border: 1px solid #86efac !important;
        }

        /* ── 일지 기록 카드 안 수정/삭제 ── */
        body.light-mode [style*="background: rgba(59,130,246,0.3)"] {
            background: #dbeafe !important;
            color: #1d4ed8 !important;
        }
        body.light-mode [style*="background: #dc2626"] {
            background: #ef4444 !important;
            color: #ffffff !important;
        }

        /* ── 가계부 수정 모달 내부 ── */
        body.light-mode #acc-edit-modal > div {
            background: #ffffff !important;
            color: #212529 !important;
        }


        /* ── 엑셀 다운로드 버튼 (다크/라이트 모두) ── */
        .excel-btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            color: #ffffff !important;
            margin-bottom: 10px;
            letter-spacing: -0.3px;
        }
        .excel-diary  { background: linear-gradient(135deg, #10b981, #059669); }
        .excel-account { background: linear-gradient(135deg, #3b82f6, #2563eb); margin-bottom: 0; }
        body.light-mode .excel-btn { color: #ffffff !important; }
        body.light-mode .excel-diary  { background: linear-gradient(135deg, #10b981, #059669) !important; }
        body.light-mode .excel-account { background: linear-gradient(135deg, #3b82f6, #2563eb) !important; }
        /* ── 데이터 탭 공통 스타일 ── */
        .data-section-card {
            background: rgba(30,25,20,0.7);
            border: 1px solid rgba(255,179,0,0.15);
            padding: 18px;
            border-radius: 14px;
            margin-bottom: 14px;
        }
        .data-section-title {
            color: #FFD54F;
            font-weight: 900;
            margin-bottom: 14px;
            font-size: 1rem;
        }
        .data-restore-btn {
            display: block;
            width: 100%;
            padding: 13px;
            background: rgba(255,179,0,0.2);
            color: #FFB300;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 800;
            font-size: 0.95rem;
            border: 2px dashed rgba(255,179,0,0.5);
            box-sizing: border-box;
        }
        .data-reset-desc {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 14px;
        }
        .data-check-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #d4c8b8;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
        }
        .data-reset-btn {
            width: 100%;
            padding: 13px;
            background: rgba(239,68,68,0.25);
            color: #f87171;
            border-radius: 10px;
            border: 1px solid rgba(239,68,68,0.4);
            cursor: pointer;
            font-weight: 800;
            font-size: 0.95rem;
        }

        /* 라이트모드 데이터 탭 */
        body.light-mode .data-section-card {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
        }
        body.light-mode .data-section-title { color: #b45309 !important; }
        body.light-mode .data-restore-btn {
            background: #fef3c7 !important;
            color: #b45309 !important;
            border: 2px dashed #f59e0b !important;
        }
        body.light-mode .data-reset-desc { color: #6b7280 !important; }
        body.light-mode .data-check-label { color: #374151 !important; }
        body.light-mode .data-reset-btn {
            background: #fee2e2 !important;
            color: #dc2626 !important;
            border: 1px solid #fca5a5 !important;
        }
        /* ── 지도 봉장등록 폼 (buildFormEl) ── */
        body.light-mode .ac-form .fi,
        body.light-mode .fi {
            background: #ffffff !important;
            color: #212529 !important;
            border: 1px solid #d1d5db !important;
        }
        body.light-mode .fi::placeholder { color: #9ca3af !important; }
        body.light-mode .tw {
            background: #f1f5f9 !important;
            border-radius: 8px !important;
            padding: 10px !important;
        }
        body.light-mode .tw span[style*="color:#ccc"],
        body.light-mode .tw span[style*="color: #ccc"] {
            color: #374151 !important;
        }
        body.light-mode .cbox {
            background: #f0fdf4 !important;
            border: 1px solid #86efac !important;
            color: #166534 !important;
        }
        body.light-mode .cbox div[style*="color:var(--tx)"] { color: #374151 !important; }
        /* ── 내정보 입력칸 ── */
        body.light-mode #input-nickname,
        body.light-mode #input-farmname {
            background: #ffffff !important;
            color: #212529 !important;
            border: 2px solid #ced4da !important;
        }
        body.light-mode #input-nickname::placeholder,
        body.light-mode #input-farmname::placeholder {
            color: #9ca3af !important;
        }
        body.light-mode #input-nickname:focus,
        body.light-mode #input-farmname:focus {
            border-color: #2563eb !important;
            outline: none !important;
        }
        /* 내정보 영역 레이블 */
        body.light-mode #settings-apiary label {
            color: #374151 !important;
        }
        /* ── 방역/기록 조회 봉장 탭 ── */
        body.light-mode [style*="background: rgba(255,179,0,0.85)"],
        body.light-mode [style*="background:rgba(255,179,0,0.85)"],
        body.light-mode [style*="background: rgba(255,179,0,.85)"],
        body.light-mode [style*="background:rgba(255,179,0,.85)"] {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%) !important;
            color: #ffffff !important;
        }
        body.light-mode [style*="background: rgba(15,10,5,.9)"],
        body.light-mode [style*="background:rgba(15,10,5,.9)"],
        body.light-mode [style*="background: rgba(10,6,2,.92)"],
        body.light-mode [style*="background:rgba(10,6,2,.92)"] {
            background: #e0e7ff !important;
            color: #3730a3 !important;
        }
        /* ── 라이트모드 연한 글씨 전체 진하게 ── */
        body.light-mode [style*="color: #999"],
        body.light-mode [style*="color:#999"],
        body.light-mode [style*="color: #aaa"],
        body.light-mode [style*="color:#aaa"],
        body.light-mode [style*="color: #888"],
        body.light-mode [style*="color:#888"],
        body.light-mode [style*="color: #777"],
        body.light-mode [style*="color:#777"],
        body.light-mode [style*="color: #666"],
        body.light-mode [style*="color:#666"],
        body.light-mode [style*="color: #555"],
        body.light-mode [style*="color:#555"],
        body.light-mode [style*="color: #444"],
        body.light-mode [style*="color:#444"] {
            color: #374151 !important;
        }
        /* var(--dim) 사용 요소 */
        body.light-mode { --dim: #6b7280; }

        /* 카드 안 설명 텍스트 */
        body.light-mode .record-card p,
        body.light-mode .record-card div,
        body.light-mode .record-card span {
            color: #374151;
        }
        /* 방역 기록 카드 */
        body.light-mode [style*="color: #d4c8b8"],
        body.light-mode [style*="color:#d4c8b8"] {
            color: #212529 !important;
        }
        body.light-mode [style*="color: #ccc"],
        body.light-mode [style*="color:#ccc"] {
            color: #374151 !important;
        }
        /* 박스 배경 안 텍스트 */
        body.light-mode [style*="background: rgba(0,0,0,0.2)"],
        body.light-mode [style*="background: rgba(0,0,0,.2)"],
        body.light-mode [style*="background: rgba(0,0,0,0.25)"],
        body.light-mode [style*="background: rgba(0,0,0,.25)"],
        body.light-mode [style*="background: rgba(0,0,0,0.3)"],
        body.light-mode [style*="background: rgba(0,0,0,.3)"] {
            background: #f1f5f9 !important;
            color: #212529 !important;
            border: 1px solid #e2e8f0 !important;
        }
        /* ── 선택된 날짜 셀 하이라이트 ── */
        .cal-day.selected-day {
            outline: 3px solid #4f46e5 !important;
            outline-offset: -2px;
            border-radius: 10px;
        }
        body.light-mode .cal-day.selected-day {
            outline-color: #4f46e5 !important;
            background: rgba(79,70,229,0.08) !important;
        }
        /* ========== 라이트모드 보완 끝 ========== */
        </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        .leaflet-container { background:#1a1a1a; }
        .leaflet-popup-content-wrapper { background:transparent !important; border:none !important; box-shadow:none !important; padding:0 !important; }
        .leaflet-popup-content { margin:0 !important; }
        .leaflet-popup-tip-container { display:none; }
        .honey-tooltip { background:rgba(20,15,10,0.9) !important; color:#FFD54F !important; border:1px solid rgba(255,179,0,0.4) !important; font-weight:700 !important; }
        .leaflet-tile { border-radius:0; }
        /* 꿀벌 로딩 애니메이션 */
        @keyframes beeFly {
            0%   { transform: translate(0,0) rotate(0deg); }
            25%  { transform: translate(6px,-4px) rotate(8deg); }
            50%  { transform: translate(0,-8px) rotate(0deg); }
            75%  { transform: translate(-6px,-4px) rotate(-8deg); }
            100% { transform: translate(0,0) rotate(0deg); }
        }
        @keyframes beeWing {
            0%,100% { transform: scaleX(1); }
            50%      { transform: scaleX(-1); }
        }
        @keyframes splashBee {
            0%   { transform: translate(var(--sx),var(--sy)) scale(0) rotate(var(--sr)); opacity:0; }
            20%  { opacity:1; }
            80%  { opacity:1; }
            100% { transform: translate(var(--ex),var(--ey)) scale(1) rotate(var(--er)); opacity:0; }
        }
        @keyframes fadeOutSplash {
            0%   { opacity:1; }
            100% { opacity:0; pointer-events:none; }
        }
        #bee-splash {
            position:fixed; top:0;left:0;right:0;bottom:0; z-index:9999;
            background:linear-gradient(135deg,#1a0800 0%,#2d1200 50%,#1a0800 100%);
            display:flex; flex-direction:column;
            align-items:center; justify-content:center; gap:16px;
        }
        .splash-bee {
            position:absolute;
            font-size:2rem;
            animation: splashBee 1.8s ease-in-out forwards;
        }
        .map-bee-loader {
            position:absolute; top:50%; left:50%;
            transform:translate(-50%,-50%);
            z-index:1000; pointer-events:none;
            display:flex; flex-direction:column; align-items:center; gap:8px;
        }
        .bee-spin { animation: beeFly 0.6s ease-in-out infinite; font-size:2.5rem; }
        .vworld-marker {
            display:flex; align-items:center; justify-content:center;
            width:32px; height:40px; cursor:pointer;
        }
        /* 밀원수 필터 칩 */
        .honey-chip {
            padding:5px 12px; border-radius:20px; font-size:0.75rem; font-weight:700;
            border:2px solid; cursor:pointer; transition:all 0.2s; white-space:nowrap;
            touch-action:manipulation;
        }
        .honey-chip.active { color:#1a0800 !important; }
    
/* ── 봉장지도 레이아웃 ── */
#view-map { display:none; flex-direction:column; }
#view-map.view-active { display:flex !important; flex-direction:column; height:calc(100dvh - 70px); overflow:hidden; }
#view-map #hdr { flex-shrink:0; }
#view-map #mapwrap { flex-shrink:0; }
#view-map #locbar { flex-shrink:0; display:none; }
#view-map #locbar.show { display:flex; }
#view-map #panel { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:10px 12px 100px; min-height:0; }

/* ════ 봉장지도 전용 CSS ════ */




#hdr{padding:11px 14px;background:linear-gradient(135deg,#1a0a00,#2d1400);border-bottom:2px solid rgba(255,179,0,.25);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
#hdr h1{font-size:1.05rem;font-weight:900;color:var(--gold)}
#gst{font-size:0.78rem;color:#aaa;font-weight:600}
#mapwrap{position:relative;flex-shrink:0}
#vmap{width:100%;height:52dvh;background:#111}
.mtr{position:absolute;top:10px;right:10px;z-index:500;display:flex;gap:6px}
.mbl{position:absolute;bottom:12px;left:10px;z-index:500;display:flex;flex-direction:column;gap:6px}
.mtype{padding:7px 13px;background:rgba(10,6,2,.92);border:1px solid rgba(255,179,0,.35);border-radius:10px;color:#999;font-size:.85rem;font-weight:700;cursor:pointer;touch-action:manipulation}
.mtype.on{background:rgba(255,179,0,.92);color:#1a0800;border-color:var(--gold);box-shadow:0 2px 8px rgba(255,179,0,.4)}
.flt{padding:7px 13px;background:rgba(10,6,2,.92);border:1px solid rgba(255,179,0,.25);border-radius:10px;color:#999;font-size:.85rem;font-weight:700;cursor:pointer;touch-action:manipulation;white-space:nowrap}
.flt.on{background:rgba(255,179,0,.9);color:#1a0800;border-color:var(--gold);box-shadow:0 2px 8px rgba(255,179,0,.35)}
.icob{width:44px;height:44px;background:rgba(10,6,2,.92);border:2px solid rgba(255,179,0,.35);border-radius:50%;font-size:1.3rem;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:manipulation;box-shadow:0 2px 8px rgba(0,0,0,.4)}
#locbar{display:none;padding:10px 14px;background:rgba(5,10,20,.97);border-top:1px solid rgba(59,130,246,.4);align-items:center;gap:10px;flex-shrink:0}
#locbar.on{display:flex}
#panel{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:12px 14px 40px}
#legend{display:flex;gap:10px;flex-wrap:wrap;padding:8px 4px 10px;font-size:.82rem;color:#bbb;font-weight:600}
.ac{background:rgba(26,18,10,.9);border:1px solid rgba(255,179,0,.2);border-radius:14px;margin-bottom:12px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.3)}
.ac-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;gap:8px}
.ac-btns{display:flex;flex-direction:column;gap:6px;align-items:flex-end;flex-shrink:0}
.btn{padding:8px 14px;border:none;border-radius:8px;font-size:.8rem;font-weight:700;cursor:pointer;touch-action:manipulation}
.bg{background:rgba(255,179,0,.2);color:#FFD54F}
.br{background:rgba(185,28,28,.3);color:#ff8a80}
.mapbtn{width:100%;padding:9px;background:rgba(255,179,0,.08);color:#FFD54F;border:none;border-top:1px solid rgba(255,179,0,.15);font-size:.8rem;cursor:pointer;touch-action:manipulation;font-weight:600}
.ac-form{display:none;padding:16px;border-top:2px solid rgba(255,179,0,.2);background:rgba(0,0,0,.3)}
.ac-form.on{display:block}
.fi{width:100%;padding:10px 12px;background:rgba(0,0,0,.35);border:1px solid var(--bdr);border-radius:10px;color:var(--tx);font-size:.88rem;outline:none;margin-bottom:10px}
.fi:focus{border-color:var(--gold)}
.fi::placeholder{color:#3a3a3a}
.fbig{width:100%;padding:12px;border:none;border-radius:12px;font-size:.9rem;font-weight:700;cursor:pointer;touch-action:manipulation;margin-bottom:8px}
.fgps{background:rgba(59,130,246,.25);color:#60a5fa;border:1px solid rgba(59,130,246,.4)}
.fsave{background:linear-gradient(135deg,#b45309,#78350f);color:#fef3c7}
.fcancel{background:rgba(100,100,100,.15);color:#666;margin-bottom:0}
.cbox{display:none;padding:8px 10px;background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.25);border-radius:8px;margin-bottom:10px;font-size:.78rem}
.cbox.on{display:block}
.tw{display:flex;align-items:center;gap:10px;padding:9px 10px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:10px}
.tt{width:44px;height:24px;border-radius:24px;cursor:pointer;display:flex;align-items:center;padding:2px;transition:background .3s}
.th{width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .3s}
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(20,14,6,.96);color:var(--goldl);padding:9px 18px;border-radius:20px;font-size:.82rem;font-weight:700;border:1px solid rgba(255,179,0,.3);z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis}
#toast.on{opacity:1}
.leaflet-control-zoom{border:2px solid rgba(255,179,0,.4)!important;border-radius:10px!important;overflow:hidden!important;box-shadow:0 2px 8px rgba(0,0,0,.4)!important}
.leaflet-control-zoom a{background:rgba(15,10,5,.92)!important;color:#FFB300!important;font-size:1.2rem!important;font-weight:900!important;width:36px!important;height:36px!important;line-height:36px!important}
.leaflet-control-zoom a:hover{background:rgba(255,179,0,.25)!important}
body.light-mode .leaflet-control-zoom{border:2px solid #2563eb!important;box-shadow:0 2px 8px rgba(0,0,0,.25)!important}
body.light-mode .leaflet-control-zoom a{background:rgba(255,255,255,.97)!important;color:#1d4ed8!important;font-weight:900!important}
body.light-mode .leaflet-control-zoom a:hover{background:#dbeafe!important}
.leaflet-popup-content-wrapper{background:transparent!important;border:none!important;box-shadow:none!important;padding:0!important}
.leaflet-popup-content{margin:0!important}
.leaflet-popup-tip-container{display:none!important}

/* ════ 봉장지도 CSS 끝 ════ */

/* 봉장지도 입력창 강화 */
#view-map .fi {
  background: #2a1a08 !important;
  color: #fff !important;
  border: 1px solid rgba(255,179,0,.4) !important;
  border-radius: 8px !important;
  padding: 10px 12px !important;
  font-size: .88rem !important;
  width: 100% !important;
  margin-bottom: 10px !important;
  box-sizing: border-box !important;
}
#view-map .fi::placeholder { color: #666 !important; }
#view-map .fi:focus { border-color: var(--gold, #FFB300) !important; outline: none !important; background: #321e08 !important; }
/* 저장 버튼 강화 */
#view-map .fsave { background: #16a34a !important; color: #fff !important; }
#view-map .fgps  { background: rgba(59,130,246,.18) !important; color: #93c5fd !important; border: 1px solid rgba(59,130,246,.3) !important; }
#view-map .fcancel { background: rgba(100,100,100,.2) !important; color: #888 !important; }
</style>
</head>
<body>

    <div id="splash">
        <div class="bee-fly">🐝</div>
        <h1 class="logo-text">BEE MASTER</h1>
        <p class="subtitle">스마트 양봉 관리 시스템</p>
        <div class="choice-btn-container">
            <button class="choice-btn btn-apiculture" onclick="startApp('양봉')">
                <span>🍯</span>
                양봉
            </button>
            <button class="choice-btn btn-oriental" onclick="startApp('동양종')">
                <span>🐝</span>
                동양종
            </button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="top-nav-bar" style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 14px;">
            <button id="top-left-btn" onclick="handleTopLeftBtn()" class="btn-home" style="flex-shrink:0;white-space:nowrap;">⬅ 뒤로가기</button>
            <div style="flex:1;text-align:center;line-height:1.3;">
                <div id="selected-type-text" style="color:#FFB300;font-size:12px;font-weight:800;letter-spacing:0.5px;">선택: 양봉</div>
                <div style="font-weight:800;font-size:15px;color:#ffffff;">
                    <span id="current-date">2026.02.05</span>
                    <span style="color:#FFD54F;margin-left:6px;" id="temp-display">--°C</span>
                </div>
            </div>
            <div style="display:flex;gap:5px;align-items:center;flex-shrink:0;">
                <button onclick="toggleHighContrast()" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.4);border-radius:8px;padding:5px 8px;font-size:0.75rem;color:#ffffff;cursor:pointer;font-weight:700;touch-action:manipulation;">고대비</button>
                <button id="theme-toggle-btn" onclick="toggleTheme()" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.4);border-radius:8px;padding:5px 8px;font-size:0.85rem;cursor:pointer;touch-action:manipulation;">🌙</button>
            </div>
        </div>

        <!-- 외검 가능 여부 가이드 -->
        <div id="inspection-guide" style="margin: 16px; margin-top: -8px; display: none;"></div>

        <!-- 오늘의 작업 알림 -->
        <div id="today-work-suggestion" style="margin: 16px; margin-top: -8px; display: none;">
            <div style="background: linear-gradient(135deg, rgba(255,179,0,0.15) 0%, rgba(255,143,0,0.1) 100%); border: 2px solid rgba(255,179,0,0.3); border-radius: 12px; padding: 14px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <span style="font-size: 1.3rem;">💡</span>
                    <span style="color: #FFD54F; font-weight: 700; font-size: 0.95rem;">오늘의 추천 작업</span>
                </div>
                <div id="today-work-list" style="color: #d4c8b8; font-size: 0.85rem; line-height: 1.6;"></div>
            </div>
        </div>

        <!-- 동양종 준비중 화면 -->
        <div id="view-oriental-prep" class="view-group">
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 40px;">
                <div style="font-size: 120px; margin-bottom: 30px; animation: bounce 2s infinite;">🐝</div>
                <h2 style="font-size: 2rem; font-weight: 900; color: #FFD54F; margin-bottom: 20px; font-family: 'Gowun Batang', serif;">
                    동양종 관리 시스템
                </h2>
                <div style="background: linear-gradient(135deg, rgba(78,52,46,0.3) 0%, rgba(62,44,38,0.2) 100%); border: 2px solid rgba(78,52,46,0.5); border-radius: 20px; padding: 40px; max-width: 400px; margin-bottom: 30px;">
                    <p style="font-size: 1.5rem; font-weight: 700; color: #FFB300; margin-bottom: 15px;">준비중입니다</p>
                    <p style="font-size: 1rem; color: #c4b8a8; line-height: 1.8;">
                        동양종 양봉 관리 기능은<br>
                        현재 개발 중에 있습니다.<br><br>
                        곧 만나보실 수 있습니다!
                    </p>
                </div>
                <button onclick="goHomeWithoutConfirm()" style="background: linear-gradient(135deg, #4E342E 0%, #3E2C26 100%); color: white; padding: 18px 40px; border-radius: 14px; font-weight: 800; font-size: 1.1rem; border: none; box-shadow: 0 8px 20px rgba(78,52,46,0.4); cursor: pointer;">
                    대문으로 돌아가기
                </button>
            </div>
        </div>

        <!-- 달력 화면 -->
        <div id="view-calendar" class="view-group">
            

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 14px;">
                <button onclick="switchView('diary', true)" style="background: linear-gradient(135deg, #A0522D 0%, #7A3B1E 100%); color: #FFF8E1; padding: 16px 6px; border-radius: 14px; font-size: 15px; font-weight: 900; border: none; box-shadow: 0 4px 14px rgba(100,50,10,0.35); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; touch-action: manipulation;">
                    <span style="font-size:1.6rem;">✍️</span>일지작성
                </button>
                <button onclick="switchView('disease-history', true)" style="background: linear-gradient(135deg, #A0522D 0%, #7A3B1E 100%); color: #FFF8E1; padding: 16px 6px; border-radius: 14px; font-size: 15px; font-weight: 900; border: none; box-shadow: 0 4px 14px rgba(100,50,10,0.35); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; touch-action: manipulation;">
                    <span style="font-size:1.6rem;">📋</span>방역조회
                </button>
                <button onclick="switchView('personal-schedule', true)" style="background: linear-gradient(135deg, #A0522D 0%, #7A3B1E 100%); color: #FFF8E1; padding: 16px 6px; border-radius: 14px; font-size: 15px; font-weight: 900; border: none; box-shadow: 0 4px 14px rgba(100,50,10,0.35); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; touch-action: manipulation;">
                    <span style="font-size:1.6rem;">📅</span>일정
                </button>
            </div>

            <!-- 봉장별 필터 제거 -->
            <div id="location-filters" style="display:none;"></div>
            
            <div style="display:flex;align-items:center;justify-content:space-between;background:rgba(255,179,0,0.06);border-radius:12px;padding:6px 8px;margin-bottom:10px;gap:4px;">
                <button onclick="changeYear(-1)" style="color:#FFB300;background:rgba(255,179,0,0.15);border:none;border-radius:8px;padding:8px 10px;font-size:0.9rem;font-weight:900;cursor:pointer;min-height:40px;min-width:38px;touch-action:manipulation;">◀◀</button>
                <button onclick="changeMonth(-1)" style="color:#FFB300;background:rgba(255,179,0,0.1);border:none;border-radius:8px;padding:8px 12px;font-size:1.2rem;font-weight:900;cursor:pointer;min-height:40px;min-width:38px;touch-action:manipulation;">◀</button>
                <h3 id="cal-title" style="color:#FFD54F;font-weight:900;font-size:1rem;margin:0;flex:1;text-align:center;"></h3>
                <button onclick="goToToday()" style="color:#FFB300;background:rgba(255,179,0,0.15);border:1px solid rgba(255,179,0,0.3);border-radius:8px;padding:6px 10px;font-size:0.8rem;font-weight:700;cursor:pointer;min-height:40px;touch-action:manipulation;">오늘</button>
                <button onclick="changeMonth(1)" style="color:#FFB300;background:rgba(255,179,0,0.1);border:none;border-radius:8px;padding:8px 12px;font-size:1.2rem;font-weight:900;cursor:pointer;min-height:40px;min-width:38px;touch-action:manipulation;">▶</button>
                <button onclick="changeYear(1)" style="color:#FFB300;background:rgba(255,179,0,0.15);border:none;border-radius:8px;padding:8px 10px;font-size:0.9rem;font-weight:900;cursor:pointer;min-height:40px;min-width:38px;touch-action:manipulation;">▶▶</button>
            </div>
            <div id="cal-body" class="calendar-grid"></div>
            <div id="record-list" class="mt-8 space-y-4 pb-24"></div>
        </div>

        <!-- 일지 입력 화면 -->
        <div id="view-diary" class="view-group" style="padding-bottom: 200px;">
            <div class="input-row">
                <span class="input-label">📍 봉장 선택</span>
                <input type="hidden" id="loc-select" value="1봉장">
                <div id="location-buttons" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                    <!-- JavaScript에서 동적 생성 -->
                </div>
            </div>

            <div class="input-row">
                <span class="input-label">🛠 작업 내용</span>
                <button onclick="openWorkSelection()" class="toggle-btn mb-2">
                    <span id="work-btn-text">작업을 선택하세요</span>
                    <span>▶</span>
                </button>
                <div id="selected-works-display" class="flex flex-wrap"></div>
            </div>

            <button onclick="switchView('disease', true)" class="btn-dis">
                <span>💊 방제 처리를 했나요?</span>
                <span id="dis-status">입력 ▶</span>
            </button>

            <div class="input-row">
                <span class="input-label">📝 상세 메모</span>
                <div style="position: relative;">
                    <textarea id="main-memo" class="field" style="height: 140px; resize: vertical; padding-right: 80px;" placeholder="구체적인 작업내용을 기록하세요...&#10;예: 벌통 상태, 여왕벌 확인 여부, 특이사항 등" onfocus="insertWeather()"></textarea>
                    <button class="voice-btn" onclick="startVoiceMemo(this)">🎤 음성</button>
                </div>
            </div>

            <div class="input-row">
                <span class="input-label">📷 사진 첨부 (최대 3장)</span>
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <button type="button" onclick="openInlineCamera('diary')" style="flex: 1; padding: 12px; background: rgba(255,179,0,0.15); color: #FFB300; border-radius: 10px; text-align: center; font-weight: 700; border: 1px dashed rgba(255,179,0,0.3); cursor: pointer;">
                        📸 직접 촬영
                    </button>
                    <label style="flex: 1; padding: 12px; background: rgba(74,222,128,0.15); color: #4ade80; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 700; border: 1px dashed rgba(74,222,128,0.3);">
                        🖼️ 앨범 선택
                        <input type="file" id="diary-photo-input" accept="image/*" multiple onchange="handleDiaryPhotoUpload(this)" style="display:none">
                    </label>
                </div>
                <div id="diary-photo-preview" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
            </div>

        
            <!-- 저장 버튼 고정 -->
            <div style="position:sticky;bottom:70px;left:0;right:0;padding:10px 16px;background:linear-gradient(to top,rgba(26,14,5,1) 70%,transparent);z-index:100;">
                <button onclick="saveData()" class="btn-save btn-diary-save" style="width:100%;min-height:52px;font-size:1rem;">
                    📔 일지 저장하기
                </button>
            </div>
        </div>
        <!-- 방제 입력 화면 -->
        <div id="view-disease" class="view-group" style="padding-bottom: 100px;">
            <h3 style="color: #FFB300; margin-bottom: 20px; font-size: 1.5rem; font-weight: 900; text-align: center;">💊 방제 처리</h3>
            
            <div class="input-row">
                <label class="input-label">📍 봉장 선택</label>
                <input type="hidden" id="disease-loc-select" value="1봉장">
                <div id="disease-apiary-buttons" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                    <!-- 활성화된 봉장만 동적으로 렌더링 -->
                </div>
            </div>
            
            <div class="input-row">
                <label class="input-label">🦠 질병 종류</label>
                <select id="disease-type" onchange="updateMedicineOptions()" class="field">
                    <!-- JavaScript에서 동적 생성 -->
                </select>
            </div>

            <div id="disease-custom" style="display: none; margin-bottom: 16px;">
                <input type="text" id="disease-custom-name" placeholder="질병명 직접 입력" class="field">
            </div>

            <div class="input-row" id="medicine-section" style="display:none;">
                <label class="input-label">💊 약제 선택</label>
                <select id="medicine-type" onchange="showMedicineDetail()" class="field">
                    <option value="">질병을 먼저 선택하세요</option>
                </select>
            </div>

            <div id="medicine-detail" style="display: none;">
                <div id="medicine-detail-row" class="input-row">
                    <label class="input-label">약품명 상세</label>
                    <select id="medicine-detail-select" class="field">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <div class="input-row">
                    <label class="input-label">처리방법</label>
                    <select id="medicine-method" class="field">
                        <option value="">선택하세요</option>
                    </select>
                </div>
            </div>

            <div class="input-row">
                <label class="input-label">⏰ 다음 방역 알림</label>
                <select id="disease-alarm" class="field">
                    <option value="0">안함</option>
                    <option value="3">3일 뒤</option>
                    <option value="5">5일 뒤</option>
                    <option value="7">7일 뒤</option>
                    <option value="10">10일 뒤</option>
                    <option value="14">14일 뒤</option>
                </select>
            </div>

            <div class="input-row">
                <label class="input-label">📝 상세 기록</label>
                <textarea id="disease-memo" class="field" style="height: 140px; resize: vertical;" placeholder="방제 상세 내용을 기록하세요...&#10;예: 벌통 번호, 처리량, 특이사항 등"></textarea>
            </div>

            <div class="input-row">
                <span class="input-label">📷 사진 첨부 (최대 3장)</span>
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <button type="button" onclick="openInlineCamera('disease')" style="flex: 1; padding: 12px; background: rgba(255,179,0,0.15); color: #FFB300; border-radius: 10px; text-align: center; font-weight: 700; border: 1px dashed rgba(255,179,0,0.3); cursor: pointer;">
                        📸 직접 촬영
                    </button>
                    <label style="flex: 1; padding: 12px; background: rgba(74,222,128,0.15); color: #4ade80; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 700; border: 1px dashed rgba(74,222,128,0.3);">
                        🖼️ 앨범 선택
                        <input type="file" id="disease-photo-input" accept="image/*" multiple onchange="handleDiseasePhotoUpload(this)" style="display:none">
                    </label>
                </div>
                <div id="disease-photo-preview" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
            </div>

            <button onclick="saveDiseaseData()" class="btn-save btn-disease-save">
                💊 방제 기록 저장
            </button>
        </div>

        <!-- 방역일지 조회 화면 -->
        <div id="view-disease-history" class="view-group">
            <div style="margin-bottom: 20px;">
                <h2 class="text-xl font-black mb-4" style="color: #FFB300;">📋 방역일지 조회</h2>

                <!-- 조회 탭 (봉장별 / 기간별) -->
                <div style="display:flex; gap:8px; margin-bottom:14px;">
                    <button id="dh-tab-loc" onclick="switchDiseaseHistoryTab('loc')"
                        style="flex:1; padding:10px; border-radius:10px; border:none; cursor:pointer; font-weight:700; font-size:0.9rem;
                               background:rgba(255,179,0,0.3); color:#FFD54F;">🏠 봉장별</button>
                    <button id="dh-tab-period" onclick="switchDiseaseHistoryTab('period')"
                        style="flex:1; padding:10px; border-radius:10px; border:none; cursor:pointer; font-weight:700; font-size:0.9rem;
                               background:rgba(40,30,25,0.6); color:#999;">📅 기간별</button>
                </div>

                <!-- 봉장별 필터 -->
                <div id="dh-panel-loc">
                    <div id="disease-location-filters" style="display:flex; gap:6px; margin-bottom:14px; padding:0 2px; overflow-x:auto; flex-wrap:wrap;"></div>
                    <div id="history-list-view" class="space-y-4 pb-24">
                        <p class="text-center py-20" style="color: #666; font-style: italic;">방역 기록이 없습니다.</p>
                    </div>
                </div>

                <!-- 기간별 조회 -->
                <div id="dh-panel-period" style="display:none;">
                    <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
                        <div style="flex:1; min-width:120px;">
                            <label style="color:#999; font-size:0.8rem; display:block; margin-bottom:4px;">시작일</label>
                            <input type="date" id="dh-date-from" class="field" style="padding:10px;" onchange="renderDiseaseHistoryPeriod()">
                        </div>
                        <div style="flex:1; min-width:120px;">
                            <label style="color:#999; font-size:0.8rem; display:block; margin-bottom:4px;">종료일</label>
                            <input type="date" id="dh-date-to" class="field" style="padding:10px;" onchange="renderDiseaseHistoryPeriod()">
                        </div>
                    </div>
                    <!-- 빠른 기간 버튼 -->
                    <div style="display:flex; gap:6px; margin-bottom:14px; flex-wrap:wrap;">
                        <button onclick="setDiseasePeriod(7)"  style="padding:6px 12px; border-radius:8px; border:none; cursor:pointer; background:rgba(255,179,0,0.2); color:#FFB300; font-size:0.8rem; font-weight:700;">최근 7일</button>
                        <button onclick="setDiseasePeriod(30)" style="padding:6px 12px; border-radius:8px; border:none; cursor:pointer; background:rgba(255,179,0,0.2); color:#FFB300; font-size:0.8rem; font-weight:700;">최근 30일</button>
                        <button onclick="setDiseasePeriod(90)" style="padding:6px 12px; border-radius:8px; border:none; cursor:pointer; background:rgba(255,179,0,0.2); color:#FFB300; font-size:0.8rem; font-weight:700;">최근 3개월</button>
                        <button onclick="setDiseasePeriod(365)" style="padding:6px 12px; border-radius:8px; border:none; cursor:pointer; background:rgba(255,179,0,0.2); color:#FFB300; font-size:0.8rem; font-weight:700;">최근 1년</button>
                        <button onclick="setDiseasePeriod(0)"  style="padding:6px 12px; border-radius:8px; border:none; cursor:pointer; background:rgba(100,100,100,0.2); color:#999; font-size:0.8rem; font-weight:700;">전체</button>
                    </div>
                    <div id="history-period-view" class="space-y-4 pb-24">
                        <p class="text-center py-20" style="color:#666; font-style:italic;">기간을 선택하세요.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 달력 미리보기 모달 -->
        <div id="calendar-preview-modal" style="display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.85); z-index: 10000; overflow-y: auto; padding: 20px;">
            <div style="max-width: 500px; margin: 40px auto; background: #2a1f14; border-radius: 16px; border: 2px solid rgba(255,179,0,0.4);">
                <div style="padding: 20px; border-bottom: 1px solid rgba(255,179,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 id="modal-date-title" style="color: #FFD54F; font-weight: 900; font-size: 1.3rem;">2026.02.05</h3>
                        <button onclick="closePreviewModal()" style="background: rgba(185,28,28,0.3); color: #ff6b6b; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem; line-height: 32px;">✕</button>
                    </div>
                </div>
                <div id="modal-content" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                    <!-- JavaScript로 채워짐 -->
                </div>
                <div style="padding: 16px; border-top: 1px solid rgba(255,179,0,0.2);">
                    <button onclick="openFullDayDetail()" class="btn-save w-full" style="padding: 12px;">
                        📖 전체 기록 보기
                    </button>
                </div>
            </div>
        </div>

        <!-- 가계부 수정 모달 -->
        <div id="acc-edit-modal" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.85); z-index:12000; align-items:center; justify-content:center; padding:20px;">
            <div style="background:#1e1410; border:2px solid rgba(74,222,128,0.4); border-radius:16px; padding:24px; width:100%; max-width:480px; max-height:90vh; overflow-y:auto;">
                <div id="acc-edit-modal-body"></div>
            </div>
        </div>

                <!-- 사진 확대 모달 -->
        <div id="photo-modal" style="display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.95); z-index: 15000; cursor: pointer;" onclick="closePhotoModal()">
            <div style="position: absolute; top: 20px; right: 20px; z-index: 15001;">
                <button onclick="closePhotoModal()" style="background: rgba(185,28,28,0.9); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.5rem; line-height: 40px;">✕</button>
            </div>
            <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 60px 20px 20px 20px;">
                <img id="photo-modal-img" src="" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;">
            </div>
        </div>

        <!-- 가계부 화면 -->
        <div id="view-account" class="view-group" style="padding-bottom: 160px;">
            <div style="display:flex;gap:6px;margin-bottom:18px;padding:5px;background:rgba(0,0,0,0.25);border-radius:14px;border:1px solid rgba(74,222,128,0.15);">
                <div id="v-acc-calendar" onclick="switchAccView('calendar')"
                  style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px;border-radius:10px;cursor:pointer;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;font-size:.72rem;font-weight:800;transition:all .2s;">
                  <span style="font-size:1.2rem;">📅</span>달력
                </div>
                <div id="v-list" onclick="switchAccView('list')"
                  style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px;border-radius:10px;cursor:pointer;background:transparent;color:#888;font-size:.82rem;font-weight:700;transition:all .2s;">
                  <span style="font-size:1.2rem;">✏️</span>기록
                </div>
                <div id="v-stat" onclick="switchAccView('stat')"
                  style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px;border-radius:10px;cursor:pointer;background:transparent;color:#888;font-size:.82rem;font-weight:700;transition:all .2s;">
                  <span style="font-size:1.2rem;">📊</span>내역
                </div>
                <div id="v-customers" onclick="switchAccView('customers')"
                  style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px;border-radius:10px;cursor:pointer;background:transparent;color:#888;font-size:.82rem;font-weight:700;transition:all .2s;">
                  <span style="font-size:1.2rem;">👥</span>고객
                </div>
            </div>

            <!-- 가계부 달력 -->
            <div id="acc-page-calendar">
                <div style="text-align: center; margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(74,222,128,0.2) 0%, rgba(34,197,94,0.15) 100%); border-radius: 12px;">
                    <h2 style="color: #4ade80; font-size: 1.3rem; font-weight: 900; text-shadow: 0 2px 8px rgba(74,222,128,0.3);">💰 가계부</h2>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; padding: 0 4px;">
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <button onclick="changeAccYear(-1)" style="color: #4ade80; background: rgba(74,222,128,0.15); border: none; border-radius: 10px; padding: 10px 12px; font-size: 1rem; font-weight: 900; cursor: pointer; min-height: 44px; min-width: 44px;">◀◀</button>
                        <button onclick="changeAccMonth(-1)" style="color: #4ade80; background: rgba(74,222,128,0.1); border: none; border-radius: 10px; padding: 10px 14px; font-size: 1.4rem; font-weight: 900; cursor: pointer; min-height: 44px; min-width: 44px;">◀</button>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 6px;">
                        <h3 id="acc-cal-title" style="color: #4ade80; font-weight: 900; font-size: 1.2rem; margin: 0;"></h3>
                        <button onclick="goToAccToday()" style="color: #4ade80; background: rgba(74,222,128,0.15); border: 1px solid rgba(74,222,128,0.3); border-radius: 12px; padding: 6px 14px; font-size: 0.8rem; font-weight: 700; cursor: pointer; min-height: 36px;">오늘로</button>
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <button onclick="changeAccMonth(1)" style="color: #4ade80; background: rgba(74,222,128,0.1); border: none; border-radius: 10px; padding: 10px 14px; font-size: 1.4rem; font-weight: 900; cursor: pointer; min-height: 44px; min-width: 44px;">▶</button>
                        <button onclick="changeAccYear(1)" style="color: #4ade80; background: rgba(74,222,128,0.15); border: none; border-radius: 10px; padding: 10px 12px; font-size: 1rem; font-weight: 900; cursor: pointer; min-height: 44px; min-width: 44px;">▶▶</button>
                    </div>
                </div>
                <div id="acc-cal-body" class="calendar-grid"></div>

                <!-- 오늘 수입/지출 요약 -->
                <div id="acc-today-summary" style="margin-top: 20px;"></div>
            </div>

            <!-- 가계부 입력 -->
            <div id="acc-page-list" style="display:none; padding-bottom: 120px;">
                <div class="mode-tab mode-out">
                    <div id="t-out" class="m-tab tab-out active" onclick="setInout('out')">지출(-)</div>
                    <div id="t-in" class="m-tab tab-in" onclick="setInout('in')">수입(+)</div>
                </div>
                <div id="main-cat-area" class="cat-grid"></div>
                <div id="sub-area" class="sub-cat-area">
                    <div id="sub-list" class="sub-grid"></div>
                </div>

                <!-- 선택된 세부항목 표시 (내부 상태 유지용, 화면 미표시) -->
                <div id="selected-acc-tags" style="display:none;"></div>

                <!-- 다중 항목 입력 리스트 -->
                <div style="margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <label style="color:#FFD54F; font-weight:700; font-size:0.92rem;">📦 품목 목록</label>
                        <button onclick="addAccLine()" style="background:rgba(74,222,128,0.25);color:#4ade80;border:none;border-radius:8px;padding:6px 14px;font-size:0.82rem;font-weight:700;cursor:pointer;">+ 품목추가</button>
                    </div>
                    <div id="acc-lines-container">
                        <!-- JS로 렌더링 -->
                    </div>
                </div>

                <!-- 합계 표시 -->
                <div style="background:rgba(255,179,0,0.12);border:1px solid rgba(255,179,0,0.3);border-radius:10px;padding:12px 16px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center;">
                    <span style="color:#FFD54F;font-weight:700;font-size:0.95rem;">합계 금액</span>
                    <span id="acc-total-display" style="color:#FFD54F;font-weight:900;font-size:1.2rem;">0 원</span>
                </div>

                <!-- 직접입력 hidden (호환용) -->
                <input type="hidden" id="in-item" value="">
                <input type="hidden" id="in-price" value="">
                <input type="hidden" id="acc-quantity" value="">
                <input type="hidden" id="acc-unit-price" value="">
                
                <!-- 고객 관리 (수입 선택 시만 표시) -->
                <div id="customer-info" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="color: #FFD54F; font-weight: 700; display: block; margin-bottom: 8px;">고객명</label>
                        <input type="text" id="customer-name" placeholder="고객명" class="field">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #FFD54F; font-weight: 700; display: block; margin-bottom: 8px;">연락처</label>
                        <input type="tel" id="customer-phone" placeholder="010-0000-0000" class="field">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #FFD54F; font-weight: 700; display: block; margin-bottom: 8px;">메모</label>
                        <textarea id="customer-memo" class="field" style="height: 80px;" placeholder="거래 메모 (선택사항)"></textarea>
                    </div>
                </div>
                
                <button class="btn-save w-full" onclick="saveAccData()">가계부 저장</button>
            </div>

            <!-- 가계부 통계 -->
            <div id="acc-page-stat" style="display:none;">
                <div class="flex gap-3 mb-5">
                    <select id="sel-year" class="field flex-1" onchange="renderStatView()">
                        <option value="2026">2026년</option>
                        <option value="2025">2025년</option>
                        <option value="2024">2024년</option>
                    </select>
                    <select id="sel-month" class="field flex-1" onchange="renderStatView()">
                        <option value="all">전체</option>
                        <option value="0">1월</option>
                        <option value="1">2월</option>
                        <option value="2">3월</option>
                        <option value="3">4월</option>
                        <option value="4">5월</option>
                        <option value="5">6월</option>
                        <option value="6">7월</option>
                        <option value="7">8월</option>
                        <option value="8">9월</option>
                        <option value="9">10월</option>
                        <option value="10">11월</option>
                        <option value="11">12월</option>
                    </select>
                </div>
                <div class="stat-sub-tabs">
                    <div id="ss-month" class="ss-tab active" onclick="setStatMode('month')">월별합계</div>
                    <div id="ss-out" class="ss-tab" onclick="setStatMode('out')">지출내역</div>
                    <div id="ss-in" class="ss-tab" onclick="setStatMode('in')">수입내역</div>
                </div>
                <div id="stat-content" class="pb-24"></div>
            </div>

            <!-- 고객관리 페이지 -->
            <div id="acc-page-customers" style="display:none; padding-bottom:120px;">
                <div style="text-align:center; margin-bottom:16px; padding:12px; background:linear-gradient(135deg,rgba(96,165,250,0.2),rgba(59,130,246,0.15)); border-radius:12px;">
                    <h2 style="color:#60a5fa; font-size:1.3rem; font-weight:900;">👥 고객 관리</h2>
                </div>
                <div style="display:flex; gap:8px; margin-bottom:16px;">
                    <input type="text" id="customer-search" placeholder="이름 또는 연락처 검색..." class="field" style="flex:1;" oninput="renderCustomerList()">
                </div>
                <div id="customer-list-view" style="margin-bottom:80px;"></div>
            </div>
        </div>

        <!-- 지도 화면 -->
        <!-- bee-splash 제거됨 -->

        <!-- ============ 지도 화면 ============ -->
        <div id="view-map" class="view-group" style="padding:0;">
<div id="hdr" style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--hdr,#1a0e05);border-bottom:1px solid rgba(255,179,0,.15);">
  <h1 style="font-size:.95rem;font-weight:900;color:#FFB300;">🐝 봉장지도</h1>
  <span id="gst" style="font-size:.72rem;color:#888;">GPS 대기</span>
</div>
<div id="mapwrap" style="position:relative;flex-shrink:0;">
  <div class="mtr" style="top:8px;right:8px;flex-direction:column;align-items:flex-end;gap:5px;">
    <div style="display:flex;gap:5px;">
      <button class="mtype on" id="bsat"  onclick="setTile('sat')">위성</button>
      <button class="mtype"    id="bbase" onclick="setTile('base')">일반</button>
    </div>
  </div>

  <div class="mbl">
    <button class="icob" onclick="goMyLoc()">📍</button>
  </div>
  <div id="vmap" style="width:100%;height:48dvh;background:#111;"></div>
</div>

<div id="locbar">
  <span style="font-size:1.1rem">📍</span>
  <div style="flex:1;min-width:0">
    <div id="laddr" style="font-size:.82rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">확인 중...</div>
    <div id="lcoord" style="font-size:.71rem;color:var(--dim)"></div>
  </div>
  <button class="btn" onclick="hideLocbar()" style="color:#444;flex-shrink:0">✕</button>
</div>

<div id="panel">
  <div id="legend" style="flex-wrap:wrap;gap:8px;align-items:center;">
    <span>🟡 고정봉장</span><span>🟠 이동봉장</span><span>⚫ 미등록</span><span>🔵 내위치</span>
    <div style="display:flex;gap:6px;margin-left:auto;">
      <button class="flt on" id="fall"  onclick="setFilter('all')">전체</button>
      <button class="flt"    id="fwest" onclick="setFilter('western')">🐝 양봉</button>
      <button class="flt"    id="fnat"  onclick="setFilter('native')">🏺 동양종</button>
    </div>
  </div>
  <div id="alist"></div>
</div>

<div id="toast"></div>
</div>

        <!-- 계산기 화면 -->
        <div id="view-calculator" class="view-group" style="padding-bottom: 120px;">
            <h2 class="text-2xl font-black mb-6 text-center" style="color: #FFB300;">🧮 양봉 계산기</h2>
            
            <!-- 개미산 계산 -->
            <div style="background: rgba(30,25,20,0.7); padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,213,79,0.15);">
                <h4 style="color: #FFD54F; font-weight: 900; margin-bottom: 16px; font-size: 1.1rem;">🧪 개미산 농도 계산</h4>
                
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button id="formic-volume-btn" onclick="setFormicMode('volume')" style="flex: 1; padding: 12px; background: #9a3412; color: white; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">부피 (L)</button>
                    <button id="formic-weight-btn" onclick="setFormicMode('weight')" style="flex: 1; padding: 12px; background: rgba(40,30,25,0.8); color: #999; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">무게 기준</button>
                </div>

                <div id="formic-volume" style="display: block;">
                    <p style="color: #999; font-size: 0.82rem; margin-bottom: 12px;">💡 공식: V₁ = (C₂ × V₂) ÷ C₁ &nbsp;|&nbsp; C₁=85%, C₂=목표농도, V₂=희석액총량(L)</p>
                    <input type="number" id="formic-v-target" placeholder="목표 농도 (%) 예: 60" class="field" style="margin-bottom: 12px;">
                    <input type="number" id="formic-v-total" placeholder="희석액 총량 (L) 예: 1" class="field" style="margin-bottom: 12px;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="calcFormicVolume()" style="flex: 1; background: #A0522D; color: white; padding: 14px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">계산</button>
                        <button onclick="resetFormicVolume()" style="background: rgba(100,100,100,0.5); color: white; padding: 14px 20px; border-radius: 10px; border: none; cursor: pointer;">초기화</button>
                    </div>
                    <div id="formic-v-result" style="margin-top: 12px; padding: 16px; background: rgba(139,92,246,0.2); border-radius: 10px; display: none; color: #e8e3d8;"></div>
                </div>

                <div id="formic-weight" style="display: none;">
                    <p style="color: #999; font-size: 0.82rem; margin-bottom: 12px;">💡 공식: M₁ = (C₂ × M₂) ÷ C₁ &nbsp;|&nbsp; C₁=85%, C₂=목표농도, M₂=희석액총량(kg) · 비중 1.19 적용</p>
                    <input type="number" id="formic-w-target" placeholder="목표 농도 (%) 예: 60" class="field" style="margin-bottom: 12px;">
                    <input type="number" id="formic-w-total" placeholder="희석액 총량 (kg) 예: 1" class="field" style="margin-bottom: 12px;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="calcFormicWeight()" style="flex: 1; background: #A0522D; color: white; padding: 14px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">계산</button>
                        <button onclick="resetFormicWeight()" style="background: rgba(100,100,100,0.5); color: white; padding: 14px 20px; border-radius: 10px; border: none; cursor: pointer;">초기화</button>
                    </div>
                    <div id="formic-w-result" style="margin-top: 12px; padding: 16px; background: rgba(139,92,246,0.2); border-radius: 10px; display: none; color: #e8e3d8;"></div>
                </div>
            </div>

            <!-- 옥살산 흘림처리 계산 -->
            <div style="background: rgba(30,25,20,0.7); padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,213,79,0.15);">
                <h4 style="color: #FFD54F; font-weight: 900; margin-bottom: 8px; font-size: 1.1rem;">💧 옥살산 흘림처리 농도 계산</h4>
                <p style="color: #999; font-size: 0.82rem; margin-bottom: 14px;">💡 기본 배합: 물 1kg + 설탕 1kg + 옥살산 70g = 3.38%</p>
                <input type="number" id="oxalic-water" placeholder="물의 양 (kg)" class="field" style="margin-bottom: 12px;">
                <input type="number" id="oxalic-sugar" placeholder="설탕의 양 (kg)" class="field" style="margin-bottom: 12px;">
                <input type="number" id="oxalic-amount" placeholder="옥살산의 양 (g)" class="field" style="margin-bottom: 12px;">
                <div style="display: flex; gap: 8px;">
                    <button onclick="calcOxalic()" style="flex: 1; background: #A0522D; color: white; padding: 14px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">계산</button>
                    <button onclick="resetOxalic()" style="background: rgba(100,100,100,0.5); color: white; padding: 14px 20px; border-radius: 10px; border: none; cursor: pointer;">초기화</button>
                </div>
                <div id="oxalic-result" style="margin-top: 12px; padding: 16px; background: rgba(139,92,246,0.2); border-radius: 10px; display: none; color: #e8e3d8;"></div>
            </div>

            <!-- 주정 계산 -->
            <div style="background: rgba(30,25,20,0.7); padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,213,79,0.15);">
                <h4 style="color: #FFD54F; font-weight: 900; margin-bottom: 16px; font-size: 1.1rem;">🍶 주정 농도 계산</h4>
                <input type="number" id="alcohol-current" placeholder="현재 농도 (%)" class="field" style="margin-bottom: 12px;">
                <input type="number" id="alcohol-target" placeholder="목표 농도 (%)" class="field" style="margin-bottom: 12px;">
                <input type="number" id="alcohol-volume" placeholder="희석액 총량 (L)" class="field" style="margin-bottom: 12px;">
                <div style="display: flex; gap: 8px;">
                    <button onclick="calcAlcohol()" style="flex: 1; background: #A0522D; color: white; padding: 14px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">계산</button>
                    <button onclick="resetAlcohol()" style="background: rgba(100,100,100,0.5); color: white; padding: 14px 20px; border-radius: 10px; border: none; cursor: pointer;">초기화</button>
                </div>
                <div id="alcohol-result" style="margin-top: 12px; padding: 16px; background: rgba(139,92,246,0.2); border-radius: 10px; display: none; color: #e8e3d8;"></div>
            </div>

            <!-- 설탕 사양액 계산 -->
            <div style="background: rgba(30,25,20,0.7); padding: 20px; border-radius: 16px; margin-bottom: 100px; border: 1px solid rgba(255,213,79,0.15);">
                <h4 style="color: #FFD54F; font-weight: 900; margin-bottom: 16px; font-size: 1.1rem;">🍯 설탕 사양액 계산</h4>
                <input type="number" id="sugar-ratio" placeholder="비율 (1:1은 1 입력)" class="field" style="margin-bottom: 12px;">
                <input type="number" id="sugar-water" placeholder="물의 양 (L)" class="field" style="margin-bottom: 12px;">
                <div style="display: flex; gap: 8px;">
                    <button onclick="calcSugar()" style="flex: 1; background: #A0522D; color: white; padding: 14px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">계산</button>
                    <button onclick="resetSugar()" style="background: rgba(100,100,100,0.5); color: white; padding: 14px 20px; border-radius: 10px; border: none; cursor: pointer;">초기화</button>
                </div>
                <div id="sugar-result" style="margin-top: 12px; padding: 16px; background: rgba(139,92,246,0.2); border-radius: 10px; display: none; color: #e8e3d8;"></div>
            </div>
        </div>

        <!-- 봉장 관리 설정 화면 -->
        <div id="view-apiary-settings" class="view-group" style="padding-bottom: 140px;">
            <h2 class="text-2xl font-black mb-4 text-center" style="color: #FFB300;">⚙️ 설정</h2>
            
            <!-- 설정 탭 -->
            <div class="v-switch" style="margin-bottom: 20px;">
                <div id="v-settings-apiary" class="v-btn active" onclick="switchSettingsTab('apiary')">봉장</div>
                <div id="v-settings-custom" class="v-btn" onclick="switchSettingsTab('custom')">항목 설정</div>
                <div id="v-settings-data" class="v-btn" onclick="switchSettingsTab('data')">데이터</div>
            </div>

            <!-- ===== 봉장 관리 탭 ===== -->
            <div id="settings-apiary" class="settings-tab">
                <!-- 닉네임/농장명 -->
                <div style="background:rgba(255,179,0,.07);border:1px solid rgba(255,179,0,.2);border-radius:12px;padding:14px 16px;margin-bottom:18px;">
                  <div style="font-weight:900;color:#FFB300;font-size:.9rem;margin-bottom:10px;">👤 내 정보</div>
                  <div>
                    <label style="color:#aaa;font-size:.78rem;display:block;margin-bottom:4px;">🏷️ 농장 상호명 <span style="color:#FFB300;font-weight:700;">(봉장명 앞에 자동으로 붙고 지도에도 표시됩니다)</span></label>
                    <input id="input-farmname" type="text" placeholder="예) 황실양봉, 행복양봉원" class="field"
                      style="width:100%;padding:9px 12px;background:#2a1a08;border:1px solid rgba(255,179,0,.3);border-radius:8px;color:#fff;font-size:.88rem;box-sizing:border-box;" />
                  </div>
                  <button onclick="saveUserInfoManual()" style="width:100%;margin-top:12px;padding:12px;background:linear-gradient(135deg,#16a34a,#15803d);color:#ffffff;border:none;border-radius:10px;font-size:1rem;font-weight:800;cursor:pointer;">✅ 저장</button>
                </div>
                <p style="color: #999; font-size: 0.85rem; margin-bottom: 14px;">사용할 봉장을 선택하세요</p>
                <div style="background: rgba(30,25,20,0.7); padding: 18px; border-radius: 12px; margin-bottom: 12px;">
                    <h3 style="color: #FFD54F; font-weight: bold; margin-bottom: 12px; font-size: 1rem;">🏠 고정 봉장</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label class="apiary-toggle-item"><input type="checkbox" id="toggle-1봉장" onchange="toggleApiary('1봉장', this.checked)"><span class="apiary-label">1봉장</span></label>
                        <label class="apiary-toggle-item"><input type="checkbox" id="toggle-2봉장" onchange="toggleApiary('2봉장', this.checked)"><span class="apiary-label">2봉장</span></label>
                        <label class="apiary-toggle-item"><input type="checkbox" id="toggle-3봉장" onchange="toggleApiary('3봉장', this.checked)"><span class="apiary-label">3봉장</span></label>
                    </div>
                </div>
                <div style="background: rgba(30,25,20,0.7); padding: 18px; border-radius: 12px;">
                    <h3 style="color: #FFD54F; font-weight: bold; margin-bottom: 12px; font-size: 1rem;">🚚 이동 봉장</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label class="apiary-toggle-item"><input type="checkbox" id="toggle-이동1봉장" onchange="toggleApiary('이동1봉장', this.checked)"><span class="apiary-label">이동1봉장</span></label>
                        <label class="apiary-toggle-item"><input type="checkbox" id="toggle-이동2봉장" onchange="toggleApiary('이동2봉장', this.checked)"><span class="apiary-label">이동2봉장</span></label>
                        <label class="apiary-toggle-item"><input type="checkbox" id="toggle-이동3봉장" onchange="toggleApiary('이동3봉장', this.checked)"><span class="apiary-label">이동3봉장</span></label>
                    </div>
                </div>
                <div style="background: rgba(30,25,20,0.7); padding: 18px; border-radius: 12px; margin-top: 12px;">
                    <h3 style="color: #FFD54F; font-weight: bold; margin-bottom: 8px; font-size: 1rem;">🎨 테마 설정</h3>
                    <p style="color: #999; font-size: 0.85rem;">상단 🌙 버튼으로 언제든지 전환할 수 있습니다.</p>
                </div>
                <button onclick="saveSettingsAll()" style="width:100%;margin-top:18px;padding:16px;background:linear-gradient(135deg,#16a34a,#15803d);color:#ffffff;border:none;border-radius:14px;font-size:1.1rem;font-weight:900;cursor:pointer;box-shadow:0 4px 16px rgba(22,163,74,0.4);">✅ 설정 저장 완료</button>
            </div>

            <!-- ===== 항목 설정 탭 ===== -->
            <div id="settings-custom" class="settings-tab" style="display: none;">

                <!-- 작업 항목 아코디언 -->
                <div style="background: rgba(30,25,20,0.7); border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                    <div onclick="toggleSettingAccordion('works')" style="padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #FFD54F; font-weight: bold;">✍️ 작업 내용 항목</span>
                        <span id="acc-arrow-works" style="color: #FFD54F;">▼</span>
                    </div>
                    <div id="acc-content-works" style="display: none; padding: 14px; border-top: 1px solid rgba(255,213,79,0.1);">
                        <div id="work-items-list" style="margin-bottom: 10px;"></div>
                        <button onclick="addWorkItem()" style="width:100%; padding:10px; background:rgba(255,179,0,0.2); color:#FFB300; border-radius:8px; border:none; cursor:pointer; font-weight:700;">+ 작업 항목 추가</button>
                        <button onclick="resetCustomItems('work')" style="width:100%; padding:8px; background:rgba(100,100,100,0.2); color:#999; border-radius:8px; border:none; cursor:pointer; font-size:0.8rem; margin-top:6px;">기본값으로 초기화</button>
                    </div>
                </div>

                <!-- 질병 종류 아코디언 -->
                <div style="background: rgba(30,25,20,0.7); border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                    <div onclick="toggleSettingAccordion('diseases')" style="padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #FFD54F; font-weight: bold;">🦠 질병 종류 항목</span>
                        <span id="acc-arrow-diseases" style="color: #FFD54F;">▼</span>
                    </div>
                    <div id="acc-content-diseases" style="display: none; padding: 14px; border-top: 1px solid rgba(255,213,79,0.1);">
                        <div id="disease-items-list" style="margin-bottom: 10px;"></div>
                        <button onclick="addDiseaseItem()" style="width:100%; padding:10px; background:rgba(255,179,0,0.2); color:#FFB300; border-radius:8px; border:none; cursor:pointer; font-weight:700;">+ 질병 항목 추가</button>
                    </div>
                </div>

                <!-- 약제 항목 아코디언 (질병별) -->
                <div style="background: rgba(30,25,20,0.7); border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                    <div onclick="toggleSettingAccordion('medicines')" style="padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #FFD54F; font-weight: bold;">💊 약제 항목 (질병별)</span>
                        <span id="acc-arrow-medicines" style="color: #FFD54F;">▼</span>
                    </div>
                    <div id="acc-content-medicines" style="display: none; padding: 14px; border-top: 1px solid rgba(255,213,79,0.1);">
                        <p style="color: #999; font-size: 0.8rem; margin-bottom: 10px;">질병별 약제 및 처리방법을 추가/수정/삭제하세요</p>
                        <div id="medicine-items-list" style="margin-bottom: 10px;"></div>
                        <button onclick="resetCustomItems('medicine')" style="width:100%; padding:8px; background:rgba(100,100,100,0.2); color:#999; border-radius:8px; border:none; cursor:pointer; font-size:0.8rem; margin-top:4px;">기본값으로 초기화</button>
                    </div>
                </div>

                <!-- 방역 알림 날짜 아코디언 -->
                <div style="background: rgba(30,25,20,0.7); border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                    <div onclick="toggleSettingAccordion('alarmdays')" style="padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #FFD54F; font-weight: bold;">🔔 방역 알림 날짜</span>
                        <span id="acc-arrow-alarmdays" style="color: #FFD54F;">▼</span>
                    </div>
                    <div id="acc-content-alarmdays" style="display: none; padding: 14px; border-top: 1px solid rgba(255,213,79,0.1);">
                        <div id="setting-alarmdays-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" id="setting-alarmdays-input" placeholder="날짜 수 (예: 21)" class="field" style="flex: 1; margin: 0;" min="1" max="365">
                            <button onclick="addAlarmDay()" style="background: rgba(255,179,0,0.3); color: #FFB300; padding: 10px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700;">추가</button>
                        </div>
                    </div>
                </div>

                <!-- 가계부 지출 항목 아코디언 -->
                <div style="background: rgba(30,25,20,0.7); border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                    <div onclick="toggleSettingAccordion('accout')" style="padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #FFD54F; font-weight: bold;">💸 가계부 지출 항목</span>
                        <span id="acc-arrow-accout" style="color: #FFD54F;">▼</span>
                    </div>
                    <div id="acc-content-accout" style="display: none; padding: 14px; border-top: 1px solid rgba(255,213,79,0.1);">
                        <div id="setting-accout-list" style="margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="setting-accout-cat-input" placeholder="카테고리명 (예: 기타경비)" class="field" style="flex: 1; margin: 0;">
                            <button onclick="addAccCategory('out')" style="background: rgba(255,179,0,0.3); color: #FFB300; padding: 10px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; white-space: nowrap;">추가</button>
                        </div>
                    </div>
                </div>

                <!-- 가계부 수입 항목 아코디언 -->
                <div style="background: rgba(30,25,20,0.7); border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                    <div onclick="toggleSettingAccordion('accin')" style="padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #FFD54F; font-weight: bold;">💰 가계부 수입 항목</span>
                        <span id="acc-arrow-accin" style="color: #FFD54F;">▼</span>
                    </div>
                    <div id="acc-content-accin" style="display: none; padding: 14px; border-top: 1px solid rgba(255,213,79,0.1);">
                        <div id="setting-accin-list" style="margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="setting-accin-cat-input" placeholder="카테고리명 (예: 체험수입)" class="field" style="flex: 1; margin: 0;">
                            <button onclick="addAccCategory('in')" style="background: rgba(255,179,0,0.3); color: #FFB300; padding: 10px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; white-space: nowrap;">추가</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== 데이터 탭 ===== -->
            <div id="settings-data" class="settings-tab" style="display: none;">
                <div class="data-section-card">
                    <h3 class="data-section-title">💾 데이터 백업/복원</h3>
                    <button onclick="backupData()" class="btn-save w-full" style="margin-bottom: 10px;">📤 데이터 백업 (JSON 다운로드)</button>
                    <label class="data-restore-btn">
                        📥 데이터 복원 (JSON 업로드)
                        <input type="file" accept=".json" onchange="restoreData(this)" style="display:none">
                    </label>
                </div>
                <div class="data-section-card">
                    <h3 class="data-section-title">📊 엑셀 내보내기</h3>
                    <button onclick="exportDiaryToExcel()" class="excel-btn excel-diary">
                        📗 일지 엑셀 다운로드
                    </button>
                    <button onclick="exportAccountToExcel()" class="excel-btn excel-account">
                        📘 가계부 엑셀 다운로드
                    </button>
                </div>
                <div class="data-section-card">
                    <h3 style="color: #ef4444; font-weight: 900; margin-bottom: 12px; font-size: 1rem;">⚠️ 데이터 초기화</h3>
                    <p class="data-reset-desc">초기화할 항목을 선택하세요 (복구 불가)</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 14px;">
                        <label class="data-check-label"><input type="checkbox" id="reset-diary"> 일지 데이터</label>
                        <label class="data-check-label"><input type="checkbox" id="reset-disease"> 방역 기록</label>
                        <label class="data-check-label"><input type="checkbox" id="reset-account"> 가계부 데이터</label>
                        <label class="data-check-label"><input type="checkbox" id="reset-schedule"> 개인 일정</label>
                    </div>
                    <button onclick="executeReset()" class="data-reset-btn">선택 항목 초기화</button>
                </div>
            </div>

        </div>

        <!-- 개인 일정 관리 화면 -->
        <div id="view-personal-schedule" class="view-group">
            <h2 class="text-2xl font-black mb-6 text-center" style="color: #c084fc;">📅 개인 일정</h2>
            
            <div class="input-row">
                <span class="input-label">날짜 선택</span>
                <input type="date" id="schedule-date" class="field">
            </div>

            <div class="input-row">
                <span class="input-label">일정 제목</span>
                <input type="text" id="schedule-title" class="field" placeholder="예: 가족 생일, 병원 약속">
            </div>

            <div class="input-row">
                <span class="input-label">상세 메모</span>
                <textarea id="schedule-memo" class="field" style="height: 100px;" placeholder="일정 상세 내용..."></textarea>
            </div>

            <button onclick="savePersonalSchedule()" class="btn-save">
                일정 저장하기
            </button>

            <h3 class="text-xl font-bold mt-8 mb-4" style="color: #c084fc;">📋 등록된 일정</h3>
            <div id="schedule-list" class="space-y-3 pb-24"></div>
        </div>

        <!-- 하단 네비게이션 -->
        <nav class="bottom-nav">
            <div id="nav-home" class="nav-item" onclick="goHome()">
                <div style="font-size: 24px; margin-bottom: 4px;">🏠</div>
                홈
            </div>
            <div id="nav-calendar" class="nav-item active" onclick="switchView('calendar', true)">
                <div style="font-size: 24px; margin-bottom: 4px;">📅</div>
                기록
            </div>
            <div id="nav-map" class="nav-item" onclick="switchView('map', true)">
                <div style="font-size: 24px; margin-bottom: 4px;">🌍</div>
                지도
            </div>
            <div id="nav-account" class="nav-item" onclick="switchView('account', true)">
                <div style="font-size: 24px; margin-bottom: 4px;">💰</div>
                가계부
            </div>
            <div id="nav-calculator" class="nav-item" onclick="switchView('calculator', true)">
                <div style="font-size: 24px; margin-bottom: 4px;">🍯</div>
                계산기
            </div>
            <div id="nav-settings" class="nav-item" onclick="switchView('apiary-settings', true)">
                <div style="font-size: 24px; margin-bottom: 4px;">⚙️</div>
                설정
            </div>
        </nav>
    </div>

    <!-- 작업 선택 팝업 -->
    <div id="work-selection-area">
        <div style="display: flex; align-items: center; margin-bottom: 24px;">
            <button onclick="closeWorkSelection()" style="background: rgba(255,179,0,0.15); color: #FFB300; border: none; border-radius: 10px; padding: 8px 16px; font-size: 0.9rem; font-weight: 700; cursor: pointer; margin-right: 12px;">⬅ 뒤로가기</button>
            <h2 class="text-2xl font-black" style="color: #FFB300; flex: 1; text-align: center; margin-right: 80px;">작업 내용 선택</h2>
        </div>
        <div class="work-grid" id="work-btn-grid">
            <!-- JavaScript에서 동적 생성 -->
        </div>
        <input type="text" id="custom-work" class="field mt-6" placeholder="직접 입력 (예: 소초교체, 여왕벌확인 등. 여러 개는 쉼표로 구분)">
        <button onclick="closeWorkSelection()" class="w-full py-5 font-black rounded-2xl mt-10 shadow-lg" style="background: linear-gradient(135deg, #FFB300 0%, #FF8F00 100%); color: #1a0800; font-size: 1.1rem;">
            ✅ 선택 완료
        </button>
    </div>

    <script>
        console.log('BEE MASTER 스크립트 시작');
        
        // ==================== 전역 변수 ====================
        let db = JSON.parse(localStorage.getItem('beeData')) || {};
        let accLogs = JSON.parse(localStorage.getItem('beeMoney')) || [];
        let selectedAccItems = [];
        let viewDate = new Date();
        const todayDate = new Date();
        let currentActiveView = 'calendar';
        let selectedBeeType = '양봉';
        let weatherInserted = false;
        let todayWeather = null;
        let viewHistory = ['calendar'];
        let personalSchedules = JSON.parse(localStorage.getItem('personalSchedules')) || [];
        let calLocFilter = 'all';      // 달력 전용
        let diseaseLocFilter = 'all';  // 방역 전용
        let selectedApiaryLoc = '1봉장';    // 일지 봉장 선택값
        let selectedDiseaseApiaryLoc = '1봉장'; // 방역 봉장 선택값
        let diseaseLogs = JSON.parse(localStorage.getItem('diseaseLogs')) || [];
        let inoutType = 'out';
        let statMode = 'month';
        let accViewDate = new Date();
        
        // 봉장 위치 데이터
        let apiaryLocations = JSON.parse(localStorage.getItem('apiaryLocations')) || {};
        // { '1봉장': { lat, lng, address, isPublic, memo, updatedAt } }

        // 봉장 활성화 설정
        let apiarySettings = JSON.parse(localStorage.getItem('apiarySettings')) || {
            '1봉장': true, '2봉장': true, '3봉장': true,
            '이동1봉장': false, '이동2봉장': false, '이동3봉장': false
        };

        // ===== 커스텀 설정 항목 (localStorage) =====
        let customSettings = JSON.parse(localStorage.getItem('beeCustomSettings')) || {
            works: ['내검','이충','왕대이충','채밀','분봉','사양','화분떡','로얄제리','프로폴리스','소초광교체','벌통청소','월동준비'],
            diseases: ['꿀벌응애','부저병','백묵병','노제마','낭충봉아부패병','직접입력'],
            medicines: ['플루발리네이트','아미트라즈','개미산','옥살산','티몰','멘톨','옥시테트라사이클린','푸마길린'],
            alarmdays: [3, 5, 7, 10, 14, 21, 28]
        };

        // 가계부 카테고리 (localStorage 기반)
        let customCategories = JSON.parse(localStorage.getItem('beeCustomCategories')) || null;
        if(!customCategories) {
            customCategories = {
                'out': {
                    "사료": ["설탕", "자연화분", "대용화분", "고체사료", "기타"],
                    "약품": ["속살만", "개미산", "만푸골드", "노제마약", "부저약", "소독제", "기타"],
                    "자재": ["벌통", "소초광", "개포", "격리판", "소문", "기타"],
                    "장비": ["채밀기", "탈봉기", "훈연기", "작업복", "소화기", "기타"],
                    "운영": ["임대료", "전기세", "주유비", "간식비", "기타"]
                },
                'in': {
                    "천연꿀": ["아카시아꿀", "밤꿀", "잡화꿀", "사양꿀", "기타"],
                    "양봉산물": ["생화분", "프로폴리스", "로열젤리", "밀랍", "기타"],
                    "종봉분양": ["벌통판매", "여왕벌분양", "수정벌임대", "기타"],
                    "기타": ["보조금", "교육수입", "기타"]
                }
            };
            localStorage.setItem('beeCustomCategories', JSON.stringify(customCategories));
        }

        // categories를 customCategories로 동기화
        const categories = customCategories;

        // 24절기 데이터
        const solarTerms = {
            '2026-1-5': '소한',
            '2026-1-20': '대한',
            '2026-2-4': '입춘',
            '2026-2-19': '우수',
            '2026-3-6': '경칩',
            '2026-3-21': '춘분',
            '2026-4-5': '청명',
            '2026-4-20': '곡우',
            '2026-5-6': '입하',
            '2026-5-21': '소만',
            '2026-6-6': '망종',
            '2026-6-21': '하지',
            '2026-7-7': '소서',
            '2026-7-23': '대서',
            '2026-8-7': '입추',
            '2026-8-23': '처서',
            '2026-9-8': '백로',
            '2026-9-23': '추분',
            '2026-10-8': '한로',
            '2026-10-23': '상강',
            '2026-11-7': '입동',
            '2026-11-22': '소설',
            '2026-12-7': '대설',
            '2026-12-22': '동지'
        };

        // 가계부 카테고리
        // (categories는 위에서 customCategories로 선언됨)

        // 음성 인식
        let recognition = null;
        let isRecording = false;
        let currentVoiceButton = null;

        // Web Speech API 초기화
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'ko-KR';

            recognition.onstart = function() {
                isRecording = true;
                if(currentVoiceButton) {
                    currentVoiceButton.classList.add('recording');
                    currentVoiceButton.innerHTML = '⏹️ 중지';
                    currentVoiceButton.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                }
                showToast('🎤 음성 인식 중...');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const memoField = document.getElementById('main-memo');
                if(memoField) {
                    const currentText = memoField.value;
                    memoField.value = currentText + (currentText ? '\n' : '') + transcript;
                }
                showToast('✅ 음성이 입력되었습니다');
            };

            recognition.onerror = function(event) {
                console.error('음성 인식 오류:', event.error);
                if(event.error === 'no-speech') {
                    showToast('⚠️ 음성이 감지되지 않았습니다');
                } else if(event.error === 'not-allowed') {
                    showToast('❌ 마이크 권한이 필요합니다');
                } else {
                    showToast('❌ 음성 인식 오류: ' + event.error);
                }
            };

            recognition.onend = function() {
                isRecording = false;
                if(currentVoiceButton) {
                    currentVoiceButton.classList.remove('recording');
                    currentVoiceButton.innerHTML = '🎤 음성';
                    currentVoiceButton.style.background = '';
                }
            };
        }

        // ==================== 앱 시작 함수 ====================
        function goHome() {
            // 대문으로 돌아가기
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('splash').style.display = 'flex';
            document.querySelector('.bottom-nav').style.display = 'none';
        }

        function startApp(type) {
            try {
                console.log('🚀 앱 시작:', type);
                
                selectedBeeType = type;
                
                // 스플래시 숨기기
                const splash = document.getElementById('splash');
                const mainApp = document.getElementById('main-app');
                
                if(splash) splash.style.display = 'none';
                if(mainApp) {
                    mainApp.classList.remove('hidden');
                    mainApp.style.display = 'block';  // 명시적으로 display 설정!
                    console.log('✓ 메인 앱 표시됨');
                }
                
                // 타입 표시 업데이트
                const typeText = document.getElementById('selected-type-text');
                if(typeText) typeText.innerText = "선택: " + type;
                
                updateCurrentDate();
                
                // 모든 뷰 숨기기
                document.querySelectorAll('.view-group').forEach(el => {
                    el.classList.remove('view-active');
                });
                
                if (type === '동양종') {
                    console.log('동양종 모드 진입');
                    const orientalView = document.getElementById('view-oriental-prep');
                    if(orientalView) orientalView.classList.add('view-active');
                    
                    const bottomNav = document.querySelector('.bottom-nav');
                    if(bottomNav) bottomNav.style.display = 'none';
                    
                    viewHistory = ['oriental-prep'];
                    currentActiveView = 'oriental-prep';
                } else {
                    console.log('양봉 모드 진입');
                    
                    // 달력 화면 활성화
                    const calendarView = document.getElementById('view-calendar');
                    if(calendarView) {
                        calendarView.classList.add('view-active');
                        console.log('✓ 달력 화면 활성화됨');
                    } else {
                        console.error('❌ 달력 화면을 찾을 수 없음');
                    }
                    
                    // 하단 네비게이션 표시
                    const bottomNav = document.querySelector('.bottom-nav');
                    if(bottomNav) {
                        bottomNav.style.display = 'flex';
                        console.log('✓ 하단 네비게이션 표시됨');
                    }
                    
                    viewHistory = ['calendar'];
                    currentActiveView = 'calendar';
                    
                    // 네비게이션 상태 초기화
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    const navCalendar = document.getElementById('nav-calendar');
                    if(navCalendar) {
                        navCalendar.classList.add('active');
                        console.log('✓ 달력 네비게이션 활성화됨');
                    }
                    
                    // 렌더링 (약간의 지연을 주어 DOM이 준비되도록)
                    setTimeout(() => {
                        console.log('렌더링 시작...');
                        
                        try {
                            renderCalendar();
                            // 오늘 날짜 기록 자동 표시
                            const t = new Date();
                            const todayKey = `${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`;
                            showDayWithSchedule(todayKey);
                        } catch(e) {
                            console.error('달력 렌더링 오류:', e);
                        }
                        
                        try {
                            renderMainCats();
                        } catch(e) {
                            console.error('카테고리 렌더링 오류:', e);
                        }
                        
                        try {
                            renderLocationButtons();
                        } catch(e) {
                            console.error('봉장 버튼 렌더링 오류:', e);
                        }
                        
                        try {
                            renderLocationFilters();
                        } catch(e) {
                            console.error('필터 렌더링 오류:', e);
                        }
                        
                        console.log('✅ 모든 렌더링 완료');
                    }, 200);
                }
                
                console.log('✅ startApp 완료');
            } catch(error) {
                console.error('❌ startApp 오류:', error);
                alert('앱 시작 중 오류가 발생했습니다. 페이지를 새로고침해주세요.');
            }
        }

        // ==================== 날짜 및 날씨 ====================
        function updateCurrentDate() {
            const year = todayDate.getFullYear();
            const month = String(todayDate.getMonth() + 1).padStart(2, '0');
            const day = String(todayDate.getDate()).padStart(2, '0');
            document.getElementById('current-date').innerText = `${year}.${month}.${day}`;
        }

        async function fetchWeatherData() {
            try {
                const lat = 36.9922;
                const lon = 127.1129;
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m&timezone=Asia/Seoul`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if(data && data.current) {
                    const temp = Math.round(data.current.temperature_2m);
                    const windSpeed = data.current.wind_speed_10m.toFixed(1);
                    
                    todayWeather = { temp, windSpeed, description: '맑음' };
                    
                    const tempDisplay = document.querySelector('.top-nav-bar .ml-2');
                    if (tempDisplay) tempDisplay.innerText = `${temp}°C`;
                    
                    updateInspectionGuide(temp, windSpeed);
                }
            } catch (error) {
                console.error('날씨 API 오류:', error);
                todayWeather = { temp: 15, windSpeed: '2.0', description: '정보 없음' };
            }
        }

        function updateInspectionGuide(temp, windSpeed) {
            const guide = document.getElementById('inspection-guide');
            if(!guide) return;
            
            let status, color, icon;
            
            if(temp >= 10 && windSpeed <= 5) {
                status = '외검 적합';
                color = '#4ade80';
                icon = '✅';
            } else if(temp >= 8 && windSpeed <= 7) {
                status = '외검 가능 (주의)';
                color = '#fbbf24';
                icon = '⚠️';
            } else {
                status = '외검 부적합';
                color = '#ef4444';
                icon = '❌';
            }
            
            guide.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px; border: 2px solid ${color};">
                    <span style="font-size: 1.5rem;">${icon}</span>
                    <div>
                        <div style="color: ${color}; font-weight: bold; font-size: 1rem;">${status}</div>
                        <div style="color: #999; font-size: 0.75rem;">기온 ${temp}°C / 풍속 ${windSpeed}m/s</div>
                    </div>
                </div>
            `;
        }

        function insertWeather() {
            const memoField = document.getElementById('main-memo');
            if (weatherInserted || memoField.value.trim().length > 0) return;
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
            
            if (todayWeather) {
                const weatherText = `[${dateStr} 작업일지] ${todayWeather.temp}°C / ${todayWeather.description} / 풍속 ${todayWeather.windSpeed}m/s\n\n`;
                memoField.value = weatherText;
                weatherInserted = true;
                memoField.setSelectionRange(weatherText.length, weatherText.length);
            }
        }

        // ==================== 오늘의 작업 제안 ====================
        function showTodayWorkSuggestion() {
            const container = document.getElementById('today-work-suggestion');
            const listEl = document.getElementById('today-work-list');
            if(!container || !listEl) return;

            // 최근 7일간 작업 분석
            const today = new Date();
            const suggestions = [];
            const recentWorks = {};
            
            for(let i = 1; i <= 7; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const key = `${checkDate.getFullYear()}-${checkDate.getMonth()+1}-${checkDate.getDate()}`;
                
                if(db[key] && db[key].records) {
                    db[key].records.forEach(r => {
                        if(r.works) {
                            r.works.forEach(w => {
                                recentWorks[w] = (recentWorks[w] || 0) + 1;
                            });
                        }
                    });
                }
            }

            // 방역 알림 확인
            const todayKey = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
            if(db[todayKey]?.isDiseaseAlarm) {
                suggestions.push('🔔 <strong>방역 알림</strong>이 설정되어 있습니다');
            }

            // 개인 일정 확인
            const todayScheduleDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            const todaySchedules = personalSchedules.filter(s => s.date === todayScheduleDate);
            if(todaySchedules.length > 0) {
                todaySchedules.forEach(s => {
                    suggestions.push(`📅 <strong>${s.title}</strong>${s.memo ? ': ' + s.memo : ''}`);
                });
            }

            // 최근 많이 한 작업 (내검은 항상 추천)
            if(!recentWorks['내검']) {
                suggestions.push('🔍 <strong>내검</strong>을 권장합니다');
            }

            // 계절별 추천
            const month = today.getMonth() + 1;
            if(month >= 3 && month <= 5) {
                if(!recentWorks['분봉']) suggestions.push('🐝 봄철입니다. <strong>분봉 준비</strong>를 확인하세요');
            } else if(month >= 6 && month <= 8) {
                if(!recentWorks['채밀']) suggestions.push('🍯 여름철입니다. <strong>채밀</strong> 시기를 확인하세요');
            } else if(month >= 11 || month <= 2) {
                if(!recentWorks['월동준비']) suggestions.push('❄️ 겨울철입니다. <strong>월동 준비</strong> 상태를 점검하세요');
            }

            if(suggestions.length === 0) {
                suggestions.push('오늘은 특별한 예정 작업이 없습니다 😊');
            }

            listEl.innerHTML = suggestions.map(s => `• ${s}`).join('<br>');
            container.style.display = 'block';
        }

        // ==================== 달력 미리보기 모달 ====================
        let previewModalDate = null;

        function showPreviewModal(year, month, day) {
            const key = `${year}-${month+1}-${day}`;
            previewModalDate = {year, month, day, key};
            
            const modal = document.getElementById('calendar-preview-modal');
            const titleEl = document.getElementById('modal-date-title');
            const contentEl = document.getElementById('modal-content');
            
            titleEl.textContent = `${year}.${String(month+1).padStart(2,'0')}.${String(day).padStart(2,'0')}`;
            
            let html = '';
            
            // 일지 기록
            if(db[key] && db[key].records && db[key].records.length > 0) {
                html += '<div style="margin-bottom: 16px;"><h4 style="color: #FFD54F; font-weight: 700; margin-bottom: 10px;">📝 일지 기록</h4>';
                db[key].records.forEach(r => {
                    html += `<div style="background: rgba(255,179,0,0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="color: #FFB300; font-weight: 700; margin-bottom: 6px;">📍 ${r.loc}</div>
                        ${r.works && r.works.length > 0 ? '<div style="color: #d4c8b8; font-size: 0.85rem; margin-bottom: 4px;">작업: ' + r.works.join(', ') + '</div>' : ''}
                        ${r.memo ? '<div style="color: #999; font-size: 0.85rem; margin-bottom: 6px;">' + r.memo.substring(0, 100) + (r.memo.length > 100 ? '...' : '') + '</div>' : ''}
                        ${r.photos && r.photos.length > 0 ? '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 6px;">' + r.photos.map(p => '<img src="' + p + '" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px;">').join('') + '</div>' : ''}
                    </div>`;
                });
                html += '</div>';
            }
            
            // 방역 기록
            const diseaseRecords = diseaseLogs.filter(log => log.date === key);
            if(diseaseRecords.length > 0) {
                html += '<div style="margin-bottom: 16px;"><h4 style="color: #FFD54F; font-weight: 700; margin-bottom: 10px;">💊 방역 기록</h4>';
                diseaseRecords.forEach(d => {
                    html += `<div style="background: rgba(255,179,0,0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="color: #FFB300; font-weight: 700;">${d.diseaseType}</div>
                        <div style="color: #d4c8b8; font-size: 0.85rem;">약제: ${d.medicine}</div>
                    </div>`;
                });
                html += '</div>';
            }
            
            // 개인 일정
            const scheduleDate = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const schedules = personalSchedules.filter(s => s.date === scheduleDate);
            if(schedules.length > 0) {
                html += '<div style="margin-bottom: 16px;"><h4 style="color: #FFD54F; font-weight: 700; margin-bottom: 10px;">📅 개인 일정</h4>';
                schedules.forEach(s => {
                    html += `<div style="background: rgba(255,179,0,0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="color: #FFB300; font-weight: 700;">${s.title}</div>
                        ${s.memo ? '<div style="color: #d4c8b8; font-size: 0.85rem;">' + s.memo + '</div>' : ''}
                    </div>`;
                });
                html += '</div>';
            }
            
            // 특별 이벤트
            if(db[key]?.isQueen) {
                html += '<div style="background: rgba(255,179,0,0.15); padding: 12px; border-radius: 8px; border: 2px solid rgba(255,179,0,0.3); margin-bottom: 8px;"><div style="color: #FFD54F; font-weight: 700;">👑 여왕벌 출방 예정일</div></div>';
            }
            if(db[key]?.isDiseaseAlarm) {
                html += '<div style="background: rgba(239,68,68,0.15); padding: 12px; border-radius: 8px; border: 2px solid rgba(239,68,68,0.3); margin-bottom: 8px;"><div style="color: #ff6b6b; font-weight: 700;">🔔 방역 알림</div></div>';
            }
            
            if(html === '') {
                html = '<p style="text-align: center; color: #666; padding: 40px 20px; font-style: italic;">이 날짜에는 기록이 없습니다</p>';
            }
            
            contentEl.innerHTML = html;
            modal.style.display = 'block';
        }

        function closePreviewModal() {
            document.getElementById('calendar-preview-modal').style.display = 'none';
            previewModalDate = null;
        }

        function openFullDayDetail() {
            if(!previewModalDate) return;
            closePreviewModal();
            todayDate = new Date(previewModalDate.year, previewModalDate.month, previewModalDate.day);
            document.getElementById('current-date').textContent = 
                `${previewModalDate.year}.${String(previewModalDate.month+1).padStart(2,'0')}.${String(previewModalDate.day).padStart(2,'0')}`;
            switchView('day-detail');
        }

        // ==================== 달력 관리 ====================
        function changeMonth(n) {
            viewDate.setMonth(viewDate.getMonth() + n);
            renderCalendar();
        }

        function changeYear(n) {
            viewDate.setFullYear(viewDate.getFullYear() + n);
            renderCalendar();
        }

        function goToToday() {
            viewDate = new Date();
            renderCalendar();
            const t = new Date();
            const todayKey = `${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`;
            showDayWithSchedule(todayKey);
            showToast('📅 오늘 날짜로 이동했습니다');
        }

        function renderCalendar() {
            try {
                console.log('📅 달력 렌더링, 필터:', calLocFilter);
                
                if(!viewDate || !(viewDate instanceof Date)) {
                    viewDate = new Date();
                }
                
                const y = viewDate.getFullYear();
                const m = viewDate.getMonth();
                
                const calTitle = document.getElementById('cal-title');
                if(calTitle) calTitle.innerText = `${y}년 ${m+1}월`;
                
                const body = document.getElementById('cal-body');
                if(!body) {
                    console.error('cal-body 요소를 찾을 수 없음');
                    return;
                }
                
                body.innerHTML = '';
                
                // 요일 헤더
                ['일','월','화','수','목','금','토'].forEach(d => {
                    body.innerHTML += `<div class="cal-head">${d}</div>`;
                });
                
                const start = new Date(y, m, 1).getDay();
                const last = new Date(y, m+1, 0).getDate();
                
                for(let i=0; i<start; i++) {
                    body.innerHTML += `<div></div>`;
                }
                
                const today = new Date();
                const isThisMonth = today.getFullYear() === y && today.getMonth() === m;
                const todayDateNum = today.getDate();
                
                for(let d=1; d<=last; d++) {
                    const key = `${y}-${m+1}-${d}`;
                    let cls = "cal-day";
                    
                    if(isThisMonth && d === todayDateNum) {
                        cls += " today-highlight";
                    }
                    
                    if(db[key]?.isQueen) cls += " queen-day";
                    if(db[key]?.isDiseaseAlarm) cls += " disease-alarm-day";
                    
                    // 기록 존재 여부 (구버전 호환)
                    const hasAnyRecord = !!(db[key]?.hasData || (db[key]?.records && db[key].records.length > 0));
                    
                    const hasMatchingRecord = hasAnyRecord;
                    if(hasMatchingRecord) cls += " border-amber-600";
                    
                    const scheduleDate = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const hasSchedule = personalSchedules.some(s => s.date === scheduleDate);
                    if(hasSchedule) cls += " border-purple-400";
                    
                    let content = '';
                    
                    const solarTerm = solarTerms[key];
                    if(solarTerm) {
                        content += `<span class="solar-term">${solarTerm}</span>`;
                    }
                    
                    content += `<span style="font-weight: bold; font-size: ${solarTerm ? '0.95rem' : '1.1rem'};">${d}</span>`;
                    
                    if(isThisMonth && d === todayDateNum) {
                        content = (solarTerm ? `<span class="solar-term">${solarTerm}</span>` : '') +
                                  `<span style="background:#FFB300;color:#1a0800;font-size:0.6rem;padding:1px 5px;border-radius:6px;font-weight:900;display:block;margin-bottom:1px;">오늘</span>
                                  <span style="font-weight:bold;font-size:${solarTerm ? '0.9rem' : '1.05rem'}">${d}</span>`;
                    }
                    
                    // 이벤트 아이콘만 표시 (작은 셀에 최적화)
                    let eventIcons = '';
                    const iconStyle = 'font-size:1rem;line-height:1;';

                    // 일지 기록
                    if(db[key]?.records && db[key].records.length > 0) {
                        const cnt = db[key].records.length;
                        eventIcons += `<span style="${iconStyle}" title="일지 ${cnt}건">📝</span>`;
                        if(cnt > 1) eventIcons += `<span style="font-size:0.6rem;font-weight:900;color:#d97706;vertical-align:top;">${cnt}</span>`;
                    }

                    // 여왕벌 이벤트
                    if(db[key]?.isQueen) {
                        eventIcons += `<span style="${iconStyle}" title="왕대출방">👑</span>`;
                    }

                    // 방역 알람
                    const dayDiseases = diseaseLogs.filter(function(dl){return dl.dateStr===key;});
                    if(db[key]?.isDiseaseAlarm || dayDiseases.length > 0) {
                        eventIcons += `<span style="${iconStyle}" title="방역">🛡️</span>`;
                    }

                    // 개인일정
                    if(hasSchedule) {
                        eventIcons += `<span style="${iconStyle}" title="개인일정">📅</span>`;
                    }

                    if(eventIcons) {
                        content += `<div style="display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:1px;margin-top:3px;">${eventIcons}</div>`;
                    }
                    
                    body.innerHTML += `<div class="${cls}" onclick="handleDayClick('${key}', this)">${content}</div>`;
                }
                
                console.log('✅ 달력 렌더링 완료');
            } catch(error) {
                console.error('❌ 달력 렌더링 오류:', error);
                showToast('달력 로드 중 오류 발생');
            }
        }

        function goToDayRecord(key) {
            const data = db[key];
            if(data?.records && data.records.length > 0) {
                showDay(key);
                document.getElementById('record-list').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                switchView('diary', true);
            }
        }

        function handleDayClick(key, el) {
            // 기존 선택 셀 하이라이트 제거
            document.querySelectorAll('.cal-day.selected-day').forEach(function(d){ d.classList.remove('selected-day'); });
            // 클릭한 셀 하이라이트
            if(el) el.classList.add('selected-day');
            // 하단에 내용 표시 + 스크롤
            showDayRecordBelow(key);
        }

        function showDayRecordBelow(key) {
            showDay(key);
            setTimeout(() => {
                const el = document.getElementById('record-list');
                if(el) window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 60, behavior: 'smooth' });
            }, 80);
        }

        function showDay(key) {
            showDayWithSchedule(key);
        }
        
        function showDayWithSchedule(key) {
            const list = document.getElementById('record-list');
            if(!list) return;
            
            const data = db[key];
            const [year, month, day] = key.split('-').map(Number);
            const scheduleDate = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const daySchedules = personalSchedules.filter(s => s.date === scheduleDate);
            
            let html = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">' +
                       '<h4 class="font-bold" style="color: #FFB300; font-size: 1.1rem;">' + key + ' 기록</h4></div>';
            
            // 일지 내용 (봉장 필터 적용)
            if(data && data.records && data.records.length > 0) {
                // 필터에 맞는 기록만 표시
                const visibleRecords = data.records;

                visibleRecords.forEach(function(record, index) {
                    // 실제 records 배열에서의 인덱스 찾기 (수정/삭제용)
                    index = data.records.indexOf(record);
                    html += '<div class="record-card" style="border-left: 4px solid #FFB300;">' +
                        '<div class="flex justify-between items-start mb-3">' +
                            '<p class="font-bold text-lg" style="color: #FFB300;">📍 ' + record.loc + '</p>' +
                            '<div style="display: flex; gap: 8px; align-items: center;">' +
                                '<button class="dyn-btn" data-action="editRecord" data-key="' + key + '" data-index="' + index + '" style="background: rgba(59,130,246,0.3); color: #60a5fa; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; border: none; cursor: pointer; font-weight: 700;">수정</button>' +
                                '<button class="dyn-btn" data-action="deleteRecord" data-key="' + key + '" data-index="' + index + '" style="background: #dc2626; color: #ffffff; padding: 6px 14px; border-radius: 6px; font-size: 0.85rem; border: none; cursor: pointer; font-weight: 800; letter-spacing: 0.5px;">삭제</button>' +
                            '</div>' +
                        '</div>' +
                        '<div class="mb-4">' +
                            '<p class="text-xs mb-2" style="color: #999;">작업 내용</p>' +
                            '<div class="flex flex-wrap gap-2">' +
                                record.works.map(function(w) { return '<span class="badge" style="font-size: 0.75rem;">' + w + '</span>'; }).join('') +
                            '</div>' +
                        '</div>' +
                        (record.memo ? '<div class="mb-4">' +
                            '<p class="text-xs mb-2" style="color: #999;">상세 메모</p>' +
                            '<div class="text-sm leading-relaxed p-4 rounded-lg" style="background: rgba(0,0,0,0.3); color: #d4c8b8; white-space: pre-wrap;">' + record.memo + '</div>' +
                        '</div>' : '') +
                        (record.photos && record.photos.length > 0 ? '<div class="mb-4">' +
                            '<p class="text-xs mb-2" style="color: #999;">첨부 사진 (' + record.photos.length + '장)</p>' +
                            '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">' +
                                record.photos.map(function(p) { return '<img src="' + p + '" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 6px; cursor: pointer;" onclick="showPhotoModal(\'' + p + '\')">'; }).join('') +
                            '</div>' +
                        '</div>' : '') +
                        '<div class="text-xs mt-4 pt-3" style="color: #666; border-top: 1px solid rgba(255,179,0,0.1);">' +
                            '기록 시간: ' + (record.timestamp ? new Date(record.timestamp).toLocaleString('ko-KR') : '정보 없음') +
                        '</div>' +
                    '</div>';
                });
            }
            
            // 개인일정
            if(daySchedules.length > 0) {
                html += '<div style="margin-top: 16px;">' +
                        '<h5 style="color: #c084fc; font-weight: bold; margin-bottom: 12px; font-size: 1rem;">📅 개인일정</h5>';
                
                daySchedules.forEach(function(schedule) {
                    var originalIndex = personalSchedules.indexOf(schedule);
                    html += '<div class="record-card" style="border-left: 4px solid #c084fc;">' +
                        '<div class="flex justify-between items-start mb-2">' +
                            '<div style="flex: 1;">' +
                                '<div style="font-weight: bold; color: #c084fc; font-size: 1.1rem; margin-bottom: 4px;">' + schedule.title + '</div>' +
                                (schedule.memo ? '<div style="font-size: 0.85rem; color: #999;">' + schedule.memo + '</div>' : '') +
                            '</div>' +
                            '<div style="display: flex; gap: 8px;">' +
                                '<button class="dyn-btn" data-action="editSchedule" data-index="' + originalIndex + '" style="background: rgba(59,130,246,0.3); color: #60a5fa; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; border: none; cursor: pointer; font-weight: 700;">수정</button>' +
                                '<button class="dyn-btn" data-action="deleteSchedule" data-index="' + originalIndex + '" style="background: #dc2626; color: #ffffff; padding: 6px 14px; border-radius: 6px; font-size: 0.85rem; border: none; cursor: pointer; font-weight: 800; letter-spacing: 0.5px;">삭제</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                });
                
                html += '</div>';
            }
            
            // 방역 기록 (dateStr 기준으로 필터)
            const dayDiseaseRecords = diseaseLogs.filter(function(log) { return log.dateStr === key; });
            if(dayDiseaseRecords.length > 0) {
                html += '<div style="margin-top: 16px;">' +
                        '<h5 style="color: #f87171; font-weight: bold; margin-bottom: 12px; font-size: 1rem;">💊 방역 기록</h5>';
                dayDiseaseRecords.forEach(function(log) {
                    var logIndex = diseaseLogs.indexOf(log);
                    html += '<div class="record-card" style="border-left: 4px solid #ef4444;">' +
                        '<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">' +
                            '<div style="flex:1;min-width:0;">' +
                                '<div style="font-weight:800; color:#f87171; font-size:1rem; margin-bottom:4px;">🛡️ ' + (log.diseaseTypeName || log.diseaseType || '방역') + '</div>' +
                                '<div style="color:#aaa; font-size:0.85rem; font-weight:600;">📍 ' + (log.location || '') + '</div>' +
                            '</div>' +
                            '<div style="display:flex; gap:6px; flex-shrink:0; margin-left:8px;">' +
                                '<button class="dyn-btn" data-action="editDiseaseRecord" data-index="' + logIndex + '" style="background:rgba(59,130,246,0.3);color:#60a5fa;padding:6px 12px;border-radius:6px;font-size:0.8rem;border:none;cursor:pointer;font-weight:700;">수정</button>' +
                                '<button class="dyn-btn" data-action="deleteDiseaseRecord" data-index="' + logIndex + '" style="background:#dc2626;color:#fff;padding:6px 12px;border-radius:6px;font-size:0.8rem;border:none;cursor:pointer;font-weight:700;">삭제</button>' +
                            '</div>' +
                        '</div>' +
                        (log.medicineName || log.medicine ? '<div style="margin-bottom:6px;"><span style="color:#999;font-size:0.82rem;">약제: </span><span style="color:#d4c8b8;font-size:0.88rem;font-weight:700;">' + (log.medicineName || log.medicine) + '</span></div>' : '') +
                        (log.method ? '<div style="margin-bottom:6px;"><span style="color:#999;font-size:0.82rem;">처리방법: </span><span style="color:#d4c8b8;font-size:0.85rem;">' + log.method + '</span></div>' : '') +
                        (log.memo ? '<div style="background:rgba(0,0,0,0.25);padding:8px;border-radius:8px;color:#d4c8b8;font-size:0.85rem;margin-top:6px;white-space:pre-wrap;">' + log.memo + '</div>' : '') +
                    '</div>';
                });
                html += '</div>';
            }

            if((!data || !data.records || data.records.length === 0) && daySchedules.length === 0 && dayDiseaseRecords.length === 0) {
                html += '<p class="text-center py-20" style="color: #666; font-style: italic;">이 날짜에 기록된 일지 및 일정이 없습니다.</p>';
            }
            
            list.innerHTML = html;
        }

        // ==================== 일지 수정/삭제 ====================
        function editDayRecord(key, recordIndex) {
            const data = db[key];
            if(!data || !data.records || !data.records[recordIndex]) {
                showToast('⚠️ 기록을 찾을 수 없습니다');
                return;
            }
            
            const record = data.records[recordIndex];
            
            // 수정 UI 표시
            const list = document.getElementById('record-list');
            
            let html = '<div style="background: rgba(30,25,20,0.9); padding: 20px; border-radius: 12px; border: 2px solid #FFB300;">' +
                       '<h4 class="font-bold mb-4" style="color: #FFB300; font-size: 1.2rem;">📝 ' + key + ' 기록 수정</h4>' +
                       
                       '<div class="mb-4">' +
                           '<label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">봉장 위치</label>' +
                           '<input type="text" id="edit-loc" value="' + record.loc + '" class="field" style="background: rgba(40,30,25,0.8);" readonly>' +
                       '</div>' +
                       
                       '<div class="mb-4">' +
                           '<label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">작업 내용 (쉼표로 구분)</label>' +
                           '<input type="text" id="edit-works" value="' + record.works.join(', ') + '" class="field" style="background: rgba(40,30,25,0.8);">' +
                       '</div>' +
                       
                       '<div class="mb-4">' +
                           '<label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">상세 메모</label>' +
                           '<textarea id="edit-memo" class="field" style="height: 120px; background: rgba(40,30,25,0.8);">' + (record.memo || '') + '</textarea>' +
                       '</div>' +
                       
                       '<div style="display: flex; gap: 10px; margin-top: 20px;">' +
                           '<button onclick="saveEditedDayRecord(\'' + key + '\', ' + recordIndex + ')" style="flex: 1; background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">✅ 저장</button>' +
                           '<button onclick="showDayWithSchedule(\'' + key + '\')" style="flex: 1; background: rgba(100,100,100,0.5); color: white; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">❌ 취소</button>' +
                       '</div>' +
                   '</div>';
            
            list.innerHTML = html;
        }

        function saveEditedDayRecord(key, recordIndex) {
            const works = document.getElementById('edit-works').value;
            const memo = document.getElementById('edit-memo').value;
            
            // 작업 내용 파싱
            const worksArray = works.split(',').map(function(w) { return w.trim(); }).filter(function(w) { return w; });
            
            if(worksArray.length === 0 && !memo.trim()) {
                showToast('⚠️ 작업 내용이나 메모를 입력해주세요');
                return;
            }
            
            // 해당 인덱스의 기록만 수정
            db[key].records[recordIndex].works = worksArray;
            db[key].records[recordIndex].memo = memo;
            db[key].records[recordIndex].timestamp = new Date().toISOString();
            
            localStorage.setItem('beeData', JSON.stringify(db));
            
            showToast('✅ 기록이 수정되었습니다');
            showDayWithSchedule(key);
            renderCalendar();
        }

        function deleteDayRecord(key, recordIndex) {
            if(!db[key] || !db[key].records || !db[key].records[recordIndex]) {
                showToast('⚠️ 기록을 찾을 수 없습니다');
                return;
            }
            
            const record = db[key].records[recordIndex];
            
            if(!confirm(key + ' ' + record.loc + ' 일지 기록을 삭제하시겠습니까?')) {
                return;
            }
            
            // 왕대이충 작업이 있는 경우 11일 후 출방 이벤트 삭제
            if(record.works && record.works.includes('왕대이충')) {
                const parts = key.split('-');
                const recordDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                const queenDate = new Date(recordDate);
                queenDate.setDate(queenDate.getDate() + 11);
                
                const qy = queenDate.getFullYear();
                const qm = queenDate.getMonth() + 1;
                const qd = queenDate.getDate();
                const queenKey = qy + '-' + qm + '-' + qd;
                
                if(db[queenKey]) {
                    db[queenKey].isQueen = false;
                    if(!db[queenKey].records || db[queenKey].records.length === 0) {
                        if(!db[queenKey].isDiseaseAlarm) {
                            delete db[queenKey];
                        }
                    }
                }
            }
            
            // 같은 날짜+봉장의 방역기록도 함께 삭제
            var diseaseRemoved = 0;
            for(var di = diseaseLogs.length - 1; di >= 0; di--) {
                var dlog = diseaseLogs[di];
                if(dlog.dateStr === key && dlog.location === record.loc) {
                    // 알람 키 달력 표시 제거
                    if(dlog.alarmKey && db[dlog.alarmKey]) {
                        db[dlog.alarmKey].isDiseaseAlarm = false;
                        db[dlog.alarmKey].alarmLocation = '';
                        if(!db[dlog.alarmKey].records?.length && !db[dlog.alarmKey].isQueen) {
                            delete db[dlog.alarmKey];
                        }
                    }
                    diseaseLogs.splice(di, 1);
                    diseaseRemoved++;
                }
            }
            if(diseaseRemoved > 0) {
                localStorage.setItem('diseaseLogs', JSON.stringify(diseaseLogs));
            }

            // 해당 인덱스의 일지 기록 삭제
            db[key].records.splice(recordIndex, 1);
            
            // records가 비어있으면 날짜 키 전체 삭제
            if(db[key].records.length === 0 && !db[key].isQueen && !db[key].isDiseaseAlarm) {
                delete db[key];
            } else {
                db[key].hasData = db[key].records.length > 0;
            }
            
            localStorage.setItem('beeData', JSON.stringify(db));
            
            showToast('✅ 일지' + (diseaseRemoved > 0 ? ' + 방역기록 ' + diseaseRemoved + '건이' : '가') + ' 삭제되었습니다');
            renderCalendar();
            
            // 남은 기록이 있으면 표시, 없으면 삭제 메시지
            if(db[key] && db[key].records && db[key].records.length > 0) {
                showDayWithSchedule(key);
            } else {
                document.getElementById('record-list').innerHTML = 
                    '<p class="text-center py-20" style="color: #666; font-style: italic;">삭제되었습니다.</p>';
            }
        }

        // ==================== 방역일지 렌더링 및 수정/삭제 ====================
        // ==================== 방역일지 기간별 조회 ====================
        var diseaseHistoryTab = 'loc'; // 'loc' | 'period'

        function switchDiseaseHistoryTab(tab) {
            diseaseHistoryTab = tab;
            var locBtn = document.getElementById('dh-tab-loc');
            var perBtn = document.getElementById('dh-tab-period');
            var locPanel = document.getElementById('dh-panel-loc');
            var perPanel = document.getElementById('dh-panel-period');
            if(!locBtn) return;
            if(tab === 'loc') {
                locBtn.style.background = 'rgba(255,179,0,0.3)'; locBtn.style.color = '#FFD54F';
                perBtn.style.background = 'rgba(40,30,25,0.6)';  perBtn.style.color = '#999';
                locPanel.style.display = 'block';
                perPanel.style.display = 'none';
                renderDiseaseHistory();
            } else {
                perBtn.style.background = 'rgba(255,179,0,0.3)'; perBtn.style.color = '#FFD54F';
                locBtn.style.background = 'rgba(40,30,25,0.6)';  locBtn.style.color = '#999';
                locPanel.style.display = 'none';
                perPanel.style.display = 'block';
                // 기본 날짜 설정 (이번달)
                var now = new Date();
                var y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0');
                var fromEl = document.getElementById('dh-date-from');
                var toEl = document.getElementById('dh-date-to');
                if(fromEl && !fromEl.value) fromEl.value = y + '-' + m + '-01';
                if(toEl && !toEl.value) {
                    var lastDay = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
                    toEl.value = y + '-' + m + '-' + String(lastDay).padStart(2,'0');
                }
                renderDiseaseHistoryPeriod();
            }
        }

        function setDiseasePeriod(days) {
            var now = new Date();
            var toEl = document.getElementById('dh-date-to');
            var fromEl = document.getElementById('dh-date-from');
            if(!toEl || !fromEl) return;
            var toDate = new Date(now);
            toEl.value = toDate.toISOString().substring(0, 10);
            if(days === 0) {
                fromEl.value = '2020-01-01';
            } else {
                var fromDate = new Date(now);
                fromDate.setDate(fromDate.getDate() - days + 1);
                fromEl.value = fromDate.toISOString().substring(0, 10);
            }
            renderDiseaseHistoryPeriod();
        }

        function renderDiseaseHistoryPeriod() {
            var container = document.getElementById('history-period-view');
            if(!container) return;
            var fromEl = document.getElementById('dh-date-from');
            var toEl   = document.getElementById('dh-date-to');
            if(!fromEl || !fromEl.value || !toEl || !toEl.value) {
                container.innerHTML = '<p class="text-center py-20" style="color:#666; font-style:italic;">기간을 선택하세요.</p>';
                return;
            }
            var fromStr = fromEl.value; // yyyy-mm-dd
            var toStr   = toEl.value;

            // diseaseLogs에서 기간 필터
            var filtered = [];
            (diseaseLogs || []).forEach(function(log, i) {
                if(!log.dateStr) return;
                // log.dateStr 형식: yyyy-m-d → ISO형식으로 변환 비교
                var parts = log.dateStr.split('-');
                var dateISO = parts[0] + '-' + String(parts[1]).padStart(2,'0') + '-' + String(parts[2]).padStart(2,'0');
                if(dateISO >= fromStr && dateISO <= toStr) {
                    filtered.push({ log, i });
                }
            });

            // 최신순 정렬
            filtered.sort(function(a, b) { return b.log.dateStr > a.log.dateStr ? 1 : -1; });

            if(filtered.length === 0) {
                container.innerHTML = '<p class="text-center py-20" style="color:#666; font-style:italic;">해당 기간의 방역 기록이 없습니다.</p>';
                return;
            }

            // 요약 통계
            var locMap = {};
            filtered.forEach(function(f) {
                var loc = f.log.location || '미상';
                locMap[loc] = (locMap[loc] || 0) + 1;
            });
            var summaryItems = Object.entries(locMap).map(function(e) { return e[0] + ' ' + e[1] + '건'; }).join(' · ');

            var html = '<div style="background:rgba(255,179,0,0.1); border:1px solid rgba(255,179,0,0.3); border-radius:10px; padding:12px; margin-bottom:14px;">'
                + '<div style="color:#FFD54F; font-weight:700; margin-bottom:4px;">📊 조회 결과: ' + filtered.length + '건</div>'
                + '<div style="color:#999; font-size:0.8rem;">' + summaryItems + '</div></div>';

            filtered.forEach(function(f) {
                var log = f.log;
                var i = f.i;
                var diseaseInfo = log.diseaseTypeName || log.diseaseType || '미상';
                var dateInfo = log.dateStr || '';
                var locIcon = (log.location || '').includes('이동') ? '🚚' : '📍';
                var medicineText = log.medicineName || log.medicine || '미기재';
                html += '<div style="background:rgba(30,25,20,0.9); border:1px solid rgba(255,179,0,0.15); border-left:4px solid #dc2626; border-radius:12px; padding:16px; margin-bottom:12px;">'
                    + '<div style="color:#ef4444; font-weight:800; font-size:1rem; margin-bottom:6px;">🦠 ' + diseaseInfo + '</div>'
                    + '<div style="color:#999; font-size:0.85rem; margin-bottom:8px;">' + locIcon + ' ' + (log.location || '') + ' • ' + dateInfo + '</div>'
                    + '<div style="font-size:0.85rem; color:#aaa; margin-bottom:4px;">약제 정보</div>'
                    + '<div style="background:rgba(255,179,0,0.1); border-radius:8px; padding:8px; margin-bottom:8px;">'
                    + '<span style="color:#FFB300;">💊 ' + medicineText + '</span>'
                    + (log.detail ? ' · ' + log.detail : '')
                    + (log.method ? ' · ' + log.method : '') + '</div>'
                    + (log.memo ? '<div style="color:#aaa; font-size:0.82rem; margin-bottom:8px;">📝 ' + log.memo + '</div>' : '')
                    + '<div style="color:#555; font-size:0.75rem;">기록: ' + new Date(log.timestamp||log.date).toLocaleString('ko-KR') + '</div>'
                    + '</div>';
            });

            container.innerHTML = html;
        }

        function renderDiseaseHistory() {
            const container = document.getElementById('history-list-view');
            if(!container) return;
            
            if(!diseaseLogs || diseaseLogs.length === 0) {
                container.innerHTML = '<p class="text-center py-20" style="color: #666; font-style: italic;">방역 기록이 없습니다.</p>';
                return;
            }
            
            // 봉장 필터 적용
            const filtered = [];
            for(let i = diseaseLogs.length - 1; i >= 0; i--) {
                const log = diseaseLogs[i];
                if(diseaseLocFilter === 'all' || log.location === diseaseLocFilter) {
                    filtered.push({ log, i });
                }
            }

            if(filtered.length === 0) {
                container.innerHTML = '<p class="text-center py-20" style="color: #666; font-style: italic;">' + 
                    (diseaseLocFilter === 'all' ? '방역 기록이 없습니다.' : diseaseLocFilter + ' 방역 기록이 없습니다.') + '</p>';
                return;
            }

            let html = '';
            
            for(const { log, i } of filtered) {
                const dateObj = new Date(log.timestamp);
                const dateStr = dateObj.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="record-card" style="border-left: 4px solid #ef4444;">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <p class="font-bold text-lg" style="color: #ef4444;">🦠 ${log.diseaseTypeName || log.diseaseType}</p>
                                <p class="text-sm mt-1" style="color: #999;">📍 ${log.location} • ${log.dateStr}</p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="dyn-btn" data-action="editDiseaseRecord" data-index="${i}" style="background: rgba(59,130,246,0.3); color: #60a5fa; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; border: none; cursor: pointer; font-weight: 700;">수정</button>
                                <button class="dyn-btn" data-action="deleteDiseaseRecord" data-index="${i}" style="background: #dc2626; color: #ffffff; padding: 6px 14px; border-radius: 6px; font-size: 0.85rem; border: none; cursor: pointer; font-weight: 800; letter-spacing: 0.5px;">삭제</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <p class="text-xs mb-2" style="color: #999;">약제 정보</p>
                            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                <p style="color: #d4c8b8; font-size: 0.9rem;">
                                    💊 ${log.medicineName || log.medicine || '미기재'}
                                    ${log.detail ? ' (' + log.detail + ')' : ''}
                                </p>
                                ${log.method ? '<p style="color: #999; font-size: 0.85rem; margin-top: 4px;">처리방법: ' + log.method + '</p>' : ''}
                            </div>
                        </div>
                        
                        ${log.memo ? `
                        <div class="mb-3">
                            <p class="text-xs mb-2" style="color: #999;">상세 메모</p>
                            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; color: #d4c8b8; font-size: 0.85rem; white-space: pre-wrap;">${log.memo}</div>
                        </div>
                        ` : ''}
                        
                        ${log.photos && log.photos.length > 0 ? `
                        <div class="mb-3">
                            <p class="text-xs mb-2" style="color: #999;">첨부 사진 (${log.photos.length}장)</p>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                ${log.photos.map(p => '<img src="' + p + '" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 6px; cursor: pointer;" onclick="showPhotoModal(\'' + p + '\')">').join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="text-xs mt-3 pt-3" style="color: #666; border-top: 1px solid rgba(255,179,0,0.1);">
                            기록 시간: ${dateStr}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function editDiseaseRecord(index) {
            const log = diseaseLogs[index];
            if(!log) {
                showToast('⚠️ 기록을 찾을 수 없습니다');
                return;
            }
            
            const container = document.getElementById('history-list-view');
            
            // 날짜 포맷팅
            const dateObj = new Date(log.timestamp);
            const dateStr = dateObj.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let html = `
                <div style="background: rgba(30,25,20,0.9); padding: 20px; border-radius: 12px; border: 2px solid #ef4444;">
                    <h4 class="font-bold mb-4" style="color: #ef4444; font-size: 1.2rem;">📝 방역일지 수정</h4>
                    
                    <div class="mb-4">
                        <label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">기록 날짜</label>
                        <input type="text" value="${log.dateStr || ''}" class="field" style="background: rgba(40,30,25,0.8);" readonly>
                    </div>
                    
                    <div class="mb-4">
                        <label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">봉장 위치</label>
                        <input type="text" value="${log.location || ''}" class="field" style="background: rgba(40,30,25,0.8);" readonly>
                    </div>
                    
                    <div class="mb-4">
                        <label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">질병 종류</label>
                        <input type="text" value="${log.diseaseTypeName || log.diseaseType}" class="field" style="background: rgba(40,30,25,0.8);" readonly>
                    </div>
                    
                    <div class="mb-4">
                        <label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">약제</label>
                        <input type="text" value="${log.medicineName || log.medicine || '미기재'}" class="field" style="background: rgba(40,30,25,0.8);" readonly>
                    </div>
                    
                    <div class="mb-4">
                        <label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">약품명 상세 (수정 가능)</label>
                        <input type="text" id="edit-disease-detail" value="${log.detail || ''}" class="field" style="background: rgba(40,30,25,0.8);" placeholder="예: 왕스, 85%, 1G 등">
                    </div>
                    
                    <div class="mb-4">
                        <label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">처리 방법 (수정 가능)</label>
                        <input type="text" id="edit-disease-method" value="${log.method || ''}" class="field" style="background: rgba(40,30,25,0.8);" placeholder="예: 분무, 연무, 투입 등">
                    </div>
                    
                    <div class="mb-4">
                        <label style="display: block; color: #999; font-size: 0.85rem; margin-bottom: 8px;">상세 메모 (수정 가능)</label>
                        <textarea id="edit-disease-memo" class="field" style="height: 120px; background: rgba(40,30,25,0.8);" placeholder="상세 메모를 입력하세요...">${log.memo || ''}</textarea>
                    </div>
                    
                    <div class="text-xs mb-4 pb-3" style="color: #666; border-bottom: 1px solid rgba(255,179,0,0.1);">
                        기록 시간: ${dateStr}
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveDiseaseEdit(${index})" style="flex: 1; background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">✅ 저장</button>
                        <button onclick="renderDiseaseHistory()" style="flex: 1; background: rgba(100,100,100,0.5); color: white; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;">❌ 취소</button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function saveDiseaseEdit(index) {
            const log = diseaseLogs[index];
            if(!log) {
                showToast('⚠️ 기록을 찾을 수 없습니다');
                return;
            }
            
            try {
                const detail = document.getElementById('edit-disease-detail').value.trim();
                const method = document.getElementById('edit-disease-method').value.trim();
                const memo = document.getElementById('edit-disease-memo').value.trim();
                
                // 수정된 내용 저장
                diseaseLogs[index].detail = detail;
                diseaseLogs[index].method = method;
                diseaseLogs[index].memo = memo;
                
                localStorage.setItem('diseaseLogs', JSON.stringify(diseaseLogs));
                
                showToast('✅ 방역일지가 수정되었습니다');
                renderDiseaseHistory();
                
            } catch(error) {
                console.error('저장 오류:', error);
                showToast('❌ 저장 중 오류가 발생했습니다');
            }
        }
        
        function deleteDiseaseRecord(index) {
            const log = diseaseLogs[index];
            if(!log) {
                showToast('⚠️ 기록을 찾을 수 없습니다');
                return;
            }
            
            const diseaseInfo = log.diseaseTypeName || log.diseaseType;
            const dateInfo = log.dateStr || '날짜 미상';
            
            if(!confirm(`[${dateInfo}] ${diseaseInfo} 방역 기록을 삭제하시겠습니까?`)) {
                return;
            }
            
            try {
                // 1) 알람 날짜(미래) 달력 표시 제거
                if(log.alarmKey && db[log.alarmKey]) {
                    db[log.alarmKey].isDiseaseAlarm = false;
                    db[log.alarmKey].alarmLocation = '';
                    if(!db[log.alarmKey].records?.length && !db[log.alarmKey].isQueen) {
                        delete db[log.alarmKey];
                    }
                }
                
                // 2) 기록 날짜 달력 표시 제거
                // 같은 날짜에 다른 방역기록이 남아있는지 확인 후 처리
                if(log.dateStr && db[log.dateStr]) {
                    var remainingDiseaseOnDate = diseaseLogs.filter(function(dl, i2) {
                        return i2 !== index && dl.dateStr === log.dateStr;
                    });
                    if(remainingDiseaseOnDate.length === 0) {
                        db[log.dateStr].isDiseaseAlarm = false;
                        db[log.dateStr].alarmLocation = '';
                        if(!db[log.dateStr].records?.length && !db[log.dateStr].isQueen) {
                            delete db[log.dateStr];
                        }
                    }
                }
                
                // 3) 혹시 모를 다른 날짜 알람도 전체 검색하여 제거
                // (이전에 alarmKey 없이 저장된 기존 데이터 호환)
                Object.keys(db).forEach(function(k) {
                    if(db[k].isDiseaseAlarm && db[k].alarmLocation === log.location) {
                        // 같은 봉장의 알람이 기록 날짜 이후라면 제거
                        db[k].isDiseaseAlarm = false;
                        db[k].alarmLocation = '';
                        if(!db[k].records?.length && !db[k].isQueen) {
                            delete db[k];
                        }
                    }
                });
                
                localStorage.setItem('beeData', JSON.stringify(db));
                
                // 4) 방역일지에서 삭제
                diseaseLogs.splice(index, 1);
                localStorage.setItem('diseaseLogs', JSON.stringify(diseaseLogs));
                
                showToast('✅ 방역일지가 삭제되었습니다');
                renderDiseaseHistory();
                renderCalendar();
                
            } catch(error) {
                console.error('삭제 오류:', error);
                showToast('❌ 삭제 중 오류가 발생했습니다');
            }
        }

        // ==================== 가계부 수정/삭제 ====================
        function editAccountRecord(index) {
            const log = accLogs[index];
            if(!log) { showToast('⚠️ 기록을 찾을 수 없습니다'); return; }

            const typeColor = log.type === 'in' ? '#4ade80' : '#f87171';
            const typeText  = log.type === 'in' ? '수입' : '지출';

            // 각 품목행 HTML 생성
            const linesHtml = (log.lines && log.lines.length > 0)
                ? log.lines.map(function(ln, li) {
                    return '<div style="display:flex; gap:6px; margin-bottom:6px; align-items:center;">'
                        + '<input type="text"  id="edit-acc-line-name-'+li+'" value="'+ln.name+'" class="field" style="flex:2;" placeholder="품목명">'
                        + '<input type="number" id="edit-acc-line-qty-'+li+'"  value="'+ln.qty+'"  class="field" style="flex:1;" placeholder="수량" min="1">'
                        + '<input type="number" id="edit-acc-line-price-'+li+'" value="'+ln.unitPrice+'" class="field" style="flex:2;" placeholder="단가" min="0">'
                        + '</div>';
                  }).join('')
                : '<div style="display:flex; gap:6px; margin-bottom:6px;">'
                    + '<input type="text"  id="edit-acc-line-name-0" value="'+(log.item||'')+'" class="field" style="flex:2;" placeholder="품목명">'
                    + '<input type="number" id="edit-acc-line-qty-0"  value="1" class="field" style="flex:1;" placeholder="수량">'
                    + '<input type="number" id="edit-acc-line-price-0" value="'+(log.price||0)+'" class="field" style="flex:2;" placeholder="단가">'
                    + '</div>';

            const lineCount = (log.lines && log.lines.length > 0) ? log.lines.length : 1;

            const modal = document.getElementById('acc-edit-modal');
            document.getElementById('acc-edit-modal-body').innerHTML =
                '<h4 style="color:'+typeColor+'; font-weight:900; font-size:1.1rem; margin-bottom:16px;">📝 가계부 수정 <span style="font-size:0.8rem; background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:8px;">'+typeText+'</span></h4>'
                + '<div style="color:#999; font-size:0.78rem; margin-bottom:6px;">품목명 · 수량 · 단가</div>'
                + linesHtml
                + (log.customerName ? '<div style="margin-top:10px; padding:8px 12px; background:rgba(0,0,0,0.3); border-radius:8px; color:#94a3b8; font-size:0.85rem;">👤 '
                    +log.customerName+(log.customerPhone?' · '+log.customerPhone:'')+'</div>' : '')
                + '<div style="display:flex; gap:8px; margin-top:18px;">'
                + '<button onclick="saveAccountEdit('+index+','+lineCount+')" style="flex:1; background:linear-gradient(135deg,#4ade80,#16a34a); color:#fff; padding:12px; border-radius:10px; font-weight:700; border:none; cursor:pointer; min-height:44px;">✅ 저장</button>'
                + '<button onclick="closeAccEditModal()" style="flex:1; background:rgba(100,100,100,0.4); color:#ccc; padding:12px; border-radius:10px; font-weight:700; border:none; cursor:pointer; min-height:44px;">취소</button>'
                + '</div>';

            modal.style.display = 'flex';
        }

        function closeAccEditModal() {
            var m = document.getElementById('acc-edit-modal');
            if(m) m.style.display = 'none';
        }
        
        function saveAccountEdit(index, lineCount) {
            var newLines = [];
            for(var li = 0; li < lineCount; li++) {
                var nameEl  = document.getElementById('edit-acc-line-name-'+li);
                var qtyEl   = document.getElementById('edit-acc-line-qty-'+li);
                var priceEl = document.getElementById('edit-acc-line-price-'+li);
                if(!nameEl) continue;
                var name  = nameEl.value.trim();
                var qty   = parseInt(qtyEl ? qtyEl.value : 1) || 1;
                var price = parseInt(priceEl ? priceEl.value : 0) || 0;
                if(name) newLines.push({ name: name, qty: qty, unitPrice: price, subtotal: qty * price });
            }

            if(newLines.length === 0) { showToast('⚠️ 품목명을 입력해주세요'); return; }
            var total = newLines.reduce(function(s, l){ return s + l.subtotal; }, 0);
            if(total <= 0) { showToast('⚠️ 금액은 0보다 커야 합니다'); return; }

            accLogs[index].lines = newLines;
            accLogs[index].item  = newLines.map(function(l){ return l.name; }).join(', ');
            accLogs[index].items = newLines.map(function(l){ return l.name; });
            accLogs[index].price = total;

            localStorage.setItem('beeMoney', JSON.stringify(accLogs));
            closeAccEditModal();
            showToast('✅ 가계부가 수정되었습니다');
            renderStatView();
            renderAccCalendar();
            renderAccTodaySummary();
        }
        
        function deleteAccountRecord(index) {
            const log = accLogs[index];
            if(!log) return;
            
            if(!confirm(`${log.item} (${log.price.toLocaleString()}원) 기록을 삭제하시겠습니까?`)) return;
            
            accLogs.splice(index, 1);
            localStorage.setItem('beeMoney', JSON.stringify(accLogs));
            
            showToast('✅ 가계부가 삭제되었습니다');
            renderStatView();
            renderAccCalendar();
        }

        // ==================== 봉장 지도 (VWorld + Leaflet) ====================


var VK = 'F00592E3-2B83-38D8-9EBA-DA543461A436';

var ADB = [
  {k:'평택 진위면',lat:37.063,lng:127.052},{k:'평택 오성면',lat:37.082,lng:127.023},
  {k:'평택 서탄면',lat:37.051,lng:127.082},{k:'평택 현덕면',lat:37.001,lng:126.970},
  {k:'평택 팽성읍',lat:37.012,lng:127.025},{k:'평택 청북읍',lat:37.023,lng:126.954},
  {k:'평택 포승읍',lat:36.989,lng:126.986},{k:'평택 안중읍',lat:36.993,lng:126.924},
  {k:'평택 고덕면',lat:37.038,lng:127.100},{k:'평택 송탄',lat:37.084,lng:127.065},
  {k:'평택시',lat:37.063,lng:127.080},{k:'평택',lat:37.063,lng:127.080},
  {k:'안성 공도읍',lat:37.082,lng:127.143},{k:'안성 미양면',lat:37.043,lng:127.210},
  {k:'안성 금광면',lat:37.052,lng:127.244},{k:'안성 일죽면',lat:37.008,lng:127.440},
  {k:'안성 양성면',lat:37.012,lng:127.193},{k:'안성시',lat:37.008,lng:127.270},{k:'안성',lat:37.008,lng:127.270},
  {k:'화성 봉담읍',lat:37.212,lng:126.988},{k:'화성 우정읍',lat:37.087,lng:126.780},
  {k:'화성 팔탄면',lat:37.193,lng:126.878},{k:'화성 향남읍',lat:37.150,lng:126.912},
  {k:'화성시',lat:37.199,lng:126.831},{k:'화성',lat:37.199,lng:126.831},
  {k:'용인 남사읍',lat:37.152,lng:127.157},{k:'용인 처인구',lat:37.234,lng:127.205},
  {k:'용인 기흥구',lat:37.278,lng:127.116},{k:'용인 수지구',lat:37.322,lng:127.096},
  {k:'용인시',lat:37.238,lng:127.200},{k:'용인',lat:37.238,lng:127.200},
  {k:'수원시',lat:37.263,lng:127.028},{k:'수원',lat:37.263,lng:127.028},
  {k:'오산시',lat:37.150,lng:127.076},{k:'오산',lat:37.150,lng:127.076},
  {k:'이천시',lat:37.272,lng:127.435},{k:'이천',lat:37.272,lng:127.435},
  {k:'여주시',lat:37.298,lng:127.637},{k:'여주',lat:37.298,lng:127.637},
  {k:'천안시',lat:36.806,lng:127.152},{k:'천안',lat:36.806,lng:127.152},
  {k:'아산시',lat:36.789,lng:127.002},{k:'아산',lat:36.789,lng:127.002},
  {k:'아산 도고면',lat:36.816,lng:126.914},{k:'아산 배방읍',lat:36.805,lng:127.021},
  {k:'당진시',lat:36.889,lng:126.629},{k:'당진',lat:36.889,lng:126.629},
  {k:'서산시',lat:36.779,lng:126.452},{k:'서산',lat:36.779,lng:126.452},
  {k:'홍성군',lat:36.601,lng:126.661},{k:'홍성',lat:36.601,lng:126.661},
  {k:'예산군',lat:36.681,lng:126.849},{k:'예산',lat:36.681,lng:126.849},
  {k:'논산시',lat:36.187,lng:127.099},{k:'논산',lat:36.187,lng:127.099},
  {k:'보령시',lat:36.333,lng:126.614},{k:'보령',lat:36.333,lng:126.614},
  {k:'서울',lat:37.566,lng:126.978},{k:'부산',lat:35.179,lng:129.075},
  {k:'대구',lat:35.871,lng:128.602},{k:'인천',lat:37.456,lng:126.705},
  {k:'광주',lat:35.160,lng:126.851},{k:'대전',lat:36.351,lng:127.385},
  {k:'울산',lat:35.538,lng:129.312},{k:'제주',lat:33.499,lng:126.531},
  {k:'세종',lat:36.480,lng:127.289},{k:'춘천',lat:37.881,lng:127.730},
  {k:'강릉',lat:37.751,lng:128.876},{k:'청주',lat:36.642,lng:127.489},
  {k:'전주',lat:35.824,lng:127.148},{k:'순천',lat:34.950,lng:127.487},
  {k:'창원',lat:35.228,lng:128.681},{k:'진주',lat:35.180,lng:128.107},
  {k:'포항',lat:36.019,lng:129.343},{k:'경주',lat:35.856,lng:129.225},
  {k:'안동',lat:36.569,lng:128.729},{k:'원주',lat:37.342,lng:127.921}
];

function jsonp(url, cb) {
  var fn = 'vw_' + Date.now() + '_' + Math.random().toString(36).slice(2);
  window[fn] = function(data) { try{document.head.removeChild(s);}catch(e){} delete window[fn]; cb(data); };
  var s = document.createElement('script');
  s.src = url + '&callback=' + fn;
  s.onerror = function() { try{document.head.removeChild(s);}catch(e){} delete window[fn]; cb(null); };
  document.head.appendChild(s);
}

function nearAddr(lat, lng, cb) {
  var url = 'https://api.vworld.kr/req/address?service=address&request=getAddress&version=2.0'
    + '&crs=epsg:4326&point=' + lng + ',' + lat
    + '&format=json&type=both&zipcode=false&simple=false&key=' + VK;
  jsonp(url, function(data) {
    if(data && data.response && data.response.status === 'OK') {
      var res = data.response.result;
      var road  = res.filter(function(r){return r.type==='road';})[0];
      var jibun = res.filter(function(r){return r.type==='parcel';})[0];
      cb((road?road.text:'') || (jibun?jibun.text:'') || '');
    } else { cb(''); }
  });
}

function addrToCoord(addr, cb) {
  var url = 'https://api.vworld.kr/req/search?service=search&request=search&version=2.0'
    + '&crs=epsg:4326&query=' + encodeURIComponent(addr)
    + '&type=address&category=road&format=json&errorformat=json&key=' + VK;
  jsonp(url, function(data) {
    if(data && data.response && data.response.status==='OK'
       && data.response.result && data.response.result.items && data.response.result.items.length>0) {
      var it = data.response.result.items[0];
      cb(parseFloat(it.point.y), parseFloat(it.point.x), it.title||addr); return;
    }
    var url2 = 'https://api.vworld.kr/req/search?service=search&request=search&version=2.0'
      + '&crs=epsg:4326&query=' + encodeURIComponent(addr)
      + '&type=address&category=parcel&format=json&errorformat=json&key=' + VK;
    jsonp(url2, function(data2) {
      if(data2 && data2.response && data2.response.status==='OK'
         && data2.response.result && data2.response.result.items && data2.response.result.items.length>0) {
        var it2 = data2.response.result.items[0];
        cb(parseFloat(it2.point.y), parseFloat(it2.point.x), it2.title||addr);
      } else { addrDB(addr, cb); }
    });
  });
}

function addrDB(addr, cb) {
  function norm(s){return s.replace(/\s/g,'').replace(/시$|군$|구$/,'').replace(/읍$|면$|동$|리$/,'');}
  var q=norm(addr), found=null, bl=0;
  ADB.forEach(function(r){ var k=norm(r.k); if(q.indexOf(k)>=0||k.indexOf(q)>=0){ if(r.k.length>bl){bl=r.k.length;found=r;} } });
  if(found){cb(found.lat,found.lng,found.k);}else{cb(null,null,null);}
}

var AS = (function(){try{return JSON.parse(localStorage.getItem('apiarySettings'));}catch(e){return null;}})()
  || {'1봉장':true,'2봉장':true,'3봉장':true,'이동1봉장':false,'이동2봉장':false,'이동3봉장':false};
var AL = (function(){try{return JSON.parse(localStorage.getItem('apiaryLocations'))||{};}catch(e){return{};}})();

function getNames(){return Object.keys(AS).filter(function(k){return AS[k];});}
function saveLocs(){try{localStorage.setItem('apiaryLocations',JSON.stringify(AL));return true;}catch(e){showToast('⚠️ 저장 실패');return false;}}

var vmap=null, tiles=[], aMks=[], myMk=null, myC=null, myPos=null, wid=null;
var mapFilter='all'; // 'all' | 'western' | 'native'
var tpins={}, openForm=null, gpsMoved=false, NAMES=[];
var formLat={}, formLng={};

function getDisplayName(apiaryName) {
  try {
    var info = JSON.parse(localStorage.getItem('beeUserInfo') || '{}');
    var farm = (info.farmname || info.nickname || '').trim();
    if(farm) return farm + ' ' + apiaryName;
  } catch(e) {}
  return apiaryName;
}

function initMap(){
  if(vmap) return;
  vmap=L.map('vmap',{center:[36.5,127.8],zoom:7,zoomControl:true,attributionControl:false});
  setTile('sat');
  setTimeout(function(){
    vmap.invalidateSize();
    renderAList();
    renderAMks();
    startGPS();
    // 초기 뷰: 등록된 봉장 우선, 없으면 GPS
    var registered = getNames().filter(function(n){return AL[n]&&AL[n].lat;});
    if(registered.length > 0){
      if(registered.length === 1){
        var d = AL[registered[0]];
        vmap.setView([d.lat, d.lng], 14);
      } else {
        // 여러 봉장이면 전체가 보이는 범위로
        var lats = registered.map(function(n){return AL[n].lat;});
        var lngs = registered.map(function(n){return AL[n].lng;});
        var minLat = Math.min.apply(null,lats), maxLat = Math.max.apply(null,lats);
        var minLng = Math.min.apply(null,lngs), maxLng = Math.max.apply(null,lngs);
        vmap.fitBounds([[minLat,minLng],[maxLat,maxLng]], {padding:[40,40]});
      }
      showToast('📂 저장된 봉장 '+registered.length+'개 복원됨');
    }
    // GPS는 별도로 계속 추적 (위치바 표시용)
  },600);
}

function setTile(type){
  tiles.forEach(function(l){vmap.removeLayer(l);}); tiles=[];
  if(type==='sat'){
    tiles.push(L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+VK+'/Satellite/{z}/{y}/{x}.jpeg',{maxZoom:19}).addTo(vmap));
    tiles.push(L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+VK+'/Hybrid/{z}/{y}/{x}.png',{maxZoom:19,opacity:0.85}).addTo(vmap));
  } else {
    tiles.push(L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+VK+'/Base/{z}/{y}/{x}.png',{maxZoom:19}).addTo(vmap));
  }
  document.getElementById('bsat').classList.toggle('on',type==='sat');
  document.getElementById('bbase').classList.toggle('on',type==='base');
}

function startGPS(){
  if(!navigator.geolocation){showToast('⚠️ GPS 미지원');return;}
  if(wid) return; // 이미 실행 중이면 재실행 안함
  gpsMoved=false;
  document.getElementById('gst').textContent='📡 GPS 확인중...';
  wid=navigator.geolocation.watchPosition(onGPS,function(e){
    document.getElementById('gst').textContent=e.code===1?'🔒 위치권한 차단':'⚠️ GPS없음'; document.getElementById('gst').style.color='#ff8a80';
  },{enableHighAccuracy:true,timeout:20000,maximumAge:0});
}

function onGPS(pos){
  var lat=pos.coords.latitude, lng=pos.coords.longitude, acc=Math.round(pos.coords.accuracy);
  myPos={lat:lat,lng:lng,acc:acc};
  var col=acc<=50?'#4ade80':acc<=300?'#fbbf24':'#f87171';
  var gst=document.getElementById('gst');
  gst.textContent='📍 ±'+acc+'m'; gst.style.color=col;
  if(myMk) vmap.removeLayer(myMk);
  if(myC)  vmap.removeLayer(myC);
  myC=L.circle([lat,lng],{radius:acc,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:0.1,weight:1.5}).addTo(vmap);
  myMk=L.marker([lat,lng],{icon:L.divIcon({className:'',
    html:'<div style="width:16px;height:16px;background:#3b82f6;border:3px solid #fff;border-radius:50%;box-shadow:0 0 0 4px rgba(59,130,246,0.25);"></div>',
    iconSize:[16,16],iconAnchor:[8,8]}),zIndexOffset:2000}).addTo(vmap);
  if(!gpsMoved && acc<=500){gpsMoved=true; vmap.setView([lat,lng],14);}
  document.getElementById('laddr').textContent='주소 확인 중...';
  document.getElementById('lcoord').textContent=lat.toFixed(5)+', '+lng.toFixed(5)+'  (±'+acc+'m)';
  document.getElementById('locbar').classList.add('on');
  nearAddr(lat, lng, function(addr){
    document.getElementById('laddr').textContent = addr || '위치 확인됨';
  });
}

function goMyLoc(){
  if(myPos){vmap.setView([myPos.lat,myPos.lng],15);showToast('📍 내 위치로 이동');}
  else{startGPS();showToast('📡 GPS 신호 확인 중...');}
}
function hideLocbar(){document.getElementById('locbar').classList.remove('on');}

var mapFilter='all';

function setFilter(f){
  mapFilter=f;
  ['fall','fwest','fnat'].forEach(function(id){
    var el=document.getElementById(id);
    if(el) el.classList.remove('on');
  });
  var map={'all':'fall','western':'fwest','native':'fnat'};
  var el=document.getElementById(map[f]);
  if(el) el.classList.add('on');
  renderAMks();
  renderAList();
}

function renderAMks(){
  if(!vmap) return;
  aMks.forEach(function(m){vmap.removeLayer(m);}); aMks=[];
  getNames().forEach(function(name){
    // 필터 적용
    if(mapFilter==='native') return;
    var d=AL[name];
    var mov=name.indexOf('이동')>=0;

    // 미등록 봉장 - 지도 마커 없음
    if(!d||!d.lat){ return; }

    // 비공개면 회색, 공개면 봉장 색상
    var col = d.isPublic ? (mov?'#f97316':'#FFB300') : '#666666';
    var markerEmoji = d.isPublic ? (mov?'🚚':'🐝') : (mov?'🚚':'🔒');
    var strokeCol = d.isPublic ? 'rgba(0,0,0,0.3)' : 'rgba(255,255,255,0.6)';
    var displayLabelName = getDisplayName(name);
    var icon=L.divIcon({className:'',
      html:'<div style="text-align:center;">'
        +'<div style="width:32px;height:40px;"><svg viewBox="0 0 32 40" width="32" height="40">'
        +'<path d="M16 0C7.2 0 0 7.2 0 16c0 11 16 24 16 24s16-13 16-24C32 7.2 24.8 0 16 0z" fill="'+col+'" stroke="'+strokeCol+'" stroke-width="1.5"/>'
        +'<circle cx="16" cy="16" r="9" fill="rgba(255,255,255,0.95)"/>'
        +'<text x="16" y="21" font-size="10" text-anchor="middle">'+markerEmoji+'</text>'
        +'</svg></div>'
        +'<div style="background:rgba(10,6,2,.85);color:'+col+';font-size:.62rem;font-weight:800;padding:2px 6px;border-radius:5px;white-space:nowrap;margin-top:2px;max-width:100px;overflow:hidden;text-overflow:ellipsis;">'+displayLabelName+'</div>'
        +'</div>',
      iconSize:[32,62],iconAnchor:[16,40],popupAnchor:[0,-44]
    });
    var popDiv=document.createElement('div');
    popDiv.style.cssText='background:#1e1410;border:2px solid '+col+';border-radius:10px;padding:10px 13px;min-width:175px;';
    popDiv.innerHTML='<b style="color:'+col+';">'+(mov?'🚚 ':'🐝 ')+getDisplayName(name)+'</b>'
      +(d.address?'<div style="color:#aaa;font-size:.78rem;margin-top:4px;">📍 '+d.address+'</div>':'')
      +(d.memo?'<div style="color:#666;font-size:.76rem;margin-top:2px;">📝 '+d.memo+'</div>':'');
    var pbtnRow=document.createElement('div');
    pbtnRow.style.cssText='display:flex;gap:6px;margin-top:8px;';
    var pbtnEdit=document.createElement('button');
    pbtnEdit.style.cssText='flex:1;padding:6px;background:rgba(255,179,0,.18);color:#FFD54F;border:none;border-radius:7px;font-size:.75rem;font-weight:700;cursor:pointer;';
    pbtnEdit.textContent='✏️ 수정';
    pbtnEdit.onclick=(function(n){return function(){popEdit(n);};})(name);
    var pbtnDel=document.createElement('button');
    pbtnDel.style.cssText='flex:1;padding:6px;background:rgba(185,28,28,.22);color:#f87171;border:none;border-radius:7px;font-size:.75rem;font-weight:700;cursor:pointer;';
    pbtnDel.textContent='🗑️ 삭제';
    pbtnDel.onclick=(function(n){return function(){popDel(n);};})(name);
    pbtnRow.appendChild(pbtnEdit); pbtnRow.appendChild(pbtnDel);
    popDiv.appendChild(pbtnRow);
    var mk=L.marker([d.lat,d.lng],{icon:icon});
    mk.bindPopup(popDiv,{maxWidth:220});
    mk.addTo(vmap); aMks.push(mk);
    // 등록된 모든 봉장에 반경 표시 (공개 봉장은 진하게, 비공개는 연하게)
    {
      // 흰색 외곽 반경원 (배경과 구분)
      L.circle([d.lat,d.lng],{radius:1000,color:'#ffffff',fillColor:'transparent',fillOpacity:0,weight:2,dashArray:'6,5',opacity:0.25,interactive:false}).addTo(vmap);
      L.circle([d.lat,d.lng],{radius:2000,color:'#ffffff',fillColor:'transparent',fillOpacity:0,weight:1.5,dashArray:'5,6',opacity:0.15,interactive:false}).addTo(vmap);
      var c1=L.circle([d.lat,d.lng],{radius:1000,color:col,fillColor:col,fillOpacity:0.04,weight:1.5,dashArray:'6,5',opacity:0.7,interactive:false}).addTo(vmap);
      var c2=L.circle([d.lat,d.lng],{radius:2000,color:col,fillColor:col,fillOpacity:0.02,weight:1,dashArray:'5,6',opacity:0.5,interactive:false}).addTo(vmap);
      aMks.push(c1); aMks.push(c2);
      // 반경 라벨
      var lb1=L.marker([d.lat+0.009,d.lng+0.009],{icon:L.divIcon({className:'',html:'<div style="background:rgba(10,6,2,.6);color:'+col+';font-size:.6rem;padding:1px 4px;border-radius:5px;opacity:.7;white-space:nowrap;">1km</div>',iconAnchor:[10,8]})}).addTo(vmap);
      var lb2=L.marker([d.lat+0.018,d.lng+0.018],{icon:L.divIcon({className:'',html:'<div style="background:rgba(10,6,2,.6);color:'+col+';font-size:.6rem;padding:1px 4px;border-radius:5px;opacity:.7;white-space:nowrap;">2km</div>',iconAnchor:[10,8]})}).addTo(vmap);
      aMks.push(lb1); aMks.push(lb2);
    }
  });
}

var regListOpen = false;

function renderAList(){
  NAMES=getNames();
  var el=document.getElementById('alist');
  if(!NAMES.length){el.innerHTML='<div style="text-align:center;color:#444;padding:24px;">활성화된 봉장이 없습니다</div>';return;}
  el.innerHTML='';

  var unreg = NAMES.filter(function(n){return !AL[n]||!AL[n].lat;});
  var reg   = NAMES.filter(function(n){return AL[n]&&AL[n].lat;});

  // 미등록 봉장 카드
  unreg.forEach(function(name){
    var i=NAMES.indexOf(name);
    var mov=name.indexOf('이동')>=0, col=mov?'#f97316':'#FFB300';
    var card=document.createElement('div');
    card.className='ac'; card.id='card-'+i;
    card.style.borderLeft='4px solid '+col;

    var head=document.createElement('div');
    head.className='ac-head';
    var info=document.createElement('div'); info.style.flex='1';
    info.innerHTML='<div style="font-weight:900;font-size:.92rem">'+(mov?'🚚 ':'🐝 ')+name+'</div>'
      +'<div style="color:#444;font-size:.78rem;margin-top:2px">위치 미등록</div>';
    var btns=document.createElement('div'); btns.className='ac-btns';
    var editBtn=document.createElement('button'); editBtn.className='btn bg';
    editBtn.textContent='+ 등록';
    editBtn.onclick=(function(n,idx){return function(){toggleForm(n,idx);};})(name,i);
    btns.appendChild(editBtn);
    head.appendChild(info); head.appendChild(btns);
    card.appendChild(head);
    card.appendChild(buildFormEl(i,name,{}));
    el.appendChild(card);
  });

  // 등록된 봉장 보기 토글 버튼
  if(reg.length>0){
    var toggleBtn=document.createElement('button');
    toggleBtn.id='reg-toggle-btn';
    toggleBtn.style.cssText='width:100%;padding:13px;background:rgba(255,179,0,.1);color:#FFD54F;border:1px solid rgba(255,179,0,.35);border-radius:14px;font-size:.92rem;font-weight:800;cursor:pointer;touch-action:manipulation;margin-bottom:6px;letter-spacing:-0.3px;';
    toggleBtn.textContent=(regListOpen?'▲ ':'▼ ')+'등록된 봉장 보기 ('+reg.length+'개)';
    toggleBtn.onclick=function(){
      regListOpen=!regListOpen;
      renderAList();
      renderAMks();
    };
    el.appendChild(toggleBtn);

    // 등록된 봉장 목록 (토글)
    if(regListOpen){
      reg.forEach(function(name){
        var i=NAMES.indexOf(name);
        var d=AL[name], mov=name.indexOf('이동')>=0, col=mov?'#f97316':'#FFB300';
        var card=document.createElement('div');
        card.className='ac'; card.id='card-'+i;
        card.style.borderLeft='4px solid '+col;

        var head=document.createElement('div'); head.className='ac-head';
        var info=document.createElement('div'); info.style.flex='1';
        info.innerHTML='<div style="font-weight:900;font-size:.92rem">'+(mov?'🚚 ':'🐝 ')+name+'</div>'
          +'<div style="color:var(--dim);font-size:.78rem;margin-top:2px">📍 '+(d.address||d.lat.toFixed(4)+', '+d.lng.toFixed(4))+'</div>'
          +(d.memo?'<div style="color:#475569;font-size:.73rem;margin-top:1px">📝 '+d.memo+'</div>':'');

        var btns=document.createElement('div'); btns.className='ac-btns';
        var badge=document.createElement('span');
        badge.style.cssText='padding:2px 7px;background:'+(d.isPublic?'rgba(74,222,128,.12)':'rgba(100,100,100,.15)')+';color:'+(d.isPublic?'#4ade80':'#555')+';border-radius:5px;font-size:.7rem;';
        badge.textContent=d.isPublic?'공개':'비공개';
        btns.appendChild(badge);
        var editBtn=document.createElement('button'); editBtn.className='btn bg';
        editBtn.textContent='✏️ 수정';
        editBtn.onclick=(function(n,idx){return function(){toggleForm(n,idx);};})(name,i);
        btns.appendChild(editBtn);
        var delBtn=document.createElement('button'); delBtn.className='btn br';
        delBtn.textContent='🗑️ 삭제';
        delBtn.onclick=(function(n){return function(){delApy(n);};})(name);
        btns.appendChild(delBtn);
        head.appendChild(info); head.appendChild(btns);
        card.appendChild(head);

        var mapBtn=document.createElement('button'); mapBtn.className='mapbtn';
        mapBtn.textContent='🗺️ 지도에서 보기';
        mapBtn.onclick=(function(n){return function(){focusApy(n);};})(name);
        card.appendChild(mapBtn);

        card.appendChild(buildFormEl(i,name,d));
        el.appendChild(card);
      });
    }
  }

  // 미등록도 없고 등록도 없으면
  if(!unreg.length && !reg.length){
    el.innerHTML='<div style="text-align:center;color:#444;padding:24px;">활성화된 봉장이 없습니다</div>';
  }
}

function buildFormEl(i, name, d){
  var has=!!(d&&d.lat);
  var form=document.createElement('div');
  form.className='ac-form'; form.id='form-'+i;

  var gpsBtn=document.createElement('button'); gpsBtn.className='fbig fgps';
  gpsBtn.textContent='📡 현재 GPS 위치로 등록';
  gpsBtn.onclick=(function(idx){return function(){gpsToForm(idx);};})(i);
  form.appendChild(gpsBtn);

  var searchRow=document.createElement('div');
  searchRow.style.cssText='display:flex;gap:8px;margin-bottom:10px;';
  var addrInput=document.createElement('input');
  addrInput.id='faddy-'+i; addrInput.className='fi';
  addrInput.style.cssText='flex:1;margin-bottom:0';
  addrInput.placeholder='예) 예) 경기 화성시 봉담읍';
  addrInput.value=has?d.address:'';
  var searchBtn=document.createElement('button'); searchBtn.className='btn bg';
  searchBtn.style.cssText='padding:0 12px;flex-shrink:0';
  searchBtn.textContent='검색';
  searchBtn.onclick=(function(idx){return function(){doSearch(idx);};})(i);
  searchRow.appendChild(addrInput); searchRow.appendChild(searchBtn);
  form.appendChild(searchRow);

  var cbox=document.createElement('div');
  cbox.id='cbox-'+i; cbox.className='cbox'+(has?' on':'');
  cbox.innerHTML='<div id="cba-'+i+'" style="font-weight:700;margin-bottom:2px;color:var(--tx)">'+(has?'📍 '+(d.address||''):'')+'</div><div style="color:var(--green);font-size:.72rem">✅ 좌표 확정됨</div>';
  form.appendChild(cbox);

  var memoInput=document.createElement('input');
  memoInput.id='fmemo-'+i; memoInput.className='fi';
  memoInput.placeholder='📝 메모 (진입로 주의, 아까시 군락지 등)';
  memoInput.value=has?d.memo:'';
  form.appendChild(memoInput);

  var pub = has ? !!(d&&d.isPublic) : true; // 신규 등록 기본값: 공개
  var tw=document.createElement('div'); tw.className='tw';
  tw.innerHTML='<span style="flex:1;font-size:.88rem;color:#ccc">🌐 위치 공개</span>'
    +'<div id="tt-'+i+'" onclick="togglePub('+i+')" class="tt" style="background:'+(pub?'#16a34a':'#374151')+'">'
    +'<div id="th-'+i+'" class="th" style="transform:'+(pub?'translateX(22px)':'translateX(0)')+'"></div></div>'
    +'<span id="tl-'+i+'" style="color:'+(pub?'var(--green)':'#555')+';font-size:.8rem;font-weight:700">'+(pub?'공개':'비공개')+'</span>';
  form.appendChild(tw);

  var saveBtn=document.createElement('button'); saveBtn.className='fbig fsave';
  saveBtn.textContent='💾 저장';
  saveBtn.onclick=(function(idx){return function(){saveApy(idx);};})(i);
  form.appendChild(saveBtn);

  var cancelBtn=document.createElement('button'); cancelBtn.className='fbig fcancel';
  cancelBtn.textContent='취소';
  cancelBtn.onclick=(function(idx){return function(){closeForm(idx);};})(i);
  form.appendChild(cancelBtn);

  return form;
}

function toggleForm(name, i){
  var form=document.getElementById('form-'+i);
  var isOpen=form.classList.contains('on');
  if(openForm!==null && openForm!==i){
    var prev=document.getElementById('form-'+openForm);
    if(prev) prev.classList.remove('on');
    if(tpins[openForm]){vmap.removeLayer(tpins[openForm]);delete tpins[openForm];}
  }
  if(isOpen){
    form.classList.remove('on');
    if(tpins[i]){vmap.removeLayer(tpins[i]);delete tpins[i];}
    openForm=null;
  } else {
    var d=AL[name]||{};
    formLat[i]=d.lat||null; formLng[i]=d.lng||null;
    if(d.lat) setTimeout(function(){vmap.setView([d.lat,d.lng],15);},200);
    form.classList.add('on');
    openForm=i;
    setTimeout(function(){form.scrollIntoView({behavior:'smooth',block:'nearest'});},300);
  }
}

function closeForm(i){
  var form=document.getElementById('form-'+i);
  if(form) form.classList.remove('on');
  if(tpins[i]){vmap.removeLayer(tpins[i]);delete tpins[i];}
  if(openForm===i) openForm=null;
}

function updCbox(i){
  var box=document.getElementById('cbox-'+i);
  var bba=document.getElementById('cba-'+i);
  if(!box) return;
  if(formLat[i]){
    box.classList.add('on');
    var addrEl=document.getElementById('faddy-'+i);
    if(bba) bba.textContent='📍 '+(addrEl?addrEl.value:'');
  } else { box.classList.remove('on'); }
}

function setFCoord(i, lat, lng, label){
  formLat[i]=lat; formLng[i]=lng;
  if(tpins[i]){vmap.removeLayer(tpins[i]);delete tpins[i];}
  tpins[i]=L.marker([lat,lng],{icon:L.divIcon({className:'',
    html:'<div style="font-size:1.8rem;filter:drop-shadow(0 2px 5px rgba(0,0,0,.8))">📍</div>',
    iconSize:[30,30],iconAnchor:[10,28]}),zIndexOffset:1500}).addTo(vmap);
  vmap.setView([lat,lng],15);
  updCbox(i);
  showToast('📍 '+label+' 위치 선택됨');
}

function gpsToForm(i){
  if(myPos&&myPos.lat){
    setFCoord(i, myPos.lat, myPos.lng, '현재 GPS (±'+myPos.acc+'m)');
    var el=document.getElementById('faddy-'+i);
    if(el) el.value='주소 확인 중...';
    nearAddr(myPos.lat, myPos.lng, function(addr){
      var el2=document.getElementById('faddy-'+i);
      if(el2) el2.value=addr||'';
      updCbox(i);
    });
  } else {
    showToast('📡 GPS 신호 확인 중... 잠시 후 다시 눌러주세요');
    startGPS();
  }
}

function doSearch(i){
  var el=document.getElementById('faddy-'+i);
  var addr=el?el.value.trim():'';
  if(!addr){showToast('⚠️ 주소를 입력해주세요');return;}
  showToast('🔍 검색 중...');
  addrToCoord(addr, function(lat, lng, title){
    if(lat){
      var el2=document.getElementById('faddy-'+i);
      if(el2) el2.value=title||addr;
      setFCoord(i, lat, lng, title||addr);
    } else {
      showToast('⚠️ 찾을 수 없습니다. 도로명/지번 주소를 입력해주세요');
    }
  });
}

function togglePub(i){
  var th=document.getElementById('th-'+i);
  var tt=document.getElementById('tt-'+i);
  var tl=document.getElementById('tl-'+i);
  if(!th) return;
  var on=th.style.transform!=='translateX(22px)';
  th.style.transform=on?'translateX(22px)':'translateX(0)';
  tt.style.background=on?'#16a34a':'#374151';
  tl.textContent=on?'공개':'비공개';
  tl.style.color=on?'var(--green)':'#555';
}

function saveApy(i){
  var name=NAMES[i];
  if(!formLat[i]){showToast('⚠️ GPS 버튼이나 주소 검색으로 위치를 먼저 설정해주세요');return;}
  var th=document.getElementById('th-'+i);
  var pub=th&&th.style.transform==='translateX(22px)';
  var addrEl=document.getElementById('faddy-'+i);
  var memoEl=document.getElementById('fmemo-'+i);
  AL[name]={
    lat:formLat[i], lng:formLng[i],
    address:addrEl?addrEl.value.trim():'',
    memo:memoEl?memoEl.value.trim():'',
    isPublic:pub, updatedAt:new Date().toISOString()
  };
  if(saveLocs()){
    var lat=formLat[i], lng=formLng[i];
    closeForm(i);
    showToast('✅ '+name+' 저장 완료!');
    renderAList();
    renderAMks();
    setTimeout(function(){vmap.setView([lat,lng],15);},300);
  }
}

function delApy(name){
  if(!confirm(name+' 위치를 삭제하시겠습니까?')) return;
  delete AL[name]; saveLocs();
  showToast('🗑️ '+name+' 삭제 완료');
  renderAList(); renderAMks();
}

function popEdit(name){
  vmap.closePopup();
  regListOpen=true;
  renderAList();
  var i=NAMES.indexOf(name);
  if(i<0) return;
  setTimeout(function(){
    toggleForm(name,i);
    var card=document.getElementById('card-'+i);
    if(card) card.scrollIntoView({behavior:'smooth',block:'center'});
  },200);
}

function popDel(name){
  vmap.closePopup();
  delApy(name);
}

function focusApy(name){
  var d=AL[name]; if(!d||!vmap) return;
  vmap.setView([d.lat,d.lng],15);
  window.scrollTo({top:0,behavior:'smooth'});
}

var _mapTt=null;
function showToast(msg){
  var el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('on');
  if(_mapTt) clearTimeout(_tt);
  _mapTt=setTimeout(function(){el.classList.remove('on');},2800);
}




        function initSplash() { /* bee-splash 제거됨 */ }

        // ── VWorld 지도 초기화 ──
        // ── 내 위치 찾기 ──


// ── 사용자 정보 ──
function saveUserInfoManual(){
  saveUserInfo();
  showToast('✅ 농장 상호명이 저장되었습니다!');
}

function saveSettingsAll(){
  // 농장명 저장
  saveUserInfo();
  // 봉장 설정은 체크박스 변경시 이미 자동저장됨
  showToast('✅ 모든 설정이 저장되었습니다!');
  // 봉장 버튼 즉시 갱신
  try { loadApiarySettings(); renderLocationButtons(); renderLocationFilters(); } catch(e) {}
}

function saveUserInfo(){
  var nick = document.getElementById('input-nickname');
  var farm = document.getElementById('input-farmname');
  if(!nick) return;
  var farmVal = farm ? farm.value.trim() : '';
  localStorage.setItem('beeUserInfo', JSON.stringify({
    nickname: farmVal,
    farmname: farmVal
  }));
  // 농장명 변경 시 봉장 표시명 즉시 갱신
  try { loadApiarySettings(); renderLocationButtons(); renderLocationFilters(); } catch(e) {}
}

function loadUserInfo(){
  try {
    var info = JSON.parse(localStorage.getItem('beeUserInfo')) || {};
    var nick = document.getElementById('input-nickname');
    var farm = document.getElementById('input-farmname');
    if(nick) nick.value = info.nickname || '';
    if(farm) farm.value = info.farmname || info.nickname || '';
  } catch(e){}
}

function getUserInfo(){
  try { return JSON.parse(localStorage.getItem('beeUserInfo')) || {}; } catch(e){ return {}; }
}

        // ==================== 고객 관리 ====================
        function renderCustomerList() {
            const container = document.getElementById('customer-list-view');
            if(!container) return;

            const searchVal = (document.getElementById('customer-search')?.value || '').trim().toLowerCase();

            // accLogs에서 고객 정보 있는 수입 기록 수집 → 고객별로 집계
            const customerMap = {};
            accLogs.forEach(function(log, idx) {
                if(log.type !== 'in' || !log.customerName) return;
                const key = log.customerName + '||' + (log.customerPhone || '');
                if(!customerMap[key]) {
                    customerMap[key] = {
                        name: log.customerName,
                        phone: log.customerPhone || '',
                        totalAmount: 0,
                        count: 0,
                        lastDate: '',
                        items: []
                    };
                }
                customerMap[key].totalAmount += log.price || 0;
                customerMap[key].count++;
                const d = log.date ? log.date.substring(0, 10) : '';
                if(!customerMap[key].lastDate || d > customerMap[key].lastDate) customerMap[key].lastDate = d;
                (log.lines || [{ name: log.item, qty: 1, unitPrice: log.price }]).forEach(function(l) {
                    customerMap[key].items.push(l.name);
                });
            });

            let customers = Object.values(customerMap);

            // 검색 필터
            if(searchVal) {
                customers = customers.filter(function(c) {
                    return c.name.toLowerCase().includes(searchVal) || c.phone.includes(searchVal);
                });
            }

            // 거래금액 내림차순
            customers.sort(function(a, b) { return b.totalAmount - a.totalAmount; });

            if(customers.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#666; font-style:italic;">'
                    + (searchVal ? '검색 결과가 없습니다.' : '수입 기록에 고객 정보를 입력하면 자동으로 표시됩니다.<br><br>💡 가계부 → 기록하기 → 수입 탭에서<br>고객 정보를 입력하세요.') + '</div>';
                return;
            }

            const totalCustomers = customers.length;
            const totalSales = customers.reduce(function(s, c) { return s + c.totalAmount; }, 0);

            let html = '<div style="display:flex; gap:10px; margin-bottom:16px;">'
                + '<div style="flex:1; background:rgba(96,165,250,0.15); border-radius:10px; padding:12px; text-align:center;">'
                + '<div style="color:#60a5fa; font-size:0.75rem; margin-bottom:4px;">👥 총 고객수</div>'
                + '<div style="color:#93c5fd; font-size:1.3rem; font-weight:900;">' + totalCustomers + '명</div></div>'
                + '<div style="flex:1; background:rgba(74,222,128,0.15); border-radius:10px; padding:12px; text-align:center;">'
                + '<div style="color:#4ade80; font-size:0.75rem; margin-bottom:4px;">💰 총 매출</div>'
                + '<div style="color:#86efac; font-size:1.1rem; font-weight:900;">' + totalSales.toLocaleString() + '원</div></div>'
                + '</div>';

            customers.forEach(function(cust) {
                const uniqueItems = [...new Set(cust.items)].slice(0, 3).join(', ');
                const lastD = cust.lastDate ? cust.lastDate.replace(/-/g, '.') : '';
                html += '<div style="background:rgba(30,25,20,0.8); border:1px solid rgba(96,165,250,0.2); border-radius:12px; padding:16px; margin-bottom:10px;">'
                    + '<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">'
                    + '<div>'
                    + '<div style="font-size:1rem; font-weight:800; color:#e2e8f0; margin-bottom:4px;">👤 ' + cust.name + '</div>'
                    + (cust.phone ? '<div style="font-size:0.85rem; color:#94a3b8;">📞 ' + cust.phone + '</div>' : '')
                    + '</div>'
                    + '<div style="text-align:right;">'
                    + '<div style="color:#4ade80; font-weight:900; font-size:1rem;">' + cust.totalAmount.toLocaleString() + '원</div>'
                    + '<div style="color:#64748b; font-size:0.75rem;">' + cust.count + '회 거래</div>'
                    + '</div></div>'
                    + (uniqueItems ? '<div style="font-size:0.78rem; color:#94a3b8; margin-bottom:4px;">🏷️ ' + uniqueItems + (cust.items.length > 3 ? ' 외' : '') + '</div>' : '')
                    + (lastD ? '<div style="font-size:0.75rem; color:#64748b;">📅 마지막 거래: ' + lastD + '</div>' : '')
                    + '</div>';
            });

            container.innerHTML = html;
        }

        // ==================== 화면 전환 ====================
        function switchView(v, addToHistory = true) {
            currentActiveView = v;
            
            if (addToHistory && viewHistory[viewHistory.length - 1] !== v) {
                viewHistory.push(v);
            }
            
            document.querySelectorAll('.view-group').forEach(el => el.classList.remove('view-active'));
            document.getElementById('view-' + v).classList.add('view-active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navMap = {
                'diary': 'nav-diary',
                'calendar': 'nav-calendar',
                'calculator': 'nav-calculator',
                'account': 'nav-account',
                'apiary-settings': 'nav-settings',
                'map': 'nav-map'
            };
            if(navMap[v]) {
                document.getElementById(navMap[v]).classList.add('active');
            }

            if(v === 'calendar') {
                viewDate = new Date();
                renderCalendar();
                // 오늘 날짜 기록 자동 표시
                const t = new Date();
                const todayKey = `${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`;
                showDayWithSchedule(todayKey);
            }

            if(v === 'account') {
                accViewDate = new Date();
                switchAccView('calendar');
            }
            
            if(v === 'map') {
                setTimeout(function(){
                    if(!vmap){ initMap(); }
                    else { 
                        vmap.invalidateSize(); 
                        renderAList();
                        renderAMks(); 
                    }
                }, 200);
            }

            if(v === 'disease-history') {
                renderDiseaseFilters();
                renderDiseaseHistory();
                switchDiseaseHistoryTab(diseaseHistoryTab || 'loc');
            }
            
            if(v === 'personal-schedule') {
                renderScheduleList();
            }
            
            if(v === 'apiary-settings') {
                loadUserInfo();
                loadApiarySettings();
            }
            
            if(v === 'diary') {
                setTimeout(() => {
                    renderLocationButtons();
                    showTodayWorkSuggestion();
                }, 100);
            }
            
            if(v === 'disease') {
                // 일지에서 선택한 봉장을 방역 화면에도 동기화
                if(selectedApiaryLoc && selectedApiaryLoc !== '1봉장') {
                    selectedDiseaseApiaryLoc = selectedApiaryLoc;
                }
                setTimeout(() => renderDiseaseApiaryButtons(), 100);
            }
            
            if(v === 'calendar') {
                setTimeout(() => renderCalendar(), 100);
            }
        }

        function handleTopLeftBtn() {
            // 가계부 화면일 때: 서브탭 확인
            if(currentActiveView === 'account') {
                var listPage = document.getElementById('acc-page-list');
                var statPage = document.getElementById('acc-page-stat');
                // 기록하기 또는 통계 탭 열려있으면 → 가계부 달력으로
                if((listPage && listPage.style.display !== 'none') ||
                   (statPage && statPage.style.display !== 'none')) {
                    switchAccView('calendar');
                    return;
                }
                // 가계부 달력 상태면 → 이전 화면으로
                if (viewHistory.length > 1) {
                    viewHistory.pop();
                    const previousView = viewHistory[viewHistory.length - 1];
                    switchView(previousView, false);
                } else {
                    goHomeWithoutConfirm();
                }
                return;
            }
            
            if (viewHistory.length > 1) {
                viewHistory.pop();
                const previousView = viewHistory[viewHistory.length - 1];
                switchView(previousView, false);
            } else {
                goHomeWithoutConfirm();
            }
        }

        function goHomeWithoutConfirm() {
            document.getElementById('splash').style.display = 'flex';
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('main-memo').value = '';
            document.querySelectorAll('.work-btn.selected').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('custom-work').value = '';
            updateSelectedDisplay();
            weatherInserted = false;
            viewHistory = ['diary'];
            document.querySelector('.bottom-nav').style.display = 'flex';
            document.querySelectorAll('.view-group').forEach(el => el.classList.remove('view-active'));
        }

        // ==================== 작업 선택 ====================
        function openWorkSelection() {
            document.getElementById('work-selection-area').style.display = 'flex';
        }

        function toggleWork(btn) {
            btn.classList.toggle('selected');
        }

        function closeWorkSelection() {
            document.getElementById('work-selection-area').style.display = 'none';
            // custom-work 입력값 유지하면서 선택 표시 갱신
            updateSelectedDisplay();
        }

        function updateSelectedDisplay() {
            const selected = Array.from(document.querySelectorAll('.work-btn.selected')).map(b => b.innerText);
            const custom = document.getElementById('custom-work').value.trim();
            if(custom) selected.push(custom);
            
            const display = document.getElementById('selected-works-display');
            display.innerHTML = '';
            selected.forEach(w => {
                display.innerHTML += `<span class="badge">${w}</span>`;
            });
            
            const statusText = selected.length > 0 ? `${selected.length}개 선택됨` : "작업을 선택하세요";
            document.getElementById('work-btn-text').innerText = statusText;
        }

        // ==================== 일지 저장 ====================
        function saveData() {
            const y = todayDate.getFullYear();
            const m = todayDate.getMonth() + 1;
            const d = todayDate.getDate();
            const key = `${y}-${m}-${d}`;
            
            const works = Array.from(document.querySelectorAll('.work-btn.selected')).map(b => b.innerText);
            const custom = document.getElementById('custom-work').value.trim();
            if(custom) works.push(custom);
            
            const memo = document.getElementById('main-memo').value;
            const selectedLoc = selectedApiaryLoc || document.getElementById('loc-select').value || '1봉장';

            if(works.length === 0 && !memo.trim()) {
                showToast('⚠️ 작업 내용이나 메모를 입력해주세요');
                return;
            }
            
            // 새 기록 객체
            const newRecord = {
                hasData: true,
                beeType: selectedBeeType,
                loc: selectedLoc,
                memo: memo,
                works: works,
                photos: currentDiaryPhotos.length > 0 ? [...currentDiaryPhotos] : [],
                timestamp: new Date().toISOString()
            };
            
            // 날짜 키가 없으면 초기화
            if(!db[key]) {
                db[key] = { records: [] };
            }
            // records 배열이 없으면 생성
            if(!db[key].records) {
                db[key].records = [];
            }
            
            // 같은 봉장의 기존 기록이 있으면 업데이트, 없으면 추가
            const existingIndex = db[key].records.findIndex(r => r.loc === selectedLoc);
            if(existingIndex >= 0) {
                db[key].records[existingIndex] = newRecord;
            } else {
                db[key].records.push(newRecord);
            }
            
            // 달력 필터에서 사용하는 hasData 플래그 설정
            db[key].hasData = db[key].records.length > 0;
            
            // 왕대이충 처리
            if(works.includes('왕대이충')) {
                const today = new Date(y, m-1, d);
                const queenDate = new Date(today);
                queenDate.setDate(today.getDate() + 11);
                
                const qYear = queenDate.getFullYear();
                const qMonth = queenDate.getMonth() + 1;
                const qDay = queenDate.getDate();
                const qKey = `${qYear}-${qMonth}-${qDay}`;
                
                if(!db[qKey]) db[qKey] = {};
                db[qKey].isQueen = true;
            }
            
            localStorage.setItem('beeData', JSON.stringify(db));
            
            document.getElementById('main-memo').value = '';
            document.querySelectorAll('.work-btn.selected').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('custom-work').value = '';
            updateSelectedDisplay();
            weatherInserted = false;
            clearDiaryPhotos();
            // 방제 상태 초기화
            const disStatus = document.getElementById('dis-status');
            if(disStatus) { disStatus.textContent = '입력 ▶'; disStatus.style.color = ''; }
            
            showToast('✅ 일지가 저장되었습니다!');
            
            // 달력 화면으로 전환
            setTimeout(() => {
                renderCalendar();
                switchView('calendar', true);
            }, 300);
        }

        // ==================== 봉장 관리 ====================
        function getActiveApiaries() {
            return Object.keys(apiarySettings).filter(key => apiarySettings[key]);
        }

        function toggleApiary(name, enabled) {
            const activeCount = getActiveApiaries().length;
            
            if(!enabled && activeCount <= 1) {
                showToast('⚠️ 최소 1개 이상의 봉장을 선택해야 합니다');
                document.getElementById(`toggle-${name}`).checked = true;
                return;
            }
            
            apiarySettings[name] = enabled;
            localStorage.setItem('apiarySettings', JSON.stringify(apiarySettings));
            showToast(enabled ? `✅ ${name} 활성화` : `❌ ${name} 비활성화`);
            // 일지기록화면 봉장버튼 + 달력 필터 즉시 반영
            renderWorkButtons();
            renderLocationFilters();
            renderCalendar();
        }

        // ==================== 테마 관리 ====================
        function setTheme(theme) {
            const toggleBtn = document.getElementById('theme-toggle-btn');
            if(theme === 'light') {
                document.body.classList.add('light-mode');
                localStorage.setItem('beeTheme', 'light');
                if(toggleBtn) toggleBtn.textContent = '☀️';
            } else {
                document.body.classList.remove('light-mode');
                localStorage.setItem('beeTheme', 'dark');
                if(toggleBtn) toggleBtn.textContent = '🌙';
            }
            showToast(theme === 'light' ? '☀️ 라이트 모드로 전환' : '🌙 다크 모드로 전환');
        }

        function toggleTheme() {
            const isLight = document.body.classList.contains('light-mode');
            setTheme(isLight ? 'dark' : 'light');
        }

        function loadTheme() {
            const theme = localStorage.getItem('beeTheme') || 'dark';
            const toggleBtn = document.getElementById('theme-toggle-btn');
            if(theme === 'light') {
                document.body.classList.add('light-mode');
                if(toggleBtn) toggleBtn.textContent = '☀️';
            } else {
                document.body.classList.remove('light-mode');
                if(toggleBtn) toggleBtn.textContent = '🌙';
            }
        }

        function loadApiarySettings() {
            Object.keys(apiarySettings).forEach(name => {
                const checkbox = document.getElementById('toggle-' + name);
                if(checkbox) checkbox.checked = apiarySettings[name];
                // 레이블에 농장명 표시
                const label = checkbox ? checkbox.nextElementSibling : null;
                if(label) label.textContent = getDisplayName(name);
            });
        }

        // ===== 설정 탭 전환 =====
        function switchSettingsTab(tab) {
            document.querySelectorAll('#view-apiary-settings .v-btn').forEach(b => b.classList.remove('active'));
            var tabBtn = document.getElementById('v-settings-' + tab);
            if(tabBtn) tabBtn.classList.add('active');
            document.querySelectorAll('.settings-tab').forEach(t => t.style.display = 'none');
            var tabEl = document.getElementById('settings-' + tab);
            if(tabEl) tabEl.style.display = 'block';
            if(tab === 'custom') {
                renderCustomWorkItems();
                renderCustomDiseases();
                renderCustomMedicines();
                renderAlarmDayOptions();
                renderAlarmDayList();
                renderAccSettingList('out');
                renderAccSettingList('in');
            }
        }

        // ===== 설정 아코디언 토글 =====
        function toggleSettingAccordion(key) {
            var content = document.getElementById('acc-content-' + key);
            var arrow   = document.getElementById('acc-arrow-' + key);
            if(!content) return;
            var open = content.style.display !== 'none';
            content.style.display = open ? 'none' : 'block';
            if(arrow) arrow.textContent = open ? '▼' : '▲';
        }

        // ===== DEFAULT 값 정의 =====
        const DEFAULT_WORK_ITEMS = ['내검','이충','왕대이충','채밀','분봉','사양','화분떡','로얄제리','프로폴리스','소초광교체','벌통청소','월동준비'];
        const DEFAULT_DISEASES = [
            { value: 'mite',       name: '꿀벌응애 / 중국가시응애' },
            { value: 'afb',        name: '미국부저병 (AFB)' },
            { value: 'efb',        name: '유럽부저병 (EFB)' },
            { value: 'nosema',     name: '노제마병' },
            { value: 'chalkbrood', name: '석고병' },
            { value: 'virus',      name: '바이러스' }
        ];
        const DEFAULT_MEDICINES = {
            'mite':       ['플루발리네이트', '아미트라즈', '개미산', '옥살산', '티몰', '멘톨'],
            'afb':        ['옥시테트라사이클린'],
            'efb':        ['옥시테트라사이클린'],
            'nosema':     ['푸마길린'],
            'chalkbrood': ['환기 개선', '습도 관리', '소초 교체'],
            'virus':      ['약봉 제거', '소초 교체', '영양 공급']
        };
        const DEFAULT_ALARM_DAYS = [3, 5, 7, 10, 14, 21, 28];

        // ===== localStorage 접근 함수 =====
        function getCustomWorkItems() {
            var d = localStorage.getItem('customWorkItems');
            return d ? JSON.parse(d) : [...DEFAULT_WORK_ITEMS];
        }
        function saveCustomWorkItems(items) { localStorage.setItem('customWorkItems', JSON.stringify(items)); }

        function getCustomDiseases() {
            var d = localStorage.getItem('customDiseases');
            return d ? JSON.parse(d) : JSON.parse(JSON.stringify(DEFAULT_DISEASES));
        }
        function saveCustomDiseases(diseases) { localStorage.setItem('customDiseases', JSON.stringify(diseases)); }

        function getCustomMedicines() {
            var d = localStorage.getItem('customMedicines');
            return d ? JSON.parse(d) : JSON.parse(JSON.stringify(DEFAULT_MEDICINES));
        }
        function saveCustomMedicines(meds) { localStorage.setItem('customMedicines', JSON.stringify(meds)); }

        // ===== 처리방법(details/methods) 커스텀 저장소 =====
        function getCustomMedicineOptions() {
            var d = localStorage.getItem('customMedicineOptions');
            if(d) return JSON.parse(d);
            // 기본값: medicineOptions에서 deep copy
            return JSON.parse(JSON.stringify(medicineOptions));
        }
        function saveCustomMedicineOptions(opts) {
            localStorage.setItem('customMedicineOptions', JSON.stringify(opts));
        }

        function getAlarmDays() {
            var d = localStorage.getItem('customAlarmDays');
            return d ? JSON.parse(d) : [...DEFAULT_ALARM_DAYS];
        }
        function saveAlarmDays(days) { localStorage.setItem('customAlarmDays', JSON.stringify(days)); }

        // ===== 설정 항목 렌더링 =====
        function renderCustomWorkItems() {
            var items = getCustomWorkItems();
            var c = document.getElementById('work-items-list');
            if(!c) return;
            c.innerHTML = items.map(function(item, idx) {
                return '<div style="display:flex;align-items:center;gap:8px;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:6px;">' +
                    '<span style="flex:1;color:#d4c8b8;font-size:0.9rem;">' + item + '</span>' +
                    '<button onclick="editWorkItem(' + idx + ')" style="background:rgba(59,130,246,0.3);color:#60a5fa;padding:5px 10px;border-radius:6px;border:none;cursor:pointer;font-size:0.8rem;">수정</button>' +
                    '<button onclick="deleteWorkItem(' + idx + ')" style="background:#dc2626;color:#ffffff;padding:5px 10px;border-radius:6px;border:none;cursor:pointer;font-size:0.8rem;font-weight:700;">삭제</button>' +
                '</div>';
            }).join('');
        }

        function renderCustomDiseases() {
            var diseases = getCustomDiseases();
            var c = document.getElementById('disease-items-list');
            if(!c) return;
            c.innerHTML = diseases.map(function(d, idx) {
                var isDefault = DEFAULT_DISEASES.some(function(dd) { return dd.value === d.value; });
                return '<div style="display:flex;align-items:center;gap:8px;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:6px;">' +
                    '<span style="flex:1;color:#d4c8b8;font-size:0.9rem;">' + d.name + (isDefault ? ' <span style="color:#666;font-size:0.75rem;">(기본)</span>' : '') + '</span>' +
                    '<button onclick="editDiseaseItem(' + idx + ')" style="background:rgba(59,130,246,0.3);color:#60a5fa;padding:5px 10px;border-radius:6px;border:none;cursor:pointer;font-size:0.8rem;">수정</button>' +
                    (!isDefault ? '<button onclick="deleteDiseaseItem(' + idx + ')" style="background:#dc2626;color:#ffffff;padding:5px 10px;border-radius:6px;border:none;cursor:pointer;font-size:0.8rem;font-weight:700;">삭제</button>' : '') +
                '</div>';
            }).join('');
        }

        function renderCustomMedicines() {
            var diseases = getCustomDiseases();
            var medicines = getCustomMedicines();
            var opts = getCustomMedicineOptions();
            var c = document.getElementById('medicine-items-list');
            if(!c) return;
            var html = '';
            diseases.forEach(function(d) {
                var meds = medicines[d.value] || [];
                html += '<div style="margin-bottom:18px;border:1px solid rgba(255,213,79,0.15);border-radius:10px;overflow:hidden;">' +
                    '<div style="background:rgba(255,179,0,0.1);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;">' +
                        '<span style="color:#FFD54F;font-size:0.95rem;font-weight:900;">🦠 ' + d.name + '</span>' +
                        '<button onclick="addMedicineToDisease(\'' + d.value + '\')" style="background:rgba(74,222,128,0.25);color:#4ade80;padding:5px 12px;border-radius:8px;border:none;cursor:pointer;font-size:0.8rem;font-weight:700;">+ 약제추가</button>' +
                    '</div>';

                if(meds.length === 0) {
                    html += '<div style="padding:10px 14px;color:#666;font-size:0.85rem;">등록된 약제 없음</div>';
                } else {
                    meds.forEach(function(med, idx) {
                        var medOpts = opts[d.value] || {};
                        var details = (medOpts.details && medOpts.details[med]) ? medOpts.details[med] : [];
                        var methods = (medOpts.methods && medOpts.methods[med]) ? medOpts.methods[med] : [];
                        var isOxitet = (med === '옥시테트라사이클린');

                        html += '<div style="padding:10px 14px;border-top:1px solid rgba(255,213,79,0.08);">' +
                            // 약제명 행
                            '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">' +
                                '<span style="flex:1;color:#e8e3d8;font-size:0.92rem;font-weight:700;">💊 ' + med + '</span>' +
                                '<button onclick="editMedicineItem(\'' + d.value + '\',' + idx + ')" style="background:rgba(59,130,246,0.3);color:#60a5fa;padding:5px 10px;border-radius:6px;border:none;cursor:pointer;font-size:0.75rem;">수정</button>' +
                                '<button onclick="deleteMedicineItem(\'' + d.value + '\',' + idx + ')" style="background:rgba(239,68,68,0.3);color:#ff6b6b;padding:5px 10px;border-radius:6px;border:none;cursor:pointer;font-size:0.75rem;">삭제</button>' +
                            '</div>';

                        // 약품명 상세 (옥시테트라사이클린 포함 모든 약제 - 있는 경우만)
                        if(!isOxitet && details.length > 0) {
                            html += '<div style="margin-left:12px;margin-bottom:6px;">' +
                                '<div style="color:#aaa;font-size:0.75rem;margin-bottom:4px;">📋 약품명 상세</div>' +
                                details.map(function(det, di) {
                                    return '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">' +
                                        '<span style="flex:1;color:#c4b8a8;font-size:0.82rem;padding:4px 8px;background:rgba(0,0,0,0.2);border-radius:4px;">' + det + '</span>' +
                                        '<button onclick="editMedDetail(\'' + d.value + '\',\'' + med + '\',' + di + ')" style="background:rgba(59,130,246,0.2);color:#93c5fd;padding:3px 8px;border-radius:4px;border:none;cursor:pointer;font-size:0.72rem;">수정</button>' +
                                        '<button onclick="deleteMedDetail(\'' + d.value + '\',\'' + med + '\',' + di + ')" style="background:rgba(239,68,68,0.2);color:#fca5a5;padding:3px 8px;border-radius:4px;border:none;cursor:pointer;font-size:0.72rem;">삭제</button>' +
                                    '</div>';
                                }).join('') +
                                '<button onclick="addMedDetail(\'' + d.value + '\',\'' + med + '\')" style="font-size:0.75rem;color:#93c5fd;background:rgba(59,130,246,0.15);border:none;border-radius:4px;padding:4px 10px;cursor:pointer;margin-top:2px;">+ 상세 추가</button>' +
                            '</div>';
                        }

                        // 처리방법
                        html += '<div style="margin-left:12px;">' +
                            '<div style="color:#aaa;font-size:0.75rem;margin-bottom:4px;">⚙️ 처리방법</div>' +
                            methods.map(function(mth, mi) {
                                return '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">' +
                                    '<span style="flex:1;color:#c4b8a8;font-size:0.82rem;padding:4px 8px;background:rgba(0,0,0,0.2);border-radius:4px;">' + mth + '</span>' +
                                    '<button onclick="editMedMethod(\'' + d.value + '\',\'' + med + '\',' + mi + ')" style="background:rgba(59,130,246,0.2);color:#93c5fd;padding:3px 8px;border-radius:4px;border:none;cursor:pointer;font-size:0.72rem;">수정</button>' +
                                    '<button onclick="deleteMedMethod(\'' + d.value + '\',\'' + med + '\',' + mi + ')" style="background:rgba(239,68,68,0.2);color:#fca5a5;padding:3px 8px;border-radius:4px;border:none;cursor:pointer;font-size:0.72rem;">삭제</button>' +
                                '</div>';
                            }).join('') +
                            '<button onclick="addMedMethod(\'' + d.value + '\',\'' + med + '\')" style="font-size:0.75rem;color:#86efac;background:rgba(74,222,128,0.15);border:none;border-radius:4px;padding:4px 10px;cursor:pointer;margin-top:2px;">+ 처리방법 추가</button>' +
                        '</div>';

                        html += '</div>'; // 약제 항목 끝
                    });
                }
                html += '</div>'; // 질병 블록 끝
            });
            c.innerHTML = html;
        }

        // 방역 알림 날짜 목록 렌더링 (설정 화면)
        function renderAlarmDayList() {
            var days = getAlarmDays();
            var c = document.getElementById('setting-alarmdays-list');
            if(!c) return;
            c.innerHTML = days.map(function(d, i) {
                return '<div style="display:inline-flex;align-items:center;background:rgba(255,179,0,0.15);border-radius:20px;padding:6px 12px;gap:6px;">' +
                    '<span style="color:#e8e3d8;font-size:0.9rem;">' + d + '일 뒤</span>' +
                    '<button onclick="delAlarmDay(' + i + ')" style="background:rgba(185,28,28,0.5);color:#ff6b6b;border:none;border-radius:50%;width:20px;height:20px;font-size:0.75rem;cursor:pointer;line-height:20px;padding:0;">✕</button>' +
                '</div>';
            }).join('');
        }

        // 방역 알림 select 갱신 (기록 화면)
        function renderAlarmDayOptions() {
            var sel = document.getElementById('disease-alarm');
            if(!sel) return;
            var days = getAlarmDays();
            sel.innerHTML = '<option value="0">안함</option>' +
                days.map(function(d) { return '<option value="' + d + '">' + d + '일 뒤</option>'; }).join('');
        }

        function addAlarmDay() {
            var input = document.getElementById('setting-alarmdays-input');
            if(!input) return;
            var num = parseInt(input.value.trim());
            if(isNaN(num) || num < 1) { showToast('⚠️ 올바른 숫자를 입력하세요'); return; }
            var days = getAlarmDays();
            if(days.indexOf(num) !== -1) { showToast('⚠️ 이미 있는 항목입니다'); return; }
            days.push(num);
            days.sort(function(a,b){return a-b;});
            saveAlarmDays(days);
            input.value = '';
            renderAlarmDayList();
            renderAlarmDayOptions();
            showToast('✅ 추가되었습니다');
        }

        function delAlarmDay(index) {
            var days = getAlarmDays();
            days.splice(index, 1);
            saveAlarmDays(days);
            renderAlarmDayList();
            renderAlarmDayOptions();
            showToast('🗑️ 삭제되었습니다');
        }

        // ===== 작업 항목 편집 =====
        function addWorkItem() {
            showCustomInput('새 작업 항목 추가', '작업명을 입력하세요', '', function(val) {
                if(!val || !val.trim()) return;
                var items = getCustomWorkItems();
                if(items.indexOf(val.trim()) !== -1) { showToast('⚠️ 이미 있는 항목입니다'); return; }
                items.push(val.trim());
                saveCustomWorkItems(items);
                renderCustomWorkItems();
                renderWorkButtons();
                showToast('✅ 추가되었습니다');
            });
        }
        function editWorkItem(idx) {
            var items = getCustomWorkItems();
            showCustomInput('작업 항목 수정', '새 이름을 입력하세요', items[idx], function(val) {
                if(!val || !val.trim() || val.trim() === items[idx]) return;
                items[idx] = val.trim();
                saveCustomWorkItems(items);
                renderCustomWorkItems();
                renderWorkButtons();
                showToast('✅ 수정되었습니다');
            });
        }
        function deleteWorkItem(idx) {
            var items = getCustomWorkItems();
            items.splice(idx, 1);
            saveCustomWorkItems(items);
            renderCustomWorkItems();
            renderWorkButtons();
            showToast('🗑️ 삭제되었습니다');
        }

        // ===== 질병 항목 편집 =====
        function addDiseaseItem() {
            showCustomInput('새 질병 추가', '질병명을 입력하세요', '', function(val) {
                if(!val || !val.trim()) return;
                var diseases = getCustomDiseases();
                var newValue = 'custom_' + Date.now();
                diseases.push({ value: newValue, name: val.trim() });
                saveCustomDiseases(diseases);
                var medicines = getCustomMedicines();
                // 약제는 비워둠 (사용자가 직접 추가)
                saveCustomMedicines(medicines);
                renderCustomDiseases();
                renderCustomMedicines();
                renderDiseaseTypeSelect();
                showToast('✅ 질병이 추가되었습니다');
            });
        }
        function editDiseaseItem(idx) {
            var diseases = getCustomDiseases();
            showCustomInput('질병명 수정', '새 질병명을 입력하세요', diseases[idx].name, function(val) {
                if(!val || !val.trim()) return;
                diseases[idx].name = val.trim();
                saveCustomDiseases(diseases);
                renderCustomDiseases();
                renderDiseaseTypeSelect();
                showToast('✅ 수정되었습니다');
            });
        }
        function deleteDiseaseItem(idx) {
            var diseases = getCustomDiseases();
            var disease = diseases[idx];
            var isDefault = DEFAULT_DISEASES.some(function(d) { return d.value === disease.value; });
            if(isDefault) { showToast('⚠️ 기본 질병은 삭제할 수 없습니다'); return; }
            diseases.splice(idx, 1);
            saveCustomDiseases(diseases);
            var medicines = getCustomMedicines();
            delete medicines[disease.value];
            saveCustomMedicines(medicines);
            renderCustomDiseases();
            renderCustomMedicines();
            renderDiseaseTypeSelect();
            showToast('🗑️ 삭제되었습니다');
        }

        // ===== 약제 항목 편집 =====
        function addMedicineToDisease(diseaseValue) {
            showCustomInput('새 약제 추가', '약제명을 입력하세요', '', function(val) {
                if(!val || !val.trim()) return;
                var medicines = getCustomMedicines();
                if(!medicines[diseaseValue]) medicines[diseaseValue] = [];
                medicines[diseaseValue].push(val.trim());
                saveCustomMedicines(medicines);
                renderCustomMedicines();
                showToast('✅ 약제가 추가되었습니다');
            });
        }
        function deleteMedicineItem(diseaseValue, idx) {
            var medicines = getCustomMedicines();
            var medName = medicines[diseaseValue][idx];
            if(!confirm('[' + medName + '] 약제를 삭제하시겠습니까?')) return;
            medicines[diseaseValue].splice(idx, 1);
            saveCustomMedicines(medicines);
            // opts에서도 제거
            var opts = getCustomMedicineOptions();
            if(opts[diseaseValue]) {
                if(opts[diseaseValue].details) delete opts[diseaseValue].details[medName];
                if(opts[diseaseValue].methods) delete opts[diseaseValue].methods[medName];
                saveCustomMedicineOptions(opts);
            }
            renderCustomMedicines();
            showToast('🗑️ 약제가 삭제되었습니다');
        }

        function editMedicineItem(diseaseValue, idx) {
            var medicines = getCustomMedicines();
            var oldName = medicines[diseaseValue][idx];
            showCustomInput('약제 수정', '약제명을 수정하세요', oldName, function(val) {
                if(!val || !val.trim() || val.trim() === oldName) return;
                var newName = val.trim();
                medicines[diseaseValue][idx] = newName;
                saveCustomMedicines(medicines);
                // opts에서 키 이름 변경
                var opts = getCustomMedicineOptions();
                if(opts[diseaseValue]) {
                    if(opts[diseaseValue].details && opts[diseaseValue].details[oldName]) {
                        opts[diseaseValue].details[newName] = opts[diseaseValue].details[oldName];
                        delete opts[diseaseValue].details[oldName];
                    }
                    if(opts[diseaseValue].methods && opts[diseaseValue].methods[oldName]) {
                        opts[diseaseValue].methods[newName] = opts[diseaseValue].methods[oldName];
                        delete opts[diseaseValue].methods[oldName];
                    }
                    saveCustomMedicineOptions(opts);
                }
                renderCustomMedicines();
                showToast('✅ 약제명이 수정되었습니다');
            });
        }

        // ===== 약품명 상세(details) CRUD =====
        function addMedDetail(diseaseValue, medName) {
            showCustomInput('약품명 상세 추가', '예: 85%, 왕스, 1G 등', '', function(val) {
                if(!val || !val.trim()) return;
                var opts = getCustomMedicineOptions();
                if(!opts[diseaseValue]) opts[diseaseValue] = { medicines:[], details:{}, methods:{} };
                if(!opts[diseaseValue].details) opts[diseaseValue].details = {};
                if(!opts[diseaseValue].details[medName]) opts[diseaseValue].details[medName] = [];
                opts[diseaseValue].details[medName].push(val.trim());
                saveCustomMedicineOptions(opts);
                renderCustomMedicines();
                showToast('✅ 약품명 상세가 추가되었습니다');
            });
        }
        function editMedDetail(diseaseValue, medName, idx) {
            var opts = getCustomMedicineOptions();
            var oldVal = opts[diseaseValue]?.details?.[medName]?.[idx] || '';
            showCustomInput('약품명 상세 수정', '', oldVal, function(val) {
                if(!val || !val.trim()) return;
                opts[diseaseValue].details[medName][idx] = val.trim();
                saveCustomMedicineOptions(opts);
                renderCustomMedicines();
                showToast('✅ 수정되었습니다');
            });
        }
        function deleteMedDetail(diseaseValue, medName, idx) {
            var opts = getCustomMedicineOptions();
            opts[diseaseValue].details[medName].splice(idx, 1);
            saveCustomMedicineOptions(opts);
            renderCustomMedicines();
            showToast('🗑️ 삭제되었습니다');
        }

        // ===== 처리방법(methods) CRUD =====
        function addMedMethod(diseaseValue, medName) {
            showCustomInput('처리방법 추가', '예: 기화기, 흘림, 분무 등', '', function(val) {
                if(!val || !val.trim()) return;
                var opts = getCustomMedicineOptions();
                if(!opts[diseaseValue]) opts[diseaseValue] = { medicines:[], details:{}, methods:{} };
                if(!opts[diseaseValue].methods) opts[diseaseValue].methods = {};
                if(!opts[diseaseValue].methods[medName]) opts[diseaseValue].methods[medName] = [];
                opts[diseaseValue].methods[medName].push(val.trim());
                saveCustomMedicineOptions(opts);
                renderCustomMedicines();
                showToast('✅ 처리방법이 추가되었습니다');
            });
        }
        function editMedMethod(diseaseValue, medName, idx) {
            var opts = getCustomMedicineOptions();
            var oldVal = opts[diseaseValue]?.methods?.[medName]?.[idx] || '';
            showCustomInput('처리방법 수정', '', oldVal, function(val) {
                if(!val || !val.trim()) return;
                opts[diseaseValue].methods[medName][idx] = val.trim();
                saveCustomMedicineOptions(opts);
                renderCustomMedicines();
                showToast('✅ 수정되었습니다');
            });
        }
        function deleteMedMethod(diseaseValue, medName, idx) {
            var opts = getCustomMedicineOptions();
            opts[diseaseValue].methods[medName].splice(idx, 1);
            saveCustomMedicineOptions(opts);
            renderCustomMedicines();
            showToast('🗑️ 삭제되었습니다');
        }

        // ===== 초기화 =====
        function resetCustomItems(type) {
            if(type === 'work') {
                localStorage.removeItem('customWorkItems');
                renderCustomWorkItems();
                renderWorkButtons();
                showToast('✅ 작업 항목 초기화 완료');
            } else if(type === 'medicine') {
                localStorage.removeItem('customMedicines');
                localStorage.removeItem('customMedicineOptions');
                renderCustomMedicines();
                showToast('✅ 약제 목록 및 처리방법 초기화 완료');
            }
        }

        // ===== disease-type select 동적 렌더링 =====
        function renderDiseaseTypeSelect() {
            var sel = document.getElementById('disease-type');
            if(!sel) return;
            var diseases = getCustomDiseases();
            sel.innerHTML = diseases.map(function(d) {
                    return '<option value="' + d.value + '">' + d.name + '</option>';
                }).join('') +
                '<option value="direct">직접 입력</option>';
            // 첫 항목 선택 후 약제 목록 업데이트
            if(sel.options.length > 0) {
                sel.selectedIndex = 0;
                updateMedicineOptions();
            }
        }

        // ===== 작업 버튼 동적 렌더링 =====
        function renderWorkButtons() {
            var grid = document.getElementById('work-btn-grid');
            if(!grid) return;
            var works = getCustomWorkItems();
            grid.innerHTML = works.map(function(w) {
                return '<div class="work-btn" onclick="toggleWork(this)">' + w + '</div>';
            }).join('');
        }

        // ===== 가계부 카테고리 렌더링 =====
        function renderAccSettingList(inout) {
            var suffix = inout === 'out' ? 'accout' : 'accin';
            var c = document.getElementById('setting-' + suffix + '-list');
            if(!c) return;
            var cats = customCategories[inout] || {};
            var html = '';
            Object.keys(cats).forEach(function(cat) {
                html += '<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:12px;margin-bottom:10px;">' +
                    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
                        '<span style="color:#FFD54F;font-weight:700;font-size:0.95rem;">📂 ' + cat + '</span>' +
                        '<button class="dyn-btn" data-action="delAccCategory" data-inout="' + inout + '" data-cat="' + cat + '" style="background:rgba(185,28,28,0.5);color:#ff6b6b;border:none;border-radius:6px;padding:3px 10px;font-size:0.75rem;cursor:pointer;">삭제</button>' +
                    '</div>' +
                    '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;">' +
                        cats[cat].map(function(sub, si) {
                            return '<div style="display:inline-flex;align-items:center;background:rgba(255,179,0,0.1);border-radius:14px;padding:4px 10px;gap:5px;">' +
                                '<span style="color:#e8e3d8;font-size:0.85rem;">' + sub + '</span>' +
                                '<button class="dyn-btn" data-action="delAccSubItem" data-inout="' + inout + '" data-cat="' + cat + '" data-index="' + si + '" style="background:rgba(185,28,28,0.5);color:#ff6b6b;border:none;border-radius:50%;width:18px;height:18px;font-size:0.7rem;cursor:pointer;line-height:18px;padding:0;">✕</button>' +
                            '</div>';
                        }).join('') +
                    '</div>' +
                    '<div style="display:flex;gap:6px;">' +
                        '<input type="text" id="sub-input-' + inout + '-' + cat + '" placeholder="세부항목 추가" style="flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(255,179,0,0.2);border-radius:8px;padding:6px 10px;color:#e8e3d8;font-size:0.85rem;">' +
                        '<button onclick="addAccSubItem(\'' + inout + '\',\'' + cat + '\')" style="background:rgba(255,179,0,0.3);color:#FFD54F;border:none;border-radius:8px;padding:6px 12px;font-size:0.82rem;cursor:pointer;font-weight:700;">추가</button>' +
                    '</div>' +
                '</div>';
            });
            c.innerHTML = html;
        }

        function addAccCategory(inout) {
            var suffix = inout === 'out' ? 'accout' : 'accin';
            var input = document.getElementById('setting-' + suffix + '-cat-input');
            if(!input) return;
            var val = input.value.trim();
            if(!val) { showToast('⚠️ 카테고리명을 입력하세요'); return; }
            if(customCategories[inout][val]) { showToast('⚠️ 이미 있는 카테고리입니다'); return; }
            customCategories[inout][val] = [];
            localStorage.setItem('beeCustomCategories', JSON.stringify(customCategories));
            input.value = '';
            renderAccSettingList(inout);
            showToast('✅ 카테고리가 추가되었습니다');
        }

        function addAccSubItem(inout, cat) {
            var input = document.getElementById('sub-input-' + inout + '-' + cat);
            if(!input) return;
            var val = input.value.trim();
            if(!val) { showToast('⚠️ 항목을 입력하세요'); return; }
            if(!customCategories[inout][cat]) customCategories[inout][cat] = [];
            if(customCategories[inout][cat].indexOf(val) !== -1) { showToast('⚠️ 이미 있는 항목입니다'); return; }
            customCategories[inout][cat].push(val);
            localStorage.setItem('beeCustomCategories', JSON.stringify(customCategories));
            renderAccSettingList(inout);
            showToast('✅ 추가되었습니다');
        }

        // ===== showCustomInput 모달 =====
        function showCustomInput(title, placeholder, defaultVal, callback) {
            var overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
            overlay.innerHTML =
                '<div style="background:#2a1f14;border-radius:16px;padding:24px;width:85%;max-width:320px;border:1px solid rgba(255,179,0,0.2);">' +
                    '<h3 style="color:#FFD54F;font-weight:bold;margin-bottom:14px;font-size:1.1rem;">' + title + '</h3>' +
                    '<input id="custom-input-field" type="text" placeholder="' + placeholder + '" value="' + (defaultVal||'') + '" style="width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,179,0,0.3);border-radius:8px;padding:10px 12px;color:#e8e3d8;font-size:1rem;margin-bottom:14px;box-sizing:border-box;">' +
                    '<div style="display:flex;gap:8px;">' +
                        '<button id="custom-input-cancel" style="flex:1;padding:10px;background:rgba(100,100,100,0.3);color:#999;border-radius:8px;border:none;cursor:pointer;font-size:0.9rem;">취소</button>' +
                        '<button id="custom-input-ok" style="flex:1;padding:10px;background:rgba(255,179,0,0.3);color:#FFB300;border-radius:8px;border:none;cursor:pointer;font-weight:700;font-size:0.9rem;">확인</button>' +
                    '</div>' +
                '</div>';
            document.body.appendChild(overlay);
            var inp = overlay.querySelector('#custom-input-field');
            inp.focus();
            inp.select();
            overlay.querySelector('#custom-input-cancel').onclick = function() { document.body.removeChild(overlay); };
            overlay.querySelector('#custom-input-ok').onclick = function() {
                var val = inp.value;
                document.body.removeChild(overlay);
                callback(val);
            };
            inp.addEventListener('keydown', function(e) {
                if(e.key === 'Enter') { var val = inp.value; document.body.removeChild(overlay); callback(val); }
                if(e.key === 'Escape') { document.body.removeChild(overlay); }
            });
        }

        // ===== 백업/복원/리셋 =====
        function backupData() {
            var backup = {
                beeData: localStorage.getItem('beeData'),
                beeMoney: localStorage.getItem('beeMoney'),
                diseaseLogs: localStorage.getItem('diseaseLogs'),
                personalSchedules: localStorage.getItem('personalSchedules'),
                apiarySettings: localStorage.getItem('apiarySettings'),
                customWorkItems: localStorage.getItem('customWorkItems'),
                customDiseases: localStorage.getItem('customDiseases'),
                customMedicines: localStorage.getItem('customMedicines'),
                customMedicineOptions: localStorage.getItem('customMedicineOptions'),
                customAlarmDays: localStorage.getItem('customAlarmDays'),
                beeCustomCategories: localStorage.getItem('beeCustomCategories')
            };
            var blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'bee_master_backup_' + new Date().toISOString().slice(0,10) + '.json';
            a.click();
            showToast('✅ 백업 파일이 다운로드되었습니다');
        }

        function restoreData(input) {
            var file = input.files[0];
            if(!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    Object.keys(data).forEach(function(key) {
                        if(data[key]) localStorage.setItem(key, data[key]);
                    });
                    showToast('✅ 복원 완료! 앱을 새로고침합니다...');
                    setTimeout(function() { location.reload(); }, 1200);
                } catch(err) {
                    showToast('⚠️ 파일 형식 오류');
                }
            };
            reader.readAsText(file);
        }

        function executeReset() {
            var resetDiary    = document.getElementById('reset-diary')?.checked;
            var resetDisease  = document.getElementById('reset-disease')?.checked;
            var resetAccount  = document.getElementById('reset-account')?.checked;
            var resetSchedule = document.getElementById('reset-schedule')?.checked;
            if(!resetDiary && !resetDisease && !resetAccount && !resetSchedule) {
                showToast('⚠️ 초기화할 항목을 선택하세요');
                return;
            }
            if(!confirm('선택한 데이터를 초기화하시겠습니까? 복구가 불가능합니다!')) return;
            if(resetDiary)    { db = {}; localStorage.setItem('beeData', '{}'); }
            if(resetDisease)  { diseaseLogs = []; localStorage.setItem('diseaseLogs', '[]'); }
            if(resetAccount)  { accLogs = []; localStorage.setItem('beeMoney', '[]'); }
            if(resetSchedule) { personalSchedules = []; localStorage.setItem('personalSchedules', '[]'); }
            showToast('✅ 초기화 완료');
        }

        // ==================== 엑셀 내보내기 ====================
        function exportDiaryToExcel() {
            if(!window.XLSX) {
                showToast('⚠️ 엑셀 라이브러리 로딩 중입니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            const data = [];
            data.push(['날짜', '봉장', '양봉/토종', '작업내용', '메모', '사진수']);

            // db 객체를 날짜 순으로 정렬
            const sortedKeys = Object.keys(db).sort((a, b) => {
                const dateA = new Date(a.split('-').join('/'));
                const dateB = new Date(b.split('-').join('/'));
                return dateA - dateB;
            });

            sortedKeys.forEach(key => {
                if(db[key].records && db[key].records.length > 0) {
                    db[key].records.forEach(record => {
                        const works = (record.works || []).join(', ');
                        const photoCount = (record.photos || []).length;
                        data.push([
                            key,
                            record.loc || '',
                            record.beeType || '양봉',
                            works,
                            record.memo || '',
                            photoCount
                        ]);
                    });
                }
            });

            if(data.length === 1) {
                showToast('⚠️ 내보낼 일지 데이터가 없습니다');
                return;
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // 열 너비 설정
            ws['!cols'] = [
                {wch: 12}, // 날짜
                {wch: 10}, // 봉장
                {wch: 10}, // 양봉/토종
                {wch: 30}, // 작업내용
                {wch: 40}, // 메모
                {wch: 8}   // 사진수
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '양봉일지');

            const today = new Date();
            const filename = `BEE_MASTER_일지_${today.getFullYear()}_${String(today.getMonth()+1).padStart(2,'0')}_${String(today.getDate()).padStart(2,'0')}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            showToast('✅ 일지 엑셀 다운로드 완료!');
        }

        function exportAccountToExcel() {
            if(!window.XLSX) {
                showToast('⚠️ 엑셀 라이브러리 로딩 중입니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            if(accLogs.length === 0) {
                showToast('⚠️ 내보낼 가계부 데이터가 없습니다');
                return;
            }

            const data = [];
            data.push(['날짜', '구분', '카테고리', '항목', '금액', '고객명', '고객연락처', '수량', '메모']);

            // 날짜 순으로 정렬
            const sortedLogs = [...accLogs].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });

            sortedLogs.forEach(log => {
                data.push([
                    log.date,
                    log.type === 'in' ? '수입' : '지출',
                    log.category || '',
                    log.item || '',
                    log.price || 0,
                    log.customerName || '',
                    log.customerPhone || '',
                    log.customerQuantity || '',
                    log.memo || ''
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // 열 너비 설정
            ws['!cols'] = [
                {wch: 12}, // 날짜
                {wch: 8},  // 구분
                {wch: 12}, // 카테고리
                {wch: 20}, // 항목
                {wch: 12}, // 금액
                {wch: 12}, // 고객명
                {wch: 15}, // 연락처
                {wch: 8},  // 수량
                {wch: 30}  // 메모
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '가계부');

            // 월별 통계 시트 추가
            const statData = [];
            statData.push(['연월', '총 수입', '총 지출', '수익']);

            const monthlyStats = {};
            sortedLogs.forEach(log => {
                const date = new Date(log.date);
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
                
                if(!monthlyStats[yearMonth]) {
                    monthlyStats[yearMonth] = {income: 0, expense: 0};
                }
                
                if(log.type === 'in') {
                    monthlyStats[yearMonth].income += log.price;
                } else {
                    monthlyStats[yearMonth].expense += log.price;
                }
            });

            Object.keys(monthlyStats).sort().forEach(ym => {
                const stat = monthlyStats[ym];
                const profit = stat.income - stat.expense;
                statData.push([ym, stat.income, stat.expense, profit]);
            });

            const ws2 = XLSX.utils.aoa_to_sheet(statData);
            ws2['!cols'] = [{wch: 10}, {wch: 12}, {wch: 12}, {wch: 12}];
            XLSX.utils.book_append_sheet(wb, ws2, '월별통계');

            const today = new Date();
            const filename = `BEE_MASTER_가계부_${today.getFullYear()}_${String(today.getMonth()+1).padStart(2,'0')}_${String(today.getDate()).padStart(2,'0')}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            showToast('✅ 가계부 엑셀 다운로드 완료!');
        }

        // ==================== 사진 첨부 기능 ====================
        let currentDiaryPhotos = [];

        function handleDiaryPhotoUpload(input) {
            const files = input.files;
            if(!files || files.length === 0) return;

            const maxPhotos = 3;
            const remainingSlots = maxPhotos - currentDiaryPhotos.length;

            if(remainingSlots <= 0) {
                showToast('⚠️ 최대 3장까지만 첨부할 수 있습니다');
                input.value = '';
                return;
            }

            const filesToProcess = Math.min(files.length, remainingSlots);
            let processed = 0;

            for(let i = 0; i < filesToProcess; i++) {
                const file = files[i];
                
                if(!file.type.startsWith('image/')) {
                    showToast('⚠️ 이미지 파일만 첨부 가능합니다');
                    continue;
                }

                // 파일 크기 체크 (5MB)
                if(file.size > 5 * 1024 * 1024) {
                    showToast('⚠️ 파일 크기는 5MB 이하여야 합니다');
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    compressImage(e.target.result, 800, 0.7, function(compressed) {
                        currentDiaryPhotos.push(compressed);
                        processed++;
                        
                        if(processed === filesToProcess) {
                            renderDiaryPhotoPreview();
                            showToast(`✅ 사진 ${processed}장이 추가되었습니다`);
                        }
                    });
                };
                reader.readAsDataURL(file);
            }

            input.value = '';
        }

        function compressImage(base64, maxWidth, quality, callback) {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;

                if(width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                const compressed = canvas.toDataURL('image/jpeg', quality);
                callback(compressed);
            };
            img.src = base64;
        }

        function renderDiaryPhotoPreview() {
            const container = document.getElementById('diary-photo-preview');
            if(!container) return;

            container.innerHTML = currentDiaryPhotos.map((photo, idx) => {
                return `
                    <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.3);">
                        <img src="${photo}" style="width: 100%; height: 100%; object-fit: cover;">
                        <button onclick="removeDiaryPhoto(${idx})" style="position: absolute; top: 4px; right: 4px; background: rgba(239,68,68,0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 24px;">✕</button>
                    </div>
                `;
            }).join('');
        }

        function removeDiaryPhoto(index) {
            currentDiaryPhotos.splice(index, 1);
            renderDiaryPhotoPreview();
            showToast('🗑️ 사진이 삭제되었습니다');
        }

        function clearDiaryPhotos() {
            currentDiaryPhotos = [];
            renderDiaryPhotoPreview();
        }

        function showPhotoModal(photoSrc) {
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('photo-modal-img');
            if(modal && img) {
                img.src = photoSrc;
                modal.style.display = 'block';
            }
        }

        function closePhotoModal() {
            const modal = document.getElementById('photo-modal');
            if(modal) {
                modal.style.display = 'none';
            }
        }

        // ==================== 방역 사진 처리 ====================
        let currentDiseasePhotos = [];

        function handleDiseasePhotoUpload(input) {
            const files = input.files;
            if(!files || files.length === 0) return;

            const maxPhotos = 3;
            const remainingSlots = maxPhotos - currentDiseasePhotos.length;

            if(remainingSlots <= 0) {
                showToast('⚠️ 최대 3장까지만 첨부할 수 있습니다');
                input.value = '';
                return;
            }

            const filesToProcess = Math.min(files.length, remainingSlots);
            let processed = 0;

            for(let i = 0; i < filesToProcess; i++) {
                const file = files[i];
                
                if(!file.type.startsWith('image/')) {
                    showToast('⚠️ 이미지 파일만 첨부 가능합니다');
                    continue;
                }

                if(file.size > 5 * 1024 * 1024) {
                    showToast('⚠️ 파일 크기는 5MB 이하여야 합니다');
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    compressImage(e.target.result, 800, 0.7, function(compressed) {
                        currentDiseasePhotos.push(compressed);
                        processed++;
                        
                        if(processed === filesToProcess) {
                            renderDiseasePhotoPreview();
                            showToast(`✅ 사진 ${processed}장이 추가되었습니다`);
                        }
                    });
                };
                reader.readAsDataURL(file);
            }

            input.value = '';
        }

        function renderDiseasePhotoPreview() {
            const container = document.getElementById('disease-photo-preview');
            if(!container) return;

            container.innerHTML = currentDiseasePhotos.map((photo, idx) => {
                return `
                    <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.3);">
                        <img src="${photo}" style="width: 100%; height: 100%; object-fit: cover;">
                        <button onclick="removeDiseasePhoto(${idx})" style="position: absolute; top: 4px; right: 4px; background: rgba(239,68,68,0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 24px;">✕</button>
                    </div>
                `;
            }).join('');
        }

        function removeDiseasePhoto(index) {
            currentDiseasePhotos.splice(index, 1);
            renderDiseasePhotoPreview();
            showToast('🗑️ 사진이 삭제되었습니다');
        }

        function clearDiseasePhotos() {
            currentDiseasePhotos = [];
            renderDiseasePhotoPreview();
        }

        function renderLocationButtons() {
            try {
                console.log('🏠 봉장 버튼 렌더링 시작');
                
                const container = document.getElementById('location-buttons');
                if(!container) {
                    console.error('location-buttons 컨테이너를 찾을 수 없음');
                    return;
                }
                
                const activeApiaries = getActiveApiaries();
                const locSelect = document.getElementById('loc-select');
                // JS 변수(selectedApiaryLoc) 기준으로 봉장 결정 - hidden input 의존 제거
                const newValue = activeApiaries.includes(selectedApiaryLoc) ? selectedApiaryLoc : (activeApiaries[0] || '1봉장');
                selectedApiaryLoc = newValue;
                if(locSelect) locSelect.value = newValue;
                
                container.innerHTML = activeApiaries.map(loc => {
                    const isActive = loc === newValue;
                    const icon = loc.includes('이동') ? '🚚' : '🏠';
                    const displayName = getDisplayName(loc).replace('봉장', '봉').replace('이동봉', '이동봉');
                    
                    return `
                        <button class="location-btn ${isActive ? 'active' : ''}" data-loc="${loc}" onclick="selectLocation(this)" style="flex: 0 0 auto; min-width: 70px; padding: 8px 12px;">
                            <div style="font-size: 1rem; margin-bottom: 2px;">${icon}</div>
                            <div style="font-weight: bold; font-size: 0.8rem;">${displayName}</div>
                        </button>
                    `;
                }).join('');
                
                console.log('✅ 봉장 버튼 렌더링 완료:', activeApiaries);
            } catch(error) {
                console.error('❌ 봉장 버튼 렌더링 오류:', error);
            }
        }

        function renderLocationFilters() {
            try {
                // 활성 봉장 + db에 실제 기록된 봉장 모두 수집
                const activeApiaries = getActiveApiaries();
                
                // db에서 실제 사용된 봉장 추출 (설정 안 했어도 기록 있으면 표시)
                const dbLocs = new Set();
                Object.values(db).forEach(function(entry) {
                    if(entry && entry.records) {
                        entry.records.forEach(function(r) { if(r.loc) dbLocs.add(r.loc); });
                    }
                });
                
                // 합집합 (중복 제거, 정렬)
                const allLocs = [...new Set([...activeApiaries, ...dbLocs])].sort();
                
                // 필터 버튼 생성
                const calContainer = document.getElementById('location-filters');
                if(calContainer) {
                    calContainer.innerHTML = '';
                    var allLocs2 = ['all'].concat(allLocs);
                    allLocs2.forEach(function(v) {
                        var isAct = (v === calLocFilter);
                        var lbl = (v === 'all') ? '전체'
                            : ((v.includes('이동') ? '🚚 ' : '🏠 ') + getDisplayName(v));
                        var b = document.createElement('button');
                        b.className = 'filter-btn' + (isAct ? ' active' : '');
                        b.setAttribute('data-filter', v);
                        b.style.cssText = 'min-height:36px;padding:6px 14px;font-weight:700;';
                        b.textContent = lbl;
                        b.onclick = (function(fv){ return function(){ filterByLocation(fv); }; })(v);
                        calContainer.appendChild(b);
                    });
                }
                
                renderDiseaseFilters();
            } catch(error) {
                console.error('❌ 필터 버튼 렌더링 오류:', error);
            }
        }

        function renderDiseaseFilters() {
            const container = document.getElementById('disease-location-filters');
            if(!container) return;
            const activeApiaries = getActiveApiaries();
            
            // 방제기록에서도 실제 봉장 추출
            const diseaseLocs = new Set();
            (diseaseLogs || []).forEach(function(log) { if(log.location) diseaseLocs.add(log.location); });
            const allLocs = [...new Set([...activeApiaries, ...diseaseLocs])].sort();
            
            let html = '<button class="filter-btn active" data-filter="all" onclick="filterDiseaseByLoc(this)" style="min-height:38px;padding:6px 14px;font-weight:700;">🗂️ 전체</button>';
            html += allLocs.map(function(loc) {
                const icon = loc.includes('이동') ? '🚚' : '🏠';
                const displayName = loc.replace('봉장','');
                return '<button class="filter-btn" data-filter="' + loc + '" onclick="filterDiseaseByLoc(this)" style="min-height:38px;padding:6px 14px;font-weight:700;">' + icon + ' ' + displayName + '</button>';
            }).join('');
            container.innerHTML = html;
        }

        function filterDiseaseByLoc(btn) {
            diseaseLocFilter = btn.dataset.filter;
            document.querySelectorAll('#disease-location-filters .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderDiseaseHistory();
        }

        function selectLocation(btn) {
            document.querySelectorAll('.location-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedApiaryLoc = btn.dataset.loc;
            document.getElementById('loc-select').value = btn.dataset.loc;
        }

        function filterByLocation(filterVal) {
            calLocFilter = filterVal;
            // 버튼 active 상태 즉시 반영
            document.querySelectorAll('#location-filters .filter-btn').forEach(function(b) {
                if(b.getAttribute('data-filter') === filterVal) {
                    b.classList.add('active');
                } else {
                    b.classList.remove('active');
                }
            });
            // 달력 재렌더링
            renderCalendar();
            showToast('📍 ' + (calLocFilter === 'all' ? '전체' : calLocFilter));
        }

        // ==================== 개인 일정 ====================
        function savePersonalSchedule() {
            const date = document.getElementById('schedule-date').value;
            const title = document.getElementById('schedule-title').value;
            const memo = document.getElementById('schedule-memo').value;

            if(!date || !title) {
                showToast('⚠️ 날짜와 제목을 입력해주세요');
                return;
            }

            personalSchedules.push({
                date: date,
                title: title,
                memo: memo,
                timestamp: new Date().toISOString()
            });

            localStorage.setItem('personalSchedules', JSON.stringify(personalSchedules));
            
            document.getElementById('schedule-date').value = '';
            document.getElementById('schedule-title').value = '';
            document.getElementById('schedule-memo').value = '';

            showToast('✅ 일정이 저장되었습니다');
            renderScheduleList();
            renderCalendar();
            // 달력 화면으로 복귀 + 해당 날짜 기록 표시
            setTimeout(() => {
                const savedDate = date; // date = schedule-date.value
                const [y, m, d] = savedDate.split('-').map(Number);
                const todayKey = `${y}-${m}-${d}`;
                switchView('calendar', true);
                setTimeout(() => showDayWithSchedule(todayKey), 100);
            }, 300);
        }

        function renderScheduleList() {
            const list = document.getElementById('schedule-list');
            if(!list) return;

            if(personalSchedules.length === 0) {
                list.innerHTML = '<p class="text-center py-20" style="color: #666; font-style: italic;">등록된 일정이 없습니다.</p>';
                return;
            }

            const sorted = [...personalSchedules].sort((a, b) => new Date(a.date) - new Date(b.date));

            list.innerHTML = sorted.map((s, index) => {
                const originalIndex = personalSchedules.indexOf(s);
                const date = new Date(s.date);
                const dateStr = (date.getMonth() + 1) + '월 ' + date.getDate() + '일';
                const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                const dayName = dayNames[date.getDay()];

                return '<div class="record-card" style="border-left-color: #c084fc;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">' +
                        '<span style="font-size: 0.75rem; background: rgba(192,132,252,0.3); color: #c084fc; padding: 4px 12px; border-radius: 12px; font-weight: bold;">' + dateStr + ' (' + dayName + ')</span>' +
                        '<button class="dyn-btn" data-action="deleteSchedule" data-index="' + originalIndex + '" style="background: #dc2626; color: #ffffff; padding: 6px 14px; border-radius: 6px; font-size: 0.85rem; border: none; cursor: pointer; font-weight: 800; letter-spacing: 0.5px;">삭제</button>' +
                    '</div>' +
                    '<div style="font-weight: bold; color: white; font-size: 1.125rem; margin-bottom: 12px;">' + s.title + '</div>' +
                    (s.memo ? '<div style="font-size: 0.875rem; color: #999; margin-bottom: 12px;">' + s.memo + '</div>' : '') +
                '</div>';
            }).join('');
        }

        function deleteSchedule(index) {
            const schedule = personalSchedules[index];
            if(!schedule) {
                showToast('⚠️ 일정을 찾을 수 없습니다');
                return;
            }

            if(confirm(schedule.title + ' 일정을 삭제하시겠습니까?')) {
                personalSchedules.splice(index, 1);
                localStorage.setItem('personalSchedules', JSON.stringify(personalSchedules));
                showToast('✅ 일정이 삭제되었습니다');
                renderScheduleList();
                renderCalendar();
            }
        }

        function editSchedule(index) {
            const schedule = personalSchedules[index];
            if(!schedule) {
                showToast('⚠️ 일정을 찾을 수 없습니다');
                return;
            }
            // 일정 입력 화면으로 이동 후 데이터 채우기
            switchView('personal-schedule', true);
            setTimeout(function() {
                var titleEl = document.getElementById('schedule-title');
                var dateEl = document.getElementById('schedule-date');
                var memoEl = document.getElementById('schedule-memo');
                if(titleEl) titleEl.value = schedule.title || '';
                if(dateEl) dateEl.value = schedule.date || '';
                if(memoEl) memoEl.value = schedule.memo || '';
                // 기존 항목 삭제 후 수정본 저장 방식
                personalSchedules.splice(index, 1);
                localStorage.setItem('personalSchedules', JSON.stringify(personalSchedules));
                showToast('✏️ 내용을 수정 후 저장하세요');
            }, 100);
        }

        // ==================== 가계부 ====================
        function switchAccView(v) {
            document.getElementById('acc-page-calendar').style.display = v === 'calendar' ? 'block' : 'none';
            document.getElementById('acc-page-list').style.display = v === 'list' ? 'block' : 'none';
            document.getElementById('acc-page-stat').style.display = v === 'stat' ? 'block' : 'none';
            var cpEl = document.getElementById('acc-page-customers'); if(cpEl) cpEl.style.display = v === 'customers' ? 'block' : 'none';
            if(v === 'list') { initAccLines(); renderMainCats(); }
            // 가계부 탭 활성화 스타일
            var accTabs = {
                'calendar': 'v-acc-calendar',
                'list': 'v-list',
                'stat': 'v-stat',
                'customers': 'v-customers'
            };
            var accIcons = {'calendar':'📅','list':'✏️','stat':'📊','customers':'👥'};
            var accLabels = {'calendar':'달력','list':'기록','stat':'내역','customers':'고객'};
            Object.keys(accTabs).forEach(function(key) {
                var el = document.getElementById(accTabs[key]);
                if(!el) return;
                if(key === v) {
                    el.style.background = 'linear-gradient(135deg,#16a34a,#15803d)';
                    el.style.color = '#fff';
                    el.style.fontWeight = '800';
                } else {
                    el.style.background = 'transparent';
                    el.style.color = '#888';
                    el.style.fontWeight = '700';
                }
            });
            
            if(v === 'calendar') renderAccCalendar();
            else if(v === 'stat') renderStatView();
            else if(v === 'customers') renderCustomerList();
            else if(v === 'list') {
                // 기록하기 탭 진입 시 항상 초기화
                selectedAccItems = [];
                inoutType = 'out';
                var tOut = document.getElementById('t-out');
                var tIn  = document.getElementById('t-in');
                if(tOut) tOut.classList.add('active');
                if(tIn)  tIn.classList.remove('active');
                var inItem = document.getElementById('in-item');
                var inPrice = document.getElementById('in-price');
                if(inItem) inItem.value = '';
                if(inPrice) inPrice.value = '';
                var qEl = document.getElementById('acc-quantity');
                var upEl = document.getElementById('acc-unit-price');
                if(qEl) qEl.value = '';
                if(upEl) upEl.value = '';
                var subArea = document.getElementById('sub-area');
                if(subArea) subArea.style.display = 'none';
                renderMainCats();
            }
        }

        function changeAccMonth(n) {
            accViewDate.setMonth(accViewDate.getMonth() + n);
            renderAccCalendar();
        }

        function changeAccYear(n) {
            accViewDate.setFullYear(accViewDate.getFullYear() + n);
            renderAccCalendar();
        }

        function goToAccToday() {
            accViewDate = new Date();
            renderAccCalendar();
            initAccLines();
            showToast('📅 오늘 날짜로 이동했습니다');
        }

        function renderAccCalendar() {
            const y = accViewDate.getFullYear();
            const m = accViewDate.getMonth();
            
            document.getElementById('acc-cal-title').innerText = y + '년 ' + (m+1) + '월';
            
            const body = document.getElementById('acc-cal-body');
            body.innerHTML = '';
            
            ['일','월','화','수','목','금','토'].forEach(d => {
                body.innerHTML += '<div class="cal-head">' + d + '</div>';
            });
            
            const start = new Date(y, m, 1).getDay();
            const last = new Date(y, m+1, 0).getDate();
            
            for(let i=0; i<start; i++) {
                body.innerHTML += '<div></div>';
            }
            
            const today = new Date();
            const isThisMonth = today.getFullYear() === y && today.getMonth() === m;
            const todayDateNum = today.getDate();
            
            for(let d=1; d<=last; d++) {
                const key = y + '-' + (m+1) + '-' + d;
                let cls = "cal-day";
                
                if(isThisMonth && d === todayDateNum) {
                    cls += " today-highlight";
                }
                
                const hasAccData = accLogs.some(log => {
                    const logDate = new Date(log.date);
                    return logDate.getFullYear() === y && logDate.getMonth() === m && logDate.getDate() === d;
                });
                
                if(hasAccData) cls += " border-green-400";
                
                let content = '';
                
                const solarTerm = solarTerms[key];
                if(solarTerm) {
                    content += '<span class="solar-term">' + solarTerm + '</span>';
                }
                
                content += '<span style="font-weight: bold; font-size: 1.1rem;">' + d + '</span>';
                
                if(isThisMonth && d === todayDateNum) {
                    content = (solarTerm ? '<span class="solar-term">' + solarTerm + '</span>' : '') +
                              '<span style="background:#15803d;color:#fff;font-size:0.6rem;padding:1px 5px;border-radius:6px;font-weight:900;display:block;margin-bottom:1px;">오늘</span>' +
                              '<span style="font-weight:bold;font-size:' + (solarTerm ? '0.9rem' : '1.05rem') + ';">' + d + '</span>';
                }
                
                if(hasAccData) {
                    const dayLogs = accLogs.filter(log => {
                        const logDate = new Date(log.date);
                        return logDate.getFullYear() === y && logDate.getMonth() === m && logDate.getDate() === d;
                    });
                    const count = dayLogs.length;
                    content += '<div style="font-size: 0.65rem; color: #4ade80; margin-top: 4px;">💰' + count + '건</div>';
                }
                
                body.innerHTML += '<div class="' + cls + '" onclick="goToAccInput()">' + content + '</div>';
            }
            
            // 오늘 수입/지출 요약 렌더링
            renderAccTodaySummary();
        }

        function goToAccInput() {
            switchAccView('list');
        }

        function renderAccTodaySummary() {
            var container = document.getElementById('acc-today-summary');
            if(!container) return;

            var today = new Date();
            var ty = today.getFullYear();
            var tm = today.getMonth();
            var td = today.getDate();

            var todayLogs = (accLogs || []).filter(function(log) {
                var d = new Date(log.date);
                return d.getFullYear() === ty && d.getMonth() === tm && d.getDate() === td;
            });

            if(todayLogs.length === 0) {
                container.innerHTML =
                    '<div style="padding: 16px; background: rgba(74,222,128,0.05); border-radius: 12px; border: 1px solid rgba(74,222,128,0.15); text-align: center;">' +
                        '<p style="color: #666; font-size: 0.9rem;">오늘 기록된 수입/지출이 없습니다</p>' +
                    '</div>';
                return;
            }

            var totalIn  = 0, totalOut = 0;
            todayLogs.forEach(function(l) {
                if(l.type === 'in')  totalIn  += (l.price || 0);
                else                 totalOut += (l.price || 0);
            });
            var net = totalIn - totalOut;

            var rows = todayLogs.map(function(l, i) {
                var isIn = l.type === 'in';
                var color = isIn ? '#4ade80' : '#f87171';
                var sign  = isIn ? '+' : '-';
                var originalIndex = accLogs.indexOf(l);
                return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px;">' +
                    '<div>' +
                        '<span style="font-size: 0.75rem; background: rgba(' + (isIn ? '74,222,128' : '248,113,113') + ',0.2); color: ' + color + '; padding: 2px 8px; border-radius: 10px; margin-right: 8px;">' + (isIn ? '수입' : '지출') + '</span>' +
                        '<span style="color: #e8e3d8; font-size: 0.9rem;">' + (l.item || '항목 없음') + '</span>' +
                        (l.lines && l.lines.length > 0 ? '<div style="margin-top:3px;">' + l.lines.map(function(ln){ return '<span style="font-size:0.72rem;color:#999;margin-right:6px;">'+ln.name+' '+ln.qty+'개×'+ln.unitPrice.toLocaleString()+'원</span>'; }).join('') + '</div>' : '') +
                    '</div>' +
                    '<div style="display: flex; align-items: center; gap: 8px;">' +
                        '<span style="color: ' + color + '; font-weight: 700;">' + sign + (l.price || 0).toLocaleString() + '원</span>' +
                        '<button class="dyn-btn" data-action="editAccountRecord" data-index="' + originalIndex + '" style="background: rgba(74,222,128,0.25); color: #4ade80; padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; border: none; cursor: pointer;">수정</button> ' +
                        '<button class="dyn-btn" data-action="deleteAccountRecord" data-index="' + originalIndex + '" style="background: rgba(185,28,28,0.4); color: #ff6b6b; padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; border: none; cursor: pointer;">삭제</button>' +
                    '</div>' +
                '</div>';
            }).join('');

            container.innerHTML =
                '<div style="background: rgba(74,222,128,0.08); border-radius: 14px; border: 1px solid rgba(74,222,128,0.2); padding: 16px;">' +
                    '<p style="color: #4ade80; font-weight: 900; font-size: 1rem; margin-bottom: 14px; display: flex; align-items: center; gap: 6px;">📋 오늘 수입/지출 <span style="font-size:0.8rem; color:#999;">(' + todayLogs.length + '건)</span></p>' +
                    rows +
                    '<div style="border-top: 1px solid rgba(74,222,128,0.2); margin-top: 12px; padding-top: 12px; display: flex; justify-content: space-between; align-items: center;">' +
                        '<div style="display: flex; gap: 16px;">' +
                            '<div><span style="color: #999; font-size: 0.8rem;">수입 </span><span style="color: #4ade80; font-weight: 700;">+' + totalIn.toLocaleString() + '원</span></div>' +
                            '<div><span style="color: #999; font-size: 0.8rem;">지출 </span><span style="color: #f87171; font-weight: 700;">-' + totalOut.toLocaleString() + '원</span></div>' +
                        '</div>' +
                        '<div><span style="color: #999; font-size: 0.8rem;">잔액 </span><strong style="color: ' + (net >= 0 ? '#4ade80' : '#f87171') + '; font-size: 1.05rem;">' + (net >= 0 ? '+' : '') + net.toLocaleString() + '원</strong></div>' +
                    '</div>' +
                '</div>';
        }

        function setInout(t) {
            inoutType = t;
            selectedAccItems = [];
            renderAccTags();
            initAccLines();
            document.getElementById('t-out').className = 'm-tab tab-out' + (t === 'out' ? ' active' : '');
            document.getElementById('t-in').className = 'm-tab tab-in' + (t === 'in' ? ' active' : '');
            // mode-tab 컨테이너 색상 전환
            var modeTabs = document.querySelectorAll('.mode-tab');
            modeTabs.forEach(function(el) {
                el.classList.remove('mode-out', 'mode-in');
                el.classList.add(t === 'out' ? 'mode-out' : 'mode-in');
            });
            
            // 고객관리 필드 표시/숨김
            const customerInfo = document.getElementById('customer-info');
            if(customerInfo) {
                customerInfo.style.display = t === 'in' ? 'block' : 'none';
            }
            
            renderMainCats();
            document.getElementById('sub-area').style.display = 'none';
        }

        function renderMainCats() {
            try {
                console.log('📦 카테고리 렌더링 시작');
                
                const area = document.getElementById('main-cat-area');
                if(!area) {
                    console.warn('main-cat-area를 찾을 수 없음 (가계부 화면이 아닐 수 있음)');
                    return;
                }
                
                area.innerHTML = '';
                Object.keys(categories[inoutType]).forEach(function(catName) {
                    var btn = document.createElement('div');
                    btn.className = 'm-cat-btn';
                    btn.textContent = catName;
                    // pointerup: 터치/마우스 모두 한 번만 발생
                    btn.addEventListener('pointerup', function(e) {
                        e.stopPropagation();
                        showSub(catName, btn);
                    });
                    area.appendChild(btn);
                });
                
                console.log('✅ 카테고리 렌더링 완료');
            } catch(error) {
                console.error('❌ 카테고리 렌더링 오류:', error);
            }
        }

        function showSub(cat, el) {
            document.querySelectorAll('.m-cat-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');

            const subArea = document.getElementById('sub-area');
            subArea.style.display = 'block';

            var subList = document.getElementById('sub-list');
            subList.innerHTML = '';
            categories[inoutType][cat].forEach(function(s) {
                var btn = document.createElement('div');
                btn.className = 's-btn';
                btn.textContent = s;
                // pointerup: 터치/마우스 모두 한 번만 발생
                btn.addEventListener('pointerup', function(e) {
                    e.stopPropagation();
                    setFinal(s);
                });
                subList.appendChild(btn);
            });
        }

        var _setFinalLock = false;
        function setFinal(v) {
            // 터치+클릭 이중 발생 방지 (300ms 이내 중복 호출 차단)
            if(_setFinalLock) return;
            _setFinalLock = true;
            setTimeout(function(){ _setFinalLock = false; }, 350);

            if(v === '기타') {
                // 기타: 빈 행 찾거나 추가 후 품목명 포커스
                let targetIdx = accLines.findIndex(l => !l.name.trim());
                if(targetIdx === -1) {
                    accLines.push({ name: '', qty: 0, unitPrice: 0 });
                    targetIdx = accLines.length - 1;
                }
                currentLineIdx = targetIdx;
                renderAccLines();
                setTimeout(() => {
                    const row = document.querySelector('.acc-line-row[data-idx="'+targetIdx+'"]');
                    if(row) row.querySelector('input[type="text"]').focus();
                }, 50);
                return;
            }

            // 현재 활성 행이 비어있으면 거기에 설정, 아니면 새 행 추가
            let targetIdx = -1;
            if(!accLines[currentLineIdx]?.name?.trim()) {
                targetIdx = currentLineIdx;
            } else {
                // 이름 없는 빈 행 탐색
                targetIdx = accLines.findIndex(l => !l.name.trim());
                if(targetIdx === -1) {
                    // 없으면 새 행 추가
                    accLines.push({ name: '', qty: 0, unitPrice: 0 });
                    targetIdx = accLines.length - 1;
                }
            }

            // 품목명 설정, 수량/단가 초기화
            accLines[targetIdx].name = v;
            accLines[targetIdx].qty = 0;
            accLines[targetIdx].unitPrice = 0;
            currentLineIdx = targetIdx;

            // DOM 재생성 후 수량 입력 포커스
            renderAccLines();
            setTimeout(() => {
                const row = document.querySelector('.acc-line-row[data-idx="'+targetIdx+'"]');
                if(row) {
                    const inputs = row.querySelectorAll('input');
                    if(inputs[1]) inputs[1].focus(); // 수량 input
                }
            }, 50);

            // 선택된 s-btn 강조 (selected 클래스)
            document.querySelectorAll('.s-btn').forEach(function(btn) {
                btn.classList.remove('selected');
                if(btn.textContent.trim() === v) {
                    btn.classList.add('selected');
                }
            });
        }

        function renderAccTags() {
            const tagsDiv = document.getElementById('selected-acc-tags');
            if(!tagsDiv) return;
            if(selectedAccItems.length === 0) {
                tagsDiv.style.display = 'none';
                return;
            }
            tagsDiv.style.display = 'flex';
            tagsDiv.innerHTML = selectedAccItems.map(item =>
                `<span style="background:rgba(255,179,0,0.25);color:#FFD54F;border:1px solid rgba(255,179,0,0.5);padding:4px 10px;border-radius:16px;font-size:0.82rem;font-weight:700;display:inline-flex;align-items:center;gap:6px;" onclick="applyTagToCurrentLine('${item}')">
                    ${item}
                </span>`
            ).join('');
        }

        function removeAccTag(item) {
            selectedAccItems = selectedAccItems.filter(i => i !== item);
            renderAccTags();
            document.querySelectorAll('.s-btn').forEach(btn => {
                if(btn.textContent.trim() === item) {
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.borderColor = '';
                }
            });
        }

        // ===== 가계부 다중 품목 관리 =====
        let accLines = []; // [{name:'', qty:1, unitPrice:0}]
        let currentLineIdx = 0; // 현재 편집 중인 행 인덱스

        function initAccLines() {
            accLines = [{ name: '', qty: 0, unitPrice: 0 }];
            currentLineIdx = 0;
            renderAccLines();
        }

        function addAccLine() {
            accLines.push({ name: '', qty: 0, unitPrice: 0 });
            currentLineIdx = accLines.length - 1;
            renderAccLines();
            // 새 행 품목명 포커스
            setTimeout(() => {
                const row = document.querySelector('.acc-line-row[data-idx="'+currentLineIdx+'"]');
                if(row) row.querySelector('input[type="text"]').focus();
            }, 50);
        }

        function removeAccLine(idx) {
            if(accLines.length <= 1) {
                accLines[0] = { name: '', qty: 1, unitPrice: 0 };
            } else {
                accLines.splice(idx, 1);
                if(currentLineIdx >= accLines.length) currentLineIdx = accLines.length - 1;
            }
            renderAccLines();
        }

        function updateAccLine(idx, field, value) {
            currentLineIdx = idx;
            if(field === 'qty') {
                // 소수점 포함 자유입력 허용 (0.5kg, 2.5L 등)
                accLines[idx][field] = parseFloat(value.replace(/[^0-9.]/g, '')) || 0;
            } else if(field === 'unitPrice') {
                accLines[idx][field] = parseInt(value.replace(/[^0-9]/g, '')) || 0;
            } else {
                accLines[idx][field] = value;
            }
            updateAccTotal();
        }

        function applyTagToCurrentLine(itemName) {
            accLines[currentLineIdx].name = itemName;
            // 해당 행 품목명 input 값만 갱신 (DOM 재생성 없이)
            const row = document.querySelector('.acc-line-row[data-idx="'+currentLineIdx+'"]');
            if(row) {
                const nameInput = row.querySelector('input[type="text"]');
                if(nameInput) nameInput.value = itemName;
                // 수량 입력으로 포커스
                const inputs = row.querySelectorAll('input');
                if(inputs[1]) setTimeout(() => inputs[1].focus(), 30);
            }
        }

        function renderAccLines() {
            const container = document.getElementById('acc-lines-container');
            if(!container) return;
            
            // DOM을 통째로 교체하면 포커스가 끊기므로
            // 행 수가 바뀔 때만 HTML 재생성, 아닐 때는 값만 갱신
            const existingRows = container.querySelectorAll('.acc-line-row');
            
            if(existingRows.length !== accLines.length) {
                // 행 수 변경 시에만 전체 재생성
                _buildAccLinesHTML(container);
            } else {
                // 행 수 동일 → 값·소계·활성 테두리 갱신 (포커스 유지)
                accLines.forEach((line, idx) => {
                    const row = container.querySelector('.acc-line-row[data-idx="'+idx+'"]');
                    if(!row) return;
                    // 품목명 input 값 동기화 (포커스 없는 행만)
                    const nameInput = row.querySelector('input[type="text"]');
                    if(nameInput && document.activeElement !== nameInput) {
                        nameInput.value = line.name || '';
                    }
                    const subtotal = (line.qty || 0) * (line.unitPrice || 0);
                    const subEl = row.querySelector('.acc-subtotal');
                    if(subEl) {
                        subEl.textContent = subtotal > 0 ? subtotal.toLocaleString('ko-KR')+'원' : '-';
                        subEl.style.color = subtotal > 0 ? '#4ade80' : '#555';
                    }
                    row.style.borderColor = idx === currentLineIdx ? 'rgba(255,179,0,0.45)' : 'rgba(255,255,255,0.05)';
                    row.style.background  = idx === currentLineIdx ? 'rgba(255,179,0,0.1)' : 'rgba(0,0,0,0.18)';
                });
            }
            updateAccTotal();
        }

        function _buildAccLinesHTML(container) {
            const fs = "background:rgba(255,255,255,0.08);border:1px solid rgba(255,213,79,0.25);border-radius:8px;padding:10px 12px;color:#e8e3d8;font-size:0.92rem;width:100%;outline:none;box-sizing:border-box;";
            container.innerHTML = accLines.map((line, idx) => {
                const subtotal = (line.qty||0)*(line.unitPrice||0);
                const isActive = idx === currentLineIdx;
                return `
                <div class="acc-line-row" data-idx="${idx}"
                    style="margin-bottom:10px;padding:12px 14px;background:${isActive?'rgba(255,179,0,0.1)':'rgba(0,0,0,0.18)'};border-radius:10px;border:1px solid ${isActive?'rgba(255,179,0,0.45)':'rgba(255,255,255,0.05)'};">

                    <!-- 행1: 번호 + 품목명 + 삭제 -->
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <span style="color:#FFB300;font-size:0.8rem;font-weight:700;min-width:18px;">${idx+1}</span>
                        <input type="text" value="${line.name.replace(/"/g,'&quot;')}" placeholder="품목명 입력 또는 위에서 선택"
                            oninput="accLines[${idx}].name=this.value;"
                            onfocus="setAccActive(${idx});"
                            style="${fs} flex:1;font-weight:600;font-size:0.95rem;">
                        <button onclick="removeAccLine(${idx})"
                            style="background:#dc2626;color:#fff;border:none;border-radius:8px;min-width:36px;height:36px;cursor:pointer;font-size:1.1rem;font-weight:700;flex-shrink:0;line-height:1;">✕</button>
                    </div>

                    <!-- 행2: 수량 | 단가 | 소계 -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;align-items:end;">
                        <div>
                            <label style="color:#aaa;font-size:0.72rem;display:block;margin-bottom:5px;font-weight:600;">수량</label>
                            <input type="text" inputmode="decimal" value="${line.qty > 0 ? line.qty : ''}" placeholder="0"
                                oninput="accLines[${idx}].qty=parseFloat(this.value.replace(/[^0-9.]/g,'')||0); updateAccTotal(); updateAccSubtotal(${idx});"
                                onfocus="setAccActive(${idx});"
                                style="${fs} text-align:center;font-size:1.05rem;font-weight:700;color:#FFD54F;">
                        </div>
                        <div>
                            <label style="color:#aaa;font-size:0.72rem;display:block;margin-bottom:5px;font-weight:600;">단가 (원)</label>
                            <input type="text" inputmode="numeric" value="${line.unitPrice?line.unitPrice.toLocaleString('ko-KR'):''}" placeholder="0"
                                oninput="var v=parseInt(this.value.replace(/[^0-9]/g,'')||0); accLines[${idx}].unitPrice=v; updateAccTotal(); updateAccSubtotal(${idx});"
                                onblur="if(accLines[${idx}].unitPrice) this.value=accLines[${idx}].unitPrice.toLocaleString('ko-KR');"
                                onfocus="setAccActive(${idx}); this.value=accLines[${idx}].unitPrice||'';"
                                style="${fs} text-align:right;font-size:1.05rem;font-weight:700;">
                        </div>
                        <div>
                            <label style="color:#aaa;font-size:0.72rem;display:block;margin-bottom:5px;font-weight:600;">소계</label>
                            <div class="acc-subtotal"
                                style="background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.2);border-radius:8px;padding:10px 12px;text-align:right;font-weight:800;font-size:0.95rem;color:${subtotal>0?'#4ade80':'#555'};">
                                ${subtotal>0?subtotal.toLocaleString('ko-KR')+'원':'-'}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function setAccActive(idx) {
            currentLineIdx = idx;
            // 테두리 색만 교체 (DOM 재생성 없음)
            document.querySelectorAll('.acc-line-row').forEach((el, i) => {
                el.style.borderColor = i === idx ? 'rgba(255,179,0,0.45)' : 'rgba(255,255,255,0.05)';
                el.style.background  = i === idx ? 'rgba(255,179,0,0.1)' : 'rgba(0,0,0,0.18)';
            });
        }

        function updateAccSubtotal(idx) {
            const row = document.querySelector('.acc-line-row[data-idx="'+idx+'"]');
            if(!row) return;
            const subtotal = (accLines[idx].qty||0) * (accLines[idx].unitPrice||0);
            const el = row.querySelector('.acc-subtotal');
            if(el) {
                el.textContent = subtotal > 0 ? subtotal.toLocaleString('ko-KR')+'원' : '-';
                el.style.color = subtotal > 0 ? '#4ade80' : '#555';
            }
        }

        function updateAccTotal() {
            const total = accLines.reduce((sum, line) => sum + (line.qty || 0) * (line.unitPrice || 0), 0);
            const disp = document.getElementById('acc-total-display');
            if(disp) {
                if(total >= 10000) {
                    disp.textContent = total.toLocaleString('ko-KR') + ' 원 (' + (total/10000).toFixed(1) + '만원)';
                } else {
                    disp.textContent = total.toLocaleString('ko-KR') + ' 원';
                }
            }
            // hidden in-price 동기화
            const hp = document.getElementById('in-price');
            if(hp) hp.value = total;
        }

        function formatPriceInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if(value) {
                input.value = parseInt(value).toLocaleString('ko-KR');
            } else {
                input.value = '';
            }
        }

        function getPriceValue(input) {
            return input.value.replace(/[^0-9]/g, '');
        }

        function saveAccData() {
            // accLines 기반 저장
            const validLines = accLines.filter(l => l.name.trim() && l.unitPrice > 0);
            const total = accLines.reduce((s, l) => s + (l.qty||0)*(l.unitPrice||0), 0);
            
            if(validLines.length === 0) {
                showToast('⚠️ 품목명과 단가를 입력해주세요');
                return;
            }
            if(total <= 0) {
                showToast('⚠️ 금액은 0보다 커야 합니다');
                return;
            }
            
            const allItems = validLines.map(l => l.name.trim());
            
            // 고객 정보 읽기 (수입 탭에서만 표시되는 필드)
            var custNameEl  = document.getElementById('customer-name');
            var custPhoneEl = document.getElementById('customer-phone');
            var custMemoEl  = document.getElementById('customer-memo');
            var custQtyEl   = document.getElementById('acc-quantity');
            var custName  = custNameEl  ? custNameEl.value.trim()  : '';
            var custPhone = custPhoneEl ? custPhoneEl.value.trim() : '';
            var custMemo  = custMemoEl  ? custMemoEl.value.trim()  : '';
            var custQty   = custQtyEl   ? parseInt(custQtyEl.value)||0 : 0;

            const record = {
                type: inoutType,
                items: allItems,
                item: allItems.join(', '),
                lines: validLines.map(l => ({ name: l.name, qty: l.qty, unitPrice: l.unitPrice, subtotal: l.qty*l.unitPrice })),
                price: total,
                date: new Date().toISOString(),
                beeType: selectedBeeType,
                customerName: custName  || undefined,
                customerPhone: custPhone || undefined,
                customerMemo:  custMemo  || undefined,
                customerQuantity: custQty || undefined
            };
            
            accLogs.unshift(record);
            localStorage.setItem('beeMoney', JSON.stringify(accLogs));
            
            const savedType = inoutType === 'in' ? '수입' : '지출';
            showToast(`✅ ${savedType} 내역이 저장되었습니다. 계속 입력하려면 항목을 선택하세요`);
            
            // accLines 초기화 (새 입력 행 1개로)
            selectedAccItems = [];
            renderAccTags();
            initAccLines();
            
            // s-btn 선택 상태 초기화
            document.querySelectorAll('.s-btn').forEach(function(b) {
                b.classList.remove('selected');
                b.style.background = '';
                b.style.color = '';
                b.style.borderColor = '';
            });
            
            // 고객 정보 초기화
            var custName  = document.getElementById('customer-name');
            var custPhone = document.getElementById('customer-phone');
            var custMemo  = document.getElementById('customer-memo');
            if(custName)  custName.value  = '';
            if(custPhone) custPhone.value = '';
            if(custMemo)  custMemo.value  = '';
            
            setTimeout(function() { 
                switchAccView('calendar');
                renderAccTodaySummary();
            }, 800);
        }

        function setStatMode(mode) {
            statMode = mode;
            document.querySelectorAll('.ss-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`ss-${mode}`).classList.add('active');
            renderStatView();
        }

        // ==================== 가계부 색상 시스템 ====================
        const categoryColors = [
            '#FFB300', '#FF8F00', '#FF6F00', '#E65100', 
            '#4ade80', '#22c55e', '#16a34a', '#15803d',
            '#60a5fa', '#3b82f6', '#2563eb', '#1d4ed8',
            '#f87171', '#ef4444', '#dc2626', '#b91c1c',
            '#a78bfa', '#8b5cf6', '#7c3aed', '#6d28d9',
            '#fb923c', '#f97316', '#ea580c', '#c2410c'
        ];

        function getCategoryColor(category, type) {
            const key = type + '_' + category;
            let savedColors = JSON.parse(localStorage.getItem('beeCategoryColors') || '{}');
            
            if(!savedColors[key]) {
                const usedColors = Object.values(savedColors);
                const availableColor = categoryColors.find(c => !usedColors.includes(c)) || categoryColors[0];
                savedColors[key] = availableColor;
                localStorage.setItem('beeCategoryColors', JSON.stringify(savedColors));
            }
            
            return savedColors[key];
        }

        function renderStatView() {
            const content = document.getElementById('stat-content');
            if(!content) return;
            
            const year = parseInt(document.getElementById('sel-year').value);
            const month = document.getElementById('sel-month').value;
           
            let filtered = accLogs.filter(l => new Date(l.date).getFullYear() === year);
            
            if(month !== 'all') {
                filtered = filtered.filter(l => new Date(l.date).getMonth() === parseInt(month));
            }

            let html = "";
            
            if(statMode === 'month') {
                let totalIn = 0, totalOut = 0;
                filtered.forEach(l => {
                    if(l.type === 'in') totalIn += l.price;
                    else totalOut += l.price;
                });
                
                const profit = totalIn - totalOut;
                const profitColor = profit >= 0 ? '#4ade80' : '#f87171';
                
                html = `<div class="list-card" style="border-left-color:#FFB300; display:block;">
                    <div style="margin-bottom:16px; font-weight:bold; font-size: 1.1rem; color:#FFD54F;">💰 정산 합계</div>
                    <div class="flex justify-between mb-3 pb-3" style="border-bottom: 1px solid rgba(255,179,0,0.1);">
                        <span style="color: #999;">총 수입</span>
                        <span class="font-bold" style="color: #4ade80;">+${totalIn.toLocaleString()}원</span>
                    </div>
                    <div class="flex justify-between mb-3 pb-3" style="border-bottom: 1px solid rgba(255,179,0,0.1);">
                        <span style="color: #999;">총 지출</span>
                        <span class="font-bold" style="color: #f87171;">-${totalOut.toLocaleString()}원</span>
                    </div>
                    <div class="flex justify-between pt-2">
                        <span class="font-bold" style="font-size: 1.1rem;">최종 수익</span>
                        <span class="font-bold" style="font-size: 1.2rem; color: ${profitColor};">${profit >= 0 ? '+' : ''}${profit.toLocaleString()}원</span>
                    </div>
                </div>`;
            } else {
                const modeFiltered = filtered.filter(l => l.type === statMode);
                
                if(modeFiltered.length === 0) {
                    html = `<p class="text-center py-20" style="color: #666; font-style: italic;">내역이 없습니다.</p>`;
                } else {
                    html = modeFiltered.map((l, idx) => {
                        // 원본 배열에서의 인덱스 찾기
                        const originalIndex = accLogs.findIndex(log => 
                            log.date === l.date && 
                            log.item === l.item && 
                            log.price === l.price &&
                            log.type === l.type
                        );
                        
                        const date = new Date(l.date);
                        const dateStr = `${date.getMonth()+1}월 ${date.getDate()}일`;
                        const borderColor = l.type === 'in' ? '#4ade80' : '#f87171';
                        const textColor = l.type === 'in' ? '#4ade80' : '#f87171';
                        
                        return `
                            <div class="list-card" style="border-left-color:${borderColor}; display: block;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <b class="block mb-1" style="color: #e8e3d8; font-size: 1rem;">${l.item}</b>
                                        <small style="color: #777;">${dateStr}</small>
                                        ${l.beeType ? `<span class="text-xs ml-2 px-2 py-1 rounded" style="background: rgba(255,179,0,0.2); color: #FFB300;">${l.beeType}</span>` : ''}
                                        ${l.customerName ? `<div class="text-xs mt-1" style="color: #999;">👤 ${l.customerName}${l.customerPhone ? ' • ' + l.customerPhone : ''}${l.customerQuantity ? ' • ' + l.customerQuantity + '개' : ''}</div>` : ''}
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                                        <div class="font-bold" style="font-size: 1.1rem; color: ${textColor};">
                                            ${l.type === 'in' ? '+' : '-'}${l.price.toLocaleString()}원
                                        </div>
                                        <div style="display: flex; gap: 6px;">
                                            <button class="dyn-btn" data-action="editAccountRecord" data-index="${originalIndex}" style="background: rgba(59,130,246,0.3); color: #60a5fa; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; border: none; cursor: pointer; font-weight: 700;">수정</button>
                                            <button class="dyn-btn" data-action="deleteAccountRecord" data-index="${originalIndex}" style="background: rgba(185,28,28,0.5); color: #ff6b6b; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; border: none; cursor: pointer; font-weight: 700;">삭제</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            content.innerHTML = html;
        }

        // ==================== 방제 처리 함수 ====================
        // 방제 화면 활성 봉장 버튼 렌더링
        function renderDiseaseApiaryButtons() {
            var container = document.getElementById('disease-apiary-buttons');
            if(!container) return;
            
            var activeApiaries = getActiveApiaries();
            if(activeApiaries.length === 0) return;
            
            container.innerHTML = '';
            
            // JS변수가 활성 봉장 목록에 없으면 첫번째로 맞춤 (강제 리셋 금지)
            if(!activeApiaries.includes(selectedDiseaseApiaryLoc)) {
                selectedDiseaseApiaryLoc = activeApiaries[0] || '1봉장';
            }
            document.getElementById('disease-loc-select').value = selectedDiseaseApiaryLoc;

            activeApiaries.forEach(function(apiary) {
                var btn = document.createElement('button');
                var isActive = apiary === selectedDiseaseApiaryLoc;
                btn.className = 'location-btn' + (isActive ? ' active' : '');
                btn.innerHTML = '<div>🏠</div><div style="font-weight: bold; font-size: 0.85rem;">' + apiary + '</div>';
                btn.onclick = function() { selectDiseaseLocation(this, apiary); };
                container.appendChild(btn);
            });
        }

        function selectDiseaseLocation(btn, loc) {
            document.querySelectorAll('#disease-apiary-buttons .location-btn').forEach(function(b) {
                b.classList.remove('active');
            });
            btn.classList.add('active');
            selectedDiseaseApiaryLoc = loc;
            document.getElementById('disease-loc-select').value = loc;
        }

        const medicineOptions = {
            'mite': {
                medicines: ['플루발리네이트', '아미트라즈', '개미산', '옥살산', '티몰', '멘톨'],
                details: {
                    '플루발리네이트': ['왕스', '만프골드', '홍사방', '흠(삼금)만패'],
                    '아미트라즈': ['속살골드', '속살만6호', '마이탁'],
                    '개미산': ['85%', '80%', '75%', '70%', '65%', '60%', '55%', '50%'],
                    '옥살산': ['1G', '2G', '3G', '4G', '3.2%', '3.5%'],
                    '티몰': ['순도 99%', '일반'],
                    '멘톨': ['결정', '오일']
                },
                methods: {
                    '플루발리네이트': ['분무', '연무', '투입'],
                    '아미트라즈': ['분무', '연무', '투입'],
                    '개미산': ['기화기', '겔', '단기처리', '장기처리'],
                    '옥살산': ['증기(기화)', '연무', '분무', '흘림'],
                    '티몰': ['증발', '연무', '겔'],
                    '멘톨': ['증발', '투입']
                }
            },
            'afb': {
                medicines: ['옥시테트라사이클린'],
                details: {},
                methods: { '옥시테트라사이클린': ['분말', '사양', '분무'] }
            },
            'efb': {
                medicines: ['옥시테트라사이클린'],
                details: {},
                methods: { '옥시테트라사이클린': ['분말', '사양', '분무'] }
            },
            'nosema': {
                medicines: ['푸마길린'],
                details: { '푸마길린': ['분말'] },
                methods: { '푸마길린': ['사양'] }
            }
        };

        function updateMedicineOptions() {
            var diseaseType = document.getElementById('disease-type').value;
            var medicineSelect = document.getElementById('medicine-type');
            var customDiv = document.getElementById('disease-custom');
            
            customDiv.style.display = diseaseType === 'direct' ? 'block' : 'none';
            document.getElementById('medicine-detail').style.display = 'none';
            
            medicineSelect.innerHTML = '<option value="">선택하세요</option>';
            
            if(diseaseType && diseaseType !== 'direct') {
                // customMedicines에서 해당 질병 약제 가져오기
                var medicines = getCustomMedicines();
                var medList = medicines[diseaseType] || [];
                medList.forEach(function(m) {
                    medicineSelect.innerHTML += '<option value="' + m + '">' + m + '</option>';
                });
                // medicineOptions 상세 정보도 있으면 추가 (하위 호환)
                if(medicineOptions[diseaseType] && medicineOptions[diseaseType].medicines) {
                    medicineOptions[diseaseType].medicines.forEach(function(m) {
                        if(medList.indexOf(m) === -1) {
                            medicineSelect.innerHTML += '<option value="' + m + '">' + m + '</option>';
                        }
                    });
                }
                if(medicineOptions[diseaseType] && medicineOptions[diseaseType].medicines) {
                    medicineOptions[diseaseType].medicines.forEach(function(m) {
                        if(medList.indexOf(m) === -1) {
                            medicineSelect.innerHTML += '<option value="' + m + '">' + m + '</option>';
                        }
                    });
                }

                // 약제 목록이 있으면 섹션 표시, 없으면 숨김 ('직접 입력'만 있으면 없는 것으로 처리)
                var realOptions = Array.from(medicineSelect.options).filter(function(o){
                    return o.value && o.value !== '' && o.value !== '직접 입력';
                });
                var totalOptions = realOptions.length;
                var medSec = document.getElementById('medicine-section');
                if(medSec) medSec.style.display = totalOptions > 0 ? '' : 'none';
            } else {
                // 질병 미선택 또는 직접입력: 약제 섹션 숨김
                var medSec = document.getElementById('medicine-section');
                if(medSec) medSec.style.display = 'none';
            }
        }

        function showMedicineDetail() {
            const diseaseType = document.getElementById('disease-type').value;
            const medicine = document.getElementById('medicine-type').value;
            const detailDiv = document.getElementById('medicine-detail');
            const detailRow = document.getElementById('medicine-detail-row');
            
            if(!medicine) {
                detailDiv.style.display = 'none';
                return;
            }

            // customMedicineOptions 우선, 없으면 medicineOptions 폴백
            const customOpts = getCustomMedicineOptions();
            const diseaseOpts = customOpts[diseaseType] || medicineOptions[diseaseType];
            if(!diseaseOpts) {
                detailDiv.style.display = 'none';
                return;
            }
            
            const details = diseaseOpts.details?.[medicine];
            const methods = diseaseOpts.methods?.[medicine];
            
            if(!details && !methods) {
                detailDiv.style.display = 'none';
                return;
            }
            
            const detailSelect = document.getElementById('medicine-detail-select');
            const methodSelect = document.getElementById('medicine-method');
            
            // ★ 옥시테트라사이클린: 약품상세 없이 처리방법만 표시
            if(medicine === '옥시테트라사이클린') {
                if(detailRow) detailRow.style.display = 'none';
                methodSelect.innerHTML = '<option value="">선택하세요</option>';
                if(methods) {
                    methods.forEach(m => {
                        methodSelect.innerHTML += '<option value="' + m + '">' + m + '</option>';
                    });
                }
            } else {
                // 나머지 약제: 약품명 상세 + 처리방법 각각 표시 (원래 방식)
                if(detailRow) detailRow.style.display = 'block';
                
                if(details && details.length > 0) {
                    detailSelect.innerHTML = '<option value="">선택하세요</option>';
                    details.forEach(d => {
                        detailSelect.innerHTML += '<option value="' + d + '">' + d + '</option>';
                    });
                } else {
                    if(detailRow) detailRow.style.display = 'none';
                }
                
                if(methods && methods.length > 0) {
                    methodSelect.innerHTML = '<option value="">선택하세요</option>';
                    methods.forEach(m => {
                        methodSelect.innerHTML += '<option value="' + m + '">' + m + '</option>';
                    });
                }
            }
            
            detailDiv.style.display = 'block';
        }

        function saveDiseaseData() {
            const diseaseType = document.getElementById('disease-type').value;
            const medicine = document.getElementById('medicine-type').value;
            const memo = document.getElementById('disease-memo').value;
            const alarm = parseInt(document.getElementById('disease-alarm').value);
            // 1순위: 화면에서 active 버튼 직접 읽기 (가장 정확)
            // 2순위: JS 변수, 3순위: hidden input
            const activeLocBtn = document.querySelector('#disease-apiary-buttons .location-btn.active');
            const location = (activeLocBtn ? activeLocBtn.querySelector('div:last-child').textContent : null)
                           || selectedDiseaseApiaryLoc
                           || document.getElementById('disease-loc-select').value
                           || '1봉장';
            // JS 변수도 동기화
            selectedDiseaseApiaryLoc = location;
            
            if(!diseaseType) {
                showToast('⚠️ 질병을 선택해주세요');
                return;
            }
            
            const now = new Date();
            const y = now.getFullYear();
            const m = now.getMonth() + 1;
            const d = now.getDate();
            const key = y + '-' + m + '-' + d;
            
            // 방역 알림 설정
            var alarmKey = '';
            if(alarm > 0) {
                const alarmDate = new Date(now);
                alarmDate.setDate(now.getDate() + alarm);
                const ay = alarmDate.getFullYear();
                const am = alarmDate.getMonth() + 1;
                const ad = alarmDate.getDate();
                alarmKey = ay + '-' + am + '-' + ad;
                
                if(!db[alarmKey]) db[alarmKey] = {};
                db[alarmKey].isDiseaseAlarm = true;
                db[alarmKey].alarmLocation = location;
            }
            
            // 방제 기록 저장
            if(!diseaseLogs) diseaseLogs = [];
            
            const diseaseTypeName = document.querySelector('#disease-type option:checked')?.text || diseaseType;
            const medicineName = medicine || '미기재';
            const detailName = document.getElementById('medicine-detail-select')?.value || '';
            const methodName = document.getElementById('medicine-method')?.value || '';
            
            diseaseLogs.push({
                id: Date.now(),
                date: new Date().toISOString(),
                dateStr: key,
                alarmKey: alarmKey,
                diseaseType: diseaseType,
                diseaseTypeName: diseaseTypeName,
                medicine: medicine,
                medicineName: medicineName,
                detail: detailName,
                method: methodName,
                memo: memo,
                location: location,
                photos: currentDiseasePhotos.length > 0 ? [...currentDiseasePhotos] : [],
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem('beeData', JSON.stringify(db));
            localStorage.setItem('diseaseLogs', JSON.stringify(diseaseLogs));
            
            showToast('✅ 방제 기록이 저장되었습니다!');
            
            // 초기화 (봉장 선택은 유지)
            document.getElementById('disease-type').value = '';
            document.getElementById('medicine-type').value = '';
            document.getElementById('disease-memo').value = '';
            document.getElementById('disease-alarm').value = '0';
            document.getElementById('medicine-detail').style.display = 'none';
            document.getElementById('disease-custom').style.display = 'none';
            clearDiseasePhotos();
            // disease-loc-select는 selectedDiseaseApiaryLoc 값 유지
            document.getElementById('disease-loc-select').value = selectedDiseaseApiaryLoc;
            
            // 방제 저장 후 → 일지 입력 화면으로 돌아가기
            setTimeout(() => {
                // 일지 화면의 방제 버튼에 완료 표시
                const disStatus = document.getElementById('dis-status');
                if(disStatus) {
                    disStatus.textContent = '✅ 저장됨';
                    disStatus.style.color = '#4ade80';
                }
                switchView('diary', false);
            }, 300);
        }

        // ==================== 계산기 함수 ====================
        function setFormicMode(mode) {
            const volumeBtn = document.getElementById('formic-volume-btn');
            const weightBtn = document.getElementById('formic-weight-btn');
            const volumeDiv = document.getElementById('formic-volume');
            const weightDiv = document.getElementById('formic-weight');
            
            if(mode === 'volume') {
                volumeBtn.style.background = '#9a3412';
                volumeBtn.style.color = 'white';
                weightBtn.style.background = 'rgba(40,30,25,0.8)';
                weightBtn.style.color = '#999';
                volumeDiv.style.display = 'block';
                weightDiv.style.display = 'none';
            } else {
                weightBtn.style.background = '#9a3412';
                weightBtn.style.color = 'white';
                volumeBtn.style.background = 'rgba(40,30,25,0.8)';
                volumeBtn.style.color = '#999';
                volumeDiv.style.display = 'none';
                weightDiv.style.display = 'block';
            }
        }

        function calcFormicVolume() {
            var c2   = parseFloat(document.getElementById('formic-v-target').value); // 목표 농도(%)
            var v2L  = parseFloat(document.getElementById('formic-v-total').value);  // 희석액 총량(L)
            var c1   = 85; // 현재 개미산 농도
            
            if(!c2 || !v2L) {
                showToast('⚠️ 모든 값을 입력해주세요');
                return;
            }
            if(c2 <= 0 || c2 >= c1) {
                showToast('⚠️ 목표 농도는 1~84% 사이로 입력해주세요');
                return;
            }
            
            var v2mL  = v2L * 1000;                   // L → mL 환산
            // 공식: C₁V₁ = C₂V₂  →  V₁ = (C₂ × V₂) ÷ C₁
            var v1mL  = (c2 * v2mL) / c1;             // 필요한 85% 개미산(mL)
            var waterMl = v2mL - v1mL;                // 추가할 물(mL)
            var v1L   = v1mL / 1000;
            var waterL = waterMl / 1000;

            var result = document.getElementById('formic-v-result');
            result.style.display = 'block';
            result.innerHTML =
                '<p style="color: #c084fc; font-weight: bold; margin-bottom: 12px;">📊 계산 결과 (부피 기준)</p>' +
                '<p style="color: #999; font-size: 0.8rem; margin-bottom: 10px;">공식: V₁ = (' + c2 + '% × ' + v2L + 'L) ÷ ' + c1 + '%</p>' +
                '<p style="margin-bottom: 8px;">• 85% 개미산: <strong style="color: #FFD54F;">' + v1mL.toFixed(1) + ' mL</strong> <span style="color:#999;font-size:0.82rem;">(' + v1L.toFixed(3) + ' L)</span></p>' +
                '<p style="margin-bottom: 8px;">• 추가할 물: <strong style="color: #4ade80;">' + waterMl.toFixed(1) + ' mL</strong> <span style="color:#999;font-size:0.82rem;">(' + waterL.toFixed(3) + ' L)</span></p>' +
                '<p style="margin-bottom: 8px;">• 희석액 총량: <strong style="color: #c084fc;">' + v2L + ' L (' + v2mL.toFixed(0) + ' mL)</strong></p>' +
                '<p style="padding:8px;background:rgba(255,179,0,0.08);border-radius:6px;font-size:0.85rem;color:#FFD54F;margin-top:10px;">✅ 개미산 ' + v1mL.toFixed(1) + 'mL + 물 ' + waterMl.toFixed(1) + 'mL = ' + v2L + 'L</p>' +
                '<p style="color: #999; font-size: 0.75rem; margin-top: 6px;">※ 용기(비커 등) 눈금으로 부피 측정 시 사용</p>';
        }

        function resetFormicVolume() {
            document.getElementById('formic-v-target').value = '';
            document.getElementById('formic-v-total').value = '';
            document.getElementById('formic-v-result').style.display = 'none';
        }

        function calcFormicWeight() {
            var c2   = parseFloat(document.getElementById('formic-w-target').value); // 목표 농도(%)
            var m2kg = parseFloat(document.getElementById('formic-w-total').value);  // 희석액 총량(kg)
            var c1   = 85;    // 현재 개미산 농도
            var sg   = 1.19;  // 85% 개미산 비중

            if(!c2 || !m2kg) {
                showToast('⚠️ 모든 값을 입력해주세요');
                return;
            }
            if(c2 <= 0 || c2 >= c1) {
                showToast('⚠️ 목표 농도는 1~84% 사이로 입력해주세요');
                return;
            }

            var m2g   = m2kg * 1000;            // kg → g 환산
            // 공식: M₁ = (C₂ × M₂) ÷ C₁
            var m1g   = (c2 * m2g) / c1;        // 필요한 85% 개미산(g)
            var waterg = m2g - m1g;              // 추가할 물(g)
            var m1kg  = m1g / 1000;
            var waterkg = waterg / 1000;
            var acidMl = m1g / sg;               // 개미산 부피 참고(mL)

            var result = document.getElementById('formic-w-result');
            result.style.display = 'block';
            result.innerHTML =
                '<p style="color: #c084fc; font-weight: bold; margin-bottom: 12px;">📊 계산 결과 (무게 기준)</p>' +
                '<p style="color: #999; font-size: 0.8rem; margin-bottom: 10px;">공식: M₁ = (' + c2 + '% × ' + m2kg + 'kg) ÷ ' + c1 + '% &nbsp;|&nbsp; 비중 ' + sg + ' 적용</p>' +
                '<p style="margin-bottom: 8px;">• 85% 개미산: <strong style="color: #FFD54F;">' + m1g.toFixed(1) + ' g</strong> <span style="color:#999;font-size:0.82rem;">(' + m1kg.toFixed(3) + ' kg ≈ ' + acidMl.toFixed(1) + ' mL)</span></p>' +
                '<p style="margin-bottom: 8px;">• 추가할 물: <strong style="color: #4ade80;">' + waterg.toFixed(1) + ' g</strong> <span style="color:#999;font-size:0.82rem;">(' + waterkg.toFixed(3) + ' kg)</span></p>' +
                '<p style="margin-bottom: 8px;">• 희석액 총 무게: <strong style="color: #c084fc;">' + m2kg + ' kg (' + m2g.toFixed(0) + ' g)</strong></p>' +
                '<p style="padding:8px;background:rgba(255,179,0,0.08);border-radius:6px;font-size:0.85rem;color:#FFD54F;margin-top:10px;">✅ 개미산 ' + m1g.toFixed(1) + 'g 계량 후 물 부어 전체 ' + m2kg + 'kg 맞추세요</p>' +
                '<p style="color: #999; font-size: 0.75rem; margin-top: 6px;">※ 저울 정밀 측정 시 사용 (화학적으로 더 정확)</p>';
        }

        function resetFormicWeight() {
            document.getElementById('formic-w-target').value = '';
            document.getElementById('formic-w-total').value = '';
            document.getElementById('formic-w-result').style.display = 'none';
        }
        function calcOxalic() {
            var water = parseFloat(document.getElementById('oxalic-water').value);
            var sugar = parseFloat(document.getElementById('oxalic-sugar').value);
            var amount = parseFloat(document.getElementById('oxalic-amount').value);
            
            if(!water || !sugar || !amount) {
                showToast('⚠️ 모든 값을 입력해주세요');
                return;
            }
            
            // 농도 = 옥살산(g) / (물(g) + 설탕(g) + 옥살산(g)) × 100
            var waterG = water * 1000;
            var sugarG = sugar * 1000;
            var totalG = waterG + sugarG + amount;
            var concentration = (amount / totalG) * 100;
            
            // 총 용액량 (밀도 약 1.3 g/mL 적용)
            var totalMl = totalG / 1.3;
            // 5mL/소비 × 소비5매 = 25mL/봉군 기준
            var mlPerColony = 25;
            var colonies = Math.floor(totalMl / mlPerColony);
            
            var resultColor = (concentration >= 3 && concentration <= 5) ? '#4ade80' : '#ff6b6b';
            var resultMsg = (concentration >= 3 && concentration <= 5) 
                ? '✅ 권장 농도(3~5%) 범위 내입니다' 
                : '⚠️ 권장 농도(3~5%)를 벗어났습니다';
            
            var result = document.getElementById('oxalic-result');
            result.style.display = 'block';
            result.innerHTML =
                '<p style="color: #c084fc; font-weight: bold; margin-bottom: 12px;">📊 계산 결과</p>' +
                '<p style="margin-bottom: 8px;">• 옥살산 농도: <strong style="color: #FFD54F;">' + concentration.toFixed(2) + '%</strong></p>' +
                '<p style="margin-bottom: 8px;">• 전체 용액량: <strong style="color: #4ade80;">' + totalMl.toFixed(0) + ' mL</strong></p>' +
                '<p style="margin-bottom: 8px;">• 처리 가능 봉군 (5mL×소비5매=25mL/봉군): <strong style="color: #60a5fa;">' + colonies + ' 봉군</strong></p>' +
                '<p style="color: ' + resultColor + '; font-size: 0.85rem; margin-top: 10px; padding: 8px; background: rgba(255,179,0,0.08); border-radius: 6px;">' + resultMsg + '</p>' +
                '<p style="color: #999; font-size: 0.8rem; margin-top: 8px;">※ 옥살산 이수화물(Oxalic acid dihydrate) 기준</p>';
        }

        function resetOxalic() {
            document.getElementById('oxalic-water').value = '';
            document.getElementById('oxalic-sugar').value = '';
            document.getElementById('oxalic-amount').value = '';
            document.getElementById('oxalic-result').style.display = 'none';
        }

        function calcAlcohol() {
            const current  = parseFloat(document.getElementById('alcohol-current').value);
            const target   = parseFloat(document.getElementById('alcohol-target').value);
            const totalVol = parseFloat(document.getElementById('alcohol-volume').value); // 희석액 총량(L)
            
            if(!current || !target || !totalVol) {
                showToast('⚠️ 모든 값을 입력해주세요');
                return;
            }
            if(target >= current) {
                showToast('⚠️ 목표 농도는 현재 농도보다 낮아야 합니다');
                return;
            }
            if(current > 100 || target > 100) {
                showToast('⚠️ 농도는 100% 이하로 입력해주세요');
                return;
            }

            // 희석액 총량 기준 역산
            // 필요 주정량(L) = 목표농도 × 희석액총량 / 현재농도
            const alcoholNeeded = (target * totalVol) / current;
            const waterNeeded   = totalVol - alcoholNeeded;

            const result = document.getElementById('alcohol-result');
            result.style.display = 'block';
            result.innerHTML =
                '<p style="color: #c084fc; font-weight: bold; margin-bottom: 12px;">📊 계산 결과</p>' +
                '<p style="margin-bottom: 8px;">• 필요한 주정(' + current + '%): <strong style="color: #FFD54F;">' + alcoholNeeded.toFixed(3) + ' L</strong></p>' +
                '<p style="margin-bottom: 8px;">• 추가할 물: <strong style="color: #4ade80;">' + waterNeeded.toFixed(3) + ' L</strong></p>' +
                '<p style="margin-bottom: 8px;">• 희석액 총량: <strong style="color: #c084fc;">' + totalVol.toFixed(2) + ' L</strong></p>' +
                '<p style="color: #999; font-size: 0.8rem; margin-top: 10px;">※ 공식: 주정량 = 목표농도 × 총량 ÷ 현재농도</p>';
        }

        function resetAlcohol() {
            document.getElementById('alcohol-current').value = '';
            document.getElementById('alcohol-target').value = '';
            document.getElementById('alcohol-volume').value = '';
            document.getElementById('alcohol-result').style.display = 'none';
        }

        function calcSugar() {
            const ratio = parseFloat(document.getElementById('sugar-ratio').value);
            const water = parseFloat(document.getElementById('sugar-water').value);
            
            if(!ratio || !water) {
                showToast('⚠️ 모든 값을 입력해주세요');
                return;
            }
            
            const sugar = water * ratio;
            const totalVolume = water + (sugar * 0.6);
            
            const result = document.getElementById('sugar-result');
            result.style.display = 'block';
            result.innerHTML = 
                '<p style="color: #c084fc; font-weight: bold; margin-bottom: 12px;">📊 계산 결과</p>' +
                '<p style="margin-bottom: 8px;">• 설탕: <strong style="color: #FFD54F;">' + sugar.toFixed(2) + ' kg</strong></p>' +
                '<p style="margin-bottom: 8px;">• 물: <strong style="color: #4ade80;">' + water.toFixed(2) + ' L</strong></p>' +
                '<p>• 예상 용액량: <strong style="color: #c084fc;">' + totalVolume.toFixed(2) + ' L</strong></p>';
        }

        function resetSugar() {
            document.getElementById('sugar-ratio').value = '';
            document.getElementById('sugar-water').value = '';
            document.getElementById('sugar-result').style.display = 'none';
        }

        // ==================== 가계부 함수 ====================
        function calcAccTotal() {
            const quantity = parseFloat(document.getElementById('acc-quantity')?.value);
            const unitPriceInput = document.getElementById('acc-unit-price');
            const totalPriceInput = document.getElementById('in-price');
            
            if(quantity && unitPriceInput && unitPriceInput.value) {
                const unitPrice = parseInt(unitPriceInput.value.replace(/[^0-9]/g, ''));
                const total = unitPrice * quantity;
                if(totalPriceInput) {
                    totalPriceInput.value = total.toLocaleString('ko-KR');
                }
            }
        }

        // ==================== 기타 ====================
        function toggleHighContrast() {
            let highContrastMode = localStorage.getItem('highContrastMode') === 'true';
            highContrastMode = !highContrastMode;
            localStorage.setItem('highContrastMode', highContrastMode);
            
            if(highContrastMode) {
                document.body.classList.add('high-contrast');
                showToast('🔆 고대비 모드 활성화');
            } else {
                document.body.classList.remove('high-contrast');
                showToast('🌙 일반 모드로 전환');
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 2500);
        }

        function initSpeechRecognition() {
            if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ko-KR';
                recognition.continuous = false;
                recognition.interimResults = false;
            }
        }

        function startVoiceMemo(button) {
            // 브라우저 지원 확인
            if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                showToast('❌ 이 브라우저는 음성 인식을 지원하지 않습니다');
                return;
            }

            // 녹음 중이면 중단
            if(isRecording) {
                if(recognition) recognition.stop();
                isRecording = false;
                button.classList.remove('recording');
                button.innerHTML = '🎤 음성';
                button.style.background = '';
                return;
            }

            currentVoiceButton = button;

            // 매번 새 recognition 객체 생성 (재사용 시 오류 방지)
            try {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                const rec = new SR();
                rec.lang = 'ko-KR';
                rec.continuous = false;
                rec.interimResults = false;

                rec.onstart = function() {
                    isRecording = true;
                    button.classList.add('recording');
                    button.innerHTML = '⏹️ 중단';
                    button.style.background = 'linear-gradient(135deg,#dc2626,#b91c1c)';
                    showToast('🎤 말씀하세요...');
                };

                rec.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    // 현재 버튼 근처의 textarea 찾기
                    const container = button.closest('div[style]') || button.parentElement;
                    const textarea = container ? container.querySelector('textarea') : document.getElementById('main-memo');
                    if(textarea) {
                        textarea.value = (textarea.value ? textarea.value + ' ' : '') + transcript;
                    }
                    showToast('✅ 음성 입력 완료');
                };

                rec.onerror = function(event) {
                    console.error('음성 오류:', event.error);
                    if(event.error === 'no-speech') showToast('⚠️ 음성이 감지되지 않았습니다');
                    else if(event.error === 'not-allowed') showToast('❌ 마이크 권한을 허용해주세요');
                    else showToast('⚠️ 음성 인식 오류: ' + event.error);
                };

                rec.onend = function() {
                    isRecording = false;
                    if(currentVoiceButton) {
                        currentVoiceButton.classList.remove('recording');
                        currentVoiceButton.innerHTML = '🎤 음성';
                        currentVoiceButton.style.background = '';
                    }
                };

                recognition = rec;
                rec.start();

            } catch(error) {
                console.error('음성 인식 시작 오류:', error);
                showToast('⚠️ 음성 인식을 시작할 수 없습니다: ' + error.message);
            }
        }

        // ==================== 초기화 ====================
        // ==================== 데이터 마이그레이션 ====================
        function migrateDbHasData() {
            try {
                var db = JSON.parse(localStorage.getItem('beeData') || '{}');
                var changed = false;
                Object.keys(db).forEach(function(key) {
                    var entry = db[key];
                    if(entry && entry.records && entry.records.length > 0 && !entry.hasData) {
                        entry.hasData = true;
                        changed = true;
                    }
                });
                if(changed) {
                    localStorage.setItem('beeData', JSON.stringify(db));
                    console.log('✅ db hasData 마이그레이션 완료');
                }
            } catch(e) { console.error('db 마이그레이션 오류:', e); }
        }

        function migrateCustomMedicineOptions() {
            try {
                var stored = localStorage.getItem('customMedicineOptions');
                if(!stored) return;
                var opts = JSON.parse(stored);
                var changed = false;
                ['afb', 'efb'].forEach(function(key) {
                    if(opts[key] && opts[key].details && opts[key].details['옥시테트라사이클린']) {
                        // 기존 details 제거, methods에 분말/사양/분무 보정
                        delete opts[key].details['옥시테트라사이클린'];
                        if(!opts[key].methods) opts[key].methods = {};
                        var cur = opts[key].methods['옥시테트라사이클린'] || [];
                        // 분말이 없으면 맨 앞에 추가
                        if(cur.indexOf('분말') === -1) {
                            opts[key].methods['옥시테트라사이클린'] = ['분말'].concat(cur.filter(function(m){ return m !== '분말'; }));
                        }
                        changed = true;
                    }
                });
                if(changed) {
                    localStorage.setItem('customMedicineOptions', JSON.stringify(opts));
                    console.log('✅ customMedicineOptions 마이그레이션 완료');
                }
            } catch(e) { console.error('마이그레이션 오류:', e); }
        }

        function migrateOldDataFormat() {
            console.log('📦 데이터 마이그레이션 시작...');
            
            var changed = false;
            for (var key in db) {
                if (db.hasOwnProperty(key)) {
                    var data = db[key];
                    
                    // 기존 단일 객체 형식 감지
                    if (data.hasData === true && !data.records) {
                        console.log('구형 데이터 발견:', key);
                        
                        // 새 형식으로 변환
                        var newData = {
                            records: [{
                                hasData: true,
                                beeType: data.beeType || '양봉',
                                loc: data.loc || '1봉장',
                                memo: data.memo || '',
                                works: data.works || [],
                                timestamp: data.timestamp || new Date().toISOString()
                            }]
                        };
                        
                        // 여왕벌/방역 정보 유지
                        if (data.isQueen) newData.isQueen = data.isQueen;
                        if (data.isDiseaseAlarm) newData.isDiseaseAlarm = data.isDiseaseAlarm;
                        if (data.alarmLocation) newData.alarmLocation = data.alarmLocation;
                        
                        db[key] = newData;
                        changed = true;
                        console.log('✓ 변환 완료:', key);
                    }
                }
            }
            
            if (changed) {
                localStorage.setItem('beeData', JSON.stringify(db));
                console.log('✅ 데이터 마이그레이션 완료!');
            } else {
                console.log('✓ 마이그레이션 불필요 (이미 최신 형식)');
            }
        }

        // ===== 삭제/수정 함수 전역 노출 (window에 등록) =====
        // 모바일 bfcache 대응: 뒤로가기/새로고침으로 캐시 복원 시 대문 리셋
        window.addEventListener('pageshow', function(e) {
            if (e.persisted) {
                var sp = document.getElementById('splash');
                var ma = document.getElementById('main-app');
                if (sp) sp.style.display = 'flex';
                if (ma) { ma.style.display = 'none'; ma.classList.add('hidden'); }
            }
        });

        window.addEventListener('load', function() {
            window.deleteDayRecord    = deleteDayRecord;
            window.editDayRecord      = editDayRecord;
            window.deleteSchedule     = deleteSchedule;
            window.editSchedule       = editSchedule;
            window.deleteDiseaseRecord = deleteDiseaseRecord;
            window.editDiseaseRecord  = editDiseaseRecord;
            window.deleteAccountRecord = deleteAccountRecord;
            window.editAccountRecord  = editAccountRecord;
            // 설정 관련
            window.renderAccSettingList = renderAccSettingList;
            window.customCategories     = customCategories;
            window.showToast            = showToast;

            // 스플래시 초기화
            initSplash();
            // 초기 렌더링
            renderWorkButtons();
            renderDiseaseTypeSelect();
            renderAlarmDayOptions();
            // 테마 로드
            loadTheme();
        });

        window.addEventListener('DOMContentLoaded', function() {
            console.log('=================================================');
            console.log('🐝 BEE MASTER 초기화 시작');
            console.log('=================================================');
            
            // 데이터 마이그레이션 실행
            try {
                migrateDbHasData();
            } catch(e) {}
            try {
                migrateCustomMedicineOptions();
            } catch(e) {}
            try {
                migrateOldDataFormat();
            } catch(e) {
                console.error('✗ 데이터 마이그레이션 실패:', e);
            }
            
            try {
                updateCurrentDate();
                console.log('✓ 현재 날짜 업데이트 완료');
            } catch(e) {
                console.error('✗ 날짜 업데이트 실패:', e);
            }
            
            try {
                fetchWeatherData();
                console.log('✓ 날씨 데이터 요청 시작');
            } catch(e) {
                console.error('✗ 날씨 데이터 요청 실패:', e);
            }
            
            try {
                initSpeechRecognition();
                console.log('✓ 음성 인식 초기화 완료');
            } catch(e) {
                console.error('✗ 음성 인식 초기화 실패:', e);
            }
            
            try {
                const highContrastMode = localStorage.getItem('highContrastMode') === 'true';
                if(highContrastMode) {
                    document.body.classList.add('high-contrast');
                    console.log('✓ 고대비 모드 활성화됨');
                }
            } catch(e) {
                console.error('✗ 고대비 모드 설정 실패:', e);
            }
            
            // DOM 요소 확인
            console.log('\n📋 DOM 요소 확인:');
            console.log('- splash:', document.getElementById('splash') ? '✓' : '✗');
            console.log('- main-app:', document.getElementById('main-app') ? '✓' : '✗');
            console.log('- view-calendar:', document.getElementById('view-calendar') ? '✓' : '✗');
            console.log('- cal-body:', document.getElementById('cal-body') ? '✓' : '✗');
            console.log('- location-buttons:', document.getElementById('location-buttons') ? '✓' : '✗');
            console.log('- location-filters:', document.getElementById('location-filters') ? '✓' : '✗');
            
            console.log('\n✅ BEE MASTER 초기화 완료');
            console.log('💡 대문에서 "양봉" 또는 "동양종" 버튼을 클릭하세요');
            console.log('=================================================\n');
        });
    </script>

<script>
// ===== 동적 버튼 클릭 핸들러 =====
document.addEventListener('click', function(e) {
    // 클릭된 요소에서 최대 5단계 부모까지 dyn-btn 탐색
    var btn = e.target;
    var found = false;
    for (var i = 0; i < 5; i++) {
        if (!btn || btn.tagName === 'BODY' || btn.tagName === 'HTML') break;
        if (btn.classList && btn.classList.contains('dyn-btn')) { found = true; break; }
        btn = btn.parentElement;
    }
    if (!found) return;

    var action = btn.getAttribute('data-action') || '';
    var idx    = parseInt(btn.getAttribute('data-index') || '-1', 10);
    var key    = btn.getAttribute('data-key') || '';

    try {
        switch (action) {
            case 'deleteRecord':
                deleteDayRecord(key, idx); break;
            case 'editRecord':
                editDayRecord(key, idx); break;
            case 'deleteSchedule':
                deleteSchedule(idx); break;
            case 'editSchedule':
                editSchedule(idx); break;
            case 'deleteDiseaseRecord':
                deleteDiseaseRecord(idx); break;
            case 'editDiseaseRecord':
                editDiseaseRecord(idx); break;
            case 'deleteAccountRecord':
                deleteAccountRecord(idx); break;
            case 'editAccountRecord':
                editAccountRecord(idx); break;
            case 'delAccCategory': {
                var inout = btn.getAttribute('data-inout');
                var cat   = btn.getAttribute('data-cat');
                if (confirm('[' + cat + '] 카테고리 전체를 삭제하시겠습니까?')) {
                    delete customCategories[inout][cat];
                    localStorage.setItem('beeCustomCategories', JSON.stringify(customCategories));
                    renderAccSettingList(inout);
                    showToast('🗑️ 카테고리 삭제됨');
                }
                break;
            }
            case 'delAccSubItem': {
                var inout2 = btn.getAttribute('data-inout');
                var cat2   = btn.getAttribute('data-cat');
                customCategories[inout2][cat2].splice(idx, 1);
                localStorage.setItem('beeCustomCategories', JSON.stringify(customCategories));
                renderAccSettingList(inout2);
                showToast('🗑️ 삭제됨');
                break;
            }
        }
    } catch(err) {
        console.error('버튼 오류 [' + action + ']:', err);
    }
});
</script>

    <!-- ========== 인라인 카메라 모달 ========== -->
    <div id="camera-modal" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:#000; z-index:20000; flex-direction:column;">
        <div style="position:relative; flex:1; overflow:hidden;">
            <video id="camera-video" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
            <!-- 안내 오버레이 -->
            <div style="position:absolute; top:0; left:0; right:0; padding:16px; background:linear-gradient(to bottom,rgba(0,0,0,0.6),transparent); display:flex; justify-content:space-between; align-items:center;">
                <button onclick="closeCameraModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; border-radius:50%; width:44px; height:44px; font-size:1.4rem; cursor:pointer; display:flex; align-items:center; justify-content:center;">✕</button>
                <span style="color:white; font-weight:700; font-size:1rem;">직접 촬영</span>
                <button id="camera-flip-btn" onclick="flipCamera()" style="background:rgba(255,255,255,0.2); border:none; color:white; border-radius:50%; width:44px; height:44px; font-size:1.4rem; cursor:pointer; display:flex; align-items:center; justify-content:center;">🔄</button>
            </div>
        </div>
        <!-- 촬영 버튼 영역 -->
        <div style="background:#111; padding:30px 20px; display:flex; justify-content:center; align-items:center; gap:40px;">
            <label style="display:flex; flex-direction:column; align-items:center; gap:6px; color:#aaa; font-size:0.75rem; cursor:pointer;">
                🖼️ 앨범
                <input id="camera-album-fallback" type="file" accept="image/*" multiple style="display:none" onchange="handleCameraAlbumFallback(this)">
            </label>
            <button id="camera-shutter-btn" onclick="capturePhoto()" style="width:80px; height:80px; border-radius:50%; background:white; border:5px solid rgba(255,255,255,0.5); cursor:pointer; box-shadow:0 0 0 4px rgba(255,255,255,0.2); transition:transform 0.1s; display:flex; align-items:center; justify-content:center; font-size:2rem;">📷</button>
            <div style="width:60px;"></div>
        </div>
        <!-- 캔버스 (숨김, 캡처용) -->
        <canvas id="camera-canvas" style="display:none;"></canvas>
    </div>

    <script>
    // ========== 인라인 카메라 기능 ==========
    let cameraStream = null;
    let cameraTarget = 'diary'; // 'diary' or 'disease'
    let cameraFacing = 'environment'; // 'environment'(후면) or 'user'(전면)

    async function openInlineCamera(target) {
        cameraTarget = target;
        const modal = document.getElementById('camera-modal');
        modal.style.display = 'flex';
        modal.style.flexDirection = 'column';

        // 최대 사진 수 체크
        const currentPhotos = target === 'diary' ? currentDiaryPhotos : currentDiseasePhotos;
        if(currentPhotos.length >= 3) {
            showToast('⚠️ 최대 3장까지만 첨부할 수 있습니다');
            modal.style.display = 'none';
            return;
        }

        await startCamera(cameraFacing);
    }

    async function startCamera(facing) {
        // 기존 스트림 정지
        if(cameraStream) {
            cameraStream.getTracks().forEach(t => t.stop());
            cameraStream = null;
        }

        const video = document.getElementById('camera-video');

        try {
            const constraints = {
                video: {
                    facingMode: facing,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            };
            cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = cameraStream;
            cameraFacing = facing;
        } catch(err) {
            console.error('카메라 오류:', err);
            // 권한 거부 등 → 앨범 선택으로 대체
            closeCameraModal();
            if(err.name === 'NotAllowedError') {
                showToast('⚠️ 카메라 권한이 거부되었습니다. 앨범에서 선택해주세요.');
            } else if(err.name === 'NotFoundError') {
                showToast('⚠️ 카메라를 찾을 수 없습니다. 앨범에서 선택해주세요.');
            } else {
                showToast('⚠️ 카메라를 열 수 없습니다. 앨범을 이용해주세요.');
            }
        }
    }

    async function flipCamera() {
        const newFacing = cameraFacing === 'environment' ? 'user' : 'environment';
        await startCamera(newFacing);
    }

    function capturePhoto() {
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        if(!cameraStream) return;

        // 셔터 애니메이션
        const btn = document.getElementById('camera-shutter-btn');
        btn.style.transform = 'scale(0.88)';
        setTimeout(() => btn.style.transform = 'scale(1)', 120);

        // 캔버스에 현재 프레임 캡처
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        // 전면 카메라일 경우 좌우 반전
        if(cameraFacing === 'user') {
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
        }
        ctx.drawImage(video, 0, 0);

        const base64 = canvas.toDataURL('image/jpeg', 0.85);

        // 압축 후 저장
        compressImage(base64, 1200, 0.8, function(compressed) {
            if(cameraTarget === 'diary') {
                if(currentDiaryPhotos.length < 3) {
                    currentDiaryPhotos.push(compressed);
                    renderDiaryPhotoPreview();
                    showToast('✅ 사진이 촬영되었습니다');
                }
                // 3장이면 자동으로 닫기
                if(currentDiaryPhotos.length >= 3) {
                    closeCameraModal();
                }
            } else {
                if(currentDiseasePhotos.length < 3) {
                    currentDiseasePhotos.push(compressed);
                    renderDiseasePhotoPreview();
                    showToast('✅ 사진이 촬영되었습니다');
                }
                if(currentDiseasePhotos.length >= 3) {
                    closeCameraModal();
                }
            }
        });
    }

    function closeCameraModal() {
        if(cameraStream) {
            cameraStream.getTracks().forEach(t => t.stop());
            cameraStream = null;
        }
        document.getElementById('camera-modal').style.display = 'none';
    }

    function handleCameraAlbumFallback(input) {
        closeCameraModal();
        if(cameraTarget === 'diary') handleDiaryPhotoUpload(input);
        else handleDiseasePhotoUpload(input);
    }
    </script>

</body>
</html>
