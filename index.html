<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ ë´‰ì¥ì§€ë„</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#100c07;--bg2:#1a1208;--bg3:#221a0e;
  --bdr:rgba(255,179,0,0.22);
  --gold:#FFB300;--goldl:#FFD54F;
  --tx:#e8e0d0;--dim:#64748b;
  --blue:#3b82f6;--red:#f87171;--green:#4ade80
}
body{background:var(--bg);color:var(--tx);font-family:'Apple SD Gothic Neo','Noto Sans KR',sans-serif;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
#hdr{padding:9px 14px;background:linear-gradient(135deg,#1a0a00,#2d1400);border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
#hdr h1{font-size:1rem;font-weight:900;color:var(--gold)}
#gst{font-size:0.72rem;color:var(--dim)}
#tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--bdr);flex-shrink:0}
.tab{flex:1;padding:10px 4px;background:transparent;border:none;color:#555;font-size:0.78rem;font-weight:700;cursor:pointer;border-bottom:3px solid transparent;touch-action:manipulation}
.tab.on{color:var(--gold);border-bottom-color:var(--gold)}
#mapwrap{position:relative;flex-shrink:0}
#vmap{width:100%;height:50dvh;background:#111}
.mtr{position:absolute;top:10px;right:10px;z-index:500;display:flex;gap:6px}
.mbl{position:absolute;bottom:12px;left:10px;z-index:500;display:flex;flex-direction:column;gap:6px}
.mtype{padding:5px 10px;background:rgba(15,10,5,.9);border:1px solid var(--bdr);border-radius:8px;color:#777;font-size:.72rem;font-weight:700;cursor:pointer;touch-action:manipulation}
.mtype.on{background:rgba(255,179,0,.9);color:#1a0800;border-color:var(--gold)}
.icob{width:40px;height:40px;background:rgba(15,10,5,.9);border:2px solid var(--bdr);border-radius:50%;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:manipulation}
#locbar{display:none;padding:8px 14px;background:rgba(5,8,15,.96);border-top:1px solid rgba(59,130,246,.3);align-items:center;gap:10px;flex-shrink:0}
#locbar.on{display:flex}
#panel{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.pi{padding:12px 14px 80px}
.ac{background:var(--bg3);border:1px solid var(--bdr);border-radius:12px;padding:12px 14px;margin-bottom:8px}
.acr{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
.acn{font-weight:900;font-size:.92rem;margin-bottom:3px}
.aca{color:var(--dim);font-size:.78rem}
.acm{color:#475569;font-size:.73rem;margin-top:2px}
.acb{display:flex;flex-direction:column;gap:5px;align-items:flex-end;flex-shrink:0}
.btn{padding:6px 11px;border:none;border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;touch-action:manipulation}
.bg{background:rgba(255,179,0,.18);color:var(--goldl)}
.br{background:rgba(185,28,28,.22);color:var(--red)}
.bb{background:rgba(59,130,246,.2);color:#60a5fa;border:1px solid rgba(59,130,246,.4)}
.fl{color:#888;font-size:.82rem;display:block;margin-bottom:5px}
.fi{width:100%;padding:11px 14px;background:rgba(0,0,0,.35);border:1px solid var(--bdr);border-radius:10px;color:var(--tx);font-size:.9rem;outline:none;margin-bottom:12px}
.fi:focus{border-color:var(--gold)}
.fi::placeholder{color:#3a3a3a}
.fbig{width:100%;padding:13px;border:none;border-radius:12px;font-size:.95rem;font-weight:700;cursor:pointer;touch-action:manipulation;margin-bottom:10px}
.fsave{background:linear-gradient(135deg,#b45309,#78350f);color:#fef3c7}
.fgps{background:rgba(59,130,246,.25);color:#60a5fa;border:1px solid rgba(59,130,246,.4)}
#cbox{display:none;padding:10px 12px;background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.25);border-radius:10px;margin-bottom:14px;font-size:.8rem;color:var(--dim)}
#cbox.on{display:block}
.tw{display:flex;align-items:center;gap:10px;padding:11px 12px;background:rgba(0,0,0,.2);border-radius:10px;margin-bottom:16px}
.tt{width:48px;height:26px;border-radius:26px;cursor:pointer;display:flex;align-items:center;padding:3px;transition:background .3s}
.th{width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .3s}
.as{padding:8px 14px;border-radius:10px;border:2px solid var(--bdr);background:var(--bg3);color:#666;font-weight:700;cursor:pointer;touch-action:manipulation;font-size:.85rem}
.as.on{background:rgba(255,179,0,.2);color:var(--goldl);border-color:var(--gold)}
#regi{display:none;background:rgba(74,222,128,.06);border:1px solid rgba(74,222,128,.2);border-radius:10px;padding:12px;margin-bottom:14px}
#regi.on{display:block}
.hch{padding:5px 11px;border-radius:20px;font-size:.73rem;font-weight:700;border:2px solid;cursor:pointer;transition:all .18s;touch-action:manipulation;white-space:nowrap}
.leaflet-popup-content-wrapper{background:transparent!important;border:none!important;box-shadow:none!important;padding:0!important}
.leaflet-popup-content{margin:0!important}
.leaflet-popup-tip-container{display:none!important}
.leaflet-control-zoom{border:1px solid var(--bdr)!important}
.leaflet-control-zoom a{background:rgba(15,10,5,.9)!important;color:var(--gold)!important}
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(20,14,6,.96);color:var(--goldl);padding:9px 18px;border-radius:20px;font-size:.82rem;font-weight:700;border:1px solid rgba(255,179,0,.3);z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis}
#toast.on{opacity:1}
</style>
</head>
<body>

<div id="hdr">
  <h1>ğŸ ë´‰ì¥ì§€ë„</h1>
  <span id="gst">GPS ëŒ€ê¸°</span>
</div>

<div id="tabs">
  <button class="tab on" onclick="goTab('apiary')">ğŸ ë´‰ì¥ì§€ë„</button>
  <button class="tab"    onclick="goTab('reg')">ğŸ“ ìœ„ì¹˜ë“±ë¡</button>
</div>

<div id="mapwrap">
  <div class="mtr">
    <button class="mtype on" id="bsat"  onclick="setTile('sat')">ìœ„ì„±</button>
    <button class="mtype"    id="bbase" onclick="setTile('base')">ì¼ë°˜</button>
  </div>
  <div class="mbl">
    <button class="icob" onclick="goMyLoc()">ğŸ“</button>
  </div>
  <div id="vmap"></div>
</div>

<div id="locbar">
  <span style="font-size:1.1rem">ğŸ“</span>
  <div style="flex:1;min-width:0">
    <div id="laddr" style="font-size:.82rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">í™•ì¸ ì¤‘...</div>
    <div id="lcoord" style="font-size:.71rem;color:var(--dim)"></div>
  </div>
  <button class="btn bg" onclick="locToForm()" style="flex-shrink:0">ğŸ’¾ ì €ì¥</button>
  <button class="btn" onclick="hideLocbar()" style="color:#444;flex-shrink:0">âœ•</button>
</div>

<div id="panel">

  <div id="tab-apiary" class="pi">
    <div style="display:flex;gap:12px;flex-wrap:wrap;padding:6px 0 10px;font-size:.76rem;color:#ccc">
      <span>ğŸŸ¡ ê³ ì •ë´‰ì¥</span><span>ğŸŸ  ì´ë™ë´‰ì¥</span><span>âš« ë¯¸ë“±ë¡</span><span>ğŸ”µ ë‚´ìœ„ì¹˜</span>
    </div>
    <div id="alist"></div>
  </div>

  <div id="tab-honey" class="pi" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <span style="color:var(--goldl);font-weight:700;font-size:.88rem">ğŸŒ¸ ë°€ì›ìˆ˜ ì„ íƒ</span>
      <div style="display:flex;gap:6px">
        <button class="btn bg" onclick="allHoney(1)" style="font-size:.7rem">ì „ì²´ì„ íƒ</button>
        <button class="btn" onclick="allHoney(0)" style="background:rgba(100,100,100,.15);color:#555;font-size:.7rem">ì „ì²´í•´ì œ</button>
      </div>
    </div>
    <div id="hchips" style="display:flex;flex-wrap:wrap;gap:7px"></div>
    <div style="margin-top:14px;padding:10px;background:rgba(255,179,0,.04);border-radius:8px;border:1px solid var(--bdr);color:#475569;font-size:.75rem;line-height:1.8">
      ğŸ“Œ ë§ˆì»¤ í´ë¦­ ì‹œ ìˆ˜ì¢… ì •ë³´ í‘œì‹œ<br>ğŸ“Œ ê²½ê¸°ë‚¨ë¶€Â·í‰íƒ ì¤‘ì‹¬ ìƒ˜í”Œ ë°ì´í„°
    </div>
  </div>

  <div id="tab-reg" class="pi" style="display:none">
    <div style="margin-bottom:14px">
      <div style="color:var(--goldl);font-weight:700;font-size:.88rem;margin-bottom:8px">ğŸ“ ë´‰ì¥ ì„ íƒ</div>
      <div id="aswrap" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    </div>
    <div id="regi">
      <div style="color:var(--dim);font-size:.75rem;margin-bottom:5px">ğŸ“ í˜„ì¬ ë“±ë¡ ìœ„ì¹˜</div>
      <div id="ri-a" style="font-size:.87rem;font-weight:700;margin-bottom:2px"></div>
      <div id="ri-m" style="color:var(--dim);font-size:.75rem;margin-bottom:4px"></div>
      <div id="ri-c" style="color:#475569;font-size:.72rem;margin-bottom:10px"></div>
      <div style="display:flex;gap:8px">
        <button class="btn bb" onclick="focusReg()" style="flex:1">ğŸ—ºï¸ ì§€ë„ ë³´ê¸°</button>
        <button class="btn br" onclick="deleteApiary()" style="flex:1">ğŸ—‘ï¸ ìœ„ì¹˜ ì‚­ì œ</button>
      </div>
    </div>
    <div id="regform" style="display:none">
      <button class="fbig fgps" onclick="gpsToForm()">ğŸ“¡ í˜„ì¬ GPS ìœ„ì¹˜ë¡œ ë“±ë¡</button>
      <div style="text-align:center;font-size:.74rem;color:#475569;margin:-6px 0 12px;padding:6px;background:rgba(255,179,0,.04);border-radius:8px;border:1px dashed rgba(255,179,0,.2)">
        ğŸ—ºï¸ ë˜ëŠ” ë´‰ì¥ì§€ë„ íƒ­ì—ì„œ ì§€ë„ë¥¼ ì§ì ‘ í´ë¦­í•´ë„ ë©ë‹ˆë‹¤
      </div>
      <label class="fl">âœï¸ ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: í‰íƒ ì§„ìœ„ë©´ / ì˜¤ì„±ë©´)</label>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input id="faddy" class="fi" style="flex:1;margin-bottom:0" placeholder="í‰íƒ ì§„ìœ„ë©´, ì•„ì‚° ë„ê³ ë©´, ì•ˆì„± ê³µë„ì ...">
        <button class="btn bg" onclick="doSearch()" style="padding:0 14px;flex-shrink:0">ê²€ìƒ‰</button>
      </div>
      <div id="cbox">
        <div id="cb-a" style="font-weight:700;margin-bottom:3px"></div>
        <div id="cb-c" style="font-size:.72rem;color:var(--green)">âœ… ì¢Œí‘œ í™•ì •ë¨</div>
      </div>
      <label class="fl">ğŸ“ ë©”ëª¨</label>
      <input id="fmemo" class="fi" placeholder="ì˜ˆ) ì§„ì…ë¡œ ì£¼ì˜, ì•„ê¹Œì‹œ êµ°ë½ì§€ ì¸ê·¼">
      <div class="tw">
        <span style="flex:1;font-size:.9rem;color:#ccc">ğŸŒ ìœ„ì¹˜ ê³µê°œ</span>
        <div id="ttrack" onclick="togglePub()" class="tt" style="background:#374151">
          <div id="tthumb" class="th"></div>
        </div>
        <span id="tlabel" style="color:#555;font-size:.82rem;font-weight:700">ë¹„ê³µê°œ</span>
      </div>
      <button class="fbig fsave" onclick="saveApiary()">ğŸ’¾ ì €ì¥</button>
    </div>
    <div id="regempty" style="text-align:center;color:#444;padding:30px">ë´‰ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
  </div>

</div>
<div id="toast"></div>

<script>
'use strict';

// â”€â”€ VWORLD í‚¤ â”€â”€
var VK = 'F00592E3-2B83-38D8-9EBA-DA543461A436';

// ================================================================
// ë‚´ì¥ ì¢Œí‘œ DB (ì™¸ë¶€ API ì—†ì´ ë™ì‘)
// ================================================================
var ADB = [
  // í‰íƒ ìë©´ë™ ì „ì²´
  {k:'í‰íƒ ì§„ìœ„ë©´',lat:37.063,lng:127.052},{k:'í‰íƒ ì§„ìœ„',lat:37.063,lng:127.052},
  {k:'í‰íƒ ì˜¤ì„±ë©´',lat:37.082,lng:127.023},{k:'í‰íƒ ì˜¤ì„±',lat:37.082,lng:127.023},
  {k:'í‰íƒ ì„œíƒ„ë©´',lat:37.051,lng:127.082},{k:'í‰íƒ ì„œíƒ„',lat:37.051,lng:127.082},
  {k:'í‰íƒ í˜„ë•ë©´',lat:37.001,lng:126.970},{k:'í‰íƒ í˜„ë•',lat:37.001,lng:126.970},
  {k:'í‰íƒ íŒ½ì„±ì',lat:37.012,lng:127.025},{k:'í‰íƒ íŒ½ì„±',lat:37.012,lng:127.025},
  {k:'í‰íƒ ì²­ë¶ì',lat:37.023,lng:126.954},{k:'í‰íƒ ì²­ë¶',lat:37.023,lng:126.954},
  {k:'í‰íƒ í¬ìŠ¹ì',lat:36.989,lng:126.986},{k:'í‰íƒ í¬ìŠ¹',lat:36.989,lng:126.986},
  {k:'í‰íƒ ì•ˆì¤‘ì',lat:36.993,lng:126.924},{k:'í‰íƒ ì•ˆì¤‘',lat:36.993,lng:126.924},
  {k:'í‰íƒ ê³ ë•ë©´',lat:37.038,lng:127.100},{k:'í‰íƒ ê³ ë•',lat:37.038,lng:127.100},
  {k:'í‰íƒ ì†¡íƒ„',lat:37.084,lng:127.065},{k:'í‰íƒ í‰íƒë™',lat:37.012,lng:126.988},
  {k:'í‰íƒì‹œ',lat:37.063,lng:127.080},{k:'í‰íƒ',lat:37.063,lng:127.080},
  // ì•ˆì„±
  {k:'ì•ˆì„± ê³µë„ì',lat:37.082,lng:127.143},{k:'ì•ˆì„± ê³µë„',lat:37.082,lng:127.143},
  {k:'ì•ˆì„± ë¯¸ì–‘ë©´',lat:37.043,lng:127.210},{k:'ì•ˆì„± ê¸ˆê´‘ë©´',lat:37.052,lng:127.244},
  {k:'ì•ˆì„± ì¼ì£½ë©´',lat:37.008,lng:127.440},{k:'ì•ˆì„± ì–‘ì„±ë©´',lat:37.012,lng:127.193},
  {k:'ì•ˆì„±ì‹œ',lat:37.008,lng:127.270},{k:'ì•ˆì„±',lat:37.008,lng:127.270},
  // í™”ì„±
  {k:'í™”ì„± ë´‰ë‹´ì',lat:37.212,lng:126.988},{k:'í™”ì„± ìš°ì •ì',lat:37.087,lng:126.780},
  {k:'í™”ì„± íŒ”íƒ„ë©´',lat:37.193,lng:126.878},{k:'í™”ì„± í–¥ë‚¨ì',lat:37.150,lng:126.912},
  {k:'í™”ì„±ì‹œ',lat:37.199,lng:126.831},{k:'í™”ì„±',lat:37.199,lng:126.831},
  // ìˆ˜ì›Â·ì˜¤ì‚°Â·ìš©ì¸
  {k:'ìˆ˜ì›ì‹œ',lat:37.263,lng:127.028},{k:'ìˆ˜ì›',lat:37.263,lng:127.028},
  {k:'ì˜¤ì‚°ì‹œ',lat:37.150,lng:127.076},{k:'ì˜¤ì‚°',lat:37.150,lng:127.076},
  {k:'ìš©ì¸ì‹œ',lat:37.238,lng:127.200},{k:'ìš©ì¸',lat:37.238,lng:127.200},
  {k:'ì´ì²œì‹œ',lat:37.272,lng:127.435},{k:'ì´ì²œ',lat:37.272,lng:127.435},
  {k:'ì—¬ì£¼ì‹œ',lat:37.298,lng:127.637},{k:'ì—¬ì£¼',lat:37.298,lng:127.637},
  // ì¶©ë‚¨
  {k:'ì²œì•ˆì‹œ',lat:36.806,lng:127.152},{k:'ì²œì•ˆ',lat:36.806,lng:127.152},
  {k:'ì•„ì‚°ì‹œ',lat:36.789,lng:127.002},{k:'ì•„ì‚°',lat:36.789,lng:127.002},
  {k:'ì•„ì‚° ë„ê³ ë©´',lat:36.816,lng:126.914},{k:'ì•„ì‚° ë°°ë°©ì',lat:36.805,lng:127.021},
  {k:'ì•„ì‚° ì„ ì¥ë©´',lat:36.768,lng:126.842},{k:'ì•„ì‚° ì—¼ì¹˜ì',lat:36.819,lng:127.036},
  {k:'ë‹¹ì§„ì‹œ',lat:36.889,lng:126.629},{k:'ë‹¹ì§„',lat:36.889,lng:126.629},
  {k:'ì„œì‚°ì‹œ',lat:36.779,lng:126.452},{k:'ì„œì‚°',lat:36.779,lng:126.452},
  {k:'í™ì„±êµ°',lat:36.601,lng:126.661},{k:'í™ì„±',lat:36.601,lng:126.661},
  {k:'ì˜ˆì‚°êµ°',lat:36.681,lng:126.849},{k:'ì˜ˆì‚°',lat:36.681,lng:126.849},
  {k:'ë…¼ì‚°ì‹œ',lat:36.187,lng:127.099},{k:'ë…¼ì‚°',lat:36.187,lng:127.099},
  {k:'ë³´ë ¹ì‹œ',lat:36.333,lng:126.614},{k:'ë³´ë ¹',lat:36.333,lng:126.614},
  // ì „êµ­ ëŒ€ë„ì‹œ
  {k:'ì„œìš¸',lat:37.566,lng:126.978},{k:'ë¶€ì‚°',lat:35.179,lng:129.075},
  {k:'ëŒ€êµ¬',lat:35.871,lng:128.602},{k:'ì¸ì²œ',lat:37.456,lng:126.705},
  {k:'ê´‘ì£¼',lat:35.160,lng:126.851},{k:'ëŒ€ì „',lat:36.351,lng:127.385},
  {k:'ìš¸ì‚°',lat:35.538,lng:129.312},{k:'ì œì£¼',lat:33.499,lng:126.531},
  {k:'ì„¸ì¢…',lat:36.480,lng:127.289},{k:'ì¶˜ì²œ',lat:37.881,lng:127.730},
  {k:'ê°•ë¦‰',lat:37.751,lng:128.876},{k:'ì²­ì£¼',lat:36.642,lng:127.489},
  {k:'ì „ì£¼',lat:35.824,lng:127.148},{k:'ìˆœì²œ',lat:34.950,lng:127.487},
  {k:'ì°½ì›',lat:35.228,lng:128.681},{k:'ì§„ì£¼',lat:35.180,lng:128.107},
  {k:'í¬í•­',lat:36.019,lng:129.343},{k:'ê²½ì£¼',lat:35.856,lng:129.225},
  {k:'ì•ˆë™',lat:36.569,lng:128.729},{k:'ì›ì£¼',lat:37.342,lng:127.921}
];

// JSONP í˜¸ì¶œ (file:// CORS ìš°íšŒ)
function jsonp(url, cbName, cb) {
  var fn = 'vw_cb_' + Date.now();
  window[fn] = function(data) {
    delete window[fn];
    document.head.removeChild(s);
    cb(data);
  };
  var s = document.createElement('script');
  s.src = url + '&callback=' + fn;
  s.onerror = function() { delete window[fn]; document.head.removeChild(s); cb(null); };
  document.head.appendChild(s);
}

// VWorld ì—­ì§€ì˜¤ì½”ë”© (ì¢Œí‘œ â†’ ë„ë¡œëª… ì£¼ì†Œ)
function nearAddr(lat, lng, cb) {
  var url = 'https://api.vworld.kr/req/address'
    + '?service=address&request=getAddress&version=2.0'
    + '&crs=epsg:4326&point=' + lng + ',' + lat
    + '&format=json&type=both&zipcode=false&simple=false'
    + '&key=' + VK;
  jsonp(url, 'callback', function(data) {
    if(data && data.response && data.response.status === 'OK') {
      var results = data.response.result;
      var road   = results.filter(function(r){ return r.type === 'road'; })[0];
      var jibun  = results.filter(function(r){ return r.type === 'parcel'; })[0];
      cb((road ? road.text : '') || (jibun ? jibun.text : '') || '');
    } else { cb(''); }
  });
}

// ì£¼ì†Œ â†’ ì¢Œí‘œ (ë‚´ì¥ DB ì „ìš©)
function addrToCoord(addr, cb) {
  // VWorld ì£¼ì†Œê²€ìƒ‰ JSONP (ë„ë¡œëª… ìš°ì„ )
  var url = 'https://api.vworld.kr/req/search'
    + '?service=search&request=search&version=2.0'
    + '&crs=epsg:4326&query=' + encodeURIComponent(addr)
    + '&type=address&category=road'
    + '&format=json&errorformat=json'
    + '&key=' + VK;
  jsonp(url, 'callback', function(data) {
    if(data && data.response && data.response.status === 'OK'
       && data.response.result && data.response.result.items
       && data.response.result.items.length > 0) {
      var item = data.response.result.items[0];
      cb(parseFloat(item.point.y), parseFloat(item.point.x), item.title || addr);
      return;
    }
    // ë„ë¡œëª… ì‹¤íŒ¨ â†’ ì§€ë²ˆìœ¼ë¡œ ì¬ì‹œë„
    var url2 = 'https://api.vworld.kr/req/search'
      + '?service=search&request=search&version=2.0'
      + '&crs=epsg:4326&query=' + encodeURIComponent(addr)
      + '&type=address&category=parcel'
      + '&format=json&errorformat=json'
      + '&key=' + VK;
    jsonp(url2, 'callback', function(data2) {
      if(data2 && data2.response && data2.response.status === 'OK'
         && data2.response.result && data2.response.result.items
         && data2.response.result.items.length > 0) {
        var item2 = data2.response.result.items[0];
        cb(parseFloat(item2.point.y), parseFloat(item2.point.x), item2.title || addr);
      } else {
        // ë‚´ì¥ DB fallback
        addrToCoordDB(addr, cb);
      }
    });
  });
}

// ë‚´ì¥ DB ê²€ìƒ‰ (fallback)
function addrToCoordDB(addr, cb) {
  function norm(s){ return s.replace(/\s/g,'').replace(/ì‹œ$|êµ°$|êµ¬$/,'').replace(/ì$|ë©´$|ë™$|ë¦¬$/,''); }
  var q = norm(addr);
  var found=null, bl=0;
  ADB.forEach(function(r){
    var k = norm(r.k);
    if(q.indexOf(k)>=0 || k.indexOf(q)>=0){
      if(r.k.length>bl){ bl=r.k.length; found=r; }
    }
  });
  if(found){ cb(found.lat, found.lng, found.k); return; }
  cb(null, null, null);
}

// ================================================================
// ë°ì´í„° (localStorage)
// ================================================================
var AS = (function(){ try{return JSON.parse(localStorage.getItem('apiarySettings'));}catch(e){return null;} })()
  || {'1ë´‰ì¥':true,'2ë´‰ì¥':true,'3ë´‰ì¥':true,'ì´ë™1ë´‰ì¥':false,'ì´ë™2ë´‰ì¥':false,'ì´ë™3ë´‰ì¥':false};

var AL = (function(){ try{return JSON.parse(localStorage.getItem('apiaryLocations'))||{};}catch(e){return{};} })();

function getNames(){ return Object.keys(AS).filter(function(k){return AS[k];}); }

function saveLocs(){
  try{ localStorage.setItem('apiaryLocations',JSON.stringify(AL)); return true; }
  catch(e){ showToast('âš ï¸ ì €ì¥ ì‹¤íŒ¨: '+e.message); return false; }
}

// ================================================================
// ì§€ë„ ë³€ìˆ˜
// ================================================================
var vmap=null, tiles=[], aMks=[], myMk=null, myC=null, myPos=null, wid=null, tpin=null;
var fLat=null, fLng=null, curApy=null, curTab='apiary';
var NAMES=[];

// ================================================================
// ì§€ë„ ì´ˆê¸°í™”
// ================================================================
function initMap(){
  if(vmap) return;
  vmap=L.map('vmap',{center:[36.5,127.8],zoom:7,zoomControl:true,attributionControl:false});
  setTile('sat');
  vmap.on('click',function(e){
    if(curTab!=='reg'||!curApy) return;
    setFCoord(e.latlng.lat,e.latlng.lng,'ì§€ë„ í´ë¦­');
  });
  setTimeout(function(){
    vmap.invalidateSize();
    renderAMks();
    startGPS();
    var cnt=getNames().filter(function(n){return AL[n]&&AL[n].lat;}).length;
    if(cnt>0) showToast('ğŸ“‚ ì €ì¥ëœ ë´‰ì¥ ìœ„ì¹˜ '+cnt+'ê°œ ë³µì›ë¨');
  },300);
}

function setTile(type){
  tiles.forEach(function(l){vmap.removeLayer(l);}); tiles=[];
  if(type==='sat'){
    tiles.push(L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+VK+'/Satellite/{z}/{y}/{x}.jpeg',{maxZoom:19,errorTileUrl:'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='}).addTo(vmap));
    tiles.push(L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+VK+'/Hybrid/{z}/{y}/{x}.png',{maxZoom:19,opacity:0.85}).addTo(vmap));
  } else {
    tiles.push(L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+VK+'/Base/{z}/{y}/{x}.png',{maxZoom:19}).addTo(vmap));
  }
  document.getElementById('bsat').classList.toggle('on',type==='sat');
  document.getElementById('bbase').classList.toggle('on',type==='base');
}

// ================================================================
// GPS
// ================================================================
var gpsMoved=false;
function startGPS(){
  if(!navigator.geolocation){ showToast('âš ï¸ GPS ë¯¸ì§€ì›'); return; }
  if(wid) navigator.geolocation.clearWatch(wid);
  gpsMoved=false;
  document.getElementById('gst').textContent='ğŸ“¡ GPS í™•ì¸ì¤‘...';
  wid=navigator.geolocation.watchPosition(onGPS,function(e){
    document.getElementById('gst').textContent=e.code===1?'ğŸ”’ ìœ„ì¹˜ê¶Œí•œ ì°¨ë‹¨':'âš ï¸ GPSì—†ìŒ';
  },{enableHighAccuracy:true,timeout:20000,maximumAge:0});
}

function onGPS(pos){
  var lat=pos.coords.latitude, lng=pos.coords.longitude, acc=Math.round(pos.coords.accuracy);
  myPos={lat:lat,lng:lng,acc:acc};
  var col=acc<=50?'#4ade80':acc<=300?'#fbbf24':'#f87171';
  var gst=document.getElementById('gst');
  gst.textContent='ğŸ“ Â±'+acc+'m'; gst.style.color=col;
  // ë§ˆì»¤ ê°±ì‹ 
  if(myMk) vmap.removeLayer(myMk);
  if(myC)  vmap.removeLayer(myC);
  myC=L.circle([lat,lng],{radius:acc,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:0.1,weight:1.5}).addTo(vmap);
  myMk=L.marker([lat,lng],{icon:L.divIcon({
    className:'',
    html:'<div style="width:16px;height:16px;background:#3b82f6;border:3px solid #fff;border-radius:50%;box-shadow:0 0 0 4px rgba(59,130,246,0.25);"></div>',
    iconSize:[16,16],iconAnchor:[8,8]
  }),zIndexOffset:2000}).addTo(vmap);
  // ì²« fix + ì •í™•ë„ 500m ì´í•˜ â†’ ì§€ë„ ì´ë™
  if(!gpsMoved && acc<=500){ gpsMoved=true; vmap.setView([lat,lng],14); }
  // ë‚´ìœ„ì¹˜ë°”
  document.getElementById('laddr').textContent='ì£¼ì†Œ í™•ì¸ ì¤‘...';
  document.getElementById('lcoord').textContent=lat.toFixed(5)+', '+lng.toFixed(5)+'  (Â±'+acc+'m)';
  document.getElementById('locbar').classList.add('on');
  nearAddr(lat, lng, function(addr){
    document.getElementById('laddr').textContent = addr || 'ìœ„ì¹˜ í™•ì¸ë¨';
  });
}

function goMyLoc(){
  if(myPos){ vmap.setView([myPos.lat,myPos.lng],15); showToast('ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™'); }
  else{ startGPS(); showToast('ğŸ“¡ GPS ì‹ í˜¸ í™•ì¸ ì¤‘...'); }
}
function hideLocbar(){ document.getElementById('locbar').classList.remove('on'); }

// ================================================================
// ë´‰ì¥ ë§ˆì»¤
// ================================================================
function renderAMks(){
  if(!vmap) return;
  aMks.forEach(function(m){vmap.removeLayer(m);}); aMks=[];
  getNames().forEach(function(name){
    var d=AL[name]; if(!d||!d.lat) return;
    var mov=name.indexOf('ì´ë™')>=0;
    var col=mov?'#f97316':'#FFB300';
    var icon=L.divIcon({className:'',
      html:'<div style="width:30px;height:38px;"><svg viewBox="0 0 30 38" width="30" height="38">'
        +'<path d="M15 0C6.7 0 0 6.7 0 15c0 10 15 23 15 23s15-13 15-23C30 6.7 23.3 0 15 0z" fill="'+col+'"/>'
        +'<circle cx="15" cy="15" r="8" fill="rgba(255,255,255,0.92)"/>'
        +'<text x="15" y="20" font-size="9" text-anchor="middle">'+(mov?'ğŸšš':'ğŸ')+'</text>'
        +'</svg></div>',
      iconSize:[30,38],iconAnchor:[15,38],popupAnchor:[0,-40]
    });
    var pop='<div style="background:#1e1410;border:2px solid '+col+';border-radius:10px;padding:10px 13px;min-width:155px;">'
      +'<b style="color:'+col+';">'+(mov?'ğŸšš ':'ğŸ ')+name+'</b>'
      +(d.address?'<div style="color:#aaa;font-size:.78rem;margin-top:4px;">ğŸ“ '+d.address+'</div>':'')
      +(d.memo?'<div style="color:#666;font-size:.76rem;margin-top:2px;">ğŸ“ '+d.memo+'</div>':'')
      +'<div style="color:#475569;font-size:.72rem;margin-top:4px;">ğŸŒ '+d.lat.toFixed(4)+', '+d.lng.toFixed(4)+'</div>'
      +'<div style="color:#374151;font-size:.72rem;margin-top:6px;">ëª©ë¡ ì¹´ë“œì—ì„œ ìˆ˜ì •Â·ì‚­ì œ</div>'
      +'</div>';
    var mk=L.marker([d.lat,d.lng],{icon:icon});
    mk.bindPopup(pop,{maxWidth:220});
    mk.addTo(vmap); aMks.push(mk);
  });
}

// ================================================================
// ë´‰ì¥ ì¹´ë“œ ëª©ë¡
// ================================================================
function renderAList(){
  NAMES=getNames();
  var el=document.getElementById('alist');
  if(!NAMES.length){el.innerHTML='<div style="text-align:center;color:#444;padding:24px;">í™œì„±í™”ëœ ë´‰ì¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}
  el.innerHTML=NAMES.map(function(name,i){
    var d=AL[name]||{};
    var mov=name.indexOf('ì´ë™')>=0;
    var col=mov?'#f97316':'#FFB300';
    var has=!!d.lat;
    return '<div class="ac" style="border-left:4px solid '+col+';">'
      +'<div class="acr">'
        +'<div style="flex:1;min-width:0;">'
          +'<div class="acn">'+(mov?'ğŸšš ':'ğŸ ')+name+'</div>'
          +(has
            ?'<div class="aca">ğŸ“ '+(d.address||d.lat.toFixed(4)+', '+d.lng.toFixed(4))+'</div>'+(d.memo?'<div class="acm">ğŸ“ '+d.memo+'</div>':'')
            :'<div style="color:#444;font-size:.78rem;">ìœ„ì¹˜ ë¯¸ë“±ë¡</div>')
        +'</div>'
        +'<div class="acb">'
          +(has?'<span style="padding:2px 7px;background:'+(d.isPublic?'rgba(74,222,128,.12)':'rgba(100,100,100,.15)')+';color:'+(d.isPublic?'#4ade80':'#555')+';border-radius:5px;font-size:.7rem;">'+(d.isPublic?'ê³µê°œ':'ë¹„ê³µê°œ')+'</span>':'')
          +'<button class="btn bg" onclick="tapEdit('+i+')">'+( has?'âœï¸ ìˆ˜ì •':'+ ë“±ë¡')+'</button>'
          +(has?'<button class="btn br" onclick="tapDel('+i+')">ğŸ—‘ï¸ ì‚­ì œ</button>':'')
        +'</div>'
      +'</div>'
      +(has?'<button onclick="tapFocus('+i+')" style="margin-top:8px;width:100%;padding:6px;background:rgba(255,179,0,.08);color:var(--goldl);border:1px solid rgba(255,179,0,.2);border-radius:7px;font-size:.75rem;cursor:pointer;touch-action:manipulation;">ğŸ—ºï¸ ì§€ë„ì—ì„œ ë³´ê¸°</button>':'')
      +'</div>';
  }).join('');
}

function tapEdit(i){ var n=NAMES[i]; goTab('reg'); setTimeout(function(){selectApy(n);},120); }
function tapDel(i){
  var n=NAMES[i];
  if(!confirm(n+' ìœ„ì¹˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  delete AL[n]; saveLocs();
  showToast('ğŸ—‘ï¸ '+n+' ì‚­ì œ ì™„ë£Œ');
  renderAList(); renderAMks();
  if(curApy===n) renderRegForm(n);
}
function tapFocus(i){
  var d=AL[NAMES[i]]; if(!d||!vmap) return;
  goTab('apiary');
  setTimeout(function(){vmap.invalidateSize();vmap.setView([d.lat,d.lng],15);},200);
}

// ================================================================
// íƒ­ ì „í™˜
// ================================================================
function goTab(tab){
  curTab=tab;
  ['apiary','honey','reg'].forEach(function(t,idx){
    document.getElementById('tab-'+t).style.display=t===tab?'block':'none';
    document.querySelectorAll('#tabs .tab')[idx].classList.toggle('on',t===tab);
  });
  if(!vmap){initMap();return;}
  vmap.invalidateSize();
  if(tab==='apiary'){ renderAList(); renderAMks(); }
  else{ renderASelBtns(); }
}

// ================================================================
// ìœ„ì¹˜ë“±ë¡ í¼
// ================================================================
function renderASelBtns(){
  NAMES=getNames();
  document.getElementById('aswrap').innerHTML=NAMES.map(function(n){
    var mov=n.indexOf('ì´ë™')>=0;
    return '<button class="as'+(curApy===n?' on':'')+'" onclick="selectApy(\''+n+'\')">'+
      (mov?'ğŸšš ':'ğŸ ')+n+'</button>';
  }).join('');
}

function selectApy(name){
  curApy=name;
  document.querySelectorAll('.as').forEach(function(b){
    b.classList.toggle('on', b.textContent.trim().replace(/^[ğŸššğŸ]\s+/,'')=== name);
  });
  renderRegForm(name);
}

function renderRegForm(name){
  var d=AL[name]||{}, has=!!d.lat;
  document.getElementById('regempty').style.display='none';
  document.getElementById('regform').style.display='block';
  // ë“±ë¡ëœ ìœ„ì¹˜ ì¹´ë“œ
  var ri=document.getElementById('regi');
  if(has){
    ri.classList.add('on');
    document.getElementById('ri-a').textContent=d.address||'ì£¼ì†Œ ì—†ìŒ';
    document.getElementById('ri-m').textContent=d.memo?'ğŸ“ '+d.memo:'';
    document.getElementById('ri-c').textContent='ğŸŒ '+d.lat.toFixed(5)+', '+d.lng.toFixed(5);
  } else { ri.classList.remove('on'); }
  // í¼
  document.getElementById('faddy').value=d.address||'';
  document.getElementById('fmemo').value=d.memo||'';
  var pub=!!d.isPublic;
  document.getElementById('ttrack').style.background=pub?'#16a34a':'#374151';
  document.getElementById('tthumb').style.transform=pub?'translateX(22px)':'translateX(0)';
  document.getElementById('tlabel').textContent=pub?'ê³µê°œ':'ë¹„ê³µê°œ';
  document.getElementById('tlabel').style.color=pub?'var(--green)':'#555';
  fLat=d.lat||null; fLng=d.lng||null;
  updCBox();
}

function updCBox(){
  var box=document.getElementById('cbox');
  if(fLat){
    box.classList.add('on');
    document.getElementById('cb-a').textContent='ğŸ“ '+(document.getElementById('faddy').value||nearAddr(fLat,fLng)||'ìœ„ì¹˜ ì„ íƒë¨');
    document.getElementById('cb-c').textContent='ğŸŒ '+fLat.toFixed(5)+', '+fLng.toFixed(5)+'  âœ… ì¢Œí‘œ í™•ì •';
  } else { box.classList.remove('on'); }
}

function setFCoord(lat,lng,label){
  fLat=lat; fLng=lng;
  if(tpin){vmap.removeLayer(tpin);tpin=null;}
  tpin=L.marker([lat,lng],{icon:L.divIcon({
    className:'',
    html:'<div style="font-size:1.8rem;filter:drop-shadow(0 2px 5px rgba(0,0,0,.8))">ğŸ“</div>',
    iconSize:[30,30],iconAnchor:[10,28]
  }),zIndexOffset:1500}).addTo(vmap);
  vmap.setView([lat,lng],15);
  updCBox();
  showToast('ğŸ“ '+label+' - ë©”ëª¨ ì…ë ¥ í›„ ì €ì¥í•˜ì„¸ìš”');
}

function gpsToForm(){
  if(myPos&&myPos.lat){
    setFCoord(myPos.lat,myPos.lng,'í˜„ì¬ ìœ„ì¹˜ (Â±'+myPos.acc+'m)');
    document.getElementById('faddy').value='ì£¼ì†Œ í™•ì¸ ì¤‘...';
    nearAddr(myPos.lat, myPos.lng, function(addr){
      document.getElementById('faddy').value = addr || '';
      updCBox();
    });
  } else { showToast('ğŸ“¡ GPS ì‹ í˜¸ í™•ì¸ ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”'); startGPS(); }
}

function doSearch(){
  var addr=document.getElementById('faddy').value.trim();
  if(!addr){ showToast('âš ï¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  showToast('ğŸ” ê²€ìƒ‰ ì¤‘...');
  addrToCoord(addr, function(lat, lng, title){
    if(lat){
      document.getElementById('faddy').value = title || addr;
      setFCoord(lat, lng, title || addr);
    } else {
      showToast('âš ï¸ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„ë¡œëª…/ì§€ë²ˆ ì£¼ì†Œë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
  });
}

function togglePub(){
  var on=document.getElementById('tthumb').style.transform!=='translateX(22px)';
  document.getElementById('ttrack').style.background=on?'#16a34a':'#374151';
  document.getElementById('tthumb').style.transform=on?'translateX(22px)':'translateX(0)';
  document.getElementById('tlabel').textContent=on?'ê³µê°œ':'ë¹„ê³µê°œ';
  document.getElementById('tlabel').style.color=on?'var(--green)':'#555';
}

function saveApiary(){
  if(!curApy){ showToast('âš ï¸ ë´‰ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  if(!fLat){ showToast('âš ï¸ GPS ë²„íŠ¼ì´ë‚˜ ì£¼ì†Œ ê²€ìƒ‰ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”'); return; }
  var pub=document.getElementById('tthumb').style.transform==='translateX(22px)';
  AL[curApy]={lat:fLat,lng:fLng,
    address:document.getElementById('faddy').value.trim(),
    memo:document.getElementById('fmemo').value.trim(),
    isPublic:pub, updatedAt:new Date().toISOString()};
  if(saveLocs()){
    if(tpin){vmap.removeLayer(tpin);tpin=null;}
    showToast('âœ… '+curApy+' ì €ì¥ ì™„ë£Œ!');
    setTimeout(function(){
      goTab('apiary');
      setTimeout(function(){vmap.invalidateSize();vmap.setView([fLat,fLng],15);renderAMks();},200);
    },600);
  }
}

function deleteApiary(){
  if(!curApy) return;
  if(!confirm(curApy+' ìœ„ì¹˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  delete AL[curApy]; saveLocs();
  showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
  renderRegForm(curApy); renderAMks();
}

function focusReg(){
  if(!curApy) return;
  var d=AL[curApy]; if(!d||!vmap) return;
  goTab('apiary');
  setTimeout(function(){vmap.invalidateSize();vmap.setView([d.lat,d.lng],15);},200);
}

function locToForm(){
  if(!myPos){ showToast('âš ï¸ GPS ìœ„ì¹˜ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”'); return; }
  var ns=getNames();
  if(!ns.length){ showToast('âš ï¸ í™œì„± ë´‰ì¥ì´ ì—†ìŠµë‹ˆë‹¤'); return; }
  var unreg=ns.filter(function(n){return !AL[n]||!AL[n].lat;});
  var target=unreg.length?unreg[0]:ns[0];
  goTab('reg');
  setTimeout(function(){
    renderASelBtns(); selectApy(target);
    setTimeout(function(){
      setFCoord(myPos.lat,myPos.lng,'í˜„ì¬ ìœ„ì¹˜ (Â±'+myPos.acc+'m)');
      nearAddr(myPos.lat, myPos.lng, function(addr){
        document.getElementById('faddy').value = addr || '';
        updCBox();
      });
    },200);
  },150);
}

// ================================================================
// í† ìŠ¤íŠ¸
// ================================================================
var _tt=null;
function showToast(msg){
  var el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('on');
  if(_tt) clearTimeout(_tt);
  _tt=setTimeout(function(){el.classList.remove('on');},2800);
}

// ================================================================
// ì‹œì‘
// ================================================================
window.addEventListener('load',function(){
  NAMES=getNames();
  renderAList();
  initMap();
});
</script>
</body>
</html>
